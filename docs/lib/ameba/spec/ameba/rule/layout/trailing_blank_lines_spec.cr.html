<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Begin Jekyll SEO tag v2.8.0 -->
<title>lib/ameba/spec/ameba/rule/layout/trailing_blank_lines_spec.cr</title>
<meta name="generator" content="Jekyll v3.9.3" />
<meta property="og:title" content="lib/ameba/spec/ameba/rule/layout/trailing_blank_lines_spec.cr" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="This documentation is automatically generated by online-judge-tools/verification-helper" />
<meta property="og:description" content="This documentation is automatically generated by online-judge-tools/verification-helper" />
<meta property="og:type" content="website" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="lib/ameba/spec/ameba/rule/layout/trailing_blank_lines_spec.cr" />
<script type="application/ld+json">
{"@context":"https://schema.org","@type":"WebPage","description":"This documentation is automatically generated by online-judge-tools/verification-helper","headline":"lib/ameba/spec/ameba/rule/layout/trailing_blank_lines_spec.cr","url":"/ac-library.cr/docs/lib/ameba/spec/ameba/rule/layout/trailing_blank_lines_spec.cr.html"}</script>
<!-- End Jekyll SEO tag -->

    <link rel="stylesheet" href="/ac-library.cr/docs/assets/css/style.css?v=">
    <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.min.js"></script>
    <![endif]-->
    <!-- start custom head snippets, customize with your own _includes/head-custom.html file -->

<!-- Setup Google Analytics -->



<!-- You can set your favicon here -->
<!-- link rel="shortcut icon" type="image/x-icon" href="/ac-library.cr/docs/favicon.ico" -->

<!-- end custom head snippets -->

  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1><a href="/ac-library.cr/docs/"></a></h1>

        

        <p><small>This documentation is automatically generated by <a href="https://github.com/online-judge-tools/verification-helper">online-judge-tools/verification-helper</a></small></p>

        

        

        
      </header>
      <section>

      <script type="text/javascript" async="" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML">
</script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    TeX: { equationNumbers: { autoNumber: "AMS" }},
    tex2jax: {
      inlineMath: [ ['$','$'] ],
      processEscapes: true
    },
    "HTML-CSS": { matchFontHeight: false },
    displayAlign: "left",
    displayIndent: "2em"
  });
</script>



<style type="text/css">
@media screen and (min-width: 900px) {
    div.wrapper {
        width: 100%;
    }
    div.wrapper > header {
        width: 280px;
    }
    div.wrapper > section {
        width: calc(100% - 300px);
    }
}
a:hover, a:focus {
    font-weight: normal;
    text-decoration: underline;
}
h1 a:hover {
    font-weight: bold;
}
h1 a:focus {
    font-weight: bold;
}
</style>



<h1>
<img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/spec/ameba/rule/layout/trailing_blank_lines_spec.cr
    
</h1>

<ul>
    <li><a href="/blob/master/lib/ameba/spec/ameba/rule/layout/trailing_blank_lines_spec.cr">View this file on GitHub</a></li>
    <li>Last update: 1970-01-01 00:00:00+00:00</li>
    
    
    
    
</ul>








    <h2>Depends on</h2>
    <ul>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/spec/spec_helper.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/spec/spec_helper.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/branch.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/branch.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/branchable.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/branchable.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/flow_expression.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/flow_expression.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/scope.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/scope.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/util.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/util.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/variabling/argument.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/variabling/argument.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/variabling/assignment.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/variabling/assignment.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/variabling/ivariable.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/variabling/ivariable.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/variabling/reference.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/variabling/reference.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/variabling/variable.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/variabling/variable.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/visitors/base_visitor.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/visitors/base_visitor.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/visitors/counting_visitor.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/visitors/counting_visitor.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/visitors/flow_expression_visitor.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/visitors/flow_expression_visitor.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/visitors/node_visitor.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/visitors/node_visitor.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/visitors/redundant_control_expression_visitor.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/visitors/redundant_control_expression_visitor.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/visitors/scope_visitor.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/visitors/scope_visitor.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ast/visitors/top_level_nodes_visitor.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ast/visitors/top_level_nodes_visitor.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/config.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/config.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/ext/location.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/ext/location.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/formatter/base_formatter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/formatter/base_formatter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/formatter/disabled_formatter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/formatter/disabled_formatter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/formatter/dot_formatter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/formatter/dot_formatter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/formatter/explain_formatter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/formatter/explain_formatter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/formatter/flycheck_formatter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/formatter/flycheck_formatter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/formatter/json_formatter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/formatter/json_formatter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/formatter/todo_formatter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/formatter/todo_formatter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/formatter/util.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/formatter/util.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/glob_utils.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/glob_utils.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/inline_comments.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/inline_comments.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/issue.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/issue.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/reportable.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/reportable.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/base.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/base.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/layout/line_length.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/layout/line_length.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/layout/trailing_blank_lines.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/layout/trailing_blank_lines.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/layout/trailing_whitespace.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/layout/trailing_whitespace.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/ambiguous_assignment.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/ambiguous_assignment.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/bad_directive.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/bad_directive.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/comparison_to_boolean.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/comparison_to_boolean.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/debug_calls.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/debug_calls.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/debugger_statement.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/debugger_statement.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/duplicated_require.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/duplicated_require.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/empty_ensure.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/empty_ensure.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/empty_expression.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/empty_expression.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/empty_loop.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/empty_loop.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/formatting.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/formatting.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/hash_duplicated_key.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/hash_duplicated_key.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/literal_assignments_in_expressions.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/literal_assignments_in_expressions.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/literal_in_condition.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/literal_in_condition.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/literal_in_interpolation.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/literal_in_interpolation.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/literals_comparison.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/literals_comparison.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/missing_block_argument.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/missing_block_argument.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/not_nil.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/not_nil.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/not_nil_after_no_bang.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/not_nil_after_no_bang.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/percent_array.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/percent_array.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/rand_zero.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/rand_zero.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/redundant_string_coercion.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/redundant_string_coercion.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/redundant_with_index.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/redundant_with_index.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/redundant_with_object.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/redundant_with_object.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/shadowed_argument.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/shadowed_argument.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/shadowed_exception.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/shadowed_exception.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/shadowing_outer_local_var.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/shadowing_outer_local_var.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/shared_var_in_fiber.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/shared_var_in_fiber.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/spec_focus.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/spec_focus.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/syntax.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/syntax.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/unneeded_disable_directive.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/unneeded_disable_directive.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/unreachable_code.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/unreachable_code.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/unused_argument.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/unused_argument.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/unused_block_argument.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/unused_block_argument.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/useless_assign.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/useless_assign.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/lint/useless_condition_in_when.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/lint/useless_condition_in_when.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/metrics/cyclomatic_complexity.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/metrics/cyclomatic_complexity.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/performance/any_after_filter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/performance/any_after_filter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/performance/any_instead_of_empty.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/performance/any_instead_of_empty.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/performance/base.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/performance/base.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/performance/chained_call_with_no_bang.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/performance/chained_call_with_no_bang.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/performance/compact_after_map.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/performance/compact_after_map.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/performance/first_last_after_filter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/performance/first_last_after_filter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/performance/flatten_after_map.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/performance/flatten_after_map.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/performance/map_instead_of_block.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/performance/map_instead_of_block.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/performance/size_after_filter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/performance/size_after_filter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/constant_names.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/constant_names.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/guard_clause.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/guard_clause.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/is_a_filter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/is_a_filter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/is_a_nil.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/is_a_nil.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/large_numbers.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/large_numbers.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/method_names.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/method_names.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/negated_conditions_in_unless.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/negated_conditions_in_unless.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/parentheses_around_condition.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/parentheses_around_condition.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/predicate_name.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/predicate_name.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/query_bool_methods.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/query_bool_methods.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/redundant_begin.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/redundant_begin.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/redundant_next.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/redundant_next.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/redundant_return.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/redundant_return.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/type_names.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/type_names.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/unless_else.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/unless_else.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/variable_names.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/variable_names.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/verbose_block.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/verbose_block.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/rule/style/while_true.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/rule/style/while_true.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/runner.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/runner.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/severity.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/severity.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/source.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/source.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/source/corrector.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/source/corrector.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/source/rewriter.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/source/rewriter.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/source/rewriter/action.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/source/rewriter/action.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/spec/annotated_source.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/spec/annotated_source.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/spec/be_valid.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/spec/be_valid.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/spec/expect_issue.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/spec/expect_issue.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/spec/support.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/spec/support.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/spec/util.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/spec/util.cr
            
        </a></li>
    
        <li><a href="/ac-library.cr/docs/lib/ameba/src/ameba/tokenizer.cr"><img class="emoji" title=":warning:" alt=":warning:" src="https://github.githubassets.com/images/icons/emoji/unicode/26a0.png" height="20" width="20"> lib/ameba/src/ameba/tokenizer.cr
            
        </a></li>
    
    </ul>









<h2>Code</h2>

<script defer type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script defer src="https://cdn.jsdelivr.net/npm/jquery-balloon-js@1.1.2/jquery.balloon.min.js" integrity="sha256-ZEYs9VrgAeNuPvs15E39OsyOJaIkXEEt10fzxJ20+2I=" crossorigin="anonymous"></script>
<script defer type="text/javascript" src="/ac-library.cr/docs/assets/js/copy-button.js"></script>
<link rel="stylesheet" href="/ac-library.cr/docs/assets/css/copy-button.css">

<span><a id="unbundled"></a></span>




<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="n">require</span> <span class="s">"../../../spec_helper"</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Layout</span>
  <span class="n">subject</span> <span class="o">=</span> <span class="n">TrailingBlankLines</span><span class="p">.</span><span class="k">new</span>

  <span class="n">describe</span> <span class="n">TrailingBlankLines</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s">"passes if there is a blank line at the end of a source"</span> <span class="k">do</span>
      <span class="n">expect_no_issues</span> <span class="n">subject</span><span class="p">,</span> <span class="s">"a = 1</span><span class="se">\n</span><span class="s">"</span>
    <span class="n">end</span>

    <span class="n">it</span> <span class="s">"passes if source is empty"</span> <span class="k">do</span>
      <span class="n">expect_no_issues</span> <span class="n">subject</span><span class="p">,</span> <span class="s">""</span>
    <span class="n">end</span>

    <span class="n">it</span> <span class="s">"fails if there is no blank lines at the end"</span> <span class="k">do</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">expect_issue</span> <span class="n">subject</span><span class="p">,</span> <span class="s">"no-blankline # error: Trailing newline missing"</span>
      <span class="n">expect_correction</span> <span class="n">source</span><span class="p">,</span> <span class="s">"no-blankline</span><span class="se">\n</span><span class="s">"</span>
    <span class="n">end</span>

    <span class="n">it</span> <span class="s">"fails if there more then one blank line at the end of a source"</span> <span class="k">do</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">expect_issue</span> <span class="n">subject</span><span class="p">,</span> <span class="s">"a = 1</span><span class="se">\n</span><span class="s"> </span><span class="se">\n</span><span class="s"> # error: Excessive trailing newline detected"</span>
      <span class="n">expect_no_corrections</span> <span class="n">source</span>
    <span class="n">end</span>

    <span class="n">it</span> <span class="s">"fails if last line is not blank"</span> <span class="k">do</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">expect_issue</span> <span class="n">subject</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n\n</span><span class="s"> puts 22 # error: Trailing newline missing"</span>
      <span class="n">expect_correction</span> <span class="n">source</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n\n</span><span class="s"> puts 22</span><span class="se">\n</span><span class="s">"</span>
    <span class="n">end</span>

    <span class="n">context</span> <span class="s">"when unnecessary blank line has been detected"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s">"reports rule, pos and message"</span> <span class="k">do</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">.</span><span class="k">new</span> <span class="s">"a = 1</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"source.cr"</span><span class="p">,</span> <span class="n">normalize</span><span class="o">:</span> <span class="nb">false</span>
        <span class="n">subject</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="n">source</span><span class="p">).</span><span class="n">should_not</span> <span class="n">be_valid</span>

        <span class="n">issue</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">first</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">to_s</span><span class="p">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s">"source.cr:3:1"</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">end_location</span><span class="p">.</span><span class="n">should</span> <span class="n">be_nil</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s">"Excessive trailing newline detected"</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">context</span> <span class="s">"when final line has been missed"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s">"reports rule, pos and message"</span> <span class="k">do</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">.</span><span class="k">new</span> <span class="s">"a = 1"</span><span class="p">,</span> <span class="s">"source.cr"</span><span class="p">,</span> <span class="n">normalize</span><span class="o">:</span> <span class="nb">false</span>
        <span class="n">subject</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="n">source</span><span class="p">).</span><span class="n">should_not</span> <span class="n">be_valid</span>

        <span class="n">issue</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">first</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">to_s</span><span class="p">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s">"source.cr:1:1"</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">end_location</span><span class="p">.</span><span class="n">should</span> <span class="n">be_nil</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s">"Trailing newline missing"</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span></code></pre></figure>





<span><a id="bundled"></a></span>




<figure class="highlight"><pre><code class="language-cpp" data-lang="cpp"><span class="cp"># require "../../../spec_helper"
</span><span class="n">require</span> <span class="s">"spec"</span>
<span class="cp"># require "../src/ameba"
# require "./ameba</span><span class="cm">/*"
require "yaml"

# require "./glob_utils"
module Ameba
  # Helper module that is utilizes helpers for working with globs.
  module GlobUtils
    # Returns all files that match specified globs.
    # Globs can have wildcards or be rejected:
    #
    # ```
    # find_files_by_globs(["**/</span><span class="cp">*.cr", "!lib"])
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="nf">find_files_by_globs</span><span class="p">(</span><span class="n">globs</span><span class="p">)</span>
      <span class="n">rejected</span> <span class="o">=</span> <span class="n">rejected_globs</span><span class="p">(</span><span class="n">globs</span><span class="p">)</span>
      <span class="n">selected</span> <span class="o">=</span> <span class="n">globs</span> <span class="o">-</span> <span class="n">rejected</span>

      <span class="n">expand</span><span class="p">(</span><span class="n">selected</span><span class="p">)</span> <span class="o">-</span> <span class="n">expand</span><span class="p">(</span><span class="n">rejected</span><span class="p">.</span><span class="n">map</span><span class="o">!</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.[</span><span class="mf">1.</span><span class="p">.</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
    <span class="n">end</span>

    <span class="cp"># Expands globs. Globs can point to files or even directories.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># expand(["spec</span><span class="cm">/*.cr", "src"]) # =&gt; all files in src folder + first level specs
    # ```
    def expand(globs)
      globs.flat_map do |glob|
        glob += "/**/</span><span class="cp">*.cr" if File.directory?(glob)
</span>        <span class="n">Dir</span><span class="p">[</span><span class="n">glob</span><span class="p">]</span>
      <span class="n">end</span><span class="p">.</span><span class="n">uniq</span><span class="o">!</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">rejected_globs</span><span class="p">(</span><span class="n">globs</span><span class="p">)</span>
      <span class="n">globs</span><span class="p">.</span><span class="n">select</span> <span class="k">do</span> <span class="o">|</span><span class="n">glob</span><span class="o">|</span>
        <span class="n">glob</span><span class="p">.</span><span class="n">starts_with</span><span class="o">?</span><span class="p">(</span><span class="sc">'!'</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">File</span><span class="p">.</span><span class="n">exists</span><span class="o">?</span><span class="p">(</span><span class="n">glob</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># A configuration entry for `Ameba::Runner`.
#
# Config can be loaded from configuration YAML file and adjusted.
#
# ```
# config = Config.load
# config.formatter = my_formatter
# ```
#
# By default config loads `.ameba.yml` file in a current directory.
#
</span><span class="k">class</span> <span class="nc">Ameba</span><span class="o">::</span><span class="n">Config</span>
  <span class="n">include</span> <span class="n">GlobUtils</span>

  <span class="n">AVAILABLE_FORMATTERS</span> <span class="o">=</span> <span class="p">{</span>
    <span class="nl">progress:</span> <span class="n">Formatter</span><span class="o">::</span><span class="n">DotFormatter</span><span class="p">,</span>
    <span class="nl">todo:</span>     <span class="n">Formatter</span><span class="o">::</span><span class="n">TODOFormatter</span><span class="p">,</span>
    <span class="nl">flycheck:</span> <span class="n">Formatter</span><span class="o">::</span><span class="n">FlycheckFormatter</span><span class="p">,</span>
    <span class="nl">silent:</span>   <span class="n">Formatter</span><span class="o">::</span><span class="n">BaseFormatter</span><span class="p">,</span>
    <span class="nl">disabled:</span> <span class="n">Formatter</span><span class="o">::</span><span class="n">DisabledFormatter</span><span class="p">,</span>
    <span class="nl">json:</span>     <span class="n">Formatter</span><span class="o">::</span><span class="n">JSONFormatter</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="n">PATH</span> <span class="o">=</span> <span class="s">".ameba.yml"</span>

  <span class="n">DEFAULT_GLOBS</span> <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">(</span>
    <span class="o">*</span><span class="err">*/</span><span class="o">*</span><span class="p">.</span><span class="n">cr</span>
    <span class="o">!</span><span class="n">lib</span>
  <span class="p">)</span>

  <span class="n">getter</span> <span class="n">rules</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Rule</span><span class="o">::</span><span class="n">Base</span><span class="p">)</span>
  <span class="n">property</span> <span class="n">severity</span> <span class="o">=</span> <span class="n">Severity</span><span class="o">::</span><span class="n">Convention</span>

  <span class="cp"># Returns a list of paths (with wildcards) to files.
</span>  <span class="cp"># Represents a list of sources to be inspected.
</span>  <span class="cp"># If globs are not set, it will return default list of files.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># config = Ameba::Config.load
</span>  <span class="cp"># config.globs = ["**</span><span class="cm">/*.cr"]
  # config.globs
  # ```
  property globs : Array(String)

  # Represents a list of paths to exclude from globs.
  # Can have wildcards.
  #
  # ```
  # config = Ameba::Config.load
  # config.excluded = ["spec", "src/server/*.cr"]
  # ```
  property excluded : Array(String)

  # Returns `true` if correctable issues should be autocorrected.
  property? autocorrect = false

  @rule_groups : Hash(String, Array(Rule::Base))

  # Creates a new instance of `Ameba::Config` based on YAML parameters.
  #
  # `Config.load` uses this constructor to instantiate new config by YAML file.
  protected def initialize(config : YAML::Any)
    @rules = Rule.rules.map &amp;.new(config).as(Rule::Base)
    @rule_groups = @rules.group_by &amp;.group
    @excluded = load_array_section(config, "Excluded")
    @globs = load_array_section(config, "Globs", DEFAULT_GLOBS)

    return unless formatter_name = load_formatter_name(config)
    self.formatter = formatter_name
  end

  # Loads YAML configuration file by `path`.
  #
  # ```
  # config = Ameba::Config.load
  # ```
  def self.load(path = PATH, colors = true)
    Colorize.enabled = colors
    content = File.exists?(path) ? File.read path : "{}"
    Config.new YAML.parse(content)
  rescue e
    raise "Config file is invalid: #{e.message}"
  end

  def self.formatter_names
    AVAILABLE_FORMATTERS.keys.join('|')
  end

  # Returns a list of sources matching globs and excluded sections.
  #
  # ```
  # config = Ameba::Config.load
  # config.sources # =&gt; list of default sources
  # config.globs = ["**/</span><span class="cp">*.cr"]
</span>  <span class="cp"># config.excluded = ["spec"]
</span>  <span class="cp"># config.sources # =&gt; list of sources pointing to files found by the wildcards
</span>  <span class="cp"># ```
</span>  <span class="n">def</span> <span class="n">sources</span>
    <span class="p">(</span><span class="n">find_files_by_globs</span><span class="p">(</span><span class="n">globs</span><span class="p">)</span> <span class="o">-</span> <span class="n">find_files_by_globs</span><span class="p">(</span><span class="n">excluded</span><span class="p">))</span>
      <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span> <span class="n">Source</span><span class="p">.</span><span class="k">new</span> <span class="n">File</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">path</span><span class="p">),</span> <span class="n">path</span> <span class="p">}</span>
  <span class="n">end</span>

  <span class="cp"># Returns a formatter to be used while inspecting files.
</span>  <span class="cp"># If formatter is not set, it will return default formatter.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># config = Ameba::Config.load
</span>  <span class="cp"># config.formatter = custom_formatter
</span>  <span class="cp"># config.formatter
</span>  <span class="cp"># ```
</span>  <span class="n">property</span> <span class="n">formatter</span> <span class="o">:</span> <span class="n">Formatter</span><span class="o">::</span><span class="n">BaseFormatter</span> <span class="k">do</span>
    <span class="n">Formatter</span><span class="o">::</span><span class="n">DotFormatter</span><span class="p">.</span><span class="k">new</span>
  <span class="n">end</span>

  <span class="cp"># Sets formatter by name.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># config = Ameba::Config.load
</span>  <span class="cp"># config.formatter = :progress
</span>  <span class="cp"># ```
</span>  <span class="n">def</span> <span class="n">formatter</span><span class="o">=</span><span class="p">(</span><span class="n">name</span> <span class="o">:</span> <span class="n">String</span> <span class="o">|</span> <span class="n">Symbol</span><span class="p">)</span>
    <span class="n">unless</span> <span class="n">formatter</span> <span class="o">=</span> <span class="n">AVAILABLE_FORMATTERS</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">?</span>
      <span class="n">raise</span> <span class="s">"Unknown formatter `#{name}`. Use one of #{Config.formatter_names}."</span>
    <span class="n">end</span>
    <span class="err">@</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">formatter</span><span class="p">.</span><span class="k">new</span>
  <span class="n">end</span>

  <span class="cp"># Updates rule properties.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># config = Ameba::Config.load
</span>  <span class="cp"># config.update_rule "MyRuleName", enabled: false
</span>  <span class="cp"># ```
</span>  <span class="n">def</span> <span class="n">update_rule</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span> <span class="n">excluded</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
    <span class="n">rule</span> <span class="o">=</span> <span class="err">@</span><span class="n">rules</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="o">==</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
    <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="s">"Rule `#{name}` does not exist"</span><span class="p">)</span> <span class="n">unless</span> <span class="n">rule</span>

    <span class="n">rule</span>
      <span class="p">.</span><span class="n">tap</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enabled</span><span class="p">)</span>
      <span class="p">.</span><span class="n">tap</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">excluded</span> <span class="o">=</span> <span class="n">excluded</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="cp"># Updates rules properties.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># config = Ameba::Config.load
</span>  <span class="cp"># config.update_rules %w(Rule1 Rule2), enabled: true
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># also it allows to update groups of rules:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># config.update_rules %w(Group1 Group2), enabled: true
</span>  <span class="cp"># ```
</span>  <span class="n">def</span> <span class="n">update_rules</span><span class="p">(</span><span class="n">names</span><span class="p">,</span> <span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span> <span class="n">excluded</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
    <span class="n">names</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">name</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">rules</span> <span class="o">=</span> <span class="err">@</span><span class="n">rule_groups</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">?</span>
        <span class="n">rules</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">rule</span><span class="o">|</span>
          <span class="n">rule</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">enabled</span>
          <span class="n">rule</span><span class="p">.</span><span class="n">excluded</span> <span class="o">=</span> <span class="n">excluded</span>
        <span class="n">end</span>
      <span class="k">else</span>
        <span class="n">update_rule</span> <span class="n">name</span><span class="p">,</span> <span class="n">enabled</span><span class="p">,</span> <span class="n">excluded</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">def</span> <span class="n">load_formatter_name</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="s">"Formatter"</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.[</span><span class="s">"Name"</span><span class="p">]</span><span class="o">?</span>
    <span class="n">name</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">to_s</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">def</span> <span class="n">load_array_section</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">section_name</span><span class="p">,</span> <span class="k">default</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">String</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">value</span> <span class="o">=</span> <span class="n">config</span><span class="p">[</span><span class="n">section_name</span><span class="p">]</span><span class="o">?</span>
    <span class="n">when</span> <span class="p">.</span><span class="n">nil</span><span class="o">?</span>  <span class="n">then</span> <span class="k">default</span>
    <span class="n">when</span> <span class="p">.</span><span class="n">as_s</span><span class="o">?</span> <span class="n">then</span> <span class="p">[</span><span class="n">value</span><span class="p">.</span><span class="n">to_s</span><span class="p">]</span>
    <span class="n">when</span> <span class="p">.</span><span class="n">as_a</span><span class="o">?</span> <span class="n">then</span> <span class="n">value</span><span class="p">.</span><span class="n">as_a</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">as_s</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">raise</span> <span class="s">"Incorrect '#{section_name}' section in a config files"</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># :nodoc:
</span>  <span class="n">module</span> <span class="n">RuleConfig</span>
    <span class="n">macro</span> <span class="n">properties</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">definitions</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">NamedTuple</span> <span class="o">%</span><span class="p">}</span>
      <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span> <span class="n">Assign</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">definitions</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">var</span><span class="o">:</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">value</span><span class="p">}</span> <span class="o">%</span><span class="p">}</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">elsif</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span> <span class="n">Call</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="n">definitions</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">var</span><span class="o">:</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">first</span><span class="p">}</span> <span class="o">%</span><span class="p">}</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">elsif</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span> <span class="n">TypeDeclaration</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">definitions</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">var</span><span class="o">:</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">type</span><span class="o">:</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">type</span><span class="p">}</span> <span class="o">%</span><span class="p">}</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">elsif</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span> <span class="n">Expressions</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">prop</span> <span class="n">in</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">expressions</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">prop</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span> <span class="n">Assign</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">definitions</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">var</span><span class="o">:</span> <span class="n">prop</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="n">prop</span><span class="p">.</span><span class="n">value</span><span class="p">}</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="n">elsif</span> <span class="n">prop</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span> <span class="n">Call</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">definitions</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">var</span><span class="o">:</span> <span class="n">prop</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="n">prop</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">first</span><span class="p">}</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="n">elsif</span> <span class="n">prop</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span> <span class="n">TypeDeclaration</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">definitions</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="n">var</span><span class="o">:</span> <span class="n">prop</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">value</span><span class="o">:</span> <span class="n">prop</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">type</span><span class="o">:</span> <span class="n">prop</span><span class="p">.</span><span class="n">type</span><span class="p">}</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>

      <span class="p">{</span><span class="o">%</span> <span class="n">properties</span> <span class="o">=</span> <span class="p">{}</span> <span class="n">of</span> <span class="n">MacroId</span> <span class="o">=&gt;</span> <span class="n">NamedTuple</span> <span class="o">%</span><span class="p">}</span>
      <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">df</span> <span class="n">in</span> <span class="n">definitions</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">name</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">:</span><span class="n">var</span><span class="p">].</span><span class="n">id</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">key</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="n">camelcase</span><span class="p">.</span><span class="n">stringify</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">value</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">:</span><span class="n">value</span><span class="p">]</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">type</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="o">:</span><span class="n">type</span><span class="p">]</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">converter</span> <span class="o">=</span> <span class="n">nil</span> <span class="o">%</span><span class="p">}</span>

        <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="s">"Severity"</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Severity</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="n">converter</span> <span class="o">=</span> <span class="n">SeverityYamlConverter</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>

        <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="n">nil</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span> <span class="n">BoolLiteral</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Bool</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="n">elsif</span> <span class="n">value</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span> <span class="n">StringLiteral</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">type</span> <span class="o">=</span> <span class="n">String</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="n">elsif</span> <span class="n">value</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span> <span class="n">NumberLiteral</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">value</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="o">:</span><span class="n">i32</span> <span class="o">%</span><span class="p">}</span>
              <span class="p">{</span><span class="o">%</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Int32</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">elsif</span> <span class="n">value</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="o">:</span><span class="n">i64</span> <span class="o">%</span><span class="p">}</span>
              <span class="p">{</span><span class="o">%</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Int64</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">elsif</span> <span class="n">value</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="o">:</span><span class="n">f32</span> <span class="o">%</span><span class="p">}</span>
              <span class="p">{</span><span class="o">%</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Float32</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">elsif</span> <span class="n">value</span><span class="p">.</span><span class="n">kind</span> <span class="o">==</span> <span class="o">:</span><span class="n">f64</span> <span class="o">%</span><span class="p">}</span>
              <span class="p">{</span><span class="o">%</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Float64</span> <span class="o">%</span><span class="p">}</span>
            <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>
          <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>

          <span class="p">{</span><span class="o">%</span> <span class="n">type</span> <span class="o">=</span> <span class="n">Nil</span> <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="n">nil</span> <span class="o">%</span><span class="p">}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>

        <span class="p">{</span><span class="o">%</span> <span class="n">properties</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">key</span><span class="o">:</span> <span class="n">key</span><span class="p">,</span> <span class="k">default</span><span class="o">:</span> <span class="n">value</span><span class="p">,</span> <span class="n">type</span><span class="o">:</span> <span class="n">type</span><span class="p">,</span> <span class="n">converter</span><span class="o">:</span> <span class="n">converter</span><span class="p">}</span> <span class="o">%</span><span class="p">}</span>

        <span class="err">@</span><span class="p">[</span><span class="n">YAML</span><span class="o">::</span><span class="n">Field</span><span class="p">(</span><span class="n">key</span><span class="o">:</span> <span class="p">{{</span> <span class="n">key</span> <span class="p">}},</span> <span class="n">converter</span><span class="o">:</span> <span class="p">{{</span> <span class="n">converter</span> <span class="p">}},</span> <span class="n">type</span><span class="o">:</span> <span class="p">{{</span> <span class="n">type</span> <span class="p">}})]</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">type</span> <span class="o">==</span> <span class="n">Bool</span> <span class="o">%</span><span class="p">}</span>
          <span class="n">property</span><span class="o">?</span> <span class="p">{{</span> <span class="n">name</span> <span class="p">}}</span> <span class="o">:</span> <span class="p">{{</span> <span class="n">type</span> <span class="p">}}</span> <span class="o">=</span> <span class="p">{{</span> <span class="n">value</span> <span class="p">}}</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
          <span class="n">property</span> <span class="p">{{</span> <span class="n">name</span> <span class="p">}}</span> <span class="o">:</span> <span class="p">{{</span> <span class="n">type</span> <span class="p">}}</span> <span class="o">=</span> <span class="p">{{</span> <span class="n">value</span> <span class="p">}}</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>

      <span class="p">{</span><span class="o">%</span> <span class="n">unless</span> <span class="n">properties</span><span class="p">[</span><span class="s">"enabled"</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="o">%</span><span class="p">}</span>
        <span class="err">@</span><span class="p">[</span><span class="n">YAML</span><span class="o">::</span><span class="n">Field</span><span class="p">(</span><span class="n">key</span><span class="o">:</span> <span class="s">"Enabled"</span><span class="p">)]</span>
        <span class="n">property</span><span class="o">?</span> <span class="n">enabled</span> <span class="o">=</span> <span class="nb">true</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>

      <span class="p">{</span><span class="o">%</span> <span class="n">unless</span> <span class="n">properties</span><span class="p">[</span><span class="s">"severity"</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="o">%</span><span class="p">}</span>
        <span class="err">@</span><span class="p">[</span><span class="n">YAML</span><span class="o">::</span><span class="n">Field</span><span class="p">(</span><span class="n">key</span><span class="o">:</span> <span class="s">"Severity"</span><span class="p">,</span> <span class="n">converter</span><span class="o">:</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">SeverityYamlConverter</span><span class="p">)]</span>
        <span class="n">property</span> <span class="n">severity</span> <span class="o">=</span> <span class="p">{{</span> <span class="err">@</span><span class="n">type</span> <span class="p">}}.</span><span class="n">default_severity</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>

      <span class="p">{</span><span class="o">%</span> <span class="n">unless</span> <span class="n">properties</span><span class="p">[</span><span class="s">"excluded"</span><span class="p">.</span><span class="n">id</span><span class="p">]</span> <span class="o">%</span><span class="p">}</span>
        <span class="err">@</span><span class="p">[</span><span class="n">YAML</span><span class="o">::</span><span class="n">Field</span><span class="p">(</span><span class="n">key</span><span class="o">:</span> <span class="s">"Excluded"</span><span class="p">)]</span>
        <span class="n">property</span> <span class="n">excluded</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">String</span><span class="p">)</span><span class="o">?</span>
      <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>
    <span class="n">end</span>

    <span class="n">macro</span> <span class="n">included</span>
      <span class="n">GROUP_SEVERITY</span> <span class="o">=</span> <span class="p">{</span>
        <span class="nl">Lint:</span>        <span class="n">Ameba</span><span class="o">::</span><span class="n">Severity</span><span class="o">::</span><span class="n">Warning</span><span class="p">,</span>
        <span class="nl">Metrics:</span>     <span class="n">Ameba</span><span class="o">::</span><span class="n">Severity</span><span class="o">::</span><span class="n">Warning</span><span class="p">,</span>
        <span class="nl">Performance:</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Severity</span><span class="o">::</span><span class="n">Warning</span><span class="p">,</span>
      <span class="p">}</span>

      <span class="n">class_getter</span> <span class="n">default_severity</span> <span class="o">:</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Severity</span> <span class="k">do</span>
        <span class="n">GROUP_SEVERITY</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span><span class="o">?</span> <span class="o">||</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Severity</span><span class="o">::</span><span class="n">Convention</span>
      <span class="n">end</span>

      <span class="n">macro</span> <span class="n">inherited</span>
        <span class="n">include</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Serializable</span>
        <span class="n">include</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Serializable</span><span class="o">::</span><span class="n">Strict</span>

        <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">config</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
          <span class="k">if</span> <span class="p">(</span><span class="n">raw</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">raw</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Hash</span><span class="p">)</span>
            <span class="n">yaml</span> <span class="o">=</span> <span class="n">raw</span><span class="p">[</span><span class="n">rule_name</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">to_yaml</span>
          <span class="n">end</span>
          <span class="n">from_yaml</span> <span class="n">yaml</span> <span class="o">||</span> <span class="s">"{}"</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span>
  <span class="cp"># A module that utilizes inline comments parsing and processing logic.
</span>  <span class="n">module</span> <span class="n">InlineComments</span>
    <span class="n">COMMENT_DIRECTIVE_REGEX</span> <span class="o">=</span>
      <span class="o">/</span><span class="err">#</span> <span class="n">ameba</span><span class="o">:</span><span class="p">(</span><span class="o">?&lt;</span><span class="n">action</span><span class="o">&gt;</span><span class="err">\</span><span class="n">w</span><span class="o">+</span><span class="p">)</span> <span class="p">(</span><span class="o">?&lt;</span><span class="n">rules</span><span class="o">&gt;</span><span class="err">\</span><span class="n">w</span><span class="o">+</span><span class="p">(</span><span class="o">?:</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="n">w</span><span class="o">+</span><span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="o">?:</span><span class="p">,</span><span class="o">?</span> <span class="err">\</span><span class="n">w</span><span class="o">+</span><span class="p">(</span><span class="o">?:</span><span class="err">\</span><span class="o">/</span><span class="err">\</span><span class="n">w</span><span class="o">+</span><span class="p">)</span><span class="o">?</span><span class="p">)</span><span class="o">*</span><span class="p">)</span><span class="o">/</span>

    <span class="cp"># Available actions in the inline comments
</span>    <span class="k">enum</span> <span class="n">Action</span>
      <span class="n">Disable</span>
      <span class="n">Enable</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if current location is disabled for a particular rule,
</span>    <span class="cp"># `false` otherwise.
</span>    <span class="cp">#
</span>    <span class="cp"># Location is disabled in two cases:
</span>    <span class="cp">#   1. The line of the location ends with a comment directive.
</span>    <span class="cp">#   2. The line above the location is a comment directive.
</span>    <span class="cp">#
</span>    <span class="cp"># For example, here are two examples of disabled location:
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># # ameba:disable Style/LargeNumbers
</span>    <span class="cp"># Time.epoch(1483859302)
</span>    <span class="cp">#
</span>    <span class="cp"># Time.epoch(1483859302) # ameba:disable Style/LargeNumbers
</span>    <span class="cp"># ```
</span>    <span class="cp">#
</span>    <span class="cp"># But here are examples which are not considered as disabled location:
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># # ameba:disable Style/LargeNumbers
</span>    <span class="cp"># #
</span>    <span class="cp"># Time.epoch(1483859302)
</span>    <span class="cp">#
</span>    <span class="cp"># if use_epoch? # ameba:disable Style/LargeNumbers
</span>    <span class="cp">#   Time.epoch(1483859302)
</span>    <span class="cp"># end
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">location_disabled</span><span class="o">?</span><span class="p">(</span><span class="n">location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="o">?</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="k">if</span> <span class="n">rule</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">Rule</span><span class="o">::</span><span class="n">SPECIAL</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="n">line_number</span> <span class="o">=</span> <span class="n">location</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">line_number</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="o">-</span> <span class="mi">1</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">line_number</span><span class="p">]</span><span class="o">?</span>

      <span class="n">line_disabled</span><span class="o">?</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">line_number</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
          <span class="p">(</span><span class="n">prev_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
          <span class="n">comment</span><span class="o">?</span><span class="p">(</span><span class="n">prev_line</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="n">line_disabled</span><span class="o">?</span><span class="p">(</span><span class="n">prev_line</span><span class="p">,</span> <span class="n">rule</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="cp"># Parses inline comment directive. Returns a tuple that consists of
</span>    <span class="cp"># an action and parsed rules if directive found, nil otherwise.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># line = "# ameba:disable Rule1, Rule2"
</span>    <span class="cp"># directive = parse_inline_directive(line)
</span>    <span class="cp"># directive[:action] # =&gt; "disable"
</span>    <span class="cp"># directive[:rules]  # =&gt; ["Rule1", "Rule2"]
</span>    <span class="cp"># ```
</span>    <span class="cp">#
</span>    <span class="cp"># It ignores the directive if it is commented out.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># line = "# # ameba:disable Rule1, Rule2"
</span>    <span class="cp"># parse_inline_directive(line) # =&gt; nil
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="nf">parse_inline_directive</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">directive</span> <span class="o">=</span> <span class="n">COMMENT_DIRECTIVE_REGEX</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">commented_out</span><span class="o">?</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">gsub</span><span class="p">(</span><span class="n">directive</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">""</span><span class="p">))</span>
      <span class="p">{</span>
        <span class="nl">action:</span> <span class="n">directive</span><span class="p">[</span><span class="s">"action"</span><span class="p">],</span>
        <span class="nl">rules:</span>  <span class="n">directive</span><span class="p">[</span><span class="s">"rules"</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="o">/</span><span class="p">[</span><span class="err">\</span><span class="n">s</span><span class="p">,]</span><span class="o">/</span><span class="p">,</span> <span class="n">remove_empty</span><span class="o">:</span> <span class="nb">true</span><span class="p">),</span>
      <span class="p">}</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the line at the given `line_number` is a comment.
</span>    <span class="n">def</span> <span class="n">comment</span><span class="o">?</span><span class="p">(</span><span class="n">line_number</span> <span class="o">:</span> <span class="n">Int32</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">line_number</span><span class="p">]</span><span class="o">?</span>
      <span class="n">comment</span><span class="o">?</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">comment</span><span class="o">?</span><span class="p">(</span><span class="n">line</span> <span class="o">:</span> <span class="n">String</span><span class="p">)</span>
      <span class="n">line</span><span class="p">.</span><span class="n">lstrip</span><span class="p">.</span><span class="n">starts_with</span><span class="o">?</span> <span class="sc">'#'</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">line_disabled</span><span class="o">?</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="n">directive</span> <span class="o">=</span> <span class="n">parse_inline_directive</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="n">Action</span><span class="p">.</span><span class="n">parse</span><span class="o">?</span><span class="p">(</span><span class="n">directive</span><span class="p">[</span><span class="o">:</span><span class="n">action</span><span class="p">]).</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">disable</span><span class="o">?</span><span class="p">)</span>

      <span class="n">rules</span> <span class="o">=</span> <span class="n">directive</span><span class="p">[</span><span class="o">:</span><span class="n">rules</span><span class="p">]</span>
      <span class="n">rules</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">||</span> <span class="n">rules</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">group</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">commented_out</span><span class="o">?</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
      <span class="n">commented</span> <span class="o">=</span> <span class="nb">false</span>

      <span class="n">lexer</span> <span class="o">=</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Lexer</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">line</span><span class="p">).</span><span class="n">tap</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">comments_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span>
      <span class="n">Tokenizer</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">lexer</span><span class="p">).</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">token</span><span class="o">|</span>
        <span class="n">commented</span> <span class="o">=</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">token</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">comment</span><span class="o">?</span>
      <span class="n">end</span>
      <span class="n">commented</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span>
  <span class="cp"># Represents an issue reported by Ameba.
</span>  <span class="k">struct</span> <span class="nc">Issue</span>
    <span class="k">enum</span> <span class="n">Status</span>
      <span class="n">Enabled</span>
      <span class="n">Disabled</span>
    <span class="n">end</span>

    <span class="cp"># The source code that triggered this issue.
</span>    <span class="n">getter</span> <span class="n">code</span> <span class="o">:</span> <span class="n">String</span>

    <span class="cp"># A rule that triggers this issue.
</span>    <span class="n">getter</span> <span class="n">rule</span> <span class="o">:</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>

    <span class="cp"># Location of the issue.
</span>    <span class="n">getter</span> <span class="n">location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="o">?</span>

    <span class="cp"># End location of the issue.
</span>    <span class="n">getter</span> <span class="n">end_location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="o">?</span>

    <span class="cp"># Issue message.
</span>    <span class="n">getter</span> <span class="n">message</span> <span class="o">:</span> <span class="n">String</span>

    <span class="cp"># Issue status.
</span>    <span class="n">getter</span> <span class="n">status</span> <span class="o">:</span> <span class="n">Status</span>

    <span class="n">delegate</span> <span class="o">:</span><span class="n">enabled</span><span class="o">?</span><span class="p">,</span> <span class="o">:</span><span class="n">disabled</span><span class="o">?</span><span class="p">,</span>
      <span class="n">to</span><span class="o">:</span> <span class="n">status</span>

    <span class="n">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">code</span><span class="p">,</span> <span class="err">@</span><span class="n">rule</span><span class="p">,</span> <span class="err">@</span><span class="n">location</span><span class="p">,</span> <span class="err">@</span><span class="n">end_location</span><span class="p">,</span> <span class="err">@</span><span class="n">message</span><span class="p">,</span> <span class="n">status</span> <span class="o">:</span> <span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span> <span class="err">@</span><span class="n">block</span> <span class="o">:</span> <span class="p">(</span><span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
      <span class="err">@</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span> <span class="o">||</span> <span class="n">Status</span><span class="o">::</span><span class="n">Enabled</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">syntax</span><span class="o">?</span>
      <span class="n">rule</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span><span class="o">::</span><span class="n">Syntax</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">correctable</span><span class="o">?</span>
      <span class="o">!</span><span class="err">@</span><span class="n">block</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">correct</span><span class="p">(</span><span class="n">corrector</span><span class="p">)</span>
      <span class="err">@</span><span class="n">block</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">call</span><span class="p">(</span><span class="n">corrector</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span>
  <span class="cp"># Represents a module used to report issues.
</span>  <span class="n">module</span> <span class="n">Reportable</span>
    <span class="cp"># List of reported issues.
</span>    <span class="n">getter</span> <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Issue</span>

    <span class="cp"># Adds a new issue to the list of issues.
</span>    <span class="n">def</span> <span class="n">add_issue</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span>
                  <span class="n">location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="o">?</span><span class="p">,</span>
                  <span class="n">end_location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="o">?</span><span class="p">,</span>
                  <span class="n">message</span> <span class="o">:</span> <span class="n">String</span><span class="p">,</span>
                  <span class="n">status</span> <span class="o">:</span> <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span>
                  <span class="n">block</span> <span class="o">:</span> <span class="p">(</span><span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span> <span class="o">:</span> <span class="n">Issue</span>
      <span class="n">status</span> <span class="o">||=</span>
        <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">::</span><span class="n">Disabled</span> <span class="k">if</span> <span class="n">location_disabled</span><span class="o">?</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">rule</span><span class="p">)</span>

      <span class="n">Issue</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">block</span><span class="p">).</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">issue</span><span class="o">|</span>
        <span class="n">issues</span> <span class="o">&lt;&lt;</span> <span class="n">issue</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">add_issue</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span>
                  <span class="n">location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="o">?</span><span class="p">,</span>
                  <span class="n">end_location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="o">?</span><span class="p">,</span>
                  <span class="n">message</span> <span class="o">:</span> <span class="n">String</span><span class="p">,</span>
                  <span class="n">status</span> <span class="o">:</span> <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span>
                  <span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="n">Issue</span>
      <span class="n">add_issue</span> <span class="n">rule</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="cp"># Adds a new issue for Crystal AST *node*.
</span>    <span class="n">def</span> <span class="n">add_issue</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span> <span class="o">:</span> <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span> <span class="n">block</span> <span class="o">:</span> <span class="p">(</span><span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span> <span class="o">:</span> <span class="n">Issue</span>
      <span class="n">add_issue</span> <span class="n">rule</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">end_location</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">add_issue</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span> <span class="o">:</span> <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="n">Issue</span>
      <span class="n">add_issue</span> <span class="n">rule</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="cp"># Adds a new issue for Crystal *token*.
</span>    <span class="n">def</span> <span class="n">add_issue</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">token</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Token</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span> <span class="o">:</span> <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span> <span class="n">block</span> <span class="o">:</span> <span class="p">(</span><span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span> <span class="o">:</span> <span class="n">Issue</span>
      <span class="n">add_issue</span> <span class="n">rule</span><span class="p">,</span> <span class="n">token</span><span class="p">.</span><span class="n">location</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">add_issue</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">token</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Token</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span> <span class="o">:</span> <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="n">Issue</span>
      <span class="n">add_issue</span> <span class="n">rule</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="cp"># Adds a new issue for *location* defined by line and column numbers.
</span>    <span class="n">def</span> <span class="n">add_issue</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">location</span> <span class="o">:</span> <span class="p">{</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">},</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span> <span class="o">:</span> <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span> <span class="n">block</span> <span class="o">:</span> <span class="p">(</span><span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span> <span class="o">:</span> <span class="n">Issue</span>
      <span class="n">location</span> <span class="o">=</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">location</span><span class="p">)</span>

      <span class="n">add_issue</span> <span class="n">rule</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">add_issue</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">location</span> <span class="o">:</span> <span class="p">{</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">},</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span> <span class="o">:</span> <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="n">Issue</span>
      <span class="n">add_issue</span> <span class="n">rule</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="cp"># Adds a new issue for *location* and *end_location* defined by line and column numbers.
</span>    <span class="n">def</span> <span class="n">add_issue</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span>
                  <span class="n">location</span> <span class="o">:</span> <span class="p">{</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">},</span>
                  <span class="n">end_location</span> <span class="o">:</span> <span class="p">{</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">},</span>
                  <span class="n">message</span><span class="p">,</span>
                  <span class="n">status</span> <span class="o">:</span> <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span>
                  <span class="n">block</span> <span class="o">:</span> <span class="p">(</span><span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span> <span class="o">:</span> <span class="n">Issue</span>
      <span class="n">location</span> <span class="o">=</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">location</span><span class="p">)</span>
      <span class="n">end_location</span> <span class="o">=</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="n">end_location</span><span class="p">)</span>

      <span class="n">add_issue</span> <span class="n">rule</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">add_issue</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span>
                  <span class="n">location</span> <span class="o">:</span> <span class="p">{</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">},</span>
                  <span class="n">end_location</span> <span class="o">:</span> <span class="p">{</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">},</span>
                  <span class="n">message</span><span class="p">,</span>
                  <span class="n">status</span> <span class="o">:</span> <span class="n">Issue</span><span class="o">::</span><span class="n">Status</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span>
                  <span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">Source</span><span class="o">::</span><span class="n">Corrector</span> <span class="o">-&gt;</span><span class="p">)</span> <span class="o">:</span> <span class="n">Issue</span>
      <span class="n">add_issue</span> <span class="n">rule</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">block</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the list of not disabled issues is empty, `false` otherwise.
</span>    <span class="n">def</span> <span class="n">valid</span><span class="o">?</span>
      <span class="n">issues</span><span class="p">.</span><span class="n">none</span><span class="o">?</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">enabled</span><span class="o">?</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span>
  <span class="cp"># Represents a runner for inspecting sources files.
</span>  <span class="cp"># Holds a list of rules to do inspection based on,
</span>  <span class="cp"># list of sources to run inspection on and a formatter
</span>  <span class="cp"># to prepare a report.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># config = Ameba::Config.load
</span>  <span class="cp"># runner = Ameba::Runner.new config
</span>  <span class="cp"># runner.run.success? # =&gt; true or false
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">Runner</span>
    <span class="cp"># An error indicating that the inspection loop got stuck correcting
</span>    <span class="cp"># issues back and forth.
</span>    <span class="k">class</span> <span class="nc">InfiniteCorrectionLoopError</span> <span class="o">&lt;</span> <span class="n">RuntimeError</span>
      <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">issues_by_iteration</span><span class="p">,</span> <span class="n">loop_start</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">root_cause</span> <span class="o">=</span>
          <span class="n">issues_by_iteration</span><span class="p">[</span><span class="n">loop_start</span><span class="p">..</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">" -&gt; "</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">uniq</span><span class="o">!</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">", "</span><span class="p">))</span>

        <span class="n">message</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="n">build</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
          <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="s">"Infinite loop"</span>
          <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="s">" in "</span> <span class="o">&lt;&lt;</span> <span class="n">path</span> <span class="n">unless</span> <span class="n">path</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
          <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="s">" caused by "</span> <span class="o">&lt;&lt;</span> <span class="n">root_cause</span>
        <span class="n">end</span>

        <span class="n">super</span> <span class="n">message</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># A list of rules to do inspection based on.
</span>    <span class="err">@</span><span class="n">rules</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Rule</span><span class="o">::</span><span class="n">Base</span><span class="p">)</span>

    <span class="cp"># A list of sources to run inspection on.
</span>    <span class="n">getter</span> <span class="n">sources</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Source</span><span class="p">)</span>

    <span class="cp"># A level of severity to be reported.
</span>    <span class="err">@</span><span class="n">severity</span> <span class="o">:</span> <span class="n">Severity</span>

    <span class="cp"># A formatter to prepare report.
</span>    <span class="err">@</span><span class="n">formatter</span> <span class="o">:</span> <span class="n">Formatter</span><span class="o">::</span><span class="n">BaseFormatter</span>

    <span class="cp"># A syntax rule which always inspects a source first
</span>    <span class="err">@</span><span class="n">syntax_rule</span> <span class="o">=</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span><span class="o">::</span><span class="n">Syntax</span><span class="p">.</span><span class="k">new</span>

    <span class="cp"># Checks for unneeded disable directives. Always inspects a source last
</span>    <span class="err">@</span><span class="n">unneeded_disable_directive_rule</span> <span class="o">:</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span><span class="o">?</span>

    <span class="cp"># Returns `true` if correctable issues should be autocorrected.
</span>    <span class="k">private</span> <span class="n">getter</span><span class="o">?</span> <span class="n">autocorrect</span> <span class="o">:</span> <span class="n">Bool</span>

    <span class="cp"># Instantiates a runner using a `config`.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># config = Ameba::Config.load
</span>    <span class="cp"># config.files = files
</span>    <span class="cp"># config.formatter = formatter
</span>    <span class="cp">#
</span>    <span class="cp"># Ameba::Runner.new config
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">config</span> <span class="o">:</span> <span class="n">Config</span><span class="p">)</span>
      <span class="err">@</span><span class="n">sources</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">sources</span>
      <span class="err">@</span><span class="n">formatter</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">formatter</span>
      <span class="err">@</span><span class="n">severity</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">severity</span>
      <span class="err">@</span><span class="n">rules</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">rules</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">enabled</span><span class="o">?</span><span class="p">).</span><span class="n">reject</span><span class="o">!</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">special</span><span class="o">?</span><span class="p">)</span>
      <span class="err">@</span><span class="n">autocorrect</span> <span class="o">=</span> <span class="n">config</span><span class="p">.</span><span class="n">autocorrect</span><span class="o">?</span>

      <span class="err">@</span><span class="n">unneeded_disable_directive_rule</span> <span class="o">=</span>
        <span class="n">config</span><span class="p">.</span><span class="n">rules</span>
          <span class="p">.</span><span class="n">find</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="o">==</span><span class="p">(</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span><span class="o">::</span><span class="n">UnneededDisableDirective</span><span class="p">.</span><span class="n">rule_name</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">rules</span><span class="p">,</span> <span class="err">@</span><span class="n">sources</span><span class="p">,</span> <span class="err">@</span><span class="n">formatter</span><span class="p">,</span> <span class="err">@</span><span class="n">severity</span><span class="p">,</span> <span class="err">@</span><span class="n">autocorrect</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Performs the inspection. Iterates through all sources and test it using
</span>    <span class="cp"># list of rules. If a specific rule fails on a specific source, it adds
</span>    <span class="cp"># an issue to that source.
</span>    <span class="cp">#
</span>    <span class="cp"># This action also notifies formatter when inspection is started/finished,
</span>    <span class="cp"># and when a specific source started/finished to be inspected.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># runner = Ameba::Runner.new config
</span>    <span class="cp"># runner.run # =&gt; returns runner again
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">run</span>
      <span class="err">@</span><span class="n">formatter</span><span class="p">.</span><span class="n">started</span> <span class="err">@</span><span class="n">sources</span>

      <span class="n">channels</span> <span class="o">=</span> <span class="err">@</span><span class="n">sources</span><span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="n">Channel</span><span class="p">(</span><span class="n">Exception</span><span class="o">?</span><span class="p">).</span><span class="k">new</span> <span class="p">}</span>
      <span class="err">@</span><span class="n">sources</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">channels</span><span class="p">).</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="p">,</span> <span class="n">channel</span><span class="o">|</span>
        <span class="n">spawn</span> <span class="k">do</span>
          <span class="n">run_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">rescue</span> <span class="n">e</span>
          <span class="n">channel</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span>
          <span class="n">channel</span><span class="p">.</span><span class="n">send</span><span class="p">(</span><span class="n">nil</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">channels</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">chan</span><span class="o">|</span>
        <span class="n">chan</span><span class="p">.</span><span class="n">receive</span><span class="p">.</span><span class="k">try</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="n">raise</span> <span class="n">e</span> <span class="p">}</span>
      <span class="n">end</span>

      <span class="n">self</span>
    <span class="n">ensure</span>
      <span class="err">@</span><span class="n">formatter</span><span class="p">.</span><span class="n">finished</span> <span class="err">@</span><span class="n">sources</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">run_source</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="err">@</span><span class="n">formatter</span><span class="p">.</span><span class="n">source_started</span> <span class="n">source</span>

      <span class="cp"># This variable is a 2D array used to track corrected issues after each
</span>      <span class="cp"># inspection iteration. This is used to output meaningful infinite loop
</span>      <span class="cp"># error message.
</span>      <span class="n">corrected_issues</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Array</span><span class="p">(</span><span class="n">Issue</span><span class="p">)</span>

      <span class="cp"># When running with --fix, we need to inspect the source until no more
</span>      <span class="cp"># corrections are made (because automatic corrections can introduce new
</span>      <span class="cp"># issues). In the normal case the loop is only executed once.
</span>      <span class="n">loop_unless_infinite</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">corrected_issues</span><span class="p">)</span> <span class="k">do</span>
        <span class="cp"># We have to reprocess the source to pick up any changes. Since a
</span>        <span class="cp"># change could (theoretically) introduce syntax errors, we break the
</span>        <span class="cp"># loop if we find any.
</span>        <span class="err">@</span><span class="n">syntax_rule</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">break</span> <span class="n">unless</span> <span class="n">source</span><span class="p">.</span><span class="n">valid</span><span class="o">?</span>

        <span class="err">@</span><span class="n">rules</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">rule</span><span class="o">|</span>
          <span class="n">next</span> <span class="k">if</span> <span class="n">rule</span><span class="p">.</span><span class="n">excluded</span><span class="o">?</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
          <span class="n">rule</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="n">end</span>
        <span class="n">check_unneeded_directives</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="k">break</span> <span class="n">unless</span> <span class="n">autocorrect</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">source</span><span class="p">.</span><span class="n">correct</span><span class="o">?</span>

        <span class="cp"># The issues that couldn't be corrected will be found again so we
</span>        <span class="cp"># only keep the corrected ones in order to avoid duplicate reporting.
</span>        <span class="n">corrected_issues</span> <span class="o">&lt;&lt;</span> <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">correctable</span><span class="o">?</span><span class="p">)</span>
        <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">clear</span>
      <span class="n">end</span>

      <span class="n">corrected_issues</span><span class="p">.</span><span class="n">flatten</span><span class="p">.</span><span class="n">reverse_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">issue</span><span class="o">|</span>
        <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">unshift</span><span class="p">(</span><span class="n">issue</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">File</span><span class="p">.</span><span class="n">write</span><span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">code</span><span class="p">)</span> <span class="n">unless</span> <span class="n">corrected_issues</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
    <span class="n">ensure</span>
      <span class="err">@</span><span class="n">formatter</span><span class="p">.</span><span class="n">source_finished</span> <span class="n">source</span>
    <span class="n">end</span>

    <span class="cp"># Explains an issue at a specified *location*.
</span>    <span class="cp">#
</span>    <span class="cp"># Runner should perform inspection before doing the explain.
</span>    <span class="cp"># This is necessary to be able to find the issue at a specified location.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># runner = Ameba::Runner.new config
</span>    <span class="cp"># runner.run
</span>    <span class="cp"># runner.explain({file: file, line: l, column: c})
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">explain</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">output</span> <span class="o">=</span> <span class="n">STDOUT</span><span class="p">)</span>
      <span class="n">Formatter</span><span class="o">::</span><span class="n">ExplainFormatter</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">location</span><span class="p">).</span><span class="n">finished</span> <span class="err">@</span><span class="n">sources</span>
    <span class="n">end</span>

    <span class="cp"># Indicates whether the last inspection successful or not.
</span>    <span class="cp"># It returns `true` if no issues matching severity in sources found, `false` otherwise.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># runner = Ameba::Runner.new config
</span>    <span class="cp"># runner.run
</span>    <span class="cp"># runner.success? # =&gt; true or false
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">success</span><span class="o">?</span>
      <span class="err">@</span><span class="n">sources</span><span class="p">.</span><span class="n">all</span><span class="o">?</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="o">|</span>
        <span class="n">source</span><span class="p">.</span><span class="n">issues</span>
          <span class="p">.</span><span class="n">reject</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">disabled</span><span class="o">?</span><span class="p">)</span>
          <span class="p">.</span><span class="n">none</span><span class="o">?</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">severity</span><span class="p">.</span><span class="o">&lt;=</span><span class="p">(</span><span class="err">@</span><span class="n">severity</span><span class="p">))</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">MAX_ITERATIONS</span> <span class="o">=</span> <span class="mi">200</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">loop_unless_infinite</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">corrected_issues</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">)</span>
      <span class="cp"># Keep track of the state of the source. If a rule modifies the source
</span>      <span class="cp"># and another rule undoes it producing identical source we have an
</span>      <span class="cp"># infinite loop.
</span>      <span class="n">processed_sources</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">UInt64</span>

      <span class="cp"># It is possible for a rule to keep adding indefinitely to a file,
</span>      <span class="cp"># making it bigger and bigger. If the inspection loop runs for an
</span>      <span class="cp"># excessively high number of iterations, this is likely happening.
</span>      <span class="n">iterations</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="n">loop</span> <span class="k">do</span>
        <span class="n">check_for_infinite_loop</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">corrected_issues</span><span class="p">,</span> <span class="n">processed_sources</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">iterations</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">MAX_ITERATIONS</span>
          <span class="n">raise</span> <span class="n">InfiniteCorrectionLoopError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">corrected_issues</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="n">yield</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Check whether a run created source identical to a previous run, which
</span>    <span class="cp"># means that we definitely have an infinite loop.
</span>    <span class="k">private</span> <span class="n">def</span> <span class="n">check_for_infinite_loop</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">corrected_issues</span><span class="p">,</span> <span class="n">processed_sources</span><span class="p">)</span>
      <span class="n">checksum</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">code</span><span class="p">.</span><span class="n">hash</span>

      <span class="k">if</span> <span class="n">loop_start</span> <span class="o">=</span> <span class="n">processed_sources</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">checksum</span><span class="p">)</span>
        <span class="n">raise</span> <span class="n">InfiniteCorrectionLoopError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span>
          <span class="n">source</span><span class="p">.</span><span class="n">path</span><span class="p">,</span>
          <span class="n">corrected_issues</span><span class="p">,</span>
          <span class="n">loop_start</span><span class="o">:</span> <span class="n">loop_start</span>
        <span class="p">)</span>
      <span class="n">end</span>

      <span class="n">processed_sources</span> <span class="o">&lt;&lt;</span> <span class="n">checksum</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">check_unneeded_directives</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">rule</span> <span class="o">=</span> <span class="err">@</span><span class="n">unneeded_disable_directive_rule</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">rule</span><span class="p">.</span><span class="n">enabled</span><span class="o">?</span>

      <span class="n">rule</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">require</span> <span class="s">"colorize"</span>

<span class="n">module</span> <span class="n">Ameba</span>
  <span class="k">enum</span> <span class="n">Severity</span>
    <span class="n">Error</span>
    <span class="n">Warning</span>
    <span class="n">Convention</span>

    <span class="cp"># Returns a symbol uniquely indicating severity.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Severity::Warning.symbol # =&gt; 'W'
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">symbol</span> <span class="o">:</span> <span class="n">Char</span>
      <span class="k">case</span> <span class="n">self</span>
      <span class="n">in</span> <span class="n">Error</span>      <span class="n">then</span> <span class="sc">'E'</span>
      <span class="n">in</span> <span class="n">Warning</span>    <span class="n">then</span> <span class="sc">'W'</span>
      <span class="n">in</span> <span class="n">Convention</span> <span class="n">then</span> <span class="sc">'C'</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Returns a color uniquely indicating severity.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Severity::Warning.color # =&gt; Colorize::ColorANSI::Red
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">color</span> <span class="p">:</span> <span class="n">Colorize</span><span class="o">::</span><span class="n">Color</span>
      <span class="k">case</span> <span class="n">self</span>
      <span class="n">in</span> <span class="n">Error</span>      <span class="n">then</span> <span class="n">Colorize</span><span class="o">::</span><span class="n">ColorANSI</span><span class="o">::</span><span class="n">Red</span>
      <span class="n">in</span> <span class="n">Warning</span>    <span class="n">then</span> <span class="n">Colorize</span><span class="o">::</span><span class="n">ColorANSI</span><span class="o">::</span><span class="n">Red</span>
      <span class="n">in</span> <span class="n">Convention</span> <span class="n">then</span> <span class="n">Colorize</span><span class="o">::</span><span class="n">ColorANSI</span><span class="o">::</span><span class="n">Blue</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Creates Severity by the name.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Severity.parse("convention") # =&gt; Severity::Convention
</span>    <span class="cp"># Severity.parse("foo-bar")    # =&gt; Exception: Incorrect severity name
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">name</span> <span class="p">:</span> <span class="n">String</span><span class="p">)</span>
      <span class="n">super</span> <span class="n">name</span>
    <span class="n">rescue</span> <span class="n">ArgumentError</span>
      <span class="n">raise</span> <span class="s">"Incorrect severity name #{name}. Try one of #{values}"</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># Converter for `YAML.mapping` which converts severity enum to and from YAML.
</span>  <span class="k">class</span> <span class="nc">SeverityYamlConverter</span>
    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">from_yaml</span><span class="p">(</span><span class="n">ctx</span> <span class="o">:</span> <span class="n">YAML</span><span class="o">::</span><span class="n">ParseContext</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Nodes</span><span class="o">::</span><span class="n">Node</span><span class="p">)</span>
      <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">YAML</span><span class="o">::</span><span class="n">Nodes</span><span class="o">::</span><span class="n">Scalar</span><span class="p">)</span>
        <span class="n">raise</span> <span class="s">"Severity must be a scalar, not #{node.class}"</span>
      <span class="n">end</span>

      <span class="k">case</span> <span class="n">value</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">value</span>
      <span class="n">when</span> <span class="n">String</span> <span class="n">then</span> <span class="n">Severity</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">Nil</span>    <span class="n">then</span> <span class="n">nil</span>
      <span class="k">else</span>
        <span class="n">raise</span> <span class="s">"Incorrect severity: #{value}"</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">to_yaml</span><span class="p">(</span><span class="n">value</span> <span class="p">:</span> <span class="n">Severity</span><span class="p">,</span> <span class="n">yaml</span> <span class="o">:</span> <span class="n">YAML</span><span class="o">::</span><span class="n">Nodes</span><span class="o">::</span><span class="n">Builder</span><span class="p">)</span>
      <span class="n">yaml</span><span class="p">.</span><span class="n">scalar</span> <span class="n">value</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span>
  <span class="cp"># An entity that represents a Crystal source file.
</span>  <span class="cp"># Has path, lines of code and issues reported by rules.
</span>  <span class="k">class</span> <span class="nc">Source</span>
    <span class="n">include</span> <span class="n">InlineComments</span>
    <span class="n">include</span> <span class="n">Reportable</span>

    <span class="cp"># Path to the source file.
</span>    <span class="n">getter</span> <span class="n">path</span> <span class="o">:</span> <span class="n">String</span>

    <span class="cp"># Crystal code (content of a source file).
</span>    <span class="n">getter</span> <span class="n">code</span> <span class="o">:</span> <span class="n">String</span>

    <span class="cp"># Creates a new source by `code` and `path`.
</span>    <span class="cp">#
</span>    <span class="cp"># For example:
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># path = "./src/source.cr"
</span>    <span class="cp"># Ameba::Source.new File.read(path), path
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">code</span><span class="p">,</span> <span class="err">@</span><span class="n">path</span> <span class="o">=</span> <span class="s">""</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Corrects any correctable issues and updates `code`.
</span>    <span class="cp"># Returns `false` if no issues were corrected.
</span>    <span class="n">def</span> <span class="n">correct</span><span class="o">?</span>
      <span class="n">corrector</span> <span class="o">=</span> <span class="n">Corrector</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
      <span class="n">issues</span><span class="p">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">correct</span><span class="p">(</span><span class="n">corrector</span><span class="p">))</span>

      <span class="n">corrected_code</span> <span class="o">=</span> <span class="n">corrector</span><span class="p">.</span><span class="n">process</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">corrected_code</span>

      <span class="err">@</span><span class="n">code</span> <span class="o">=</span> <span class="n">corrected_code</span>
      <span class="err">@</span><span class="n">lines</span> <span class="o">=</span> <span class="n">nil</span>
      <span class="err">@</span><span class="n">ast</span> <span class="o">=</span> <span class="n">nil</span>

      <span class="nb">true</span>
    <span class="n">end</span>

    <span class="cp"># Returns lines of code split by new line character.
</span>    <span class="cp"># Since `code` is immutable and can't be changed, this
</span>    <span class="cp"># method caches lines in an instance variable, so calling
</span>    <span class="cp"># it second time will not perform a split, but will return
</span>    <span class="cp"># lines instantly.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># source = Ameba::Source.new "a = 1\nb = 2", path
</span>    <span class="cp"># source.lines # =&gt; ["a = 1", "b = 2"]
</span>    <span class="cp"># ```
</span>    <span class="n">getter</span> <span class="n">lines</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="p">{</span> <span class="n">code</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">)</span> <span class="p">}</span>

    <span class="cp"># Returns AST nodes constructed by `Crystal::Parser`.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># source = Ameba::Source.new code, path
</span>    <span class="cp"># source.ast
</span>    <span class="cp"># ```
</span>    <span class="n">getter</span> <span class="n">ast</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span> <span class="k">do</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">Parser</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
        <span class="p">.</span><span class="n">tap</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">wants_doc</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span>
        <span class="p">.</span><span class="n">tap</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">path</span><span class="p">)</span>
        <span class="p">.</span><span class="n">parse</span>
    <span class="n">end</span>

    <span class="n">getter</span> <span class="n">fullpath</span> <span class="o">:</span> <span class="n">String</span> <span class="k">do</span>
      <span class="n">File</span><span class="p">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the source is a spec file, `false` otherwise.
</span>    <span class="n">def</span> <span class="n">spec</span><span class="o">?</span>
      <span class="n">path</span><span class="p">.</span><span class="n">ends_with</span><span class="o">?</span><span class="p">(</span><span class="s">"_spec.cr"</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if *filepath* matches the source's path, `false` otherwise.
</span>    <span class="n">def</span> <span class="n">matches_path</span><span class="o">?</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
      <span class="n">path</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">File</span><span class="p">.</span><span class="n">expand_path</span><span class="p">(</span><span class="n">filepath</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="cp"># Converts an AST location to a string position.
</span>    <span class="n">def</span> <span class="nf">pos</span><span class="p">(</span><span class="n">location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="p">,</span> <span class="n">end</span> <span class="n">end_pos</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span> <span class="o">:</span> <span class="n">Int32</span>
      <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="n">location</span><span class="p">.</span><span class="n">line_number</span><span class="p">,</span> <span class="n">location</span><span class="p">.</span><span class="n">column_number</span>
      <span class="n">pos</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mf">0.</span><span class="p">..</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">sum</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="n">line</span> <span class="o">+</span> <span class="n">column</span> <span class="o">-</span> <span class="mi">2</span>
      <span class="n">pos</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">end_pos</span>
      <span class="n">pos</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">require</span> <span class="s">"compiler/crystal/syntax/*"</span>

<span class="n">module</span> <span class="n">Ameba</span>
  <span class="cp"># Represents Crystal syntax tokenizer based on `Crystal::Lexer`.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># source = Ameba::Source.new code, path
</span>  <span class="cp"># tokenizer = Ameba::Tokenizer.new(source)
</span>  <span class="cp"># tokenizer.run do |token|
</span>  <span class="cp">#   puts token
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">Tokenizer</span>
    <span class="cp"># Instantiates Tokenizer using a `source`.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># source = Ameba::Source.new code, path
</span>    <span class="cp"># Ameba::Tokenizer.new(source)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="err">@</span><span class="n">lexer</span> <span class="o">=</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Lexer</span><span class="p">.</span><span class="k">new</span> <span class="n">source</span><span class="p">.</span><span class="n">code</span>
      <span class="err">@</span><span class="n">lexer</span><span class="p">.</span><span class="n">count_whitespace</span> <span class="o">=</span> <span class="nb">true</span>
      <span class="err">@</span><span class="n">lexer</span><span class="p">.</span><span class="n">comments_enabled</span> <span class="o">=</span> <span class="nb">true</span>
      <span class="err">@</span><span class="n">lexer</span><span class="p">.</span><span class="n">wants_raw</span> <span class="o">=</span> <span class="nb">true</span>
      <span class="err">@</span><span class="n">lexer</span><span class="p">.</span><span class="n">filename</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">path</span>
    <span class="n">end</span>

    <span class="cp"># Instantiates Tokenizer using a `lexer`.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># lexer = Crystal::Lexer.new(code)
</span>    <span class="cp"># Ameba::Tokenizer.new(lexer)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">lexer</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Lexer</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Runs the tokenizer and yields each token as a block argument.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Ameba::Tokenizer.new(source).run do |token|
</span>    <span class="cp">#   puts token
</span>    <span class="cp"># end
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">run</span><span class="p">(</span><span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Token</span> <span class="o">-&gt;</span> <span class="n">_</span><span class="p">)</span>
      <span class="n">run_normal_state</span> <span class="err">@</span><span class="n">lexer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
      <span class="nb">true</span>
    <span class="n">rescue</span> <span class="n">e</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">SyntaxException</span>
      <span class="cp"># puts e
</span>      <span class="nb">false</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">run_normal_state</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span> <span class="n">break_on_rcurly</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Token</span> <span class="o">-&gt;</span> <span class="n">_</span><span class="p">)</span>
      <span class="n">loop</span> <span class="k">do</span>
        <span class="n">token</span> <span class="o">=</span> <span class="err">@</span><span class="n">lexer</span><span class="p">.</span><span class="n">next_token</span>
        <span class="n">block</span><span class="p">.</span><span class="n">call</span> <span class="n">token</span>

        <span class="k">case</span> <span class="n">token</span><span class="p">.</span><span class="n">type</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">delimiter_start</span><span class="o">?</span>
          <span class="n">run_delimiter_state</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">string_array_start</span><span class="o">?</span><span class="p">,</span> <span class="p">.</span><span class="n">symbol_array_start</span><span class="o">?</span>
          <span class="n">run_array_state</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">eof</span><span class="o">?</span>
          <span class="k">break</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">op_rcurly</span><span class="o">?</span>
          <span class="k">break</span> <span class="k">if</span> <span class="n">break_on_rcurly</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">run_delimiter_state</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Token</span> <span class="o">-&gt;</span> <span class="n">_</span><span class="p">)</span>
      <span class="n">loop</span> <span class="k">do</span>
        <span class="n">token</span> <span class="o">=</span> <span class="err">@</span><span class="n">lexer</span><span class="p">.</span><span class="n">next_string_token</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">delimiter_state</span><span class="p">)</span>
        <span class="n">block</span><span class="p">.</span><span class="n">call</span> <span class="n">token</span>

        <span class="k">case</span> <span class="n">token</span><span class="p">.</span><span class="n">type</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">delimiter_end</span><span class="o">?</span>
          <span class="k">break</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">interpolation_start</span><span class="o">?</span>
          <span class="n">run_normal_state</span> <span class="n">lexer</span><span class="p">,</span> <span class="n">break_on_rcurly</span><span class="p">:</span> <span class="nb">true</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">eof</span><span class="o">?</span>
          <span class="k">break</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">run_array_state</span><span class="p">(</span><span class="n">lexer</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Token</span> <span class="o">-&gt;</span> <span class="n">_</span><span class="p">)</span>
      <span class="n">loop</span> <span class="k">do</span>
        <span class="n">lexer</span><span class="p">.</span><span class="n">next_string_array_token</span>
        <span class="n">block</span><span class="p">.</span><span class="n">call</span> <span class="n">token</span>

        <span class="k">case</span> <span class="n">token</span><span class="p">.</span><span class="n">type</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">string_array_end</span><span class="o">?</span>
          <span class="k">break</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">eof</span><span class="o">?</span>
          <span class="k">break</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./ameba/ast/**"
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># Represents the branch in Crystal code.
</span>  <span class="cp"># Branch is a part of a branchable statement.
</span>  <span class="cp"># For example, the branchable if statement contains 3 branches:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># if a = something # --&gt; Branch A
</span>  <span class="cp">#   a = 1          # --&gt; Branch B
</span>  <span class="cp">#   put a if out   # --&gt; Branch C
</span>  <span class="cp"># else
</span>  <span class="cp">#   do_something a # --&gt; Branch D
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">Branch</span>
    <span class="cp"># The actual branch node.
</span>    <span class="n">getter</span> <span class="n">node</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>

    <span class="cp"># The parent branchable.
</span>    <span class="n">getter</span> <span class="n">parent</span> <span class="o">:</span> <span class="n">Branchable</span>

    <span class="n">delegate</span> <span class="n">to_s</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>

    <span class="n">def_equals_and_hash</span> <span class="n">node</span><span class="p">,</span> <span class="n">location</span>

    <span class="cp"># Creates a new branch.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Branch.new(if_node)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">parent</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if current branch is in a loop, `false` - otherwise.
</span>    <span class="cp"># For example, this branch is in a loop:
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># while true
</span>    <span class="cp">#   handle_input # this branch is in a loop
</span>    <span class="cp">#   if wrong_input
</span>    <span class="cp">#     show_message # this branch is also in a loop.
</span>    <span class="cp">#   end
</span>    <span class="cp"># end
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">in_loop</span><span class="o">?</span>
      <span class="err">@</span><span class="n">parent</span><span class="p">.</span><span class="n">loop</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="cp"># Constructs a new branch based on the node in scope.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Branch.of(assign_node, scope)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">scope</span> <span class="o">:</span> <span class="n">Scope</span><span class="p">)</span>
      <span class="n">of</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">scope</span><span class="p">.</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Constructs a new branch based on the node some parent scope.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Branch.of(assign_node, def_node)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">parent_node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="n">BranchVisitor</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">node</span><span class="p">).</span><span class="n">tap</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">accept</span> <span class="n">parent_node</span><span class="p">).</span><span class="n">branch</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="k">private</span> <span class="k">class</span> <span class="nc">BranchVisitor</span> <span class="o">&lt;</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Visitor</span>
      <span class="err">@</span><span class="n">current_branch</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="o">?</span>

      <span class="n">property</span> <span class="n">branchable</span> <span class="o">:</span> <span class="n">Branchable</span><span class="o">?</span>
      <span class="n">property</span> <span class="n">branch</span> <span class="o">:</span> <span class="n">Branch</span><span class="o">?</span>

      <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="k">private</span> <span class="n">def</span> <span class="n">on_branchable_start</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="o">*</span><span class="n">branches</span><span class="p">)</span>
        <span class="n">on_branchable_start</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">branches</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="k">private</span> <span class="n">def</span> <span class="n">on_branchable_start</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">branches</span> <span class="o">:</span> <span class="n">Array</span> <span class="o">|</span> <span class="n">Tuple</span><span class="p">)</span>
        <span class="err">@</span><span class="n">branchable</span> <span class="o">=</span> <span class="n">Branchable</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">branchable</span><span class="p">)</span>

        <span class="n">branches</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">branch_node</span><span class="o">|</span>
          <span class="k">break</span> <span class="k">if</span> <span class="n">branch</span> <span class="err">#</span> <span class="n">branch</span> <span class="n">found</span>
          <span class="err">@</span><span class="n">current_branch</span> <span class="o">=</span> <span class="n">branch_node</span> <span class="k">if</span> <span class="n">branch_node</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">branch_node</span><span class="p">.</span><span class="n">nop</span><span class="o">?</span>
          <span class="n">branch_node</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="nb">false</span>
      <span class="n">end</span>

      <span class="k">private</span> <span class="n">def</span> <span class="n">on_branchable_end</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="err">@</span><span class="n">branchable</span> <span class="o">=</span> <span class="err">@</span><span class="n">branchable</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">parent</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">false</span> <span class="k">if</span> <span class="n">branch</span>

        <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="k">class</span> <span class="o">==</span> <span class="err">@</span><span class="n">node</span><span class="p">.</span><span class="k">class</span> <span class="o">&amp;&amp;</span>
           <span class="n">node</span><span class="p">.</span><span class="n">location</span> <span class="o">==</span> <span class="err">@</span><span class="n">node</span><span class="p">.</span><span class="n">location</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="n">branchable</span> <span class="o">=</span> <span class="err">@</span><span class="n">branchable</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
           <span class="p">(</span><span class="n">branch</span> <span class="o">=</span> <span class="err">@</span><span class="n">current_branch</span><span class="p">)</span>
          <span class="err">@</span><span class="n">branch</span> <span class="o">=</span> <span class="n">Branch</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">branch</span><span class="p">,</span> <span class="n">branchable</span><span class="p">)</span>
        <span class="n">end</span>

        <span class="nb">true</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span><span class="p">)</span>
        <span class="n">on_branchable_start</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">then</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span><span class="p">)</span>
        <span class="n">on_branchable_end</span> <span class="n">node</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span><span class="p">)</span>
        <span class="n">on_branchable_start</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">then</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span><span class="p">)</span>
        <span class="n">on_branchable_end</span> <span class="n">node</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">BinaryOp</span><span class="p">)</span>
        <span class="n">on_branchable_start</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">right</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">BinaryOp</span><span class="p">)</span>
        <span class="n">on_branchable_end</span> <span class="n">node</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Case</span><span class="p">)</span>
        <span class="n">on_branchable_start</span> <span class="n">node</span><span class="p">,</span> <span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">whens</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">].</span><span class="n">flatten</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Case</span><span class="p">)</span>
        <span class="n">on_branchable_end</span> <span class="n">node</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span><span class="p">)</span>
        <span class="n">on_branchable_start</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span><span class="p">)</span>
        <span class="n">on_branchable_end</span> <span class="n">node</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Until</span><span class="p">)</span>
        <span class="n">on_branchable_start</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Until</span><span class="p">)</span>
        <span class="n">on_branchable_end</span> <span class="n">node</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ExceptionHandler</span><span class="p">)</span>
        <span class="n">on_branchable_start</span> <span class="n">node</span><span class="p">,</span> <span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">body</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">rescues</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">ensure</span><span class="p">].</span><span class="n">flatten</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ExceptionHandler</span><span class="p">)</span>
        <span class="n">on_branchable_end</span> <span class="n">node</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Rescue</span><span class="p">)</span>
        <span class="n">on_branchable_start</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Rescue</span><span class="p">)</span>
        <span class="n">on_branchable_end</span> <span class="n">node</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroIf</span><span class="p">)</span>
        <span class="n">on_branchable_start</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">then</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroIf</span><span class="p">)</span>
        <span class="n">on_branchable_end</span> <span class="n">node</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroFor</span><span class="p">)</span>
        <span class="n">on_branchable_start</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">exp</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroFor</span><span class="p">)</span>
        <span class="n">on_branchable_end</span> <span class="n">node</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./util"
# Utility module for Ameba's rules.
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span><span class="o">::</span><span class="n">Util</span>
  <span class="cp"># Returns tuple with two bool flags:
</span>  <span class="cp">#
</span>  <span class="cp"># 1. is *node* a literal?
</span>  <span class="cp"># 2. can *node* be proven static?
</span>  <span class="k">protected</span> <span class="n">def</span> <span class="n">literal_kind</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">:</span> <span class="p">{</span><span class="n">Bool</span><span class="p">,</span> <span class="n">Bool</span><span class="p">}</span>
    <span class="k">case</span> <span class="n">node</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">NilLiteral</span><span class="p">,</span>
         <span class="n">Crystal</span><span class="o">::</span><span class="n">BoolLiteral</span><span class="p">,</span>
         <span class="n">Crystal</span><span class="o">::</span><span class="n">NumberLiteral</span><span class="p">,</span>
         <span class="n">Crystal</span><span class="o">::</span><span class="n">CharLiteral</span><span class="p">,</span>
         <span class="n">Crystal</span><span class="o">::</span><span class="n">StringLiteral</span><span class="p">,</span>
         <span class="n">Crystal</span><span class="o">::</span><span class="n">SymbolLiteral</span><span class="p">,</span>
         <span class="n">Crystal</span><span class="o">::</span><span class="n">RegexLiteral</span><span class="p">,</span>
         <span class="n">Crystal</span><span class="o">::</span><span class="n">ProcLiteral</span><span class="p">,</span>
         <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroLiteral</span>
      <span class="err">{</span><span class="nb">true</span><span class="p">,</span> <span class="nb">true</span><span class="err">}</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">RangeLiteral</span>
      <span class="err">{</span><span class="nb">true</span><span class="p">,</span> <span class="n">static_literal</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">from</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">static_literal</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">to</span><span class="p">)</span><span class="err">}</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ArrayLiteral</span><span class="p">,</span>
         <span class="n">Crystal</span><span class="o">::</span><span class="n">TupleLiteral</span>
      <span class="err">{</span><span class="nb">true</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">elements</span><span class="p">.</span><span class="n">all</span><span class="o">?</span> <span class="k">do</span> <span class="o">|</span><span class="n">el</span><span class="o">|</span>
        <span class="n">static_literal</span><span class="o">?</span><span class="p">(</span><span class="n">el</span><span class="p">)</span>
      <span class="n">end</span><span class="err">}</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">HashLiteral</span>
      <span class="err">{</span><span class="nb">true</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">entries</span><span class="p">.</span><span class="n">all</span><span class="o">?</span> <span class="k">do</span> <span class="o">|</span><span class="n">entry</span><span class="o">|</span>
        <span class="n">static_literal</span><span class="o">?</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">key</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
          <span class="n">static_literal</span><span class="o">?</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
      <span class="n">end</span><span class="err">}</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">NamedTupleLiteral</span>
      <span class="err">{</span><span class="nb">true</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">entries</span><span class="p">.</span><span class="n">all</span><span class="o">?</span> <span class="k">do</span> <span class="o">|</span><span class="n">entry</span><span class="o">|</span>
        <span class="n">static_literal</span><span class="o">?</span><span class="p">(</span><span class="n">entry</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>
      <span class="n">end</span><span class="err">}</span>
    <span class="k">else</span>
      <span class="err">{</span><span class="nb">false</span><span class="p">,</span> <span class="nb">false</span><span class="err">}</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># Returns `true` if current `node` is a static literal, `false` otherwise.
</span>  <span class="n">def</span> <span class="n">static_literal</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">:</span> <span class="n">Bool</span>
    <span class="n">is_literal</span><span class="p">,</span> <span class="n">is_static</span> <span class="o">=</span> <span class="n">literal_kind</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">is_literal</span> <span class="o">&amp;&amp;</span> <span class="n">is_static</span>
  <span class="n">end</span>

  <span class="cp"># Returns `true` if current `node` is a dynamic literal, `false` otherwise.
</span>  <span class="n">def</span> <span class="n">dynamic_literal</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">:</span> <span class="n">Bool</span>
    <span class="n">is_literal</span><span class="p">,</span> <span class="n">is_static</span> <span class="o">=</span> <span class="n">literal_kind</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">is_literal</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_static</span>
  <span class="n">end</span>

  <span class="cp"># Returns `true` if current `node` is a literal, `false` otherwise.
</span>  <span class="n">def</span> <span class="n">literal</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">:</span> <span class="n">Bool</span>
    <span class="n">is_literal</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">literal_kind</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">is_literal</span>
  <span class="n">end</span>

  <span class="cp"># Returns `true` if current `node` is a `Crystal::Path`
</span>  <span class="cp"># matching given *name*, `false` otherwise.
</span>  <span class="n">def</span> <span class="n">path_named</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span> <span class="o">:</span> <span class="n">Bool</span>
    <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Path</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">name</span> <span class="o">==</span> <span class="n">node</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">"::"</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="cp"># Returns a source code for the current node.
</span>  <span class="cp"># This method uses `node.location` and `node.end_location`
</span>  <span class="cp"># to determine and cut a piece of source of the node.
</span>  <span class="n">def</span> <span class="n">node_source</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">code_lines</span><span class="p">)</span>
    <span class="n">loc</span><span class="p">,</span> <span class="n">end_loc</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">end_location</span>
    <span class="k">return</span> <span class="n">unless</span> <span class="n">loc</span> <span class="o">&amp;&amp;</span> <span class="n">end_loc</span>

    <span class="n">source_between</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">end_loc</span><span class="p">,</span> <span class="n">code_lines</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="cp"># Returns the source code from *loc* to *end_loc* (inclusive).
</span>  <span class="n">def</span> <span class="n">source_between</span><span class="p">(</span><span class="n">loc</span><span class="p">,</span> <span class="n">end_loc</span><span class="p">,</span> <span class="n">code_lines</span><span class="p">)</span> <span class="o">:</span> <span class="n">String</span><span class="o">?</span>
    <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="n">loc</span><span class="p">.</span><span class="n">line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="p">.</span><span class="n">column_number</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">end_line</span><span class="p">,</span> <span class="n">end_column</span> <span class="o">=</span> <span class="n">end_loc</span><span class="p">.</span><span class="n">line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">end_loc</span><span class="p">.</span><span class="n">column_number</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="n">node_lines</span> <span class="o">=</span> <span class="n">code_lines</span><span class="p">[</span><span class="n">line</span><span class="p">..</span><span class="n">end_line</span><span class="p">]</span>
    <span class="n">first_line</span><span class="p">,</span> <span class="n">last_line</span> <span class="o">=</span> <span class="n">node_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">?</span><span class="p">,</span> <span class="n">node_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">?</span>

    <span class="k">return</span> <span class="k">if</span> <span class="n">first_line</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">last_line</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">first_line</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">column</span> <span class="err">#</span> <span class="n">compiler</span> <span class="n">reports</span> <span class="n">incorrect</span> <span class="n">location</span>

    <span class="n">node_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">first_line</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="mf">0.</span><span class="p">..</span><span class="n">column</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">line</span> <span class="o">==</span> <span class="n">end_line</span> <span class="err">#</span> <span class="n">one</span> <span class="n">line</span>
      <span class="n">end_column</span> <span class="o">=</span> <span class="n">end_column</span> <span class="o">-</span> <span class="n">column</span>
      <span class="n">last_line</span> <span class="o">=</span> <span class="n">node_lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">end</span>

    <span class="k">return</span> <span class="k">if</span> <span class="n">last_line</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">end_column</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="n">node_lines</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_line</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="n">end_column</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">..</span><span class="n">last_line</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
    <span class="n">node_lines</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="cp"># Returns `true` if node is a flow command, `false` otherwise.
</span>  <span class="cp"># Node represents a flow command if it is a control expression,
</span>  <span class="cp"># or special call node that interrupts execution (i.e. raise, exit, abort).
</span>  <span class="n">def</span> <span class="n">flow_command</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">in_loop</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">node</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Return</span>
      <span class="nb">true</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Break</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Next</span>
      <span class="n">in_loop</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span>
      <span class="n">raise</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">||</span> <span class="n">exit</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">||</span> <span class="n">abort</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="nb">false</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># Returns `true` if node is a flow expression, `false` if not.
</span>  <span class="cp"># Node represents a flow expression if it is full-filled by a flow command.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this node is a flow expression, because each branch contains
</span>  <span class="cp"># a flow command `return`:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># if a &gt; 0
</span>  <span class="cp">#   return :positive
</span>  <span class="cp"># elsif a &lt; 0
</span>  <span class="cp">#   return :negative
</span>  <span class="cp"># else
</span>  <span class="cp">#   return :zero
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># This node is a not a flow expression:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># if a &gt; 0
</span>  <span class="cp">#   return :positive
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># That's because not all branches return(i.e. `else` is missing).
</span>  <span class="n">def</span> <span class="n">flow_expression</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">in_loop</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">flow_command</span><span class="o">?</span> <span class="n">node</span><span class="p">,</span> <span class="n">in_loop</span>

    <span class="k">case</span> <span class="n">node</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span>
      <span class="n">flow_expressions</span><span class="o">?</span> <span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">then</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">],</span> <span class="n">in_loop</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">BinaryOp</span>
      <span class="n">flow_expression</span><span class="o">?</span> <span class="n">node</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">in_loop</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Case</span>
      <span class="n">flow_expressions</span><span class="o">?</span> <span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="n">whens</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">].</span><span class="n">flatten</span><span class="p">,</span> <span class="n">in_loop</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ExceptionHandler</span>
      <span class="n">flow_expressions</span><span class="o">?</span> <span class="p">[</span><span class="n">node</span><span class="p">.</span><span class="k">else</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">rescues</span><span class="p">].</span><span class="n">flatten</span><span class="p">,</span> <span class="n">in_loop</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Until</span>
      <span class="n">flow_expression</span><span class="o">?</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span><span class="p">,</span> <span class="n">in_loop</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Rescue</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">When</span>
      <span class="n">flow_expression</span><span class="o">?</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span><span class="p">,</span> <span class="n">in_loop</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span>
      <span class="n">node</span><span class="p">.</span><span class="n">expressions</span><span class="p">.</span><span class="n">any</span><span class="o">?</span> <span class="err">{</span> <span class="o">|</span><span class="n">exp</span><span class="o">|</span> <span class="n">flow_expression</span><span class="o">?</span> <span class="n">exp</span><span class="p">,</span> <span class="n">in_loop</span> <span class="err">}</span>
    <span class="k">else</span>
      <span class="nb">false</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">def</span> <span class="n">flow_expressions</span><span class="o">?</span><span class="p">(</span><span class="n">nodes</span><span class="p">,</span> <span class="n">in_loop</span><span class="p">)</span>
    <span class="n">nodes</span><span class="p">.</span><span class="n">all</span><span class="o">?</span> <span class="err">{</span> <span class="o">|</span><span class="n">exp</span><span class="o">|</span> <span class="n">flow_expression</span><span class="o">?</span> <span class="n">exp</span><span class="p">,</span> <span class="n">in_loop</span> <span class="err">}</span>
  <span class="n">end</span>

  <span class="cp"># Returns `true` if node represents `raise` method call.
</span>  <span class="n">def</span> <span class="n">raise</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">"raise"</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
  <span class="n">end</span>

  <span class="cp"># Returns `true` if node represents `exit` method call.
</span>  <span class="n">def</span> <span class="n">exit</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">"exit"</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
  <span class="n">end</span>

  <span class="cp"># Returns `true` if node represents `abort` method call.
</span>  <span class="n">def</span> <span class="n">abort</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
      <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">"abort"</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
  <span class="n">end</span>

  <span class="cp"># Returns `true` if node represents a loop.
</span>  <span class="n">def</span> <span class="n">loop</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">case</span> <span class="n">node</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Until</span>
      <span class="nb">true</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span>
      <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">"loop"</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
    <span class="k">else</span>
      <span class="nb">false</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># Returns the exp code of a control expression.
</span>  <span class="cp"># Wraps implicit tuple literal with curly brackets (e.g. multi-return).
</span>  <span class="n">def</span> <span class="n">control_exp_code</span><span class="p">(</span><span class="n">node</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ControlExpression</span><span class="p">,</span> <span class="n">code_lines</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unless</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">exp</span>
    <span class="k">return</span> <span class="n">unless</span> <span class="n">exp_code</span> <span class="o">=</span> <span class="n">node_source</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">code_lines</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">exp_code</span> <span class="n">unless</span> <span class="n">exp</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">TupleLiteral</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">exp_code</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">'{'</span>
    <span class="k">return</span> <span class="n">unless</span> <span class="n">exp_start</span> <span class="o">=</span> <span class="n">exp</span><span class="p">.</span><span class="n">elements</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">location</span>
    <span class="k">return</span> <span class="n">unless</span> <span class="n">exp_end</span> <span class="o">=</span> <span class="n">exp</span><span class="p">.</span><span class="n">end_location</span>

    <span class="s">"{#{source_between(exp_start, exp_end, code_lines)}}"</span>
  <span class="n">end</span>

  <span class="cp"># Returns `nil` if *node* does not contain a name.
</span>  <span class="n">def</span> <span class="n">name_location</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name_location</span>
      <span class="k">return</span> <span class="n">loc</span>
    <span class="n">end</span>

    <span class="k">return</span> <span class="n">node</span><span class="p">.</span><span class="n">var</span><span class="p">.</span><span class="n">location</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">TypeDeclaration</span><span class="p">)</span> <span class="o">||</span>
                                <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">UninitializedVar</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">responds_to</span><span class="o">?</span><span class="p">(:</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>

    <span class="n">name</span><span class="p">.</span><span class="n">location</span>
  <span class="n">end</span>

  <span class="cp"># Returns zero if *node* does not contain a name.
</span>  <span class="n">def</span> <span class="n">name_size</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">unless</span> <span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name_size</span><span class="p">).</span><span class="n">zero</span><span class="o">?</span>
      <span class="k">return</span> <span class="n">size</span>
    <span class="n">end</span>

    <span class="k">return</span> <span class="mi">0</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">responds_to</span><span class="o">?</span><span class="p">(:</span><span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">case</span> <span class="n">name</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>     <span class="n">then</span> <span class="n">name</span><span class="p">.</span><span class="n">name_size</span>
    <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Token</span><span class="o">::</span><span class="n">Kind</span> <span class="n">then</span> <span class="n">name</span><span class="p">.</span><span class="n">to_s</span><span class="p">.</span><span class="n">size</span> <span class="err">#</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MagicConstant</span>
    <span class="k">else</span>                           <span class="n">name</span><span class="p">.</span><span class="n">size</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># Returns `nil` if *node* does not contain a name.
</span>  <span class="cp">#
</span>  <span class="cp"># NOTE: Use this instead of `Crystal::Call#name_end_location` to avoid an
</span>  <span class="cp">#       off-by-one error.
</span>  <span class="n">def</span> <span class="n">name_end_location</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unless</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">name_location</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">=</span> <span class="n">name_size</span><span class="p">(</span><span class="n">node</span><span class="p">)).</span><span class="n">zero</span><span class="o">?</span>

    <span class="n">loc</span><span class="p">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">column_number</span><span class="p">:</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># A generic entity to represent a branchable Crystal node.
</span>  <span class="cp"># For example, `Crystal::If`, `Crystal::Unless`, `Crystal::While`
</span>  <span class="cp"># are branchables.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># while a &gt; 100 # Branchable A
</span>  <span class="cp">#   if b &gt; 2    # Branchable B
</span>  <span class="cp">#     a += 1
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">Branchable</span>
    <span class="n">include</span> <span class="n">Util</span>

    <span class="n">getter</span> <span class="n">branches</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>

    <span class="cp"># The actual Crystal node.
</span>    <span class="n">getter</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>

    <span class="cp"># Parent branchable (if any)
</span>    <span class="n">getter</span> <span class="n">parent</span> <span class="o">:</span> <span class="n">Branchable</span><span class="o">?</span>

    <span class="n">delegate</span> <span class="n">to_s</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>

    <span class="cp"># Creates a new branchable
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Branchable.new(node, parent_branchable)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">parent</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if this node or one of the parent branchables is a loop,
</span>    <span class="cp"># `false` otherwise.
</span>    <span class="n">def</span> <span class="n">loop</span><span class="o">?</span>
      <span class="n">loop</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="o">||</span> <span class="o">!!</span><span class="n">parent</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">loop</span><span class="o">?</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./util"
</span>
<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># Represents a flow expression in Crystal code.
</span>  <span class="cp"># For example,
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def foobar
</span>  <span class="cp">#   a = 3
</span>  <span class="cp">#   return 42 # =&gt; flow expression
</span>  <span class="cp">#   a + 1
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># Flow expression contains an actual node of a control expression and
</span>  <span class="cp"># a parent node, which allows easily search through the related statement
</span>  <span class="cp"># (i.e. find unreachable code)
</span>  <span class="k">class</span> <span class="nc">FlowExpression</span>
    <span class="n">include</span> <span class="n">Util</span>

    <span class="cp"># Is true only if some of the nodes parents is a loop.
</span>    <span class="n">getter</span><span class="o">?</span> <span class="n">in_loop</span> <span class="o">:</span> <span class="n">Bool</span>

    <span class="cp"># The actual node of the flow expression.
</span>    <span class="n">getter</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>

    <span class="n">delegate</span> <span class="n">to_s</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>

    <span class="cp"># Creates a new flow expression.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># FlowExpression.new(node, parent_node)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">in_loop</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns nodes which can't be reached because of a flow command inside.
</span>    <span class="cp"># For example:
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># def foobar
</span>    <span class="cp">#   a = 1
</span>    <span class="cp">#   return 42
</span>    <span class="cp">#
</span>    <span class="cp">#   a + 2 # =&gt; unreachable assign node
</span>    <span class="cp"># end
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">unreachable_nodes</span>
      <span class="n">unreachable_nodes</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>

      <span class="k">case</span> <span class="n">current_node</span> <span class="o">=</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span>
        <span class="n">control_flow_found</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">current_node</span><span class="p">.</span><span class="n">expressions</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">exp</span><span class="o">|</span>
          <span class="n">unreachable_nodes</span> <span class="o">&lt;&lt;</span> <span class="n">exp</span> <span class="k">if</span> <span class="n">control_flow_found</span>
          <span class="n">control_flow_found</span> <span class="o">||=</span> <span class="o">!</span><span class="n">loop</span><span class="o">?</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">flow_expression</span><span class="o">?</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">in_loop</span><span class="o">?</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">BinaryOp</span>
        <span class="k">if</span> <span class="n">flow_expression</span><span class="o">?</span><span class="p">(</span><span class="n">current_node</span><span class="p">.</span><span class="n">left</span><span class="p">,</span> <span class="n">in_loop</span><span class="o">?</span><span class="p">)</span>
          <span class="n">unreachable_nodes</span> <span class="o">&lt;&lt;</span> <span class="n">current_node</span><span class="p">.</span><span class="n">right</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">unreachable_nodes</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./variabling/*"
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># Represents the argument of some node.
</span>  <span class="cp"># Holds the reference to the variable, thus to scope.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, all these vars are arguments:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def method(a, b, c = 10, &amp;block)
</span>  <span class="cp">#   3.times do |i|
</span>  <span class="cp">#   end
</span>  <span class="cp">#
</span>  <span class="cp">#   -&gt;(x : Int32)</span> <span class="p">{}</span>
  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">Argument</span>
    <span class="cp"># The actual node.
</span>    <span class="n">getter</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Arg</span>

    <span class="cp"># Variable of this argument (may be the same node)
</span>    <span class="n">getter</span> <span class="n">variable</span> <span class="o">:</span> <span class="n">Variable</span>

    <span class="n">delegate</span> <span class="n">location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">to_s</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>

    <span class="cp"># Creates a new argument.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Argument.new(node, variable)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">variable</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the `name` is empty, `false` otherwise.
</span>    <span class="n">def</span> <span class="n">anonymous</span><span class="o">?</span>
      <span class="n">name</span><span class="p">.</span><span class="n">blank</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the `name` starts with '_', `false` otherwise.
</span>    <span class="n">def</span> <span class="n">ignored</span><span class="o">?</span>
      <span class="n">name</span><span class="p">.</span><span class="n">starts_with</span><span class="o">?</span> <span class="sc">'_'</span>
    <span class="n">end</span>

    <span class="cp"># Name of the argument.
</span>    <span class="n">def</span> <span class="n">name</span>
      <span class="k">case</span> <span class="n">current_node</span> <span class="o">=</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Arg</span>
        <span class="n">current_node</span><span class="p">.</span><span class="n">name</span>
      <span class="k">else</span>
        <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span> <span class="s">"Invalid node"</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./reference"
# require "./variable"
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># Represents the existence of the local variable.
</span>  <span class="cp"># Holds the var node and variable assignments.
</span>  <span class="k">class</span> <span class="nc">Variable</span>
    <span class="cp"># List of the assignments of this variable.
</span>    <span class="n">getter</span> <span class="n">assignments</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Assignment</span>

    <span class="cp"># List of the references of this variable.
</span>    <span class="n">getter</span> <span class="n">references</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Reference</span>

    <span class="cp"># The actual var node.
</span>    <span class="n">getter</span> <span class="n">node</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span>

    <span class="cp"># Scope of this variable.
</span>    <span class="n">getter</span> <span class="n">scope</span> <span class="o">:</span> <span class="n">Scope</span>

    <span class="cp"># Node of the first assignment which can be available before any reference.
</span>    <span class="n">getter</span> <span class="n">assign_before_reference</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="o">?</span>

    <span class="n">delegate</span> <span class="n">location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">name</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">to_s</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>

    <span class="cp"># Creates a new variable(in the scope).
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Variable.new(node, scope)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">scope</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if it is a special variable, i.e `$?`.
</span>    <span class="n">def</span> <span class="n">special</span><span class="o">?</span>
      <span class="err">@</span><span class="n">node</span><span class="p">.</span><span class="n">special_var</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="cp"># Assigns the variable (creates a new assignment).
</span>    <span class="cp"># Variable may have multiple assignments.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># variable = Variable.new(node, scope)
</span>    <span class="cp"># variable.assign(node1)
</span>    <span class="cp"># variable.assign(node2)
</span>    <span class="cp"># variable.assignment.size # =&gt; 2
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">assign</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
      <span class="n">assignments</span> <span class="o">&lt;&lt;</span> <span class="n">Assignment</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>

      <span class="n">update_assign_reference</span><span class="o">!</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if variable has any reference.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># variable = Variable.new(node, scope)
</span>    <span class="cp"># variable.reference(var_node)
</span>    <span class="cp"># variable.referenced? # =&gt; true
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">referenced</span><span class="o">?</span>
      <span class="o">!</span><span class="n">references</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="cp"># Creates a reference to this variable in some scope.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># variable = Variable.new(node, scope)
</span>    <span class="cp"># variable.reference(var_node, some_scope)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">reference</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">,</span> <span class="n">scope</span> <span class="o">:</span> <span class="n">Scope</span><span class="p">)</span>
      <span class="n">Reference</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">scope</span><span class="p">).</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">reference</span><span class="o">|</span>
        <span class="n">references</span> <span class="o">&lt;&lt;</span> <span class="n">reference</span>
        <span class="n">scope</span><span class="p">.</span><span class="n">references</span> <span class="o">&lt;&lt;</span> <span class="n">reference</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Reference variable's assignments.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># variable = Variable.new(node, scope)
</span>    <span class="cp"># variable.assign(assign_node)
</span>    <span class="cp"># variable.reference_assignments!
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">reference_assignments</span><span class="o">!</span>
      <span class="n">consumed_branches</span> <span class="o">=</span> <span class="n">Set</span><span class="p">(</span><span class="n">Branch</span><span class="p">).</span><span class="k">new</span>

      <span class="n">assignments</span><span class="p">.</span><span class="n">reverse_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">assignment</span><span class="o">|</span>
        <span class="n">next</span> <span class="k">if</span> <span class="n">assignment</span><span class="p">.</span><span class="n">branch</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">consumed_branches</span><span class="p">)</span>
        <span class="n">assignment</span><span class="p">.</span><span class="n">referenced</span> <span class="o">=</span> <span class="nb">true</span>

        <span class="k">break</span> <span class="n">unless</span> <span class="n">branch</span> <span class="o">=</span> <span class="n">assignment</span><span class="p">.</span><span class="n">branch</span>
        <span class="n">consumed_branches</span> <span class="o">&lt;&lt;</span> <span class="n">branch</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the current var is referenced in
</span>    <span class="cp"># in the block. For example this variable is captured
</span>    <span class="cp"># by block:
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># a = 1
</span>    <span class="cp"># 3.times { |i| a = a + i }
</span>    <span class="cp"># ```
</span>    <span class="cp">#
</span>    <span class="cp"># And this variable is not captured by block.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># i = 1
</span>    <span class="cp"># 3.times { |i| i + 1 }
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">captured_by_block</span><span class="o">?</span><span class="p">(</span><span class="n">scope</span> <span class="o">=</span> <span class="err">@</span><span class="n">scope</span><span class="p">)</span>
      <span class="n">scope</span><span class="p">.</span><span class="n">inner_scopes</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">inner_scope</span><span class="o">|</span>
        <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">inner_scope</span><span class="p">.</span><span class="n">block</span><span class="o">?</span> <span class="o">&amp;&amp;</span>
                       <span class="n">inner_scope</span><span class="p">.</span><span class="n">references</span><span class="o">?</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">check_inner_scopes</span><span class="o">:</span> <span class="nb">false</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">captured_by_block</span><span class="o">?</span><span class="p">(</span><span class="n">inner_scope</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="nb">false</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if current variable potentially referenced in a macro,
</span>    <span class="cp"># `false` if not.
</span>    <span class="n">def</span> <span class="n">used_in_macro</span><span class="o">?</span><span class="p">(</span><span class="n">scope</span> <span class="o">=</span> <span class="err">@</span><span class="n">scope</span><span class="p">)</span>
      <span class="n">scope</span><span class="p">.</span><span class="n">inner_scopes</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">inner_scope</span><span class="o">|</span>
        <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">MacroReferenceFinder</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">inner_scope</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">references</span><span class="o">?</span>
      <span class="n">end</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">MacroReferenceFinder</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">scope</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">references</span><span class="o">?</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="p">(</span><span class="n">outer_scope</span> <span class="o">=</span> <span class="n">scope</span><span class="p">.</span><span class="n">outer_scope</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">used_in_macro</span><span class="o">?</span><span class="p">(</span><span class="n">outer_scope</span><span class="p">)</span>

      <span class="nb">false</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the variable is a target (on the left) of the assignment,
</span>    <span class="cp"># `false` otherwise.
</span>    <span class="n">def</span> <span class="n">target_of</span><span class="o">?</span><span class="p">(</span><span class="n">assign</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">assign</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span>           <span class="n">then</span> <span class="n">eql</span><span class="o">?</span><span class="p">(</span><span class="n">assign</span><span class="p">.</span><span class="n">target</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">OpAssign</span>         <span class="n">then</span> <span class="n">eql</span><span class="o">?</span><span class="p">(</span><span class="n">assign</span><span class="p">.</span><span class="n">target</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MultiAssign</span>      <span class="n">then</span> <span class="n">assign</span><span class="p">.</span><span class="n">targets</span><span class="p">.</span><span class="n">any</span><span class="o">?</span> <span class="err">{</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span> <span class="n">eql</span><span class="o">?</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="err">}</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">UninitializedVar</span> <span class="n">then</span> <span class="n">eql</span><span class="o">?</span><span class="p">(</span><span class="n">assign</span><span class="p">.</span><span class="n">var</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nb">false</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the name starts with '_', `false` if not.
</span>    <span class="n">def</span> <span class="n">ignored</span><span class="o">?</span>
      <span class="n">name</span><span class="p">.</span><span class="n">starts_with</span><span class="o">?</span> <span class="sc">'_'</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the `node` represents exactly
</span>    <span class="cp"># the same Crystal node as `@node`.
</span>    <span class="n">def</span> <span class="n">eql</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="err">@</span><span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">&amp;&amp;</span>
        <span class="n">node</span><span class="p">.</span><span class="n">location</span> <span class="o">==</span> <span class="err">@</span><span class="n">node</span><span class="p">.</span><span class="n">location</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the variable is declared before the `node`.
</span>    <span class="n">def</span> <span class="n">declared_before</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">var_location</span><span class="p">,</span> <span class="n">node_location</span> <span class="o">=</span> <span class="n">location</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">var_location</span> <span class="o">&amp;&amp;</span> <span class="n">node_location</span>

      <span class="p">(</span><span class="n">var_location</span><span class="p">.</span><span class="n">line_number</span> <span class="o">&lt;</span> <span class="n">node_location</span><span class="p">.</span><span class="n">line_number</span><span class="p">)</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">var_location</span><span class="p">.</span><span class="n">line_number</span> <span class="o">==</span> <span class="n">node_location</span><span class="p">.</span><span class="n">line_number</span> <span class="o">&amp;&amp;</span>
          <span class="n">var_location</span><span class="p">.</span><span class="n">column_number</span> <span class="o">&lt;</span> <span class="n">node_location</span><span class="p">.</span><span class="n">column_number</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">MacroReferenceFinder</span> <span class="o">&lt;</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Visitor</span>
      <span class="n">property</span><span class="o">?</span> <span class="n">references</span> <span class="o">=</span> <span class="nb">false</span>

      <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">reference</span> <span class="p">:</span> <span class="n">String</span> <span class="o">=</span> <span class="n">reference</span><span class="p">)</span>
        <span class="n">node</span><span class="p">.</span><span class="n">accept</span> <span class="n">self</span>
      <span class="n">end</span>

      <span class="err">@</span><span class="p">[</span><span class="n">AlwaysInline</span><span class="p">]</span>
      <span class="k">private</span> <span class="n">def</span> <span class="n">includes_reference</span><span class="o">?</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="n">val</span><span class="p">.</span><span class="n">to_s</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="err">@</span><span class="n">reference</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
        <span class="nb">true</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroLiteral</span><span class="p">)</span>
        <span class="o">!</span><span class="p">(</span><span class="err">@</span><span class="n">references</span> <span class="o">||=</span> <span class="n">includes_reference</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">value</span><span class="p">))</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroExpression</span><span class="p">)</span>
        <span class="o">!</span><span class="p">(</span><span class="err">@</span><span class="n">references</span> <span class="o">||=</span> <span class="n">includes_reference</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">exp</span><span class="p">))</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroFor</span><span class="p">)</span>
        <span class="o">!</span><span class="p">(</span><span class="err">@</span><span class="n">references</span> <span class="o">||=</span> <span class="n">includes_reference</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">exp</span><span class="p">)</span> <span class="o">||</span>
                          <span class="n">includes_reference</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">body</span><span class="p">))</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroIf</span><span class="p">)</span>
        <span class="o">!</span><span class="p">(</span><span class="err">@</span><span class="n">references</span> <span class="o">||=</span> <span class="n">includes_reference</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">)</span> <span class="o">||</span>
                          <span class="n">includes_reference</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">then</span><span class="p">)</span> <span class="o">||</span>
                          <span class="n">includes_reference</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">))</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">update_assign_reference</span><span class="o">!</span>
      <span class="k">if</span> <span class="err">@</span><span class="n">assign_before_reference</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">&amp;&amp;</span>
         <span class="n">references</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">assignments</span><span class="p">.</span><span class="n">size</span> <span class="o">&amp;&amp;</span>
         <span class="n">assignments</span><span class="p">.</span><span class="n">none</span><span class="o">?</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">op_assign</span><span class="o">?</span><span class="p">)</span>
        <span class="err">@</span><span class="n">assign_before_reference</span> <span class="o">=</span> <span class="n">assignments</span><span class="p">.</span><span class="n">find</span> <span class="p">{</span> <span class="o">|</span><span class="n">ass</span><span class="o">|</span> <span class="o">!</span><span class="n">ass</span><span class="p">.</span><span class="n">in_branch</span><span class="o">?</span> <span class="p">}.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">node</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># Represents a reference to the variable.
</span>  <span class="cp"># It behaves like a variable is used to distinguish a
</span>  <span class="cp"># the variable from its reference.
</span>  <span class="k">class</span> <span class="nc">Reference</span> <span class="o">&lt;</span> <span class="n">Variable</span>
    <span class="n">property</span><span class="o">?</span> <span class="k">explicit</span> <span class="o">=</span> <span class="nb">true</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./variable"
</span>
<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># Represents the assignment to the variable.
</span>  <span class="cp"># Holds the assign node and the variable.
</span>  <span class="k">class</span> <span class="nc">Assignment</span>
    <span class="n">property</span><span class="o">?</span> <span class="n">referenced</span> <span class="o">=</span> <span class="nb">false</span>

    <span class="cp"># The actual assignment node.
</span>    <span class="n">getter</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>

    <span class="cp"># Variable of this assignment.
</span>    <span class="n">getter</span> <span class="n">variable</span> <span class="o">:</span> <span class="n">Variable</span>

    <span class="cp"># Branch of this assignment.
</span>    <span class="n">getter</span> <span class="n">branch</span> <span class="o">:</span> <span class="n">Branch</span><span class="o">?</span>

    <span class="cp"># A scope assignment belongs to
</span>    <span class="n">getter</span> <span class="n">scope</span> <span class="o">:</span> <span class="n">Scope</span>

    <span class="n">delegate</span> <span class="n">to_s</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>

    <span class="cp"># Creates a new assignment.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># Assignment.new(node, variable, scope)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">variable</span><span class="p">,</span> <span class="err">@</span><span class="n">scope</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">scope</span> <span class="o">=</span> <span class="err">@</span><span class="n">variable</span><span class="p">.</span><span class="n">scope</span>

      <span class="err">@</span><span class="n">branch</span> <span class="o">=</span> <span class="n">Branch</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="err">@</span><span class="n">node</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span>
      <span class="err">@</span><span class="n">referenced</span> <span class="o">=</span> <span class="nb">true</span> <span class="k">if</span> <span class="err">@</span><span class="n">variable</span><span class="p">.</span><span class="n">special</span><span class="o">?</span> <span class="o">||</span>
                            <span class="err">@</span><span class="n">variable</span><span class="p">.</span><span class="n">scope</span><span class="p">.</span><span class="n">type_definition</span><span class="o">?</span> <span class="o">||</span>
                            <span class="n">referenced_in_loop</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">referenced_in_loop</span><span class="o">?</span>
      <span class="err">@</span><span class="n">variable</span><span class="p">.</span><span class="n">referenced</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="o">!!</span><span class="err">@</span><span class="n">branch</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">in_loop</span><span class="o">?</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if this assignment is an op assign, `false` if not.
</span>    <span class="cp"># For example, this is an op assign:
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># a ||= 1
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">op_assign</span><span class="o">?</span>
      <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">OpAssign</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if this assignment is in a branch, `false` if not.
</span>    <span class="cp"># For example, this assignment is in a branch:
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># a = 1 if a.nil?
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">in_branch</span><span class="o">?</span>
      <span class="o">!</span><span class="n">branch</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="cp"># Returns the target node of the variable in this assignment.
</span>    <span class="n">def</span> <span class="n">target_node</span>
      <span class="k">case</span> <span class="n">assign</span> <span class="o">=</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span>           <span class="n">then</span> <span class="n">assign</span><span class="p">.</span><span class="n">target</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">OpAssign</span>         <span class="n">then</span> <span class="n">assign</span><span class="p">.</span><span class="n">target</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">UninitializedVar</span> <span class="n">then</span> <span class="n">assign</span><span class="p">.</span><span class="n">var</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MultiAssign</span>
        <span class="n">assign</span><span class="p">.</span><span class="n">targets</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">target</span><span class="o">|</span>
          <span class="n">target</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">target</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">variable</span><span class="p">.</span><span class="n">name</span>
        <span class="n">end</span>
      <span class="k">else</span>
        <span class="n">node</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Indicates whether the node is a transformed assignment by the compiler.
</span>    <span class="cp"># i.e.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># collection.each do |(a, b)|
</span>    <span class="cp">#   puts b
</span>    <span class="cp"># end
</span>    <span class="cp"># ```
</span>    <span class="cp">#
</span>    <span class="cp"># is transformed to:
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># collection.each do |__arg0|
</span>    <span class="cp">#   a = __arg0[0]
</span>    <span class="cp">#   b = __arg0[1]
</span>    <span class="cp">#   puts(b)
</span>    <span class="cp"># end
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">transformed</span><span class="o">?</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="p">(</span><span class="n">assign</span> <span class="o">=</span> <span class="n">node</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="p">(</span><span class="n">value</span> <span class="o">=</span> <span class="n">assign</span><span class="p">.</span><span class="n">value</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="p">(</span><span class="n">obj</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">obj</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span>

      <span class="n">obj</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">starts_with</span><span class="o">?</span> <span class="s">"__arg"</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="k">class</span> <span class="nc">InstanceVariable</span>
    <span class="n">getter</span> <span class="n">node</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">InstanceVar</span>

    <span class="n">delegate</span> <span class="n">location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">name</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>
    <span class="n">delegate</span> <span class="n">to_s</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="err">@</span><span class="n">node</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># Represents a context of the local variable visibility.
</span>  <span class="cp"># This is where the local variables belong to.
</span>  <span class="k">class</span> <span class="nc">Scope</span>
    <span class="cp"># Whether the scope yields.
</span>    <span class="n">setter</span> <span class="n">yields</span> <span class="o">=</span> <span class="nb">false</span>

    <span class="cp"># Link to local variables
</span>    <span class="n">getter</span> <span class="n">variables</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Variable</span>

    <span class="cp"># Link to all variable references in currency scope
</span>    <span class="n">getter</span> <span class="n">references</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Reference</span>

    <span class="cp"># Link to the arguments in current scope
</span>    <span class="n">getter</span> <span class="n">arguments</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Argument</span>

    <span class="cp"># Link to the instance variables used in current scope
</span>    <span class="n">getter</span> <span class="n">ivariables</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">InstanceVariable</span>

    <span class="cp"># Link to the outer scope
</span>    <span class="n">getter</span> <span class="n">outer_scope</span> <span class="o">:</span> <span class="n">Scope</span><span class="o">?</span>

    <span class="cp"># List of inner scopes
</span>    <span class="n">getter</span> <span class="n">inner_scopes</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Scope</span>

    <span class="cp"># The actual AST node that represents a current scope.
</span>    <span class="n">getter</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>

    <span class="n">delegate</span> <span class="n">to_s</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="n">node</span>
    <span class="n">delegate</span> <span class="n">location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="n">node</span>
    <span class="n">delegate</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">to</span><span class="o">:</span> <span class="n">node</span>

    <span class="n">def_equals_and_hash</span> <span class="n">node</span><span class="p">,</span> <span class="n">location</span>

    <span class="cp"># Creates a new scope. Accepts the AST node and the outer scope.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># scope = Scope.new(class_node, nil)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">outer_scope</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
      <span class="err">@</span><span class="n">outer_scope</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">inner_scopes</span><span class="p">.</span><span class="o">&lt;&lt;</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Creates a new variable in the current scope.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># scope = Scope.new(class_node, nil)
</span>    <span class="cp"># scope.add_variable(var_node)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">add_variable</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">variables</span> <span class="o">&lt;&lt;</span> <span class="n">Variable</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Creates a new argument in the current scope.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># scope = Scope.new(class_node, nil)
</span>    <span class="cp"># scope.add_argument(arg_node)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">add_argument</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">add_variable</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">).</span><span class="n">at</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">arguments</span> <span class="o">&lt;&lt;</span> <span class="n">Argument</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">variables</span><span class="p">.</span><span class="n">last</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Adds a new instance variable to the current scope.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># scope = Scope.new(class_node, nil)
</span>    <span class="cp"># scope.add_ivariable(ivar_node)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">add_ivariable</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">ivariables</span> <span class="o">&lt;&lt;</span> <span class="n">InstanceVariable</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns variable by its name or `nil` if it does not exist.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># scope = Scope.new(class_node, nil)
</span>    <span class="cp"># scope.find_variable("foo")
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">find_variable</span><span class="p">(</span><span class="n">name</span> <span class="o">:</span> <span class="n">String</span><span class="p">)</span>
      <span class="n">variables</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="o">==</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="o">||</span> <span class="n">outer_scope</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">find_variable</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Creates a new assignment for the variable.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># scope = Scope.new(class_node, nil)
</span>    <span class="cp"># scope.assign_variable(var_name, assign_node)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">assign_variable</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
      <span class="n">find_variable</span><span class="p">(</span><span class="n">name</span><span class="p">).</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">assign</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if current scope represents a block (or proc),
</span>    <span class="cp"># `false` otherwise.
</span>    <span class="n">def</span> <span class="n">block</span><span class="o">?</span>
      <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Block</span><span class="p">)</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">ProcLiteral</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if current scope represents a spawn block, e. g.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># spawn do
</span>    <span class="cp">#   # ...
</span>    <span class="cp"># end
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">spawn_block</span><span class="o">?</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Block</span><span class="p">)</span>

      <span class="n">call</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Block</span><span class="p">).</span><span class="n">call</span>
      <span class="n">call</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="s">"spawn"</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if current scope sits inside a macro.
</span>    <span class="n">def</span> <span class="n">in_macro</span><span class="o">?</span>
      <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Macro</span><span class="p">)</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">MacroFor</span><span class="p">))</span> <span class="o">||</span>
        <span class="o">!!</span><span class="n">outer_scope</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">in_macro</span><span class="o">?</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if instance variable is assigned in this scope.
</span>    <span class="n">def</span> <span class="n">assigns_ivar</span><span class="o">?</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="n">arguments</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="o">==</span> <span class="n">name</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="n">ivariables</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="o">==</span> <span class="s">"@#{name}"</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if and only if current scope represents some
</span>    <span class="cp"># type definition, for example a class.
</span>    <span class="n">def</span> <span class="n">type_definition</span><span class="o">?</span>
      <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">ClassDef</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">ModuleDef</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">LibDef</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">FunDef</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">TypeDef</span><span class="p">)</span> <span class="o">||</span>
        <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">CStructOrUnionDef</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if current scope (or any of inner scopes) references variable,
</span>    <span class="cp"># `false` otherwise.
</span>    <span class="n">def</span> <span class="n">references</span><span class="o">?</span><span class="p">(</span><span class="n">variable</span> <span class="o">:</span> <span class="n">Variable</span><span class="p">,</span> <span class="n">check_inner_scopes</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span>
      <span class="n">variable</span><span class="p">.</span><span class="n">references</span><span class="p">.</span><span class="n">any</span><span class="o">?</span> <span class="k">do</span> <span class="o">|</span><span class="n">reference</span><span class="o">|</span>
        <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">reference</span><span class="p">.</span><span class="n">scope</span> <span class="o">==</span> <span class="n">self</span>
        <span class="n">check_inner_scopes</span> <span class="o">&amp;&amp;</span> <span class="n">inner_scopes</span><span class="p">.</span><span class="n">any</span><span class="o">?</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">references</span><span class="o">?</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
      <span class="n">end</span> <span class="o">||</span> <span class="n">variable</span><span class="p">.</span><span class="n">used_in_macro</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if current scope (or any of inner scopes) yields,
</span>    <span class="cp"># `false` otherwise.
</span>    <span class="n">def</span> <span class="n">yields</span><span class="o">?</span><span class="p">(</span><span class="n">check_inner_scopes</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="err">@</span><span class="n">yields</span>
      <span class="k">return</span> <span class="n">inner_scopes</span><span class="p">.</span><span class="n">any</span><span class="o">?</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">yields</span><span class="o">?</span><span class="p">)</span> <span class="k">if</span> <span class="n">check_inner_scopes</span>
      <span class="nb">false</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if current scope is a def, `false` otherwise.
</span>    <span class="n">def</span> <span class="n">def</span><span class="o">?</span>
      <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Def</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if this scope is a top level scope, `false` otherwise.
</span>    <span class="n">def</span> <span class="n">top_level</span><span class="o">?</span>
      <span class="n">outer_scope</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if var is an argument in current scope, `false` otherwise.
</span>    <span class="n">def</span> <span class="n">arg</span><span class="o">?</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">current_node</span> <span class="o">=</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Def</span>
        <span class="n">var</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Arg</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">any_arg</span><span class="o">?</span><span class="p">(</span><span class="n">current_node</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Block</span>
        <span class="n">var</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">any_arg</span><span class="o">?</span><span class="p">(</span><span class="n">current_node</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ProcLiteral</span>
        <span class="n">var</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">any_arg</span><span class="o">?</span><span class="p">(</span><span class="n">current_node</span><span class="p">.</span><span class="n">def</span><span class="p">.</span><span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="nb">false</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">any_arg</span><span class="o">?</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
      <span class="n">args</span><span class="p">.</span><span class="n">any</span><span class="o">?</span> <span class="err">{</span> <span class="o">|</span><span class="n">arg</span><span class="o">|</span> <span class="n">arg</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">var</span><span class="p">.</span><span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="n">arg</span><span class="p">.</span><span class="n">location</span> <span class="o">==</span> <span class="n">var</span><span class="p">.</span><span class="n">location</span> <span class="err">}</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if the *node* represents exactly
</span>    <span class="cp"># the same Crystal node as `@node`.
</span>    <span class="n">def</span> <span class="n">eql</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">node</span> <span class="o">==</span> <span class="err">@</span><span class="n">node</span> <span class="o">&amp;&amp;</span>
        <span class="n">node</span><span class="p">.</span><span class="n">location</span> <span class="o">&amp;&amp;</span>
        <span class="n">node</span><span class="p">.</span><span class="n">location</span> <span class="o">==</span> <span class="err">@</span><span class="n">node</span><span class="p">.</span><span class="n">location</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">require</span> <span class="s">"compiler/crystal/syntax/*"</span>

<span class="cp"># A module that helps to traverse Crystal AST using `Crystal::Visitor`.
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># An abstract base visitor that utilizes general logic for all visitors.
</span>  <span class="n">abstract</span> <span class="k">class</span> <span class="nc">BaseVisitor</span> <span class="o">&lt;</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Visitor</span>
    <span class="cp"># A corresponding rule that uses this visitor.
</span>    <span class="err">@</span><span class="n">rule</span> <span class="p">:</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>

    <span class="cp"># A source that needs to be traversed.
</span>    <span class="err">@</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span>

    <span class="cp"># Creates instance of this visitor.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># visitor = Ameba::AST::NodeVisitor.new(rule, source)
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">rule</span><span class="p">,</span> <span class="err">@</span><span class="n">source</span><span class="p">)</span>
      <span class="err">@</span><span class="n">source</span><span class="p">.</span><span class="n">ast</span><span class="p">.</span><span class="n">accept</span> <span class="n">self</span>
    <span class="n">end</span>

    <span class="cp"># A main visit method that accepts `Crystal::ASTNode`.
</span>    <span class="cp"># Returns `true`, meaning all child nodes will be traversed.
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="nb">true</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># AST Visitor that counts occurrences of certain keywords
</span>  <span class="k">class</span> <span class="nc">CountingVisitor</span> <span class="o">&lt;</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Visitor</span>
    <span class="n">DEFAULT_COMPLEXITY</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">getter</span><span class="o">?</span> <span class="n">macro_condition</span> <span class="o">=</span> <span class="nb">false</span>

    <span class="cp"># Creates a new counting visitor
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">scope</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="err">@</span><span class="n">complexity</span> <span class="o">=</span> <span class="n">DEFAULT_COMPLEXITY</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="nb">true</span>
    <span class="n">end</span>

    <span class="cp"># Returns the number of keywords that were found in the node
</span>    <span class="n">def</span> <span class="n">count</span>
      <span class="err">@</span><span class="n">scope</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
      <span class="err">@</span><span class="n">complexity</span>
    <span class="n">end</span>

    <span class="cp"># Uses the same logic than rubocop. See
</span>    <span class="cp"># https://github.com/rubocop-hq/rubocop/blob/master/lib/rubocop/cop/metrics/cyclomatic_complexity.rb#L21
</span>    <span class="cp"># Except "for", because crystal doesn't have a "for" loop.
</span>    <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">node</span> <span class="n">in</span> <span class="o">%</span><span class="n">i</span><span class="p">(</span><span class="k">if</span> <span class="k">while</span> <span class="n">until</span> <span class="n">rescue</span> <span class="n">or</span> <span class="n">and</span><span class="p">)</span> <span class="o">%</span><span class="p">}</span>
      <span class="cp"># :nodoc:
</span>      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="p">{{</span> <span class="n">node</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">capitalize</span> <span class="p">}})</span>
        <span class="err">@</span><span class="n">complexity</span> <span class="o">+=</span> <span class="mi">1</span> <span class="n">unless</span> <span class="n">macro_condition</span><span class="o">?</span>
      <span class="n">end</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Case</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">macro_condition</span><span class="o">?</span>

      <span class="cp"># Count the complexity of an exhaustive `Case` as 1
</span>      <span class="cp"># Otherwise count the number of `When`s
</span>      <span class="err">@</span><span class="n">complexity</span> <span class="o">+=</span> <span class="n">node</span><span class="p">.</span><span class="n">exhaustive</span><span class="o">?</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="n">node</span><span class="p">.</span><span class="n">whens</span><span class="p">.</span><span class="n">size</span>

      <span class="nb">true</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroIf</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroFor</span><span class="p">)</span>
      <span class="err">@</span><span class="n">macro_condition</span> <span class="o">=</span> <span class="nb">true</span>
      <span class="err">@</span><span class="n">complexity</span> <span class="o">=</span> <span class="n">DEFAULT_COMPLEXITY</span>

      <span class="nb">false</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "../util"
</span>
<span class="cp"># require "./base_visitor"
</span>
<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># AST Visitor that traverses all the flow expressions.
</span>  <span class="k">class</span> <span class="nc">FlowExpressionVisitor</span> <span class="o">&lt;</span> <span class="n">BaseVisitor</span>
    <span class="n">include</span> <span class="n">Util</span>

    <span class="err">@</span><span class="n">loop_stack</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>

    <span class="cp"># Creates a new flow expression visitor.
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">rule</span><span class="p">,</span> <span class="err">@</span><span class="n">source</span><span class="p">)</span>
      <span class="err">@</span><span class="n">source</span><span class="p">.</span><span class="n">ast</span><span class="p">.</span><span class="n">accept</span> <span class="n">self</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">flow_expression</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">in_loop</span><span class="o">?</span><span class="p">)</span>
        <span class="err">@</span><span class="n">rule</span><span class="p">.</span><span class="n">test</span> <span class="err">@</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">FlowExpression</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">in_loop</span><span class="o">?</span><span class="p">)</span>
      <span class="n">end</span>
      <span class="nb">true</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span><span class="p">)</span>
      <span class="n">on_loop_started</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Until</span><span class="p">)</span>
      <span class="n">on_loop_started</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="n">on_loop_started</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">if</span> <span class="n">loop</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span><span class="p">)</span>
      <span class="n">on_loop_ended</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Until</span><span class="p">)</span>
      <span class="n">on_loop_ended</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="n">on_loop_ended</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">if</span> <span class="n">loop</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">on_loop_started</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="err">@</span><span class="n">loop_stack</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">on_loop_ended</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="err">@</span><span class="n">loop_stack</span><span class="p">.</span><span class="n">pop</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">in_loop</span><span class="o">?</span>
      <span class="o">!</span><span class="err">@</span><span class="n">loop_stack</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./base_visitor"
</span>
<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># List of nodes to be visited by Ameba's rules.
</span>  <span class="n">NODES</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Alias</span><span class="p">,</span>
    <span class="n">IsA</span><span class="p">,</span>
    <span class="n">Assign</span><span class="p">,</span>
    <span class="n">Call</span><span class="p">,</span>
    <span class="n">Block</span><span class="p">,</span>
    <span class="n">Case</span><span class="p">,</span>
    <span class="n">ClassDef</span><span class="p">,</span>
    <span class="n">ClassVar</span><span class="p">,</span>
    <span class="n">Def</span><span class="p">,</span>
    <span class="n">EnumDef</span><span class="p">,</span>
    <span class="n">ExceptionHandler</span><span class="p">,</span>
    <span class="n">Expressions</span><span class="p">,</span>
    <span class="n">HashLiteral</span><span class="p">,</span>
    <span class="n">If</span><span class="p">,</span>
    <span class="n">InstanceVar</span><span class="p">,</span>
    <span class="n">LibDef</span><span class="p">,</span>
    <span class="n">ModuleDef</span><span class="p">,</span>
    <span class="n">NilLiteral</span><span class="p">,</span>
    <span class="n">StringInterpolation</span><span class="p">,</span>
    <span class="n">Unless</span><span class="p">,</span>
    <span class="n">Var</span><span class="p">,</span>
    <span class="n">When</span><span class="p">,</span>
    <span class="n">While</span><span class="p">,</span>
    <span class="n">Until</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="cp"># An AST Visitor that traverses the source and allows all nodes
</span>  <span class="cp"># to be inspected by rules.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># visitor = Ameba::AST::NodeVisitor.new(rule, source)
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">NodeVisitor</span> <span class="o">&lt;</span> <span class="n">BaseVisitor</span>
    <span class="err">@</span><span class="n">skip</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">.</span><span class="k">class</span><span class="p">)</span><span class="o">?</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">rule</span><span class="p">,</span> <span class="err">@</span><span class="n">source</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
      <span class="err">@</span><span class="n">skip</span> <span class="o">=</span> <span class="n">skip</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">.</span><span class="k">class</span><span class="p">))</span>
      <span class="n">super</span> <span class="err">@</span><span class="n">rule</span><span class="p">,</span> <span class="err">@</span><span class="n">source</span>
    <span class="n">end</span>

    <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">name</span> <span class="n">in</span> <span class="n">NODES</span> <span class="o">%</span><span class="p">}</span>
      <span class="cp"># A visit callback for `Crystal::{{ name }}` node.
</span>      <span class="cp">#
</span>      <span class="cp"># Returns `true` if the child nodes should be traversed as well,
</span>      <span class="cp"># `false` otherwise.
</span>      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="p">{{</span> <span class="n">name</span> <span class="p">}})</span>
        <span class="k">return</span> <span class="nb">false</span> <span class="k">if</span> <span class="n">skip</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

        <span class="err">@</span><span class="n">rule</span><span class="p">.</span><span class="n">test</span> <span class="err">@</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span>
        <span class="nb">true</span>
      <span class="n">end</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>

    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="o">!</span><span class="n">skip</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">skip</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="o">!!</span><span class="err">@</span><span class="n">skip</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="k">class</span><span class="p">))</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># A class that utilizes a logic to traverse AST nodes and
</span>  <span class="cp"># fire a source test callback if a redundant `Crystal::ControlExpression`
</span>  <span class="cp"># is reached.
</span>  <span class="k">class</span> <span class="nc">RedundantControlExpressionVisitor</span>
    <span class="cp"># A corresponding rule that uses this visitor.
</span>    <span class="n">getter</span> <span class="n">rule</span> <span class="o">:</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>

    <span class="cp"># A source that needs to be traversed.
</span>    <span class="n">getter</span> <span class="n">source</span> <span class="o">:</span> <span class="n">Source</span>

    <span class="cp"># A node to run traversal on.
</span>    <span class="n">getter</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">rule</span><span class="p">,</span> <span class="err">@</span><span class="n">source</span><span class="p">,</span> <span class="err">@</span><span class="n">node</span><span class="p">)</span>
      <span class="n">traverse_node</span> <span class="n">node</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">traverse_control_expression</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rule</span><span class="p">.</span><span class="n">test</span><span class="p">(</span><span class="err">@</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">self</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">traverse_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ControlExpression</span>   <span class="n">then</span> <span class="n">traverse_control_expression</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span>         <span class="n">then</span> <span class="n">traverse_expressions</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span> <span class="n">then</span> <span class="n">traverse_condition</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Case</span>                <span class="n">then</span> <span class="n">traverse_case</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">BinaryOp</span>            <span class="n">then</span> <span class="n">traverse_binary_op</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ExceptionHandler</span>    <span class="n">then</span> <span class="n">traverse_exception_handler</span> <span class="n">node</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">traverse_expressions</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">traverse_node</span> <span class="n">node</span><span class="p">.</span><span class="n">expressions</span><span class="p">.</span><span class="n">last</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">traverse_condition</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">.</span><span class="n">nop</span><span class="o">?</span>

      <span class="n">traverse_node</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">then</span><span class="p">)</span>
      <span class="n">traverse_node</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">traverse_case</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">whens</span><span class="p">.</span><span class="n">each</span> <span class="err">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">traverse_node</span> <span class="n">n</span><span class="p">.</span><span class="n">body</span> <span class="err">}</span>
      <span class="n">traverse_node</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">traverse_binary_op</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">traverse_node</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">traverse_exception_handler</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">traverse_node</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span>
      <span class="n">traverse_node</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span>
      <span class="n">node</span><span class="p">.</span><span class="n">rescues</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">each</span> <span class="err">{</span> <span class="o">|</span><span class="n">n</span><span class="o">|</span> <span class="n">traverse_node</span> <span class="n">n</span><span class="p">.</span><span class="n">body</span> <span class="err">}</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./base_visitor"
</span>
<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># AST Visitor that traverses the source and constructs scopes.
</span>  <span class="k">class</span> <span class="nc">ScopeVisitor</span> <span class="o">&lt;</span> <span class="n">BaseVisitor</span>
    <span class="cp"># Non-exhaustive list of nodes to be visited by Ameba's rules.
</span>    <span class="n">NODES</span> <span class="o">=</span> <span class="err">{</span>
      <span class="n">ClassDef</span><span class="p">,</span>
      <span class="n">ModuleDef</span><span class="p">,</span>
      <span class="n">EnumDef</span><span class="p">,</span>
      <span class="n">LibDef</span><span class="p">,</span>
      <span class="n">FunDef</span><span class="p">,</span>
      <span class="n">TypeDef</span><span class="p">,</span>
      <span class="n">TypeOf</span><span class="p">,</span>
      <span class="n">CStructOrUnionDef</span><span class="p">,</span>
      <span class="n">ProcLiteral</span><span class="p">,</span>
      <span class="n">Block</span><span class="p">,</span>
      <span class="n">Macro</span><span class="p">,</span>
      <span class="n">MacroFor</span><span class="p">,</span>
    <span class="err">}</span>

    <span class="n">SPECIAL_NODE_NAMES</span> <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">[</span><span class="n">super</span> <span class="n">previous_def</span><span class="p">]</span>
    <span class="n">RECORD_NODE_NAME</span>   <span class="o">=</span> <span class="s">"record"</span>

    <span class="err">@</span><span class="n">scope_queue</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Scope</span>
    <span class="err">@</span><span class="n">current_scope</span> <span class="p">:</span> <span class="n">Scope</span>
    <span class="err">@</span><span class="n">current_assign</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="o">?</span>
    <span class="err">@</span><span class="n">skip</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">.</span><span class="k">class</span><span class="p">)</span><span class="o">?</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">rule</span><span class="p">,</span> <span class="err">@</span><span class="n">source</span><span class="p">,</span> <span class="n">skip</span> <span class="o">=</span> <span class="n">nil</span><span class="p">)</span>
      <span class="err">@</span><span class="n">skip</span> <span class="o">=</span> <span class="n">skip</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">as</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">.</span><span class="k">class</span><span class="p">))</span>
      <span class="err">@</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">source</span><span class="p">.</span><span class="n">ast</span><span class="p">)</span> <span class="err">#</span> <span class="n">top</span> <span class="n">level</span> <span class="n">scope</span>
      <span class="err">@</span><span class="n">source</span><span class="p">.</span><span class="n">ast</span><span class="p">.</span><span class="n">accept</span> <span class="n">self</span>
      <span class="err">@</span><span class="n">scope_queue</span><span class="p">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">scope</span><span class="o">|</span> <span class="err">@</span><span class="n">rule</span><span class="p">.</span><span class="n">test</span> <span class="err">@</span><span class="n">source</span><span class="p">,</span> <span class="n">scope</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="n">scope</span> <span class="p">}</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">on_scope_enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">skip</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="err">@</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">Scope</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">on_scope_end</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="err">@</span><span class="n">scope_queue</span> <span class="o">&lt;&lt;</span> <span class="err">@</span><span class="n">current_scope</span>

      <span class="cp"># go up if this is not a top level scope
</span>      <span class="k">return</span> <span class="n">unless</span> <span class="n">outer_scope</span> <span class="o">=</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">outer_scope</span>
      <span class="err">@</span><span class="n">current_scope</span> <span class="o">=</span> <span class="n">outer_scope</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">on_assign_end</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
      <span class="n">target</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
        <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">assign_variable</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="n">on_scope_end</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">if</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">eql</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">name</span> <span class="n">in</span> <span class="n">NODES</span> <span class="o">%</span><span class="p">}</span>
      <span class="cp"># :nodoc:
</span>      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="p">{{</span> <span class="n">name</span> <span class="p">}})</span>
        <span class="n">on_scope_enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Yield</span><span class="p">)</span>
      <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">yields</span> <span class="o">=</span> <span class="nb">true</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Def</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">"-&gt;"</span> <span class="o">||</span> <span class="n">on_scope_enter</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">OpAssign</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MultiAssign</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">UninitializedVar</span><span class="p">)</span>
      <span class="err">@</span><span class="n">current_assign</span> <span class="o">=</span> <span class="n">node</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">OpAssign</span><span class="p">)</span>
      <span class="n">on_assign_end</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
      <span class="err">@</span><span class="n">current_assign</span> <span class="o">=</span> <span class="n">nil</span>
      <span class="n">on_scope_end</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">if</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">eql</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MultiAssign</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">targets</span><span class="p">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">target</span><span class="o">|</span> <span class="n">on_assign_end</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">}</span>
      <span class="err">@</span><span class="n">current_assign</span> <span class="o">=</span> <span class="n">nil</span>
      <span class="n">on_scope_end</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">if</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">eql</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">end_visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">UninitializedVar</span><span class="p">)</span>
      <span class="n">on_assign_end</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
      <span class="err">@</span><span class="n">current_assign</span> <span class="o">=</span> <span class="n">nil</span>
      <span class="n">on_scope_end</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="k">if</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">eql</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">TypeDeclaration</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">type_definition</span><span class="o">?</span>
      <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="p">(</span><span class="n">var</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">var</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span>

      <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Arg</span><span class="p">)</span>
      <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">InstanceVar</span><span class="p">)</span>
      <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">add_ivariable</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span>
      <span class="n">variable</span> <span class="o">=</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">find_variable</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span>

      <span class="k">case</span>
      <span class="n">when</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">arg</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="err">#</span> <span class="n">node</span> <span class="n">is</span> <span class="n">an</span> <span class="n">argument</span>
        <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">add_argument</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">variable</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="err">@</span><span class="n">current_assign</span> <span class="err">#</span> <span class="n">node</span> <span class="n">is</span> <span class="n">a</span> <span class="n">variable</span>
        <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">add_variable</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">variable</span> <span class="err">#</span> <span class="n">node</span> <span class="n">is</span> <span class="n">a</span> <span class="n">reference</span>
        <span class="n">reference</span> <span class="o">=</span> <span class="n">variable</span><span class="p">.</span><span class="n">reference</span> <span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">current_scope</span>
        <span class="k">if</span> <span class="err">@</span><span class="n">current_assign</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">OpAssign</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">reference</span><span class="p">.</span><span class="n">target_of</span><span class="o">?</span><span class="p">(</span><span class="err">@</span><span class="n">current_assign</span><span class="p">)</span>
          <span class="n">variable</span><span class="p">.</span><span class="n">reference_assignments</span><span class="o">!</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">case</span>
      <span class="n">when</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">def</span><span class="o">?</span>
        <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">SPECIAL_NODE_NAMES</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
          <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">arguments</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg</span><span class="o">|</span>
            <span class="n">variable</span> <span class="o">=</span> <span class="n">arg</span><span class="p">.</span><span class="n">variable</span>
            <span class="n">variable</span><span class="p">.</span><span class="n">reference</span><span class="p">(</span><span class="n">variable</span><span class="p">.</span><span class="n">node</span><span class="p">,</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">).</span><span class="k">explicit</span> <span class="o">=</span> <span class="nb">false</span>
          <span class="n">end</span>
        <span class="n">end</span>
        <span class="nb">true</span>
      <span class="n">when</span> <span class="err">@</span><span class="n">current_scope</span><span class="p">.</span><span class="n">top_level</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">record_macro</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
        <span class="nb">false</span>
      <span class="k">else</span>
        <span class="nb">true</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">record_macro</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">RECORD_NODE_NAME</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">first</span><span class="o">?</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Path</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">skip</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="o">!!</span><span class="err">@</span><span class="n">skip</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="k">class</span><span class="p">))</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span>
  <span class="cp"># AST Visitor that visits certain nodes at a top level, which
</span>  <span class="cp"># can characterize the source (i.e. require statements, modules etc.)
</span>  <span class="k">class</span> <span class="nc">TopLevelNodesVisitor</span> <span class="o">&lt;</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Visitor</span>
    <span class="n">getter</span> <span class="n">require_nodes</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Require</span>

    <span class="cp"># Creates a new instance of visitor
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">scope</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="err">@</span><span class="n">scope</span><span class="p">.</span><span class="n">accept</span><span class="p">(</span><span class="n">self</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :nodoc:
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Require</span><span class="p">)</span>
      <span class="n">require_nodes</span> <span class="o">&lt;&lt;</span> <span class="n">node</span>
      <span class="nb">true</span>
    <span class="n">end</span>

    <span class="cp"># If a top level node is `Crystal::Expressions`,
</span>    <span class="cp"># then always traverse the children.
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span><span class="p">)</span>
      <span class="nb">true</span>
    <span class="n">end</span>

    <span class="cp"># A general visit method for rest of the nodes.
</span>    <span class="cp"># Returns `false`, meaning all child nodes will not be traversed.
</span>    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="nb">false</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./ameba/ext/**"
# Extensions to Crystal::Location
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Ext</span><span class="o">::</span><span class="n">Location</span>
  <span class="cp"># Returns the same location as this location but with the line and/or column number(s) changed
</span>  <span class="cp"># to the given value(s).
</span>  <span class="n">def</span> <span class="n">with</span><span class="p">(</span><span class="n">line_number</span> <span class="o">=</span> <span class="err">@</span><span class="n">line_number</span><span class="p">,</span> <span class="n">column_number</span> <span class="o">=</span> <span class="err">@</span><span class="n">column_number</span><span class="p">)</span> <span class="o">:</span> <span class="n">self</span>
    <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">filename</span><span class="p">,</span> <span class="n">line_number</span><span class="p">,</span> <span class="n">column_number</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="cp"># Returns the same location as this location but with the line and/or column number(s) adjusted
</span>  <span class="cp"># by the given amount(s).
</span>  <span class="n">def</span> <span class="n">adjust</span><span class="p">(</span><span class="n">line_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">column_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">:</span> <span class="n">self</span>
    <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">filename</span><span class="p">,</span> <span class="err">@</span><span class="n">line_number</span> <span class="o">+</span> <span class="n">line_number</span><span class="p">,</span> <span class="err">@</span><span class="n">column_number</span> <span class="o">+</span> <span class="n">column_number</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="cp"># Seeks to a given *offset* relative to `self`.
</span>  <span class="n">def</span> <span class="n">seek</span><span class="p">(</span><span class="n">offset</span> <span class="o">:</span> <span class="n">self</span><span class="p">)</span> <span class="o">:</span> <span class="n">self</span>
    <span class="k">if</span> <span class="n">offset</span><span class="p">.</span><span class="n">filename</span><span class="p">.</span><span class="n">as</span><span class="o">?</span><span class="p">(</span><span class="n">String</span><span class="p">).</span><span class="n">presence</span> <span class="o">&amp;&amp;</span> <span class="err">@</span><span class="n">filename</span> <span class="o">!=</span> <span class="n">offset</span><span class="p">.</span><span class="n">filename</span>
      <span class="n">raise</span> <span class="n">ArgumentError</span><span class="p">.</span><span class="k">new</span> <span class="o">&lt;&lt;-</span><span class="n">MSG</span>
        <span class="n">Mismatching</span> <span class="n">filenames</span><span class="o">:</span>
          <span class="cp">#{@filename}
</span>          <span class="cp">#{offset.filename}
</span>        <span class="n">MSG</span>
    <span class="n">end</span>

    <span class="k">if</span> <span class="n">offset</span><span class="p">.</span><span class="n">line_number</span> <span class="o">==</span> <span class="mi">1</span>
      <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">filename</span><span class="p">,</span> <span class="err">@</span><span class="n">line_number</span><span class="p">,</span> <span class="err">@</span><span class="n">column_number</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">column_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span>
      <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="err">@</span><span class="n">filename</span><span class="p">,</span> <span class="err">@</span><span class="n">line_number</span> <span class="o">+</span> <span class="n">offset</span><span class="p">.</span><span class="n">line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">offset</span><span class="p">.</span><span class="n">column_number</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="k">class</span> <span class="nc">Crystal</span><span class="o">::</span><span class="n">Location</span>
  <span class="n">include</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Ext</span><span class="o">::</span><span class="n">Location</span>
<span class="n">end</span>

<span class="cp"># require "./ameba/rule/**"
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span>
  <span class="cp"># List of names of the special rules, which
</span>  <span class="cp"># behave differently than usual rules.
</span>  <span class="n">SPECIAL</span> <span class="o">=</span> <span class="p">{</span>
    <span class="n">Lint</span><span class="o">::</span><span class="n">Syntax</span><span class="p">.</span><span class="n">rule_name</span><span class="p">,</span>
    <span class="n">Lint</span><span class="o">::</span><span class="n">UnneededDisableDirective</span><span class="p">.</span><span class="n">rule_name</span><span class="p">,</span>
  <span class="p">}</span>

  <span class="cp"># Represents a base of all rules. In other words, all rules
</span>  <span class="cp"># inherits from this struct:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># class MyRule &lt; Ameba::Rule::Base
</span>  <span class="cp">#   def test(source)
</span>  <span class="cp">#     if invalid?(source)
</span>  <span class="cp">#       issue_for line, column, "Something wrong."
</span>  <span class="cp">#     end
</span>  <span class="cp">#   end
</span>  <span class="cp">#
</span>  <span class="cp">#   private def invalid?(source)
</span>  <span class="cp">#     # ...
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># Enforces rules to implement an abstract `#test` method which
</span>  <span class="cp"># is designed to test the source passed in. If source has issues
</span>  <span class="cp"># that are tested by this rule, it should add an issue.
</span>  <span class="n">abstract</span> <span class="k">class</span> <span class="nc">Base</span>
    <span class="n">include</span> <span class="n">Config</span><span class="o">::</span><span class="n">RuleConfig</span>

    <span class="cp"># This method is designed to test the source passed in. If source has issues
</span>    <span class="cp"># that are tested by this rule, it should add an issue.
</span>    <span class="cp">#
</span>    <span class="cp"># Be default it uses a node visitor to traverse all the nodes in the source.
</span>    <span class="cp"># NOTE: Must be overridden for other type of rules.
</span>    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">)</span>
      <span class="n">AST</span><span class="o">::</span><span class="n">NodeVisitor</span><span class="p">.</span><span class="k">new</span> <span class="n">self</span><span class="p">,</span> <span class="n">source</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="o">*</span><span class="n">opts</span><span class="p">)</span>
      <span class="cp"># can't be abstract
</span>    <span class="n">end</span>

    <span class="cp"># A convenient addition to `#test` method that does the same
</span>    <span class="cp"># but returns a passed in `source` as an addition.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># source = MyRule.new.catch(source)
</span>    <span class="cp"># source.valid?
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="k">catch</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">)</span>
      <span class="n">source</span><span class="p">.</span><span class="n">tap</span> <span class="p">{</span> <span class="n">test</span> <span class="n">source</span> <span class="p">}</span>
    <span class="n">end</span>

    <span class="cp"># Returns a name of this rule, which is basically a class name.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># class MyRule &lt; Ameba::Rule::Base
</span>    <span class="cp">#   def test(source)
</span>    <span class="cp">#   end
</span>    <span class="cp"># end
</span>    <span class="cp">#
</span>    <span class="cp"># MyRule.new.name # =&gt; "MyRule"
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">name</span>
      <span class="p">{{</span> <span class="err">@</span><span class="n">type</span> <span class="p">}}.</span><span class="n">rule_name</span>
    <span class="n">end</span>

    <span class="cp"># Returns a group this rule belong to.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># class MyGroup::MyRule &lt; Ameba::Rule::Base
</span>    <span class="cp">#   # ...
</span>    <span class="cp"># end
</span>    <span class="cp">#
</span>    <span class="cp"># MyGroup::MyRule.new.group # =&gt; "MyGroup"
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">group</span>
      <span class="p">{{</span> <span class="err">@</span><span class="n">type</span> <span class="p">}}.</span><span class="n">group_name</span>
    <span class="n">end</span>

    <span class="cp"># Checks whether the source is excluded from this rule.
</span>    <span class="cp"># It searches for a path in `excluded` property which matches
</span>    <span class="cp"># the one of the given source.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># my_rule.excluded?(source) # =&gt; true or false
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">excluded</span><span class="o">?</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="o">!!</span><span class="n">excluded</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">any</span><span class="o">?</span> <span class="k">do</span> <span class="o">|</span><span class="n">path</span><span class="o">|</span>
        <span class="n">source</span><span class="p">.</span><span class="n">matches_path</span><span class="o">?</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="o">||</span>
          <span class="n">Dir</span><span class="p">.</span><span class="n">glob</span><span class="p">(</span><span class="n">path</span><span class="p">).</span><span class="n">any</span><span class="o">?</span> <span class="p">{</span> <span class="o">|</span><span class="n">glob</span><span class="o">|</span> <span class="n">source</span><span class="p">.</span><span class="n">matches_path</span><span class="o">?</span><span class="p">(</span><span class="n">glob</span><span class="p">)</span> <span class="p">}</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if this rule is special and behaves differently than
</span>    <span class="cp"># usual rules.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># my_rule.special? # =&gt; true or false
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">special</span><span class="o">?</span>
      <span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">SPECIAL</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="o">==</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
      <span class="n">name</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">hash</span>
      <span class="n">name</span><span class="p">.</span><span class="n">hash</span>
    <span class="n">end</span>

    <span class="n">macro</span> <span class="n">issue_for</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="n">source</span><span class="p">.</span><span class="n">add_issue</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="p">{{</span> <span class="o">*</span><span class="n">args</span> <span class="p">}},</span> <span class="p">{{</span> <span class="o">**</span><span class="n">kwargs</span> <span class="p">}})</span> <span class="p">{{</span> <span class="n">block</span> <span class="p">}}</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">rule_name</span>
      <span class="n">name</span><span class="p">.</span><span class="n">gsub</span><span class="p">(</span><span class="s">"Ameba::Rule::"</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">gsub</span><span class="p">(</span><span class="s">"::"</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">group_name</span>
      <span class="n">rule_name</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">'/'</span><span class="p">)[</span><span class="mf">0.</span><span class="p">..</span><span class="o">-</span><span class="mi">1</span><span class="p">].</span><span class="n">join</span><span class="p">(</span><span class="sc">'/'</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">subclasses</span>
      <span class="p">{{</span> <span class="err">@</span><span class="n">type</span><span class="p">.</span><span class="n">subclasses</span> <span class="p">}}</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">abstract</span><span class="o">?</span>
      <span class="p">{{</span> <span class="err">@</span><span class="n">type</span><span class="p">.</span><span class="n">abstract</span><span class="o">?</span> <span class="p">}}</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">inherited_rules</span>
      <span class="n">subclasses</span><span class="p">.</span><span class="n">each_with_object</span><span class="p">([]</span> <span class="n">of</span> <span class="n">Base</span><span class="p">.</span><span class="k">class</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">klass</span><span class="p">,</span> <span class="n">obj</span><span class="o">|</span>
        <span class="n">klass</span><span class="p">.</span><span class="n">abstract</span><span class="o">?</span> <span class="o">?</span> <span class="n">obj</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="n">klass</span><span class="p">.</span><span class="n">inherited_rules</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">obj</span> <span class="o">&lt;&lt;</span> <span class="n">klass</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">macro</span> <span class="nf">read_type_doc</span><span class="p">(</span><span class="n">filepath</span> <span class="o">=</span> <span class="n">__FILE__</span><span class="p">)</span>
      <span class="p">{{</span> <span class="n">run</span><span class="p">(</span><span class="s">"../../contrib/read_type_doc"</span><span class="p">,</span>
           <span class="err">@</span><span class="n">type</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"::"</span><span class="p">).</span><span class="n">last</span><span class="p">,</span>
           <span class="n">filepath</span>
         <span class="p">).</span><span class="n">chomp</span><span class="p">.</span><span class="n">stringify</span> <span class="p">}}.</span><span class="n">presence</span>
    <span class="n">end</span>

    <span class="n">macro</span> <span class="n">inherited</span>
      <span class="cp"># Returns documentation for this rule, if there is any.
</span>      <span class="cp">#
</span>      <span class="cp"># ```
</span>      <span class="cp"># module Ameba
</span>      <span class="cp">#   # This is a test rule.
</span>      <span class="cp">#   # Does nothing.
</span>      <span class="cp">#   class MyRule &lt; Ameba::Rule::Base
</span>      <span class="cp">#     def test(source)
</span>      <span class="cp">#     end
</span>      <span class="cp">#   end
</span>      <span class="cp"># end
</span>      <span class="cp">#
</span>      <span class="cp"># MyRule.parsed_doc # =&gt; "This is a test rule.\nDoes nothing."
</span>      <span class="cp"># ```
</span>      <span class="n">class_getter</span> <span class="n">parsed_doc</span> <span class="o">:</span> <span class="n">String</span><span class="o">?</span> <span class="o">=</span> <span class="n">read_type_doc</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># Returns a list of all available rules.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Ameba::Rule.rules # =&gt; [Rule1, Rule2, ....]
</span>  <span class="cp"># ```
</span>  <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">rules</span>
    <span class="n">Base</span><span class="p">.</span><span class="n">inherited_rules</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Layout</span>
  <span class="cp"># A rule that disallows lines longer than `max_length` number of symbols.
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Layout/LineLength:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp">#   MaxLength: 100
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">LineLength</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">enabled</span> <span class="nb">false</span>
      <span class="n">description</span> <span class="s">"Disallows lines longer than `MaxLength` number of symbols"</span>
      <span class="n">max_length</span> <span class="mi">140</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Line too long"</span>

    <span class="n">def</span> <span class="nf">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
        <span class="n">issue_for</span><span class="p">({</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_length</span> <span class="o">+</span> <span class="mi">1</span><span class="p">},</span> <span class="n">MSG</span><span class="p">)</span> <span class="k">if</span> <span class="n">line</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">max_length</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Layout</span>
  <span class="cp"># A rule that disallows trailing blank lines at the end of the source file.
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Layout/TrailingBlankLines:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">TrailingBlankLines</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows trailing blank lines"</span>
    <span class="n">end</span>

    <span class="n">MSG</span>               <span class="o">=</span> <span class="s">"Excessive trailing newline detected"</span>
    <span class="n">MSG_FINAL_NEWLINE</span> <span class="o">=</span> <span class="s">"Trailing newline missing"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">source_lines</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">source_lines</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>

      <span class="n">last_source_line</span> <span class="o">=</span> <span class="n">source_lines</span><span class="p">.</span><span class="n">last</span>
      <span class="n">source_lines_size</span> <span class="o">=</span> <span class="n">source_lines</span><span class="p">.</span><span class="n">size</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">source_lines_size</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">last_source_line</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>

      <span class="n">last_line_empty</span> <span class="o">=</span> <span class="n">last_source_line</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">source_lines_size</span><span class="p">.</span><span class="n">zero</span><span class="o">?</span> <span class="o">||</span>
                <span class="p">(</span><span class="n">source_lines</span><span class="p">.</span><span class="n">last</span><span class="p">(</span><span class="mi">2</span><span class="p">).</span><span class="n">join</span><span class="p">.</span><span class="n">presence</span> <span class="o">&amp;&amp;</span> <span class="n">last_line_empty</span><span class="p">)</span>

      <span class="k">if</span> <span class="n">last_line_empty</span>
        <span class="n">issue_for</span><span class="p">({</span><span class="n">source_lines_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="n">MSG</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">issue_for</span><span class="p">({</span><span class="n">source_lines_size</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="n">MSG_FINAL_NEWLINE</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
          <span class="n">corrector</span><span class="p">.</span><span class="n">insert_before</span><span class="p">({</span><span class="n">source_lines_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="sc">'\n'</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Layout</span>
  <span class="cp"># A rule that disallows trailing whitespace.
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Layout/TrailingWhitespace:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">TrailingWhitespace</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows trailing whitespace"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Trailing whitespace detected"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="p">,</span> <span class="n">index</span><span class="o">|</span>
        <span class="n">next</span> <span class="n">unless</span> <span class="n">ws_index</span> <span class="o">=</span> <span class="n">line</span> <span class="o">=~</span> <span class="o">/</span><span class="err">\</span><span class="n">s</span><span class="o">+</span><span class="err">$</span><span class="o">/</span>

        <span class="n">location</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ws_index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">}</span>
        <span class="n">end_location</span> <span class="o">=</span> <span class="p">{</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">line</span><span class="p">.</span><span class="n">size</span><span class="p">}</span>

        <span class="n">issue_for</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
          <span class="n">corrector</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># This rule checks for mistyped shorthand assignments.
</span>  <span class="cp">#
</span>  <span class="cp"># This is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># x = -y
</span>  <span class="cp"># x = +y
</span>  <span class="cp"># x = !y
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And this is valid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># x -= y # or x = -y
</span>  <span class="cp"># x += y # or x = +y
</span>  <span class="cp"># x != y # or x = !y
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/AmbiguousAssignment:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">AmbiguousAssignment</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows ambiguous `=-/=+/=!`"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Suspicious assignment detected. Did you mean `%s`?"</span>

    <span class="n">MISTAKES</span> <span class="o">=</span> <span class="p">{</span>
      <span class="s">"=-"</span><span class="o">:</span> <span class="s">"-="</span><span class="p">,</span>
      <span class="s">"=+"</span><span class="o">:</span> <span class="s">"+="</span><span class="p">,</span>
      <span class="s">"=!"</span><span class="o">:</span> <span class="s">"!="</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">op_end_location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">location</span>

      <span class="n">op_location</span> <span class="o">=</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="p">.</span><span class="k">new</span><span class="p">(</span>
        <span class="n">op_end_location</span><span class="p">.</span><span class="n">filename</span><span class="p">,</span>
        <span class="n">op_end_location</span><span class="p">.</span><span class="n">line_number</span><span class="p">,</span>
        <span class="n">op_end_location</span><span class="p">.</span><span class="n">column_number</span> <span class="o">-</span> <span class="mi">1</span>
      <span class="p">)</span>
      <span class="n">op_text</span> <span class="o">=</span> <span class="n">source_between</span><span class="p">(</span><span class="n">op_location</span><span class="p">,</span> <span class="n">op_end_location</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">op_text</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">suggestion</span> <span class="o">=</span> <span class="n">MISTAKES</span><span class="p">[</span><span class="n">op_text</span><span class="p">]</span><span class="o">?</span>

      <span class="n">issue_for</span> <span class="n">op_location</span><span class="p">,</span> <span class="n">op_end_location</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="n">suggestion</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that reports incorrect comment directives for Ameba.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, the user can mistakenly add a directive
</span>  <span class="cp"># to disable a rule that even doesn't exist:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># # ameba:disable BadRuleName
</span>  <span class="cp"># def foo
</span>  <span class="cp">#   :bar
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/BadDirective:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">BadDirective</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Reports bad comment directives"</span>
    <span class="n">end</span>

    <span class="n">AVAILABLE_ACTIONS</span> <span class="o">=</span> <span class="n">InlineComments</span><span class="o">::</span><span class="n">Action</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">downcase</span><span class="p">)</span>
    <span class="n">ALL_RULE_NAMES</span>    <span class="o">=</span> <span class="n">Rule</span><span class="p">.</span><span class="n">rules</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">rule_name</span><span class="p">)</span>
    <span class="n">ALL_GROUP_NAMES</span>   <span class="o">=</span> <span class="n">Rule</span><span class="p">.</span><span class="n">rules</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">group_name</span><span class="p">).</span><span class="n">uniq</span><span class="o">!</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">Tokenizer</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">source</span><span class="p">).</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">token</span><span class="o">|</span>
        <span class="n">next</span> <span class="n">unless</span> <span class="n">token</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">comment</span><span class="o">?</span>
        <span class="n">next</span> <span class="n">unless</span> <span class="n">directive</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">parse_inline_directive</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">to_s</span><span class="p">)</span>

        <span class="n">check_action</span> <span class="n">source</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">directive</span><span class="p">[</span><span class="o">:</span><span class="n">action</span><span class="p">]</span>
        <span class="n">check_rules</span> <span class="n">source</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">directive</span><span class="p">[</span><span class="o">:</span><span class="n">rules</span><span class="p">]</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">check_action</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">action</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">InlineComments</span><span class="o">::</span><span class="n">Action</span><span class="p">.</span><span class="n">parse</span><span class="o">?</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>

      <span class="n">issue_for</span> <span class="n">token</span><span class="p">,</span>
        <span class="s">"Bad action in comment directive: '%s'. Possible values: %s"</span> <span class="o">%</span> <span class="p">{</span>
          <span class="n">action</span><span class="p">,</span> <span class="n">AVAILABLE_ACTIONS</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">", "</span><span class="p">),</span>
        <span class="p">}</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">check_rules</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">token</span><span class="p">,</span> <span class="n">rules</span><span class="p">)</span>
      <span class="n">bad_names</span> <span class="o">=</span> <span class="n">rules</span> <span class="o">-</span> <span class="n">ALL_RULE_NAMES</span> <span class="o">-</span> <span class="n">ALL_GROUP_NAMES</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">bad_names</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>

      <span class="n">issue_for</span> <span class="n">token</span><span class="p">,</span> <span class="s">"Such rules do not exist: %s"</span> <span class="o">%</span> <span class="n">bad_names</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">", "</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows comparison to booleans.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, these are considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># foo == true
</span>  <span class="cp"># bar != false
</span>  <span class="cp"># false === baz
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># This is because these expressions evaluate to `true` or `false`, so you
</span>  <span class="cp"># could get the same result by using either the variable directly,
</span>  <span class="cp"># or negating the variable.
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/ComparisonToBoolean:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">ComparisonToBoolean</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">enabled</span> <span class="nb">false</span>
      <span class="n">description</span> <span class="s">"Disallows comparison to booleans"</span>
    <span class="n">end</span>

    <span class="n">MSG</span>      <span class="o">=</span> <span class="s">"Comparison to a boolean is pointless"</span>
    <span class="n">OP_NAMES</span> <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">(</span><span class="o">==</span> <span class="o">!=</span> <span class="o">===</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">OP_NAMES</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span>

      <span class="n">arg</span><span class="p">,</span> <span class="n">obj</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">first</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">obj</span>
      <span class="k">case</span>
      <span class="n">when</span> <span class="n">arg</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">BoolLiteral</span><span class="p">)</span>
        <span class="kt">bool</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">arg</span><span class="p">,</span> <span class="n">obj</span>
      <span class="n">when</span> <span class="n">obj</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">BoolLiteral</span><span class="p">)</span>
        <span class="kt">bool</span><span class="p">,</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">obj</span><span class="p">,</span> <span class="n">arg</span>
      <span class="n">end</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="kt">bool</span> <span class="o">&amp;&amp;</span> <span class="n">exp</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">exp_code</span> <span class="o">=</span> <span class="n">node_source</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>

      <span class="n">not</span> <span class="o">=</span>
        <span class="k">case</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span>
        <span class="n">when</span> <span class="s">"=="</span><span class="p">,</span> <span class="s">"==="</span> <span class="n">then</span> <span class="o">!</span><span class="kt">bool</span><span class="p">.</span><span class="n">value</span> <span class="err">#</span> <span class="n">foo</span> <span class="o">==</span> <span class="nb">false</span>
        <span class="n">when</span> <span class="s">"!="</span>        <span class="n">then</span> <span class="kt">bool</span><span class="p">.</span><span class="n">value</span>  <span class="err">#</span> <span class="n">foo</span> <span class="o">!=</span> <span class="nb">true</span>
        <span class="n">end</span>

      <span class="n">exp_code</span> <span class="o">=</span> <span class="s">"!#{exp_code}"</span> <span class="k">if</span> <span class="n">not</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exp_code</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows calls to debug-related methods.
</span>  <span class="cp">#
</span>  <span class="cp"># This is because we don't want debug calls accidentally being
</span>  <span class="cp"># committed into our codebase.
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/DebugCalls:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp">#   MethodNames:
</span>  <span class="cp">#     - p
</span>  <span class="cp">#     - p!
</span>  <span class="cp">#     - pp
</span>  <span class="cp">#     - pp!
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">DebugCalls</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows debug-related calls"</span>
      <span class="n">method_names</span> <span class="p">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">(</span><span class="n">p</span> <span class="n">p</span><span class="o">!</span> <span class="n">pp</span> <span class="n">pp</span><span class="o">!</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Possibly forgotten debug-related `%s` call detected"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">method_names</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows calls to debugger.
</span>  <span class="cp">#
</span>  <span class="cp"># This is because we don't want debugger breakpoints accidentally being
</span>  <span class="cp"># committed into our codebase.
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/DebuggerStatement:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">DebuggerStatement</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows calls to debugger"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Possible forgotten debugger statement detected"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">"debugger"</span> <span class="o">&amp;&amp;</span>
                    <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">&amp;&amp;</span>
                    <span class="n">node</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that reports duplicated require statements.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># require "./thing"
</span>  <span class="cp"># require "./stuff"
</span>  <span class="cp"># require "./thing" # duplicated require
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/DuplicatedRequire:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">DuplicatedRequire</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Reports duplicated require statements"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Duplicated require of `%s`"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">nodes</span> <span class="o">=</span> <span class="n">AST</span><span class="o">::</span><span class="n">TopLevelNodesVisitor</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">source</span><span class="p">.</span><span class="n">ast</span><span class="p">).</span><span class="n">require_nodes</span>
      <span class="n">nodes</span><span class="p">.</span><span class="n">each_with_object</span><span class="p">([]</span> <span class="n">of</span> <span class="n">String</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">node</span><span class="p">,</span> <span class="n">processed_require_strings</span><span class="o">|</span>
        <span class="n">issue_for</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="n">node</span><span class="p">.</span><span class="n">string</span><span class="p">)</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">string</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">processed_require_strings</span><span class="p">)</span>
        <span class="n">processed_require_strings</span> <span class="o">&lt;&lt;</span> <span class="n">node</span><span class="p">.</span><span class="n">string</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows empty ensure statement.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def some_method
</span>  <span class="cp">#   do_some_stuff
</span>  <span class="cp"># ensure
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># begin
</span>  <span class="cp">#   do_some_stuff
</span>  <span class="cp"># ensure
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And it should be written as this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def some_method
</span>  <span class="cp">#   do_some_stuff
</span>  <span class="cp"># ensure
</span>  <span class="cp">#   do_something_else
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># begin
</span>  <span class="cp">#   do_some_stuff
</span>  <span class="cp"># ensure
</span>  <span class="cp">#   do_something_else
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/EmptyEnsure
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">EmptyEnsure</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows empty ensure statement"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Empty `ensure` block detected"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ExceptionHandler</span><span class="p">)</span>
      <span class="n">node_ensure</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">ensure</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">node_ensure</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="o">!</span><span class="n">node_ensure</span><span class="p">.</span><span class="n">nop</span><span class="o">?</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">.</span><span class="n">ensure_location</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">end_location</span><span class="p">,</span> <span class="n">MSG</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows empty expressions.
</span>  <span class="cp">#
</span>  <span class="cp"># This is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># foo = ()
</span>  <span class="cp">#
</span>  <span class="cp"># if ()
</span>  <span class="cp">#   bar
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And this is valid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># foo = (some_expression)
</span>  <span class="cp">#
</span>  <span class="cp"># if (some_expression)
</span>  <span class="cp">#   bar
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/EmptyExpression:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">EmptyExpression</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows empty expressions"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Avoid empty expressions"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">expressions</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">expressions</span><span class="p">.</span><span class="n">first</span><span class="p">.</span><span class="n">nop</span><span class="o">?</span>
      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows empty loops.
</span>  <span class="cp">#
</span>  <span class="cp"># This is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># while false
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># until 10
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># loop do
</span>  <span class="cp">#   # nothing here
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And this is valid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># a = 1
</span>  <span class="cp"># while a &lt; 10
</span>  <span class="cp">#   a += 1
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># until socket_opened?
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># loop do
</span>  <span class="cp">#   do_something_here
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/EmptyLoop:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">EmptyLoop</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows empty loops"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Empty loop detected"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="n">check_node</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">block</span><span class="p">)</span> <span class="k">if</span> <span class="n">loop</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Until</span><span class="p">)</span>
      <span class="n">check_node</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span><span class="p">)</span> <span class="k">if</span> <span class="n">literal</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">check_node</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">loop_body</span><span class="p">)</span>
      <span class="n">body</span> <span class="o">=</span> <span class="n">loop_body</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Block</span><span class="p">)</span> <span class="o">?</span> <span class="n">loop_body</span><span class="p">.</span><span class="n">body</span> <span class="o">:</span> <span class="n">loop_body</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">body</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">body</span><span class="p">.</span><span class="n">nop</span><span class="o">?</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">require</span> <span class="s">"compiler/crystal/formatter"</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that verifies syntax formatting according to the
</span>  <span class="cp"># Crystal's built-in formatter.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this syntax is invalid:
</span>  <span class="cp">#
</span>  <span class="cp">#     def foo(a,b,c=0)
</span>  <span class="cp">#       #foobar
</span>  <span class="cp">#       a+b+c
</span>  <span class="cp">#     end
</span>  <span class="cp">#
</span>  <span class="cp"># And should be properly written:
</span>  <span class="cp">#
</span>  <span class="cp">#     def foo(a, b, c = 0)
</span>  <span class="cp">#       # foobar
</span>  <span class="cp">#       a + b + c
</span>  <span class="cp">#     end
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/Formatting:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp">#   FailOnError: false
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">Formatting</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Reports not formatted sources"</span>
      <span class="n">fail_on_error</span> <span class="nb">false</span>
    <span class="n">end</span>

    <span class="n">MSG</span>       <span class="o">=</span> <span class="s">"Use built-in formatter to format this source"</span>
    <span class="n">MSG_ERROR</span> <span class="o">=</span> <span class="s">"Error while formatting: %s"</span>

    <span class="k">private</span> <span class="n">LOCATION</span> <span class="o">=</span> <span class="p">{</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">}</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">source_code</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">code</span>
      <span class="n">result</span> <span class="o">=</span> <span class="n">Crystal</span><span class="p">.</span><span class="n">format</span><span class="p">(</span><span class="n">source_code</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">path</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">result</span> <span class="o">==</span> <span class="n">source_code</span>

      <span class="n">source_lines</span> <span class="o">=</span> <span class="n">source_code</span><span class="p">.</span><span class="n">lines</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">source_lines</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>

      <span class="n">end_location</span> <span class="o">=</span> <span class="p">{</span>
        <span class="n">source_lines</span><span class="p">.</span><span class="n">size</span><span class="p">,</span>
        <span class="n">source_lines</span><span class="p">.</span><span class="n">last</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
      <span class="p">}</span>

      <span class="n">issue_for</span> <span class="n">LOCATION</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">LOCATION</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">rescue</span> <span class="n">ex</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">SyntaxException</span>
      <span class="k">if</span> <span class="n">fail_on_error</span><span class="o">?</span>
        <span class="n">issue_for</span><span class="p">({</span><span class="n">ex</span><span class="p">.</span><span class="n">line_number</span><span class="p">,</span> <span class="n">ex</span><span class="p">.</span><span class="n">column_number</span><span class="p">},</span> <span class="n">MSG_ERROR</span> <span class="o">%</span> <span class="n">ex</span><span class="p">.</span><span class="n">message</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">rescue</span> <span class="n">ex</span>
      <span class="k">if</span> <span class="n">fail_on_error</span><span class="o">?</span>
        <span class="n">issue_for</span><span class="p">(</span><span class="n">LOCATION</span><span class="p">,</span> <span class="n">MSG_ERROR</span> <span class="o">%</span> <span class="n">ex</span><span class="p">.</span><span class="n">message</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows duplicated keys in hash literals.
</span>  <span class="cp">#
</span>  <span class="cp"># This is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># h = {"foo" =&gt; 1, "bar" =&gt; 2, "foo" =&gt; 3}
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And it has to written as this instead:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># h = {"foo" =&gt; 1, "bar" =&gt; 2}
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/HashDuplicatedKey:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">HashDuplicatedKey</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows duplicated keys in hash literals"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Duplicated keys in hash literal: %s"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">HashLiteral</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">keys</span> <span class="o">=</span> <span class="n">duplicated_keys</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">entries</span><span class="p">)).</span><span class="n">empty</span><span class="o">?</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="n">keys</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">", "</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">duplicated_keys</span><span class="p">(</span><span class="n">entries</span><span class="p">)</span>
      <span class="n">entries</span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">key</span><span class="p">)</span>
        <span class="p">.</span><span class="n">group_by</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">itself</span><span class="p">)</span>
        <span class="p">.</span><span class="n">select</span><span class="o">!</span> <span class="p">{</span> <span class="o">|</span><span class="n">_</span><span class="p">,</span> <span class="n">v</span><span class="o">|</span> <span class="n">v</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="p">}</span>
        <span class="p">.</span><span class="n">map</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span> <span class="n">_</span><span class="o">|</span> <span class="n">k</span> <span class="p">}</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows assignments with literal values
</span>  <span class="cp"># in control expressions.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># if foo = 42
</span>  <span class="cp">#   do_something
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And most likely should be replaced by the following:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># if foo == 42
</span>  <span class="cp">#   do_something
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/LiteralAssignmentsInExpressions:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">LiteralAssignmentsInExpressions</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows assignments with literal values in control expressions"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Detected assignment with a literal value in control expression"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Case</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Until</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="p">(</span><span class="n">cond</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">literal</span><span class="o">?</span><span class="p">(</span><span class="n">cond</span><span class="p">.</span><span class="n">value</span><span class="p">)</span>

      <span class="n">issue_for</span> <span class="n">cond</span><span class="p">,</span> <span class="n">MSG</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows useless conditional statements that contain a literal
</span>  <span class="cp"># in place of a variable or predicate function.
</span>  <span class="cp">#
</span>  <span class="cp"># This is because a conditional construct with a literal predicate will
</span>  <span class="cp"># always result in the same behaviour at run time, meaning it can be
</span>  <span class="cp"># replaced with either the body of the construct, or deleted entirely.
</span>  <span class="cp">#
</span>  <span class="cp"># This is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># if "something"
</span>  <span class="cp">#   :ok
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/LiteralInCondition:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">LiteralInCondition</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows useless conditional statements that contain \
        a literal in place of a variable or predicate function"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Literal value found in conditional"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Case</span><span class="p">)</span>
      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">if</span> <span class="n">static_literal</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows useless string interpolations
</span>  <span class="cp"># that contain a literal value instead of a variable or function.
</span>  <span class="cp">#
</span>  <span class="cp"># For example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># "Hello, #{:Ary}"
</span>  <span class="cp"># "There are #{4} cats"
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/LiteralInInterpolation
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">LiteralInInterpolation</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows useless string interpolations"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Literal value found in interpolation"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">StringInterpolation</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">expressions</span>
        <span class="p">.</span><span class="n">select</span> <span class="p">{</span> <span class="o">|</span><span class="n">exp</span><span class="o">|</span> <span class="o">!</span><span class="n">exp</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">StringLiteral</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">literal</span><span class="o">?</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="p">}</span>
        <span class="p">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">exp</span><span class="o">|</span> <span class="n">issue_for</span> <span class="n">exp</span><span class="p">,</span> <span class="n">MSG</span> <span class="p">}</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># This rule is used to identify comparisons between two literals.
</span>  <span class="cp">#
</span>  <span class="cp"># They usually have the same result - except for non-primitive
</span>  <span class="cp"># types like containers, range or regex.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this will be always false:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># "foo" == 42
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/LiteralsComparison:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">LiteralsComparison</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Identifies comparisons between literals"</span>
    <span class="n">end</span>

    <span class="n">OP_NAMES</span> <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">(</span><span class="o">===</span> <span class="o">==</span> <span class="o">!=</span><span class="p">)</span>

    <span class="n">MSG</span>        <span class="o">=</span> <span class="s">"Comparison always evaluates to %s"</span>
    <span class="n">MSG_LIKELY</span> <span class="o">=</span> <span class="s">"Comparison most likely evaluates to %s"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">OP_NAMES</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="p">(</span><span class="n">obj</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">obj</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">arg</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">first</span><span class="o">?</span><span class="p">)</span>

      <span class="n">obj_is_literal</span><span class="p">,</span> <span class="n">obj_is_static</span> <span class="o">=</span> <span class="n">literal_kind</span><span class="o">?</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
      <span class="n">arg_is_literal</span><span class="p">,</span> <span class="n">arg_is_static</span> <span class="o">=</span> <span class="n">literal_kind</span><span class="o">?</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">obj_is_literal</span> <span class="o">&amp;&amp;</span> <span class="n">arg_is_literal</span>

      <span class="n">is_dynamic</span> <span class="o">=</span> <span class="o">!</span><span class="n">obj_is_static</span> <span class="o">||</span> <span class="o">!</span><span class="n">arg_is_static</span>

      <span class="n">what</span> <span class="o">=</span>
        <span class="k">case</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span>
        <span class="n">when</span> <span class="s">"==="</span> <span class="n">then</span> <span class="s">"the same"</span>
        <span class="n">when</span> <span class="s">"=="</span>  <span class="n">then</span> <span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="n">arg</span><span class="p">.</span><span class="n">to_s</span><span class="p">).</span><span class="n">to_s</span>
        <span class="n">when</span> <span class="s">"!="</span>  <span class="n">then</span> <span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">to_s</span> <span class="o">!=</span> <span class="n">arg</span><span class="p">.</span><span class="n">to_s</span><span class="p">).</span><span class="n">to_s</span>
        <span class="n">end</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="p">(</span><span class="n">is_dynamic</span> <span class="o">?</span> <span class="n">MSG_LIKELY</span> <span class="p">:</span> <span class="n">MSG</span><span class="p">)</span> <span class="o">%</span> <span class="n">what</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows yielding method definitions without block argument.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def foo
</span>  <span class="cp">#   yield 42
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And has to be written as the following:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def foo(&amp;)
</span>  <span class="cp">#   yield 42
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/MissingBlockArgument:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">MissingBlockArgument</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows yielding method definitions without block argument"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Missing anonymous block argument. Use `&amp;` as an argument "</span> \
          <span class="s">"name to indicate yielding method."</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">AST</span><span class="o">::</span><span class="n">ScopeVisitor</span><span class="p">.</span><span class="k">new</span> <span class="n">self</span><span class="p">,</span> <span class="n">source</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Def</span><span class="p">,</span> <span class="n">scope</span> <span class="o">:</span> <span class="n">AST</span><span class="o">::</span><span class="n">Scope</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="o">!</span><span class="n">scope</span><span class="p">.</span><span class="n">yields</span><span class="o">?</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="n">block_arg</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name_location</span>
      <span class="n">end_location</span> <span class="o">=</span> <span class="n">name_end_location</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

      <span class="n">issue_for</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">MSG</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># This rule is used to identify usages of `not_nil!` calls.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered a code smell:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># names = %w[Alice Bob]
</span>  <span class="cp"># alice = names.find { |name| name == "Alice" }.not_nil!
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And can be written as this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># names = %w[Alice Bob]
</span>  <span class="cp"># alice = names.find { |name| name == "Alice" }
</span>  <span class="cp">#
</span>  <span class="cp"># if alice
</span>  <span class="cp">#   # ...
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/NotNil:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">NotNil</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Identifies usage of `not_nil!` calls"</span>
    <span class="n">end</span>

    <span class="n">NOT_NIL_NAME</span> <span class="o">=</span> <span class="s">"not_nil!"</span>
    <span class="n">MSG</span>          <span class="o">=</span> <span class="s">"Avoid using `not_nil!`"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">AST</span><span class="o">::</span><span class="n">NodeVisitor</span><span class="p">.</span><span class="k">new</span> <span class="n">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">skip</span><span class="o">:</span> <span class="p">[</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">Macro</span><span class="p">,</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroExpression</span><span class="p">,</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroIf</span><span class="p">,</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroFor</span><span class="p">,</span>
      <span class="p">]</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">NOT_NIL_NAME</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">obj</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">name_location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name_location</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">end_location</span> <span class="o">=</span> <span class="n">name_end_location</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

      <span class="n">issue_for</span> <span class="n">name_location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">MSG</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># This rule is used to identify usage of `index/find` calls followed by `not_nil!`.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered a code smell:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># %w[Alice Bob].find(&amp;.match(/^A./)).not_nil!
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And can be written as this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># %w[Alice Bob].find!(&amp;.match(/^A./))
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/NotNilAfterNoBang:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">NotNilAfterNoBang</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Identifies usage of `index/find` calls followed by `not_nil!`"</span>
    <span class="n">end</span>

    <span class="n">BLOCK_CALL_NAMES</span> <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">(</span><span class="n">index</span> <span class="n">find</span><span class="p">)</span>
    <span class="n">CALL_NAMES</span>       <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>

    <span class="n">NOT_NIL_NAME</span> <span class="o">=</span> <span class="s">"not_nil!"</span>
    <span class="n">MSG</span>          <span class="o">=</span> <span class="s">"Use `%s! {...}` instead of `%s {...}.not_nil!`"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">AST</span><span class="o">::</span><span class="n">NodeVisitor</span><span class="p">.</span><span class="k">new</span> <span class="n">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">skip</span><span class="o">:</span> <span class="p">[</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">Macro</span><span class="p">,</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroExpression</span><span class="p">,</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroIf</span><span class="p">,</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroFor</span><span class="p">,</span>
      <span class="p">]</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">NOT_NIL_NAME</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="p">(</span><span class="n">obj</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">obj</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">obj</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">block</span> <span class="o">?</span> <span class="n">BLOCK_CALL_NAMES</span> <span class="o">:</span> <span class="n">CALL_NAMES</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">name_location</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">name_location</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name_location_end</span> <span class="o">=</span> <span class="n">name_end_location</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">end_location</span> <span class="o">=</span> <span class="n">name_end_location</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

      <span class="n">msg</span> <span class="o">=</span> <span class="n">MSG</span> <span class="o">%</span> <span class="p">{</span><span class="n">obj</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">.</span><span class="n">name</span><span class="p">}</span>

      <span class="n">issue_for</span> <span class="n">name_location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">msg</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">name_location_end</span><span class="p">,</span> <span class="sc">'!'</span><span class="p">)</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">remove_trailing</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="p">{{</span> <span class="s">".not_nil!"</span><span class="p">.</span><span class="n">size</span> <span class="p">}})</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span>
  <span class="cp"># A rule that disallows some unwanted symbols in percent array literals.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is usually written by mistake:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># %i(:one, :two)
</span>  <span class="cp"># %w("one", "two")
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And the expected example is:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># %i(one two)
</span>  <span class="cp"># %w(one two)
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Lint/PercentArrays:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp">#   StringArrayUnwantedSymbols: ',"'
</span>  <span class="cp">#   SymbolArrayUnwantedSymbols: ',:'
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">PercentArrays</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows some unwanted symbols in percent array literals"</span>

      <span class="n">string_array_unwanted_symbols</span> <span class="o">%</span><span class="p">(,</span><span class="s">")</span><span class="err">
</span><span class="s">      symbol_array_unwanted_symbols %(,:)</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Symbols</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span><span class="err">`</span> <span class="n">may</span> <span class="n">be</span> <span class="n">unwanted</span> <span class="n">in</span> <span class="o">%</span><span class="n">s</span> <span class="n">array</span> <span class="n">literals</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      issue = start_token = nil</span><span class="err">

</span><span class="s">      Tokenizer.new(source).run do |token|</span><span class="err">
</span><span class="s">        case token.type</span><span class="err">
</span><span class="s">        when .string_array_start?, .symbol_array_start?</span><span class="err">
</span><span class="s">          start_token = token.dup</span><span class="err">
</span><span class="s">        when .string?</span><span class="err">
</span><span class="s">          if (_start = start_token) &amp;&amp; !issue</span><span class="err">
</span><span class="s">            issue = array_entry_invalid?(token.value, _start.raw)</span><span class="err">
</span><span class="s">          end</span><span class="err">
</span><span class="s">        when .string_array_end?</span><span class="err">
</span><span class="s">          if (_start = start_token) &amp;&amp; (_issue = issue)</span><span class="err">
</span><span class="s">            issue_for _start, _issue</span><span class="err">
</span><span class="s">          end</span><span class="err">
</span><span class="s">          issue = start_token = nil</span><span class="err">
</span><span class="s">        end</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def array_entry_invalid?(entry, array_type)</span><span class="err">
</span><span class="s">      case array_type</span><span class="err">
</span><span class="s">      when .starts_with? "</span><span class="o">%</span><span class="n">w</span><span class="s">"</span><span class="err">
</span><span class="s">        check_array_entry entry, string_array_unwanted_symbols, "</span><span class="o">%</span><span class="n">w</span><span class="s">"</span><span class="err">
</span><span class="s">      when .starts_with? "</span><span class="o">%</span><span class="n">i</span><span class="s">"</span><span class="err">
</span><span class="s">        check_array_entry entry, symbol_array_unwanted_symbols, "</span><span class="o">%</span><span class="n">i</span><span class="s">"</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def check_array_entry(entry, symbols, literal)</span><span class="err">
</span><span class="s">      MSG % {symbols, literal} if entry =~ /[#{symbols}]/</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that disallows `rand(0)` and `rand(1)` calls.</span><span class="err">
</span><span class="s">  # Such calls always return `0`.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # rand(1)</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # Should be written as:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # rand</span><span class="err">
</span><span class="s">  # # or</span><span class="err">
</span><span class="s">  # rand(2)</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/RandZero:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class RandZero &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">rand</span> <span class="n">zero</span> <span class="n">calls</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="o">%</span><span class="n">s</span> <span class="n">always</span> <span class="n">returns</span> <span class="mi">0</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return unless node.name == "</span><span class="n">rand</span><span class="s">" &amp;&amp;</span><span class="err">
</span><span class="s">                    node.args.size == 1 &amp;&amp;</span><span class="err">
</span><span class="s">                    (arg = node.args.first).is_a?(Crystal::NumberLiteral) &amp;&amp;</span><span class="err">
</span><span class="s">                    arg.value.in?("</span><span class="mi">0</span><span class="s">", "</span><span class="mi">1</span><span class="s">")</span><span class="err">

</span><span class="s">      issue_for node, MSG % node</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that disallows string conversion in string interpolation,</span><span class="err">
</span><span class="s">  # which is redundant.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # "</span><span class="n">Hello</span><span class="p">,</span> <span class="err">#</span><span class="p">{</span><span class="n">name</span><span class="p">.</span><span class="n">to_s</span><span class="p">}</span><span class="s">"</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And this is valid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # "</span><span class="n">Hello</span><span class="p">,</span> <span class="err">#</span><span class="p">{</span><span class="n">name</span><span class="p">}</span><span class="s">"</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/RedundantStringCoercion</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class RedundantStringCoercion &lt; Base</span><span class="err">
</span><span class="s">    include AST::Util</span><span class="err">

</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">redundant</span> <span class="n">string</span> <span class="n">conversions</span> <span class="n">in</span> <span class="n">interpolation</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Redundant</span> <span class="n">use</span> <span class="n">of</span> <span class="err">`</span><span class="n">Object</span><span class="err">#</span><span class="n">to_s</span><span class="err">`</span> <span class="n">in</span> <span class="n">interpolation</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::StringInterpolation)</span><span class="err">
</span><span class="s">      string_coercion_nodes(node).each do |n|</span><span class="err">
</span><span class="s">        issue_for n.name_location, n.end_location, MSG</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def string_coercion_nodes(node)</span><span class="err">
</span><span class="s">      node.expressions.select do |exp|</span><span class="err">
</span><span class="s">        exp.is_a?(Crystal::Call) &amp;&amp;</span><span class="err">
</span><span class="s">          exp.name == "</span><span class="n">to_s</span><span class="s">" &amp;&amp;</span><span class="err">
</span><span class="s">          exp.args.size.zero? &amp;&amp;</span><span class="err">
</span><span class="s">          exp.named_args.nil? &amp;&amp;</span><span class="err">
</span><span class="s">          exp.obj</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that disallows redundant `with_index` calls.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # collection.each.with_index do |e|</span><span class="err">
</span><span class="s">  #   # ...</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # collection.each_with_index do |e, _|</span><span class="err">
</span><span class="s">  #   # ...</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # and it should be written as follows:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # collection.each do |e|</span><span class="err">
</span><span class="s">  #   # ...</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/RedundantWithIndex:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class RedundantWithIndex &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">redundant</span> <span class="err">`</span><span class="n">with_index</span><span class="err">`</span> <span class="n">calls</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      args, block = node.args, node.block</span><span class="err">

</span><span class="s">      return if block.nil? || args.size &gt; 1</span><span class="err">
</span><span class="s">      return if with_index_arg?(block)</span><span class="err">

</span><span class="s">      case node.name</span><span class="err">
</span><span class="s">      when "</span><span class="n">with_index</span><span class="s">"</span><span class="err">
</span><span class="s">        report source, node, "</span><span class="n">Remove</span> <span class="n">redundant</span> <span class="n">with_index</span><span class="s">"</span><span class="err">
</span><span class="s">      when "</span><span class="n">each_with_index</span><span class="s">"</span><span class="err">
</span><span class="s">        report source, node, "</span><span class="n">Use</span> <span class="n">each</span> <span class="n">instead</span> <span class="n">of</span> <span class="n">each_with_index</span><span class="s">"</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def with_index_arg?(block : Crystal::Block)</span><span class="err">
</span><span class="s">      block.args.size &gt;= 2 &amp;&amp; block.args.last.name != "</span><span class="n">_</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def report(source, node, msg)</span><span class="err">
</span><span class="s">      issue_for node.name_location, node.name_end_location, msg</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that disallows redundant `each_with_object` calls.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # collection.each_with_object(0) do |e|</span><span class="err">
</span><span class="s">  #   # ...</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # collection.each_with_object(0) do |e, _|</span><span class="err">
</span><span class="s">  #   # ...</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # and it should be written as follows:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # collection.each do |e|</span><span class="err">
</span><span class="s">  #   # ...</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/RedundantWithObject:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class RedundantWithObject &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">redundant</span> <span class="err">`</span><span class="n">with_object</span><span class="err">`</span> <span class="n">calls</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Use</span> <span class="err">`</span><span class="n">each</span><span class="err">`</span> <span class="n">instead</span> <span class="n">of</span> <span class="err">`</span><span class="n">each_with_object</span><span class="err">`</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return if node.name != "</span><span class="n">each_with_object</span><span class="s">" ||</span><span class="err">
</span><span class="s">                node.args.size != 1 ||</span><span class="err">
</span><span class="s">                !(block = node.block) ||</span><span class="err">
</span><span class="s">                with_index_arg?(block)</span><span class="err">

</span><span class="s">      issue_for node.name_location, node.name_end_location, MSG</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def with_index_arg?(block : Crystal::Block)</span><span class="err">
</span><span class="s">      block.args.size &gt;= 2 &amp;&amp; block.args.last.name != "</span><span class="n">_</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that disallows shadowed arguments.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # do_something do |foo|</span><span class="err">
</span><span class="s">  #   foo = 1 # shadows block argument</span><span class="err">
</span><span class="s">  #   foo</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # def do_something(foo)</span><span class="err">
</span><span class="s">  #   foo = 1 # shadows method argument</span><span class="err">
</span><span class="s">  #   foo</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # and it should be written as follows:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # do_something do |foo|</span><span class="err">
</span><span class="s">  #   foo = foo + 42</span><span class="err">
</span><span class="s">  #   foo</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # def do_something(foo)</span><span class="err">
</span><span class="s">  #   foo = foo + 42</span><span class="err">
</span><span class="s">  #   foo</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/ShadowedArgument:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class ShadowedArgument &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">shadowed</span> <span class="n">arguments</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Argument</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span><span class="err">`</span> <span class="n">is</span> <span class="n">assigned</span> <span class="n">before</span> <span class="n">it</span> <span class="n">is</span> <span class="n">used</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::ScopeVisitor.new self, source</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node, scope : AST::Scope)</span><span class="err">
</span><span class="s">      scope.arguments.each do |arg|</span><span class="err">
</span><span class="s">        next unless assign = arg.variable.assign_before_reference</span><span class="err">

</span><span class="s">        issue_for assign, MSG % arg.name</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that disallows a rescued exception that get shadowed by a</span><span class="err">
</span><span class="s">  # less specific exception being rescued before a more specific</span><span class="err">
</span><span class="s">  # exception is rescued.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # begin</span><span class="err">
</span><span class="s">  #   do_something</span><span class="err">
</span><span class="s">  # rescue Exception</span><span class="err">
</span><span class="s">  #   handle_exception</span><span class="err">
</span><span class="s">  # rescue ArgumentError</span><span class="err">
</span><span class="s">  #   handle_argument_error_exception</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And it has to be written as follows:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # begin</span><span class="err">
</span><span class="s">  #   do_something</span><span class="err">
</span><span class="s">  # rescue ArgumentError</span><span class="err">
</span><span class="s">  #   handle_argument_error_exception</span><span class="err">
</span><span class="s">  # rescue Exception</span><span class="err">
</span><span class="s">  #   handle_exception</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/ShadowedException:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class ShadowedException &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">rescued</span> <span class="n">exception</span> <span class="n">that</span> <span class="n">get</span> <span class="n">shadowed</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Shadowed</span> <span class="n">exception</span> <span class="n">found</span><span class="o">:</span> <span class="o">%</span><span class="n">s</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::ExceptionHandler)</span><span class="err">
</span><span class="s">      rescues = node.rescues</span><span class="err">
</span><span class="s">      return if rescues.nil?</span><span class="err">

</span><span class="s">      shadowed(rescues).each do |path|</span><span class="err">
</span><span class="s">        issue_for path, MSG % path.names.join("</span><span class="o">::</span><span class="s">")</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def shadowed(rescues, catch_all = false)</span><span class="err">
</span><span class="s">      traversed_types = Set(String).new</span><span class="err">

</span><span class="s">      rescues = filter_rescues(rescues)</span><span class="err">
</span><span class="s">      rescues.each_with_object([] of Crystal::Path) do |types, shadowed|</span><span class="err">
</span><span class="s">        case</span><span class="err">
</span><span class="s">        when catch_all</span><span class="err">
</span><span class="s">          shadowed.concat(types)</span><span class="err">
</span><span class="s">          next</span><span class="err">
</span><span class="s">        when types.any?(&amp;.single?("</span><span class="n">Exception</span><span class="s">"))</span><span class="err">
</span><span class="s">          nodes = types.reject(&amp;.single?("</span><span class="n">Exception</span><span class="s">"))</span><span class="err">
</span><span class="s">          shadowed.concat(nodes) unless nodes.empty?</span><span class="err">
</span><span class="s">          catch_all = true</span><span class="err">
</span><span class="s">          next</span><span class="err">
</span><span class="s">        else</span><span class="err">
</span><span class="s">          nodes = types.select { |path| traverse(path.to_s, traversed_types) }</span><span class="err">
</span><span class="s">          shadowed.concat(nodes) unless nodes.empty?</span><span class="err">
</span><span class="s">        end</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def filter_rescues(rescues)</span><span class="err">
</span><span class="s">      rescues.compact_map(&amp;.types.try &amp;.select(Crystal::Path))</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def traverse(path, traversed_types)</span><span class="err">
</span><span class="s">      dup = traversed_types.includes?(path)</span><span class="err">
</span><span class="s">      dup || (traversed_types &lt;&lt; path)</span><span class="err">
</span><span class="s">      dup</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that disallows the usage of the same name as outer local variables</span><span class="err">
</span><span class="s">  # for block or proc arguments.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered incorrect:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def some_method</span><span class="err">
</span><span class="s">  #   foo = 1</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  #   3.times do |foo| # shadowing outer `foo`</span><span class="err">
</span><span class="s">  #   end</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # and should be written as:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def some_method</span><span class="err">
</span><span class="s">  #   foo = 1</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  #   3.times do |bar|</span><span class="err">
</span><span class="s">  #   end</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/ShadowingOuterLocalVar:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class ShadowingOuterLocalVar &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">the</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">the</span> <span class="n">same</span> <span class="n">name</span> <span class="n">as</span> <span class="n">outer</span> <span class="n">local</span> <span class="n">variables</span> <span class="s">" \
                  "</span><span class="k">for</span> <span class="n">block</span> <span class="n">or</span> <span class="n">proc</span> <span class="n">arguments</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Shadowing</span> <span class="n">outer</span> <span class="n">local</span> <span class="n">variable</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span><span class="err">`</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::ScopeVisitor.new self, source, skip: [</span><span class="err">
</span><span class="s">        Crystal::Macro,</span><span class="err">
</span><span class="s">        Crystal::MacroFor,</span><span class="err">
</span><span class="s">      ]</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::ProcLiteral | Crystal::Block, scope : AST::Scope)</span><span class="err">
</span><span class="s">      find_shadowing source, scope</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def find_shadowing(source, scope)</span><span class="err">
</span><span class="s">      return unless outer_scope = scope.outer_scope</span><span class="err">

</span><span class="s">      scope.arguments.reject(&amp;.ignored?).each do |arg|</span><span class="err">
</span><span class="s">        variable = outer_scope.find_variable(arg.name)</span><span class="err">

</span><span class="s">        next if variable.nil? || !variable.declared_before?(arg)</span><span class="err">
</span><span class="s">        next if outer_scope.assigns_ivar?(arg.name)</span><span class="err">

</span><span class="s">        issue_for arg.node, MSG % arg.name</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that disallows using shared variables in fibers,</span><span class="err">
</span><span class="s">  # which are mutated during iterations.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # In most cases it leads to unexpected behaviour and is undesired.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, having this example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # n = 0</span><span class="err">
</span><span class="s">  # channel = Channel(Int32).new</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # while n &lt; 3</span><span class="err">
</span><span class="s">  #   n = n + 1</span><span class="err">
</span><span class="s">  #   spawn { channel.send n }</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # 3.times { puts channel.receive } # =&gt; # 3, 3, 3</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # The problem is there is only one shared between fibers variable `n`</span><span class="err">
</span><span class="s">  # and when `channel.receive` is executed its value is `3`.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # To solve this, the code above needs to be rewritten to the following:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # n = 0</span><span class="err">
</span><span class="s">  # channel = Channel(Int32).new</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # while n &lt; 3</span><span class="err">
</span><span class="s">  #   n = n + 1</span><span class="err">
</span><span class="s">  #   m = n</span><span class="err">
</span><span class="s">  #   spawn do { channel.send m }</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # 3.times { puts channel.receive } # =&gt; # 1, 2, 3</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # This rule is able to find the shared variables between fibers, which are mutated</span><span class="err">
</span><span class="s">  # during iterations. So it reports the issue on the first sample and passes on</span><span class="err">
</span><span class="s">  # the second one.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # There are also other techniques to solve the problem above which are</span><span class="err">
</span><span class="s">  # [officially documented](https://crystal-lang.org/reference/guides/concurrency.html)</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/SharedVarInFiber:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class SharedVarInFiber &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">shared</span> <span class="n">variables</span> <span class="n">in</span> <span class="n">fibers</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Shared</span> <span class="n">variable</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span><span class="err">`</span> <span class="n">is</span> <span class="n">used</span> <span class="n">in</span> <span class="n">fiber</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::ScopeVisitor.new self, source</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node, scope : AST::Scope)</span><span class="err">
</span><span class="s">      return unless scope.spawn_block?</span><span class="err">

</span><span class="s">      scope.references.each do |ref|</span><span class="err">
</span><span class="s">        next if (variable = scope.find_variable(ref.name)).nil?</span><span class="err">
</span><span class="s">        next if variable.scope == scope || !mutated_in_loop?(variable)</span><span class="err">

</span><span class="s">        issue_for ref.node, MSG % variable.name</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    # Variable is mutated in loop if it was declared above the loop and assigned inside.</span><span class="err">
</span><span class="s">    private def mutated_in_loop?(variable)</span><span class="err">
</span><span class="s">      declared_in = variable.assignments.first?.try &amp;.branch</span><span class="err">

</span><span class="s">      variable.assignments</span><span class="err">
</span><span class="s">        .reject(&amp;.scope.spawn_block?)</span><span class="err">
</span><span class="s">        .any? do |assign|</span><span class="err">
</span><span class="s">          assign.branch.try(&amp;.in_loop?) &amp;&amp; assign.branch != declared_in</span><span class="err">
</span><span class="s">        end</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # Checks if specs are focused.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # In specs `focus: true` is mainly used to focus on a spec</span><span class="err">
</span><span class="s">  # item locally during development. However, if such change</span><span class="err">
</span><span class="s">  # is committed, it silently runs only focused spec on all</span><span class="err">
</span><span class="s">  # other environment, which is undesired.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # This is considered bad:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # describe MyClass, focus: true do</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # describe "</span><span class="p">.</span><span class="k">new</span><span class="s">", focus: true do</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # context "</span><span class="n">my</span> <span class="n">context</span><span class="s">", focus: true do</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # it "</span><span class="n">works</span><span class="s">", focus: true do</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And it should be written as the following:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # describe MyClass do</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # describe "</span><span class="p">.</span><span class="k">new</span><span class="s">" do</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # context "</span><span class="n">my</span> <span class="n">context</span><span class="s">" do</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # it "</span><span class="n">works</span><span class="s">" do</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/SpecFocus:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class SpecFocus &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Reports</span> <span class="n">focused</span> <span class="n">spec</span> <span class="n">items</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG             = "</span><span class="n">Focused</span> <span class="n">spec</span> <span class="n">item</span> <span class="n">detected</span><span class="s">"</span><span class="err">
</span><span class="s">    SPEC_ITEM_NAMES = %w(describe context it pending)</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      return unless source.spec?</span><span class="err">

</span><span class="s">      AST::NodeVisitor.new self, source</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return unless node.name.in?(SPEC_ITEM_NAMES)</span><span class="err">
</span><span class="s">      return unless node.block</span><span class="err">

</span><span class="s">      arg = node.named_args.try &amp;.find(&amp;.name.== "</span><span class="n">focus</span><span class="s">")</span><span class="err">
</span><span class="s">      return unless arg</span><span class="err">

</span><span class="s">      issue_for arg, MSG</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that reports invalid Crystal syntax.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this syntax is invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def hello</span><span class="err">
</span><span class="s">  #   do_something</span><span class="err">
</span><span class="s">  # rescue Exception =&gt; e</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And should be properly written:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def hello</span><span class="err">
</span><span class="s">  #   do_something</span><span class="err">
</span><span class="s">  # rescue e : Exception</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class Syntax &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Reports</span> <span class="n">invalid</span> <span class="n">Crystal</span> <span class="n">syntax</span><span class="s">"</span><span class="err">
</span><span class="s">      severity :error</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      source.ast</span><span class="err">
</span><span class="s">    rescue e : Crystal::SyntaxException</span><span class="err">
</span><span class="s">      issue_for({e.line_number, e.column_number}, e.message.to_s)</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that reports unneeded disable directives.</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # # ameba:disable Style/PredicateName</span><span class="err">
</span><span class="s">  # def comment?</span><span class="err">
</span><span class="s">  #   do_something</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # as the predicate name is correct and the comment directive does not</span><span class="err">
</span><span class="s">  # have any effect, the snippet should be written as the following:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def comment?</span><span class="err">
</span><span class="s">  #   do_something</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/UnneededDisableDirective</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class UnneededDisableDirective &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Reports</span> <span class="n">unneeded</span> <span class="n">disable</span> <span class="n">directives</span> <span class="n">in</span> <span class="n">comments</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Unnecessary</span> <span class="n">disabling</span> <span class="n">of</span> <span class="o">%</span><span class="n">s</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      Tokenizer.new(source).run do |token|</span><span class="err">
</span><span class="s">        next unless token.type.comment?</span><span class="err">
</span><span class="s">        next unless directive = source.parse_inline_directive(token.value.to_s)</span><span class="err">
</span><span class="s">        next unless names = unneeded_disables(source, directive, token.location)</span><span class="err">
</span><span class="s">        next if names.empty?</span><span class="err">

</span><span class="s">        issue_for token, MSG % names.join("</span><span class="p">,</span> <span class="s">")</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def unneeded_disables(source, directive, location)</span><span class="err">
</span><span class="s">      return unless directive[:action] == "</span><span class="n">disable</span><span class="s">"</span><span class="err">

</span><span class="s">      directive[:rules].reject do |rule_name|</span><span class="err">
</span><span class="s">        next if rule_name == self.name</span><span class="err">
</span><span class="s">        source.issues.any? do |issue|</span><span class="err">
</span><span class="s">          issue.rule.name == rule_name &amp;&amp;</span><span class="err">
</span><span class="s">            issue.disabled? &amp;&amp;</span><span class="err">
</span><span class="s">            issue_at_location?(source, issue, location)</span><span class="err">
</span><span class="s">        end</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def issue_at_location?(source, issue, location)</span><span class="err">
</span><span class="s">      return false unless issue_line_number = issue.location.try(&amp;.line_number)</span><span class="err">

</span><span class="s">      issue_line_number == location.line_number ||</span><span class="err">
</span><span class="s">        ((prev_line_number = issue_line_number - 1) &amp;&amp;</span><span class="err">
</span><span class="s">          prev_line_number == location.line_number &amp;&amp;</span><span class="err">
</span><span class="s">          source.comment?(prev_line_number - 1))</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that reports unreachable code.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def method(a)</span><span class="err">
</span><span class="s">  #   return 42</span><span class="err">
</span><span class="s">  #   a + 1</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # a = 1</span><span class="err">
</span><span class="s">  # loop do</span><span class="err">
</span><span class="s">  #   break</span><span class="err">
</span><span class="s">  #   a += 1</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And has to be written as the following:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def method(a)</span><span class="err">
</span><span class="s">  #   return 42 if a == 0</span><span class="err">
</span><span class="s">  #   a + 1</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # a = 1</span><span class="err">
</span><span class="s">  # loop do</span><span class="err">
</span><span class="s">  #   break a &gt; 3</span><span class="err">
</span><span class="s">  #   a += 1</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/UnreachableCode:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class UnreachableCode &lt; Base</span><span class="err">
</span><span class="s">    include AST::Util</span><span class="err">

</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Reports</span> <span class="n">unreachable</span> <span class="n">code</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Unreachable</span> <span class="n">code</span> <span class="n">detected</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::FlowExpressionVisitor.new self, source</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node, flow_expression : AST::FlowExpression)</span><span class="err">
</span><span class="s">      return unless unreachable_node = flow_expression.unreachable_nodes.first?</span><span class="err">
</span><span class="s">      issue_for unreachable_node, MSG</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that reports unused arguments.</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def method(a, b, c)</span><span class="err">
</span><span class="s">  #   a + b</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # and should be written as:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def method(a, b)</span><span class="err">
</span><span class="s">  #   a + b</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/UnusedArgument:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  #   IgnoreDefs: true</span><span class="err">
</span><span class="s">  #   IgnoreBlocks: false</span><span class="err">
</span><span class="s">  #   IgnoreProcs: false</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class UnusedArgument &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">unused</span> <span class="n">arguments</span><span class="s">"</span><span class="err">

</span><span class="s">      ignore_defs true</span><span class="err">
</span><span class="s">      ignore_blocks false</span><span class="err">
</span><span class="s">      ignore_procs false</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Unused</span> <span class="n">argument</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span><span class="err">`</span><span class="p">.</span> <span class="n">If</span> <span class="n">it</span><span class="err">'</span><span class="n">s</span> <span class="n">necessary</span><span class="p">,</span> <span class="n">use</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span><span class="err">`</span> <span class="s">" \
          "</span><span class="n">as</span> <span class="n">an</span> <span class="n">argument</span> <span class="n">name</span> <span class="n">to</span> <span class="n">indicate</span> <span class="n">that</span> <span class="n">it</span> <span class="n">won</span><span class="err">'</span><span class="n">t</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::ScopeVisitor.new self, source</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::ProcLiteral, scope : AST::Scope)</span><span class="err">
</span><span class="s">      ignore_procs? || find_unused_arguments source, scope</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Block, scope : AST::Scope)</span><span class="err">
</span><span class="s">      ignore_blocks? || find_unused_arguments source, scope</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Def, scope : AST::Scope)</span><span class="err">
</span><span class="s">      # `Lint/UnusedBlockArgument` rule covers this case explicitly</span><span class="err">
</span><span class="s">      if block_arg = node.block_arg</span><span class="err">
</span><span class="s">        scope.arguments.reject!(&amp;.node.== block_arg)</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">      ignore_defs? || find_unused_arguments source, scope</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    private def find_unused_arguments(source, scope)</span><span class="err">
</span><span class="s">      scope.arguments.each do |argument|</span><span class="err">
</span><span class="s">        next if argument.anonymous? || argument.ignored?</span><span class="err">
</span><span class="s">        next if scope.references?(argument.variable)</span><span class="err">

</span><span class="s">        name_suggestion = scope.node.is_a?(Crystal::Block) ? '_' : "</span><span class="n">_</span><span class="err">#</span><span class="p">{</span><span class="n">argument</span><span class="p">.</span><span class="n">name</span><span class="p">}</span><span class="s">"</span><span class="err">
</span><span class="s">        message = MSG % {argument.name, name_suggestion}</span><span class="err">

</span><span class="s">        location = argument.node.location</span><span class="err">
</span><span class="s">        end_location = location.try &amp;.adjust(column_number: argument.name.size - 1)</span><span class="err">

</span><span class="s">        if location &amp;&amp; end_location</span><span class="err">
</span><span class="s">          issue_for argument.node, message do |corrector|</span><span class="err">
</span><span class="s">            corrector.replace(location, end_location, name_suggestion)</span><span class="err">
</span><span class="s">          end</span><span class="err">
</span><span class="s">        else</span><span class="err">
</span><span class="s">          issue_for argument.node, message</span><span class="err">
</span><span class="s">        end</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that reports unused block arguments.</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def foo(a, b, &amp;block)</span><span class="err">
</span><span class="s">  #   a + b</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # def bar(&amp;block)</span><span class="err">
</span><span class="s">  #   yield 42</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # and should be written as:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def foo(a, b, &amp;_block)</span><span class="err">
</span><span class="s">  #   a + b</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # def bar(&amp;)</span><span class="err">
</span><span class="s">  #   yield 42</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/UnusedBlockArgument:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class UnusedBlockArgument &lt; Base</span><span class="err">
</span><span class="s">    include AST::Util</span><span class="err">

</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">unused</span> <span class="n">block</span> <span class="n">arguments</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG_UNUSED = "</span><span class="n">Unused</span> <span class="n">block</span> <span class="n">argument</span> <span class="err">`</span><span class="o">%</span><span class="mi">1</span><span class="err">$</span><span class="n">s</span><span class="err">`</span><span class="p">.</span> <span class="n">If</span> <span class="n">it</span><span class="err">'</span><span class="n">s</span> <span class="n">necessary</span><span class="p">,</span> <span class="n">use</span> <span class="err">`</span><span class="n">_</span><span class="o">%</span><span class="mi">1</span><span class="err">$</span><span class="n">s</span><span class="err">`</span> <span class="s">" \
                 "</span><span class="n">as</span> <span class="n">an</span> <span class="n">argument</span> <span class="n">name</span> <span class="n">to</span> <span class="n">indicate</span> <span class="n">that</span> <span class="n">it</span> <span class="n">won</span><span class="err">'</span><span class="n">t</span> <span class="n">be</span> <span class="n">used</span><span class="p">.</span><span class="s">"</span><span class="err">

</span><span class="s">    MSG_YIELDED = "</span><span class="n">Use</span> <span class="err">`</span><span class="o">&amp;</span><span class="err">`</span> <span class="n">as</span> <span class="n">an</span> <span class="n">argument</span> <span class="n">name</span> <span class="n">to</span> <span class="n">indicate</span> <span class="n">that</span> <span class="n">it</span> <span class="n">won</span><span class="err">'</span><span class="n">t</span> <span class="n">be</span> <span class="n">referenced</span><span class="p">.</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::ScopeVisitor.new self, source</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Def, scope : AST::Scope)</span><span class="err">
</span><span class="s">      return unless block_arg = node.block_arg</span><span class="err">
</span><span class="s">      return unless block_arg = scope.arguments.find(&amp;.node.== block_arg)</span><span class="err">

</span><span class="s">      return if block_arg.anonymous?</span><span class="err">
</span><span class="s">      return if scope.references?(block_arg.variable)</span><span class="err">

</span><span class="s">      location = block_arg.node.location</span><span class="err">
</span><span class="s">      end_location = location.try &amp;.adjust(column_number: block_arg.name.size - 1)</span><span class="err">

</span><span class="s">      if scope.yields?</span><span class="err">
</span><span class="s">        if location &amp;&amp; end_location</span><span class="err">
</span><span class="s">          issue_for location, end_location, MSG_YIELDED do |corrector|</span><span class="err">
</span><span class="s">            corrector.remove(location, end_location)</span><span class="err">
</span><span class="s">          end</span><span class="err">
</span><span class="s">        else</span><span class="err">
</span><span class="s">          issue_for block_arg.node, MSG_YIELDED</span><span class="err">
</span><span class="s">        end</span><span class="err">
</span><span class="s">      else</span><span class="err">
</span><span class="s">        return if block_arg.ignored?</span><span class="err">
</span><span class="s">        if location &amp;&amp; end_location</span><span class="err">
</span><span class="s">          issue_for location, end_location, MSG_UNUSED % block_arg.name do |corrector|</span><span class="err">
</span><span class="s">            corrector.insert_before(location, '_')</span><span class="err">
</span><span class="s">          end</span><span class="err">
</span><span class="s">        else</span><span class="err">
</span><span class="s">          issue_for block_arg.node, MSG_UNUSED % block_arg.name</span><span class="err">
</span><span class="s">        end</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that disallows useless assignments.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def method</span><span class="err">
</span><span class="s">  #   var = 1</span><span class="err">
</span><span class="s">  #   do_something</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And has to be written as the following:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # def method</span><span class="err">
</span><span class="s">  #   var = 1</span><span class="err">
</span><span class="s">  #   do_something(var)</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/UselessAssign:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class UselessAssign &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">useless</span> <span class="n">variable</span> <span class="n">assignments</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Useless</span> <span class="n">assignment</span> <span class="n">to</span> <span class="n">variable</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span><span class="err">`</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::ScopeVisitor.new self, source</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node, scope : AST::Scope)</span><span class="err">
</span><span class="s">      scope.variables.each do |var|</span><span class="err">
</span><span class="s">        next if var.ignored? || var.used_in_macro? || var.captured_by_block?</span><span class="err">

</span><span class="s">        var.assignments.each do |assign|</span><span class="err">
</span><span class="s">          next if assign.referenced? || assign.transformed?</span><span class="err">
</span><span class="s">          issue_for assign.target_node, MSG % var.name</span><span class="err">
</span><span class="s">        end</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Lint</span><span class="err">
</span><span class="s">  # A rule that disallows useless conditions in when clause</span><span class="err">
</span><span class="s">  # where it is guaranteed to always return the same result.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # case</span><span class="err">
</span><span class="s">  # when utc?</span><span class="err">
</span><span class="s">  #   io &lt;&lt; "</span> <span class="n">UTC</span><span class="s">"</span><span class="err">
</span><span class="s">  # when local?</span><span class="err">
</span><span class="s">  #   Format.new("</span> <span class="o">%:</span><span class="n">z</span><span class="s">").format(self, io) if local?</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And has to be written as the following:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # case</span><span class="err">
</span><span class="s">  # when utc?</span><span class="err">
</span><span class="s">  #   io &lt;&lt; "</span> <span class="n">UTC</span><span class="s">"</span><span class="err">
</span><span class="s">  # when local?</span><span class="err">
</span><span class="s">  #   Format.new("</span> <span class="o">%:</span><span class="n">z</span><span class="s">").format(self, io)</span><span class="err">
</span><span class="s">  # end</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Lint/UselessConditionInWhen:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class UselessConditionInWhen &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">useless</span> <span class="n">conditions</span> <span class="n">in</span> <span class="n">when</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Useless</span> <span class="n">condition</span> <span class="n">in</span> <span class="n">when</span> <span class="n">detected</span><span class="s">"</span><span class="err">

</span><span class="s">    # TODO: condition.cond may be a complex ASTNode with</span><span class="err">
</span><span class="s">    # useless inner conditions. We might need to improve this</span><span class="err">
</span><span class="s">    # simple implementation in future.</span><span class="err">
</span><span class="s">    protected def check_node(source, when_node, cond)</span><span class="err">
</span><span class="s">      cond_s = cond.to_s</span><span class="err">
</span><span class="s">      return if when_node.conds.none?(&amp;.to_s.==(cond_s))</span><span class="err">

</span><span class="s">      issue_for cond, MSG</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::When)</span><span class="err">
</span><span class="s">      ConditionInWhenVisitor.new self, source, node</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    # :nodoc:</span><span class="err">
</span><span class="s">    private class ConditionInWhenVisitor &lt; Crystal::Visitor</span><span class="err">
</span><span class="s">      @source : Source</span><span class="err">
</span><span class="s">      @rule : UselessConditionInWhen</span><span class="err">
</span><span class="s">      @parent : Crystal::When</span><span class="err">

</span><span class="s">      def initialize(@rule, @source, @parent)</span><span class="err">
</span><span class="s">        @parent.accept self</span><span class="err">
</span><span class="s">      end</span><span class="err">

</span><span class="s">      def visit(node : Crystal::If | Crystal::Unless)</span><span class="err">
</span><span class="s">        @rule.check_node(@source, @parent, node.cond)</span><span class="err">
</span><span class="s">        true</span><span class="err">
</span><span class="s">      end</span><span class="err">

</span><span class="s">      def visit(node : Crystal::ASTNode)</span><span class="err">
</span><span class="s">        true</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Metrics</span><span class="err">
</span><span class="s">  # A rule that disallows methods with a cyclomatic complexity higher than `MaxComplexity`</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Metrics/CyclomaticComplexity:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  #   MaxComplexity: 10</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class CyclomaticComplexity &lt; Base</span><span class="err">
</span><span class="s">    include AST::Util</span><span class="err">

</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Disallows</span> <span class="n">methods</span> <span class="n">with</span> <span class="n">a</span> <span class="n">cyclomatic</span> <span class="n">complexity</span> <span class="n">higher</span> <span class="n">than</span> <span class="err">`</span><span class="n">MaxComplexity</span><span class="err">`</span><span class="s">"</span><span class="err">
</span><span class="s">      max_complexity 10</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Cyclomatic</span> <span class="n">complexity</span> <span class="n">too</span> <span class="n">high</span> <span class="p">[</span><span class="o">%</span><span class="n">d</span><span class="o">/%</span><span class="n">d</span><span class="p">]</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Def)</span><span class="err">
</span><span class="s">      complexity = AST::CountingVisitor.new(node).count</span><span class="err">
</span><span class="s">      return unless complexity &gt; max_complexity</span><span class="err">

</span><span class="s">      return unless location = node.name_location</span><span class="err">
</span><span class="s">      end_location = name_end_location(node)</span><span class="err">

</span><span class="s">      issue_for location, end_location, MSG % {complexity, max_complexity}</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s"># require "</span><span class="p">.</span><span class="o">/</span><span class="n">base</span><span class="s">"</span><span class="err">
</span><span class="s"># require "</span><span class="p">..</span><span class="o">/</span><span class="n">base</span><span class="s">"</span><span class="err">

</span><span class="s">module Ameba::Rule::Performance</span><span class="err">
</span><span class="s">  # A general base class for performance rules.</span><span class="err">
</span><span class="s">  abstract class Base &lt; Ameba::Rule::Base</span><span class="err">
</span><span class="s">    def catch(source : Source)</span><span class="err">
</span><span class="s">      source.spec? ? source : super</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Performance</span><span class="err">
</span><span class="s">  # This rule is used to identify usage of `any?` calls that follow filters.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # [1, 2, 3].select { |e| e &gt; 2 }.any?</span><span class="err">
</span><span class="s">  # [1, 2, 3].reject { |e| e &gt;= 2 }.any?</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And it should be written as this:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # [1, 2, 3].any? { |e| e &gt; 2 }</span><span class="err">
</span><span class="s">  # [1, 2, 3].any? { |e| e &lt; 2 }</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Performance/AnyAfterFilter:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  #   FilterNames:</span><span class="err">
</span><span class="s">  #     - select</span><span class="err">
</span><span class="s">  #     - reject</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class AnyAfterFilter &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Identifies</span> <span class="n">usage</span> <span class="n">of</span> <span class="err">`</span><span class="n">any</span><span class="o">?</span><span class="err">`</span> <span class="n">calls</span> <span class="n">that</span> <span class="n">follow</span> <span class="n">filters</span><span class="s">"</span><span class="err">
</span><span class="s">      filter_names : Array(String) = %w(select reject)</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    ANY_NAME = "</span><span class="n">any</span><span class="o">?</span><span class="s">"</span><span class="err">
</span><span class="s">    MSG      = "</span><span class="n">Use</span> <span class="err">`</span><span class="n">any</span><span class="o">?</span> <span class="p">{...}</span><span class="err">`</span> <span class="n">instead</span> <span class="n">of</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span> <span class="p">{...}.</span><span class="n">any</span><span class="o">?</span><span class="err">`</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return unless node.name == ANY_NAME &amp;&amp; (obj = node.obj)</span><span class="err">
</span><span class="s">      return unless obj.is_a?(Crystal::Call) &amp;&amp; obj.block &amp;&amp; node.block.nil?</span><span class="err">
</span><span class="s">      return unless obj.name.in?(filter_names)</span><span class="err">

</span><span class="s">      issue_for obj.name_location, node.name_end_location, MSG % obj.name</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s"># require "</span><span class="p">.</span><span class="o">/</span><span class="n">base</span><span class="s">"</span><span class="err">

</span><span class="s">module Ameba::Rule::Performance</span><span class="err">
</span><span class="s">  # This rule is used to identify usage of arg-less `Enumerable#any?` calls.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # Using `Enumerable#any?` instead of `Enumerable#empty?` might lead to an</span><span class="err">
</span><span class="s">  # unexpected results (like `[nil, false].any? # =&gt; false`). In some cases</span><span class="err">
</span><span class="s">  # it also might be less efficient, since it iterates until the block will</span><span class="err">
</span><span class="s">  # return a _truthy_ value, instead of just checking if there's at least</span><span class="err">
</span><span class="s">  # one value present.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # [1, 2, 3].any?</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And it should be written as this:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # ![1, 2, 3].empty?</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Performance/AnyInsteadOfEmpty:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class AnyInsteadOfEmpty &lt; Base</span><span class="err">
</span><span class="s">    include AST::Util</span><span class="err">

</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Identifies</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">arg</span><span class="o">-</span><span class="n">less</span> <span class="err">`</span><span class="n">any</span><span class="o">?</span><span class="err">`</span> <span class="n">calls</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    ANY_NAME = "</span><span class="n">any</span><span class="o">?</span><span class="s">"</span><span class="err">
</span><span class="s">    MSG      = "</span><span class="n">Use</span> <span class="err">`</span><span class="o">!</span><span class="p">{...}.</span><span class="n">empty</span><span class="o">?</span><span class="err">`</span> <span class="n">instead</span> <span class="n">of</span> <span class="err">`</span><span class="p">{...}.</span><span class="n">any</span><span class="o">?</span><span class="err">`</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return unless node.name == ANY_NAME</span><span class="err">
</span><span class="s">      return unless node.block.nil? &amp;&amp; node.args.empty?</span><span class="err">
</span><span class="s">      return unless node.obj</span><span class="err">

</span><span class="s">      return unless name_location = node.name_location</span><span class="err">
</span><span class="s">      return unless end_location = name_end_location(node)</span><span class="err">

</span><span class="s">      issue_for name_location, end_location, MSG</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s"># require "</span><span class="p">.</span><span class="o">/</span><span class="n">base</span><span class="s">"</span><span class="err">

</span><span class="s">module Ameba::Rule::Performance</span><span class="err">
</span><span class="s">  # This rule is used to identify usage of chained calls not utilizing</span><span class="err">
</span><span class="s">  # the bang method variants.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered inefficient:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # names = %w[Alice Bob]</span><span class="err">
</span><span class="s">  # chars = names</span><span class="err">
</span><span class="s">  #   .flat_map(&amp;.chars)</span><span class="err">
</span><span class="s">  #   .uniq</span><span class="err">
</span><span class="s">  #   .sort</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And can be written as this:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # names = %w[Alice Bob]</span><span class="err">
</span><span class="s">  # chars = names</span><span class="err">
</span><span class="s">  #   .flat_map(&amp;.chars)</span><span class="err">
</span><span class="s">  #   .uniq!</span><span class="err">
</span><span class="s">  #   .sort!</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Performance/ChainedCallWithNoBang:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  #   CallNames:</span><span class="err">
</span><span class="s">  #     - uniq</span><span class="err">
</span><span class="s">  #     - sort</span><span class="err">
</span><span class="s">  #     - sort_by</span><span class="err">
</span><span class="s">  #     - shuffle</span><span class="err">
</span><span class="s">  #     - reverse</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class ChainedCallWithNoBang &lt; Base</span><span class="err">
</span><span class="s">    include AST::Util</span><span class="err">

</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Identifies</span> <span class="n">usage</span> <span class="n">of</span> <span class="n">chained</span> <span class="n">calls</span> <span class="n">not</span> <span class="n">utilizing</span> <span class="n">the</span> <span class="n">bang</span> <span class="n">method</span> <span class="n">variants</span><span class="s">"</span><span class="err">

</span><span class="s">      # All of those have bang method variants returning `self`</span><span class="err">
</span><span class="s">      # and are not modifying the receiver type (like `compact` does),</span><span class="err">
</span><span class="s">      # thus are safe to switch to the bang variant.</span><span class="err">
</span><span class="s">      call_names : Array(String) = %w(uniq sort sort_by shuffle reverse)</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    # All these methods are allocating a new object</span><span class="err">
</span><span class="s">    ALLOCATING_METHOD_NAMES = %w(</span><span class="err">
</span><span class="s">      keys values values_at map map_with_index flat_map compact_map</span><span class="err">
</span><span class="s">      flatten compact select reject sample group_by chunks tally merge</span><span class="err">
</span><span class="s">      combinations repeated_combinations permutations repeated_permutations</span><span class="err">
</span><span class="s">      transpose invert chars captures named_captures clone</span><span class="err">
</span><span class="s">    )</span><span class="err">

</span><span class="s">    MSG = "</span><span class="n">Use</span> <span class="n">bang</span> <span class="n">method</span> <span class="n">variant</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span><span class="o">!</span><span class="err">`</span> <span class="n">after</span> <span class="n">chained</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span><span class="err">`</span> <span class="n">call</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::NodeVisitor.new self, source, skip: [</span><span class="err">
</span><span class="s">        Crystal::Macro,</span><span class="err">
</span><span class="s">        Crystal::MacroExpression,</span><span class="err">
</span><span class="s">        Crystal::MacroIf,</span><span class="err">
</span><span class="s">        Crystal::MacroFor,</span><span class="err">
</span><span class="s">      ]</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return unless (obj = node.obj).is_a?(Crystal::Call)</span><span class="err">
</span><span class="s">      return unless node.name.in?(call_names)</span><span class="err">
</span><span class="s">      return unless obj.name.in?(call_names) || obj.name.in?(ALLOCATING_METHOD_NAMES)</span><span class="err">

</span><span class="s">      return unless location = node.name_location</span><span class="err">
</span><span class="s">      return unless end_location = name_end_location(node)</span><span class="err">

</span><span class="s">      issue_for location, end_location, MSG % {node.name, obj.name} do |corrector|</span><span class="err">
</span><span class="s">        corrector.insert_after(end_location, '!')</span><span class="err">
</span><span class="s">      end</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s"># require "</span><span class="p">.</span><span class="o">/</span><span class="n">base</span><span class="s">"</span><span class="err">

</span><span class="s">module Ameba::Rule::Performance</span><span class="err">
</span><span class="s">  # This rule is used to identify usage of `compact` calls that follow `map`.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered inefficient:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # %w[Alice Bob].map(&amp;.match(/^A./)).compact</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And can be written as this:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # %w[Alice Bob].compact_map(&amp;.match(/^A./))</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Performance/CompactAfterMap:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class CompactAfterMap &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Identifies</span> <span class="n">usage</span> <span class="n">of</span> <span class="err">`</span><span class="n">compact</span><span class="err">`</span> <span class="n">calls</span> <span class="n">that</span> <span class="n">follow</span> <span class="err">`</span><span class="n">map</span><span class="err">`</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    COMPACT_NAME = "</span><span class="n">compact</span><span class="s">"</span><span class="err">
</span><span class="s">    MAP_NAME     = "</span><span class="n">map</span><span class="s">"</span><span class="err">
</span><span class="s">    MSG          = "</span><span class="n">Use</span> <span class="err">`</span><span class="n">compact_map</span> <span class="p">{...}</span><span class="err">`</span> <span class="n">instead</span> <span class="n">of</span> <span class="err">`</span><span class="n">map</span> <span class="p">{...}.</span><span class="n">compact</span><span class="err">`</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::NodeVisitor.new self, source, skip: [</span><span class="err">
</span><span class="s">        Crystal::Macro,</span><span class="err">
</span><span class="s">        Crystal::MacroExpression,</span><span class="err">
</span><span class="s">        Crystal::MacroIf,</span><span class="err">
</span><span class="s">        Crystal::MacroFor,</span><span class="err">
</span><span class="s">      ]</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return unless node.name == COMPACT_NAME &amp;&amp; (obj = node.obj)</span><span class="err">
</span><span class="s">      return unless obj.is_a?(Crystal::Call) &amp;&amp; obj.block</span><span class="err">
</span><span class="s">      return unless obj.name == MAP_NAME</span><span class="err">

</span><span class="s">      issue_for obj.name_location, node.name_end_location, MSG</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s"># require "</span><span class="p">.</span><span class="o">/</span><span class="n">base</span><span class="s">"</span><span class="err">

</span><span class="s">module Ameba::Rule::Performance</span><span class="err">
</span><span class="s">  # This rule is used to identify usage of `first/last/first?/last?` calls that follow filters.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered inefficient:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # [-1, 0, 1, 2].select { |e| e &gt; 0 }.first?</span><span class="err">
</span><span class="s">  # [-1, 0, 1, 2].select { |e| e &gt; 0 }.last?</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And can be written as this:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # [-1, 0, 1, 2].find { |e| e &gt; 0 }</span><span class="err">
</span><span class="s">  # [-1, 0, 1, 2].reverse_each.find { |e| e &gt; 0 }</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Performance/FirstLastAfterFilter</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  #   FilterNames:</span><span class="err">
</span><span class="s">  #     - select</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class FirstLastAfterFilter &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Identifies</span> <span class="n">usage</span> <span class="n">of</span> <span class="err">`</span><span class="n">first</span><span class="o">/</span><span class="n">last</span><span class="o">/</span><span class="n">first</span><span class="o">?/</span><span class="n">last</span><span class="o">?</span><span class="err">`</span> <span class="n">calls</span> <span class="n">that</span> <span class="n">follow</span> <span class="n">filters</span><span class="s">"</span><span class="err">
</span><span class="s">      filter_names : Array(String) = %w(select)</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    CALL_NAMES  = %w(first last first? last?)</span><span class="err">
</span><span class="s">    MSG         = "</span><span class="n">Use</span> <span class="err">`</span><span class="n">find</span> <span class="p">{...}</span><span class="err">`</span> <span class="n">instead</span> <span class="n">of</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span> <span class="p">{...}.</span><span class="o">%</span><span class="n">s</span><span class="err">`</span><span class="s">"</span><span class="err">
</span><span class="s">    MSG_REVERSE = "</span><span class="n">Use</span> <span class="err">`</span><span class="n">reverse_each</span><span class="p">.</span><span class="n">find</span> <span class="p">{...}</span><span class="err">`</span> <span class="n">instead</span> <span class="n">of</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span> <span class="p">{...}.</span><span class="o">%</span><span class="n">s</span><span class="err">`</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::NodeVisitor.new self, source, skip: [</span><span class="err">
</span><span class="s">        Crystal::Macro,</span><span class="err">
</span><span class="s">        Crystal::MacroExpression,</span><span class="err">
</span><span class="s">        Crystal::MacroIf,</span><span class="err">
</span><span class="s">        Crystal::MacroFor,</span><span class="err">
</span><span class="s">      ]</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return unless node.name.in?(CALL_NAMES) &amp;&amp; (obj = node.obj)</span><span class="err">
</span><span class="s">      return unless obj.is_a?(Crystal::Call) &amp;&amp; obj.block</span><span class="err">
</span><span class="s">      return unless node.block.nil? &amp;&amp; node.args.empty?</span><span class="err">
</span><span class="s">      return unless obj.name.in?(filter_names)</span><span class="err">

</span><span class="s">      message = node.name.includes?(CALL_NAMES.first) ? MSG : MSG_REVERSE</span><span class="err">

</span><span class="s">      issue_for obj.name_location, node.name_end_location,</span><span class="err">
</span><span class="s">        message % {obj.name, node.name}</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s"># require "</span><span class="p">.</span><span class="o">/</span><span class="n">base</span><span class="s">"</span><span class="err">

</span><span class="s">module Ameba::Rule::Performance</span><span class="err">
</span><span class="s">  # This rule is used to identify usage of `flatten` calls that follow `map`.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered inefficient:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # %w[Alice Bob].map(&amp;.chars).flatten</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And can be written as this:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # %w[Alice Bob].flat_map(&amp;.chars)</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Performance/FlattenAfterMap:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class FlattenAfterMap &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Identifies</span> <span class="n">usage</span> <span class="n">of</span> <span class="err">`</span><span class="n">flatten</span><span class="err">`</span> <span class="n">calls</span> <span class="n">that</span> <span class="n">follow</span> <span class="err">`</span><span class="n">map</span><span class="err">`</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    FLATTEN_NAME = "</span><span class="n">flatten</span><span class="s">"</span><span class="err">
</span><span class="s">    MAP_NAME     = "</span><span class="n">map</span><span class="s">"</span><span class="err">
</span><span class="s">    MSG          = "</span><span class="n">Use</span> <span class="err">`</span><span class="n">flat_map</span> <span class="p">{...}</span><span class="err">`</span> <span class="n">instead</span> <span class="n">of</span> <span class="err">`</span><span class="n">map</span> <span class="p">{...}.</span><span class="n">flatten</span><span class="err">`</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::NodeVisitor.new self, source, skip: [</span><span class="err">
</span><span class="s">        Crystal::Macro,</span><span class="err">
</span><span class="s">        Crystal::MacroExpression,</span><span class="err">
</span><span class="s">        Crystal::MacroIf,</span><span class="err">
</span><span class="s">        Crystal::MacroFor,</span><span class="err">
</span><span class="s">      ]</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return unless node.name == FLATTEN_NAME &amp;&amp; (obj = node.obj)</span><span class="err">
</span><span class="s">      return unless obj.is_a?(Crystal::Call) &amp;&amp; obj.block</span><span class="err">
</span><span class="s">      return unless obj.name == MAP_NAME</span><span class="err">

</span><span class="s">      issue_for obj.name_location, node.name_end_location, MSG</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s"># require "</span><span class="p">.</span><span class="o">/</span><span class="n">base</span><span class="s">"</span><span class="err">

</span><span class="s">module Ameba::Rule::Performance</span><span class="err">
</span><span class="s">  # This rule is used to identify usage of `sum/product` calls</span><span class="err">
</span><span class="s">  # that follow `map`.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered inefficient:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # (1..3).map(&amp;.*(2)).sum</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And can be written as this:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # (1..3).sum(&amp;.*(2))</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Performance/MapInsteadOfBlock:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class MapInsteadOfBlock &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Identifies</span> <span class="n">usage</span> <span class="n">of</span> <span class="err">`</span><span class="n">sum</span><span class="o">/</span><span class="n">product</span><span class="err">`</span> <span class="n">calls</span> <span class="n">that</span> <span class="n">follow</span> <span class="err">`</span><span class="n">map</span><span class="err">`</span><span class="s">"</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    CALL_NAMES = %w(sum product)</span><span class="err">
</span><span class="s">    MAP_NAME   = "</span><span class="n">map</span><span class="s">"</span><span class="err">
</span><span class="s">    MSG        = "</span><span class="n">Use</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span> <span class="p">{...}</span><span class="err">`</span> <span class="n">instead</span> <span class="n">of</span> <span class="err">`</span><span class="n">map</span> <span class="p">{...}.</span><span class="o">%</span><span class="n">s</span><span class="err">`</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::NodeVisitor.new self, source, skip: [</span><span class="err">
</span><span class="s">        Crystal::Macro,</span><span class="err">
</span><span class="s">        Crystal::MacroExpression,</span><span class="err">
</span><span class="s">        Crystal::MacroIf,</span><span class="err">
</span><span class="s">        Crystal::MacroFor,</span><span class="err">
</span><span class="s">      ]</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return unless node.name.in?(CALL_NAMES) &amp;&amp; (obj = node.obj)</span><span class="err">
</span><span class="s">      return unless obj.is_a?(Crystal::Call) &amp;&amp; obj.block</span><span class="err">
</span><span class="s">      return unless obj.name == MAP_NAME</span><span class="err">

</span><span class="s">      issue_for obj.name_location, node.name_end_location,</span><span class="err">
</span><span class="s">        MSG % {node.name, node.name}</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s"># require "</span><span class="p">.</span><span class="o">/</span><span class="n">base</span><span class="s">"</span><span class="err">

</span><span class="s">module Ameba::Rule::Performance</span><span class="err">
</span><span class="s">  # This rule is used to identify usage of `size` calls that follow filter.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, this is considered invalid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # [1, 2, 3].select { |e| e &gt; 2 }.size</span><span class="err">
</span><span class="s">  # [1, 2, 3].reject { |e| e &lt; 2 }.size</span><span class="err">
</span><span class="s">  # [1, 2, 3].select(&amp;.&lt; 2).size</span><span class="err">
</span><span class="s">  # [0, 1, 2].select(&amp;.zero?).size</span><span class="err">
</span><span class="s">  # [0, 1, 2].reject(&amp;.zero?).size</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # And it should be written as this:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # [1, 2, 3].count { |e| e &gt; 2 }</span><span class="err">
</span><span class="s">  # [1, 2, 3].count { |e| e &gt;= 2 }</span><span class="err">
</span><span class="s">  # [1, 2, 3].count(&amp;.&lt; 2)</span><span class="err">
</span><span class="s">  # [0, 1, 2].count(&amp;.zero?)</span><span class="err">
</span><span class="s">  # [0, 1, 2].count(&amp;.!= 0)</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # YAML configuration example:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # Performance/SizeAfterFilter:</span><span class="err">
</span><span class="s">  #   Enabled: true</span><span class="err">
</span><span class="s">  #   FilterNames:</span><span class="err">
</span><span class="s">  #     - select</span><span class="err">
</span><span class="s">  #     - reject</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  class SizeAfterFilter &lt; Base</span><span class="err">
</span><span class="s">    properties do</span><span class="err">
</span><span class="s">      description "</span><span class="n">Identifies</span> <span class="n">usage</span> <span class="n">of</span> <span class="err">`</span><span class="n">size</span><span class="err">`</span> <span class="n">calls</span> <span class="n">that</span> <span class="n">follow</span> <span class="n">filter</span><span class="s">"</span><span class="err">
</span><span class="s">      filter_names : Array(String) = %w(select reject)</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    SIZE_NAME = "</span><span class="n">size</span><span class="s">"</span><span class="err">
</span><span class="s">    MSG       = "</span><span class="n">Use</span> <span class="err">`</span><span class="n">count</span> <span class="p">{...}</span><span class="err">`</span> <span class="n">instead</span> <span class="n">of</span> <span class="err">`</span><span class="o">%</span><span class="n">s</span> <span class="p">{...}.</span><span class="n">size</span><span class="err">`</span><span class="p">.</span><span class="s">"</span><span class="err">

</span><span class="s">    def test(source)</span><span class="err">
</span><span class="s">      AST::NodeVisitor.new self, source, skip: [</span><span class="err">
</span><span class="s">        Crystal::Macro,</span><span class="err">
</span><span class="s">        Crystal::MacroExpression,</span><span class="err">
</span><span class="s">        Crystal::MacroIf,</span><span class="err">
</span><span class="s">        Crystal::MacroFor,</span><span class="err">
</span><span class="s">      ]</span><span class="err">
</span><span class="s">    end</span><span class="err">

</span><span class="s">    def test(source, node : Crystal::Call)</span><span class="err">
</span><span class="s">      return unless node.name == SIZE_NAME &amp;&amp; (obj = node.obj)</span><span class="err">
</span><span class="s">      return unless obj.is_a?(Crystal::Call) &amp;&amp; obj.block</span><span class="err">
</span><span class="s">      return unless obj.name.in?(filter_names)</span><span class="err">

</span><span class="s">      issue_for obj.name_location, node.name_end_location, MSG % obj.name</span><span class="err">
</span><span class="s">    end</span><span class="err">
</span><span class="s">  end</span><span class="err">
</span><span class="s">end</span><span class="err">

</span><span class="s">module Ameba::Rule::Style</span><span class="err">
</span><span class="s">  # A rule that enforces constant names to be in screaming case.</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # For example, these constant names are considered valid:</span><span class="err">
</span><span class="s">  #</span><span class="err">
</span><span class="s">  # ```</span><span class="err">
</span><span class="s">  # LUCKY_NUMBERS     = [3, 7, 11]</span><span class="err">
</span><span class="s">  # DOCUMENTATION_URL = "</span><span class="n">http</span><span class="o">:</span><span class="c1">//crystal-lang.org/docs"</span>
  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And these are invalid names:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># myBadConstant = 1
</span>  <span class="cp"># Wrong_NAME = 2
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/ConstantNames:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">ConstantNames</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Enforces constant names to be in screaming case"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Constant name should be screaming-cased: %s, not %s"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="p">(</span><span class="n">target</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">target</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Path</span><span class="p">)</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">target</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="n">first</span>
      <span class="n">expected</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="n">upcase</span>

      <span class="k">return</span> <span class="k">if</span> <span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">expected</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="n">camelcase</span><span class="p">)</span>

      <span class="n">issue_for</span> <span class="n">target</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="p">{</span><span class="n">expected</span><span class="p">,</span> <span class="n">name</span><span class="p">}</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># Use a guard clause instead of wrapping the code inside a conditional
</span>  <span class="cp"># expression
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># # bad
</span>  <span class="cp"># def test
</span>  <span class="cp">#   if something
</span>  <span class="cp">#     work
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># # good
</span>  <span class="cp"># def test
</span>  <span class="cp">#   return unless something
</span>  <span class="cp">#
</span>  <span class="cp">#   work
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># # also good
</span>  <span class="cp"># def test
</span>  <span class="cp">#   work if something
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># # bad
</span>  <span class="cp"># if something
</span>  <span class="cp">#   raise "exception"
</span>  <span class="cp"># else
</span>  <span class="cp">#   ok
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># # good
</span>  <span class="cp"># raise "exception" if something
</span>  <span class="cp"># ok
</span>  <span class="cp">#
</span>  <span class="cp"># # bad
</span>  <span class="cp"># if something
</span>  <span class="cp">#   foo || raise("exception")
</span>  <span class="cp"># else
</span>  <span class="cp">#   ok
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># # good
</span>  <span class="cp"># foo || raise("exception") if something
</span>  <span class="cp"># ok
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/GuardClause:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">GuardClause</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">enabled</span> <span class="nb">false</span>
      <span class="n">description</span> <span class="s">"Check for conditionals that can be replaced with guard clauses"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Use a guard clause (`%s`) instead of wrapping the "</span> \
          <span class="s">"code inside a conditional expression."</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">AST</span><span class="o">::</span><span class="n">NodeVisitor</span><span class="p">.</span><span class="k">new</span> <span class="n">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">skip</span><span class="o">:</span> <span class="p">[</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span><span class="p">]</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Def</span><span class="p">)</span>
      <span class="n">final_expression</span> <span class="o">=</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">body</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span><span class="p">)</span>
          <span class="n">body</span><span class="p">.</span><span class="n">last</span>
        <span class="k">else</span>
          <span class="n">body</span>
        <span class="n">end</span>

      <span class="k">case</span> <span class="n">final_expression</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span>
        <span class="n">check_ending_if</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">final_expression</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">accepted_form</span><span class="o">?</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ending</span><span class="o">:</span> <span class="nb">false</span><span class="p">)</span>

      <span class="k">case</span>
      <span class="n">when</span> <span class="n">guard_clause</span> <span class="o">=</span> <span class="n">guard_clause</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">then</span><span class="p">)</span>
        <span class="n">parent</span><span class="p">,</span> <span class="n">conditional_keyword</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">then</span><span class="p">,</span> <span class="n">keyword</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">guard_clause</span> <span class="o">=</span> <span class="n">guard_clause</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">)</span>
        <span class="n">parent</span><span class="p">,</span> <span class="n">conditional_keyword</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">,</span> <span class="n">opposite_keyword</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">guard_clause</span> <span class="o">&amp;&amp;</span> <span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">conditional_keyword</span>

      <span class="n">guard_clause_source</span> <span class="o">=</span> <span class="n">guard_clause_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">guard_clause</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
      <span class="n">report_issue</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">guard_clause_source</span><span class="p">,</span> <span class="n">conditional_keyword</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">check_ending_if</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">accepted_form</span><span class="o">?</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ending</span><span class="p">:</span> <span class="nb">true</span><span class="p">)</span>

      <span class="n">report_issue</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="s">"return"</span><span class="p">,</span> <span class="n">opposite_keyword</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">report_issue</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">scope_exiting_keyword</span><span class="p">,</span> <span class="n">conditional_keyword</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">keyword_loc</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">cond_code</span> <span class="o">=</span> <span class="n">node_source</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>

      <span class="n">keyword_end_loc</span> <span class="o">=</span> <span class="n">keyword_loc</span><span class="p">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">column_number</span><span class="o">:</span> <span class="n">keyword</span><span class="p">(</span><span class="n">node</span><span class="p">).</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

      <span class="n">example</span> <span class="o">=</span> <span class="s">"#{scope_exiting_keyword} #{conditional_keyword} #{cond_code}"</span>
      <span class="cp"># TODO: check if example is too long for single line
</span>
      <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Nop</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unless</span> <span class="n">end_end_loc</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">end_location</span>

        <span class="n">end_loc</span> <span class="o">=</span> <span class="n">end_end_loc</span><span class="p">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">column_number</span><span class="o">:</span> <span class="p">{{</span> <span class="mi">1</span> <span class="o">-</span> <span class="s">"end"</span><span class="p">.</span><span class="n">size</span> <span class="p">}})</span>

        <span class="n">issue_for</span> <span class="n">keyword_loc</span><span class="p">,</span> <span class="n">keyword_end_loc</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="n">example</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
          <span class="n">replacement</span> <span class="o">=</span> <span class="s">"#{scope_exiting_keyword} #{conditional_keyword}"</span>
          <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">keyword_loc</span><span class="p">,</span> <span class="n">keyword_end_loc</span><span class="p">,</span> <span class="n">replacement</span><span class="p">)</span>
          <span class="n">corrector</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">end_loc</span><span class="p">,</span> <span class="n">end_end_loc</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="k">else</span>
        <span class="n">issue_for</span> <span class="n">keyword_loc</span><span class="p">,</span> <span class="n">keyword_end_loc</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="n">example</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">keyword</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span><span class="p">)</span>
      <span class="s">"if"</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">keyword</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span><span class="p">)</span>
      <span class="s">"unless"</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">opposite_keyword</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span><span class="p">)</span>
      <span class="s">"unless"</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">opposite_keyword</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span><span class="p">)</span>
      <span class="s">"if"</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">accepted_form</span><span class="o">?</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">ending</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">If</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">ternary</span><span class="o">?</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="n">unless</span> <span class="n">cond_loc</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">.</span><span class="n">location</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="n">unless</span> <span class="n">cond_end_loc</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">.</span><span class="n">end_location</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="n">unless</span> <span class="n">cond_loc</span><span class="p">.</span><span class="n">line_number</span> <span class="o">==</span> <span class="n">cond_end_loc</span><span class="p">.</span><span class="n">line_number</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="n">unless</span> <span class="p">(</span><span class="n">then_loc</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">then</span><span class="p">.</span><span class="n">location</span><span class="p">).</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">cond_loc</span> <span class="o">&lt;</span> <span class="n">then_loc</span>

      <span class="k">if</span> <span class="n">ending</span>
        <span class="o">!</span><span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Nop</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Nop</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">true</span> <span class="n">unless</span> <span class="n">code</span> <span class="o">=</span> <span class="n">node_source</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>

        <span class="n">code</span><span class="p">.</span><span class="n">starts_with</span><span class="o">?</span><span class="p">(</span><span class="s">"elsif"</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">guard_clause</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">node</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">right</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">BinaryOp</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">end_location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">end_location</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">location</span><span class="p">.</span><span class="n">line_number</span> <span class="o">==</span> <span class="n">end_location</span><span class="p">.</span><span class="n">line_number</span>

      <span class="k">case</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span>
        <span class="n">node</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">==</span> <span class="s">"raise"</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Return</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Break</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Next</span>
        <span class="n">node</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">guard_clause_source</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">guard_clause</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
      <span class="n">node</span> <span class="o">=</span> <span class="n">parent</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">BinaryOp</span><span class="p">)</span> <span class="o">?</span> <span class="n">parent</span> <span class="p">:</span> <span class="n">guard_clause</span>

      <span class="n">node_source</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># This rule is used to identify usage of `is_a?/nil?` calls within filters.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># matches = %w[Alice Bob].map(&amp;.match(/^A./))
</span>  <span class="cp">#
</span>  <span class="cp"># matches.any?(&amp;.is_a?(Regex::MatchData)) # =&gt; true
</span>  <span class="cp"># matches.one?(&amp;.nil?)                    # =&gt; true
</span>  <span class="cp">#
</span>  <span class="cp"># typeof(matches.reject(&amp;.nil?))                    # =&gt; Array(Regex::MatchData | Nil)
</span>  <span class="cp"># typeof(matches.select(&amp;.is_a?(Regex::MatchData))) # =&gt; Array(Regex::MatchData | Nil)
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And it should be written as this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># matches = %w[Alice Bob].map(&amp;.match(/^A./))
</span>  <span class="cp">#
</span>  <span class="cp"># matches.any?(Regex::MatchData) # =&gt; true
</span>  <span class="cp"># matches.one?(Nil)              # =&gt; true
</span>  <span class="cp">#
</span>  <span class="cp"># typeof(matches.reject(Nil))              # =&gt; Array(Regex::MatchData)
</span>  <span class="cp"># typeof(matches.select(Regex::MatchData)) # =&gt; Array(Regex::MatchData)
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/IsAFilter:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp">#   FilterNames:
</span>  <span class="cp">#     - select
</span>  <span class="cp">#     - reject
</span>  <span class="cp">#     - any?
</span>  <span class="cp">#     - all?
</span>  <span class="cp">#     - none?
</span>  <span class="cp">#     - one?
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">IsAFilter</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Identifies usage of `is_a?/nil?` calls within filters"</span>
      <span class="n">filter_names</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">String</span><span class="p">)</span> <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">(</span><span class="n">select</span> <span class="n">reject</span> <span class="n">any</span><span class="o">?</span> <span class="n">all</span><span class="o">?</span> <span class="n">none</span><span class="o">?</span> <span class="n">one</span><span class="o">?</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Use `%s` instead of `%s`"</span>
    <span class="n">NEW</span> <span class="o">=</span> <span class="s">"%s(%s)"</span>
    <span class="n">OLD</span> <span class="o">=</span> <span class="s">"%s {...}"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">AST</span><span class="o">::</span><span class="n">NodeVisitor</span><span class="p">.</span><span class="k">new</span> <span class="n">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">skip</span><span class="o">:</span> <span class="p">[</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">Macro</span><span class="p">,</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroExpression</span><span class="p">,</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroIf</span><span class="p">,</span>
        <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroFor</span><span class="p">,</span>
      <span class="p">]</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">filter_names</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">filter_location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name_location</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">block</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">block</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="p">(</span><span class="n">body</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">IsA</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="p">(</span><span class="n">path</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="k">const</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Path</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">body</span><span class="p">.</span><span class="n">obj</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">block</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span>

      <span class="n">name</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="n">names</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">"::"</span><span class="p">)</span>
      <span class="n">name</span> <span class="o">=</span> <span class="s">"::#{name}"</span> <span class="k">if</span> <span class="n">path</span><span class="p">.</span><span class="n">global</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">body</span><span class="p">.</span><span class="n">nil_check</span><span class="o">?</span>

      <span class="n">end_location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">end_location</span>
      <span class="k">if</span> <span class="o">!</span><span class="n">end_location</span> <span class="o">||</span> <span class="n">end_location</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">column_number</span><span class="p">.</span><span class="n">zero</span><span class="o">?</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">end_location</span> <span class="o">=</span> <span class="n">path</span><span class="p">.</span><span class="n">end_location</span>
          <span class="n">end_location</span> <span class="o">=</span> <span class="n">end_location</span><span class="p">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">column_number</span><span class="o">:</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">old</span> <span class="o">=</span> <span class="n">OLD</span> <span class="o">%</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span>
      <span class="k">new</span> <span class="o">=</span> <span class="n">NEW</span> <span class="o">%</span> <span class="p">{</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">}</span>
      <span class="n">msg</span> <span class="o">=</span> <span class="n">MSG</span> <span class="o">%</span> <span class="p">{</span><span class="k">new</span><span class="p">,</span> <span class="n">old</span><span class="p">}</span>

      <span class="k">if</span> <span class="n">end_location</span>
        <span class="n">issue_for</span><span class="p">(</span><span class="n">filter_location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
          <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">filter_location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="k">new</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="k">else</span>
        <span class="n">issue_for</span><span class="p">(</span><span class="n">filter_location</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that disallows calls to `is_a?(Nil)` in favor of `nil?`.
</span>  <span class="cp">#
</span>  <span class="cp"># This is considered bad:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># var.is_a?(Nil)
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And needs to be written as:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># var.nil?
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/IsANil:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">IsANil</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows calls to `is_a?(Nil)` in favor of `nil?`"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Use `nil?` instead of `is_a?(Nil)`"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">IsA</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">nil_check</span><span class="o">?</span>

      <span class="k">const</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="k">const</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">path_named</span><span class="o">?</span><span class="p">(</span><span class="k">const</span><span class="p">,</span> <span class="s">"Nil"</span><span class="p">)</span>

      <span class="n">issue_for</span> <span class="k">const</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="s">"#{node.obj}.nil?"</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that disallows usage of large numbers without underscore.
</span>  <span class="cp"># These do not affect the value of the number, but can help read
</span>  <span class="cp"># large numbers more easily.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, these are considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># 100000
</span>  <span class="cp"># 141592654
</span>  <span class="cp"># 5.123456
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And has to be rewritten as the following:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># 100_000
</span>  <span class="cp"># 141_592_654
</span>  <span class="cp"># 5.123_456
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/LargeNumbers:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp">#   IntMinDigits: 6 # i.e. integers higher than 99999
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">LargeNumbers</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">enabled</span> <span class="nb">false</span>
      <span class="n">description</span> <span class="s">"Disallows usage of large numbers without underscore"</span>
      <span class="n">int_min_digits</span> <span class="mi">6</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Large numbers should be written with underscores: %s"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">Tokenizer</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">source</span><span class="p">).</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">token</span><span class="o">|</span>
        <span class="n">next</span> <span class="n">unless</span> <span class="n">token</span><span class="p">.</span><span class="n">type</span><span class="p">.</span><span class="n">number</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">decimal</span><span class="o">?</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">raw</span><span class="p">)</span>

        <span class="n">parsed</span> <span class="o">=</span> <span class="n">parse_number</span><span class="p">(</span><span class="n">token</span><span class="p">.</span><span class="n">raw</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">allowed</span><span class="o">?</span><span class="p">(</span><span class="o">*</span><span class="n">parsed</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">underscored</span> <span class="o">*</span><span class="n">parsed</span><span class="p">)</span> <span class="o">!=</span> <span class="n">token</span><span class="p">.</span><span class="n">raw</span>
          <span class="n">location</span> <span class="o">=</span> <span class="n">token</span><span class="p">.</span><span class="n">location</span>
          <span class="n">end_location</span> <span class="o">=</span> <span class="n">location</span><span class="p">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">column_number</span><span class="o">:</span> <span class="n">token</span><span class="p">.</span><span class="n">raw</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

          <span class="n">issue_for</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="n">expected</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
            <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">expected</span><span class="p">)</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">decimal</span><span class="o">?</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">!~</span> <span class="o">/^</span><span class="mi">0</span><span class="p">(</span><span class="n">x</span><span class="o">|</span><span class="n">b</span><span class="o">|</span><span class="n">o</span><span class="p">)</span><span class="o">/</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">allowed</span><span class="o">?</span><span class="p">(</span><span class="n">_sign</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fraction</span><span class="p">,</span> <span class="n">_suffix</span><span class="p">)</span>
      <span class="k">return</span> <span class="nb">true</span> <span class="k">if</span> <span class="n">fraction</span> <span class="o">&amp;&amp;</span> <span class="n">fraction</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">3</span>

      <span class="n">digits</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">chars</span><span class="p">.</span><span class="n">select</span><span class="o">!</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">number</span><span class="o">?</span><span class="p">)</span>
      <span class="n">digits</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">int_min_digits</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">underscored</span><span class="p">(</span><span class="n">sign</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fraction</span><span class="p">,</span> <span class="n">suffix</span><span class="p">)</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">slice_digits</span><span class="p">(</span><span class="n">value</span><span class="p">.</span><span class="n">reverse</span><span class="p">).</span><span class="n">reverse</span>
      <span class="n">fraction</span> <span class="o">=</span> <span class="s">".#{slice_digits(fraction)}"</span> <span class="k">if</span> <span class="n">fraction</span>

      <span class="s">"#{sign}#{value}#{fraction}#{suffix}"</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">slice_digits</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">by</span> <span class="o">=</span> <span class="mi">3</span><span class="p">)</span>
      <span class="o">%</span><span class="n">w</span><span class="p">[].</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">slices</span><span class="o">|</span>
        <span class="n">value</span><span class="p">.</span><span class="n">chars</span><span class="p">.</span><span class="n">reject</span><span class="o">!</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="o">==</span> <span class="sc">'_'</span><span class="p">).</span><span class="n">each_slice</span><span class="p">(</span><span class="n">by</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">slice</span><span class="o">|</span>
          <span class="n">slices</span> <span class="o">&lt;&lt;</span> <span class="n">slice</span><span class="p">.</span><span class="n">join</span>
        <span class="n">end</span>
      <span class="n">end</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="sc">'_'</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">parse_number</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">value</span><span class="p">,</span> <span class="n">sign</span> <span class="o">=</span> <span class="n">parse_sign</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">value</span><span class="p">,</span> <span class="n">suffix</span> <span class="o">=</span> <span class="n">parse_suffix</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="n">value</span><span class="p">,</span> <span class="n">fraction</span> <span class="o">=</span> <span class="n">parse_fraction</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

      <span class="p">{</span><span class="n">sign</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">fraction</span><span class="p">,</span> <span class="n">suffix</span><span class="p">}</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="nf">parse_sign</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="sc">'+'</span><span class="p">,</span> <span class="sc">'-'</span><span class="p">)</span>
        <span class="n">sign</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mf">1.</span><span class="p">.</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
      <span class="n">end</span>
      <span class="p">{</span><span class="n">value</span><span class="p">,</span> <span class="n">sign</span><span class="p">}</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">parse_suffix</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">value</span> <span class="o">=~</span> <span class="o">/</span><span class="p">(</span><span class="n">e</span><span class="o">|</span><span class="n">_</span><span class="o">?</span><span class="p">(</span><span class="n">i</span><span class="o">|</span><span class="n">u</span><span class="o">|</span><span class="n">f</span><span class="p">))</span><span class="o">/</span><span class="p">)</span>
        <span class="n">suffix</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">pos</span><span class="p">..</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mf">0.</span><span class="p">.</span><span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">end</span>
      <span class="p">{</span><span class="n">value</span><span class="p">,</span> <span class="n">suffix</span><span class="p">}</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">parse_fraction</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">comma</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="sc">'.'</span><span class="p">)</span>
        <span class="n">fraction</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="n">comma</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">.</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">[</span><span class="mf">0.</span><span class="p">.</span><span class="n">comma</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">end</span>
      <span class="p">{</span><span class="n">value</span><span class="p">,</span> <span class="n">fraction</span><span class="p">}</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that enforces method names to be in underscored case.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, these are considered valid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># class Person
</span>  <span class="cp">#   def first_name
</span>  <span class="cp">#   end
</span>  <span class="cp">#
</span>  <span class="cp">#   def date_of_birth
</span>  <span class="cp">#   end
</span>  <span class="cp">#
</span>  <span class="cp">#   def homepage_url
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And these are invalid method names:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># class Person
</span>  <span class="cp">#   def firstName
</span>  <span class="cp">#   end
</span>  <span class="cp">#
</span>  <span class="cp">#   def date_of_Birth
</span>  <span class="cp">#   end
</span>  <span class="cp">#
</span>  <span class="cp">#   def homepageURL
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/MethodNames:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">MethodNames</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Enforces method names to be in underscored case"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Method name should be underscore-cased: %s, not %s"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Def</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="p">(</span><span class="n">expected</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">underscore</span><span class="p">)</span> <span class="o">==</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">location</span> <span class="o">=</span> <span class="n">name_location</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">end_location</span> <span class="o">=</span> <span class="n">name_end_location</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>

      <span class="n">issue_for</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="p">{</span><span class="n">expected</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">}</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that disallows negated conditions in unless.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># unless !s.empty?
</span>  <span class="cp">#   :ok
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And should be rewritten to the following:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># if s.empty?
</span>  <span class="cp">#   :ok
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># It is pretty difficult to wrap your head around a block of code
</span>  <span class="cp"># that is executed if a negated condition is NOT met.
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/NegatedConditionsInUnless:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">NegatedConditionsInUnless</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows negated conditions in unless"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Avoid negated conditions in unless blocks"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span><span class="p">)</span>
      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">if</span> <span class="n">negated_condition</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">negated_condition</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="k">case</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">BinaryOp</span>
        <span class="n">negated_condition</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">left</span><span class="p">)</span> <span class="o">||</span> <span class="n">negated_condition</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">right</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span>
        <span class="n">node</span><span class="p">.</span><span class="n">expressions</span><span class="p">.</span><span class="n">any</span><span class="o">?</span> <span class="err">{</span> <span class="o">|</span><span class="n">exp</span><span class="o">|</span> <span class="n">negated_condition</span><span class="o">?</span><span class="p">(</span><span class="n">exp</span><span class="p">)</span> <span class="err">}</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Not</span>
        <span class="nb">true</span>
      <span class="k">else</span>
        <span class="nb">false</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that checks for the presence of superfluous parentheses
</span>  <span class="cp"># around the condition of `if`, `unless`, `case, `while` and `until`.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># if (foo == 42)
</span>  <span class="cp">#   do_something
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And should be replaced by the following:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># if foo == 42
</span>  <span class="cp">#   do_something
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/ParenthesesAroundCondition:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp">#   ExcludeTernary: false
</span>  <span class="cp">#   AllowSafeAssignment: false
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">ParenthesesAroundCondition</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows redundant parentheses around control expressions"</span>

      <span class="n">exclude_ternary</span> <span class="nb">false</span>
      <span class="n">allow_safe_assignment</span> <span class="nb">false</span>
    <span class="n">end</span>

    <span class="n">MSG_REDUNDANT</span> <span class="o">=</span> <span class="s">"Redundant parentheses"</span>
    <span class="n">MSG_MISSING</span>   <span class="o">=</span> <span class="s">"Missing parentheses"</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">strip_parentheses</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">in_ternary</span><span class="p">)</span> <span class="p">:</span> <span class="n">Bool</span>
      <span class="k">case</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">BinaryOp</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ExceptionHandler</span>
        <span class="o">!</span><span class="n">in_ternary</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span>
        <span class="o">!</span><span class="n">in_ternary</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="n">has_parentheses</span><span class="o">?</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Yield</span>
        <span class="o">!</span><span class="n">in_ternary</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="n">has_parentheses</span><span class="o">?</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="n">exps</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">OpAssign</span><span class="p">,</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">MultiAssign</span>
        <span class="o">!</span><span class="n">in_ternary</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">allow_safe_assignment</span><span class="o">?</span>
      <span class="k">else</span>
        <span class="nb">true</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Case</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Until</span><span class="p">)</span>
      <span class="n">cond</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span>

      <span class="k">if</span> <span class="n">cond</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">allow_safe_assignment</span><span class="o">?</span>
        <span class="n">issue_for</span> <span class="n">cond</span><span class="p">,</span> <span class="n">MSG_MISSING</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
          <span class="n">corrector</span><span class="p">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="sc">'('</span><span class="p">,</span> <span class="sc">')'</span><span class="p">)</span>
        <span class="n">end</span>
        <span class="k">return</span>
      <span class="n">end</span>

      <span class="n">is_ternary</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">If</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">ternary</span><span class="o">?</span>

      <span class="k">return</span> <span class="k">if</span> <span class="n">is_ternary</span> <span class="o">&amp;&amp;</span> <span class="n">exclude_ternary</span><span class="o">?</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">cond</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">cond</span><span class="p">.</span><span class="n">keyword</span><span class="p">.</span><span class="n">paren</span><span class="o">?</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">exp</span> <span class="o">=</span> <span class="n">cond</span><span class="p">.</span><span class="n">single_expression</span><span class="o">?</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">strip_parentheses</span><span class="o">?</span><span class="p">(</span><span class="n">exp</span><span class="p">,</span> <span class="n">is_ternary</span><span class="p">)</span>

      <span class="n">issue_for</span> <span class="n">cond</span><span class="p">,</span> <span class="n">MSG_REDUNDANT</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">remove_trailing</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">remove_leading</span><span class="p">(</span><span class="n">cond</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that disallows tautological predicate names -
</span>  <span class="cp"># meaning those that start with the prefix `is_`, except for
</span>  <span class="cp"># the ones that are not valid Crystal code (e.g. `is_404?`).
</span>  <span class="cp">#
</span>  <span class="cp"># Favour this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def valid?(x)
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># Over this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def is_valid?(x)
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/PredicateName:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">PredicateName</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows tautological predicate names"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Favour method name '%s?' over '%s'"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Def</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span> <span class="o">=~</span> <span class="o">/^</span><span class="n">is_</span><span class="p">([</span><span class="n">a</span><span class="o">-</span><span class="n">z</span><span class="p">]</span><span class="err">\</span><span class="n">w</span><span class="o">*</span><span class="p">)</span><span class="err">\</span><span class="o">?</span><span class="err">$</span><span class="o">/</span>
      <span class="n">alternative</span> <span class="o">=</span> <span class="err">$</span><span class="mi">1</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="p">{</span><span class="n">alternative</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">}</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that disallows boolean properties without the `?` suffix - defined
</span>  <span class="cp"># using `Object#(class_)property` or `Object#(class_)getter` macros.
</span>  <span class="cp">#
</span>  <span class="cp"># Favour this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># class Person
</span>  <span class="cp">#   property? deceased = false
</span>  <span class="cp">#   getter? witty = true
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># Over this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># class Person
</span>  <span class="cp">#   property deceased = false
</span>  <span class="cp">#   getter witty = true
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/QueryBoolMethods:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">QueryBoolMethods</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Reports boolean properties without the `?` suffix"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Consider using '%s?' for '%s'"</span>

    <span class="n">CALL_NAMES</span> <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">[</span><span class="n">getter</span> <span class="n">class_getter</span> <span class="n">property</span> <span class="n">class_property</span><span class="p">]</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ClassDef</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ModuleDef</span><span class="p">)</span>
      <span class="n">calls</span> <span class="o">=</span>
        <span class="k">case</span> <span class="n">body</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span>
        <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span>
          <span class="p">[</span><span class="n">body</span><span class="p">]</span> <span class="k">if</span> <span class="n">body</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">CALL_NAMES</span><span class="p">)</span>
        <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span>
          <span class="n">body</span><span class="p">.</span><span class="n">expressions</span>
            <span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
            <span class="p">.</span><span class="n">select</span><span class="o">!</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">CALL_NAMES</span><span class="p">))</span>
        <span class="n">end</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">calls</span>

      <span class="n">calls</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">exp</span><span class="o">|</span>
        <span class="n">exp</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg</span><span class="o">|</span>
          <span class="n">name_node</span><span class="p">,</span> <span class="n">is_bool</span> <span class="o">=</span>
            <span class="k">case</span> <span class="n">arg</span>
            <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span>
              <span class="err">{</span><span class="n">arg</span><span class="p">.</span><span class="n">target</span><span class="p">,</span> <span class="n">arg</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">BoolLiteral</span><span class="p">)</span><span class="err">}</span>
            <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">TypeDeclaration</span>
              <span class="err">{</span><span class="n">arg</span><span class="p">.</span><span class="n">var</span><span class="p">,</span> <span class="n">path_named</span><span class="o">?</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">declared_type</span><span class="p">,</span> <span class="s">"Bool"</span><span class="p">)</span><span class="err">}</span>
            <span class="k">else</span>
              <span class="err">{</span><span class="n">nil</span><span class="p">,</span> <span class="nb">false</span><span class="err">}</span>
            <span class="n">end</span>

          <span class="k">if</span> <span class="n">name_node</span> <span class="o">&amp;&amp;</span> <span class="n">is_bool</span>
            <span class="n">issue_for</span> <span class="n">name_node</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="err">{</span><span class="n">exp</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name_node</span><span class="err">}</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that disallows redundant begin blocks.
</span>  <span class="cp">#
</span>  <span class="cp"># Currently it is able to detect:
</span>  <span class="cp">#
</span>  <span class="cp"># 1. Exception handler block that can be used as a part of the method.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def method
</span>  <span class="cp">#   begin
</span>  <span class="cp">#     read_content
</span>  <span class="cp">#   rescue
</span>  <span class="cp">#     close_file
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># should be rewritten as:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def method
</span>  <span class="cp">#   read_content
</span>  <span class="cp"># rescue
</span>  <span class="cp">#   close_file
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># 2. begin..end block as a top level block in a method.
</span>  <span class="cp">#
</span>  <span class="cp"># For example this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def method
</span>  <span class="cp">#   begin
</span>  <span class="cp">#     a = 1
</span>  <span class="cp">#     b = 2
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># and has to be written as the following:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def method
</span>  <span class="cp">#   a = 1
</span>  <span class="cp">#   b = 2
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/RedundantBegin:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">RedundantBegin</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows redundant begin blocks"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Redundant `begin` block detected"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Def</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">def_loc</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span>

      <span class="k">case</span> <span class="n">body</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ExceptionHandler</span>
        <span class="k">return</span> <span class="k">if</span> <span class="n">begin_exprs_in_handler</span><span class="o">?</span><span class="p">(</span><span class="n">body</span><span class="p">)</span> <span class="o">||</span> <span class="n">inner_handler</span><span class="o">?</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span>
        <span class="k">return</span> <span class="n">unless</span> <span class="n">redundant_begin_in_expressions</span><span class="o">?</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">return</span>
      <span class="n">end</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">begin_range</span> <span class="o">=</span> <span class="n">def_redundant_begin_range</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>

      <span class="n">begin_loc</span><span class="p">,</span> <span class="n">end_loc</span> <span class="o">=</span> <span class="n">begin_range</span>
      <span class="n">begin_loc</span><span class="p">,</span> <span class="n">end_loc</span> <span class="o">=</span> <span class="n">def_loc</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">begin_loc</span><span class="p">),</span> <span class="n">def_loc</span><span class="p">.</span><span class="n">seek</span><span class="p">(</span><span class="n">end_loc</span><span class="p">)</span>
      <span class="n">begin_end_loc</span> <span class="o">=</span> <span class="n">begin_loc</span><span class="p">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">column_number</span><span class="p">:</span> <span class="err">{{</span> <span class="s">"begin"</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="err">}}</span><span class="p">)</span>
      <span class="n">end_end_loc</span> <span class="o">=</span> <span class="n">end_loc</span><span class="p">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">column_number</span><span class="p">:</span> <span class="p">{{</span> <span class="s">"end"</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">}})</span>

      <span class="n">issue_for</span> <span class="n">begin_loc</span><span class="p">,</span> <span class="n">begin_end_loc</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">begin_loc</span><span class="p">,</span> <span class="n">begin_end_loc</span><span class="p">)</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">end_loc</span><span class="p">,</span> <span class="n">end_end_loc</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">redundant_begin_in_expressions</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="o">!!</span><span class="n">node</span><span class="p">.</span><span class="n">keyword</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">begin</span><span class="o">?</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">inner_handler</span><span class="o">?</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
      <span class="n">handler</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">ExceptionHandler</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">begin_exprs_in_handler</span><span class="o">?</span><span class="p">(</span><span class="n">handler</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="p">(</span><span class="n">body</span> <span class="o">=</span> <span class="n">handler</span><span class="p">.</span><span class="n">body</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span><span class="p">)</span>
      <span class="n">body</span><span class="p">.</span><span class="n">expressions</span><span class="p">.</span><span class="n">first</span><span class="o">?</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">ExceptionHandler</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">def_redundant_begin_range</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">code</span> <span class="o">=</span> <span class="n">node_source</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>

      <span class="n">lexer</span> <span class="o">=</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Lexer</span><span class="p">.</span><span class="k">new</span> <span class="n">code</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">begin_loc</span> <span class="o">=</span> <span class="n">def_redundant_begin_loc</span><span class="p">(</span><span class="n">lexer</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">end_loc</span> <span class="o">=</span> <span class="n">def_redundant_end_loc</span><span class="p">(</span><span class="n">lexer</span><span class="p">)</span>

      <span class="p">{</span><span class="n">begin_loc</span><span class="p">,</span> <span class="n">end_loc</span><span class="p">}</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="nf">def_redundant_begin_loc</span><span class="p">(</span><span class="n">lexer</span><span class="p">)</span>
      <span class="n">in_body</span> <span class="o">=</span> <span class="n">in_argument_list</span> <span class="o">=</span> <span class="nb">false</span>

      <span class="n">loop</span> <span class="k">do</span>
        <span class="n">token</span> <span class="o">=</span> <span class="n">lexer</span><span class="p">.</span><span class="n">next_token</span>

        <span class="k">case</span> <span class="n">token</span><span class="p">.</span><span class="n">type</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">eof</span><span class="o">?</span><span class="p">,</span> <span class="p">.</span><span class="n">op_minus_gt</span><span class="o">?</span>
          <span class="k">break</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">ident</span><span class="o">?</span>
          <span class="n">next</span> <span class="n">unless</span> <span class="n">in_body</span>
          <span class="k">return</span> <span class="n">unless</span> <span class="n">token</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Keyword</span><span class="o">::</span><span class="n">BEGIN</span>
          <span class="k">return</span> <span class="n">token</span><span class="p">.</span><span class="n">location</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">op_lparen</span><span class="o">?</span>
          <span class="n">in_argument_list</span> <span class="o">=</span> <span class="nb">true</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">op_rparen</span><span class="o">?</span>
          <span class="n">in_argument_list</span> <span class="o">=</span> <span class="nb">false</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">newline</span><span class="o">?</span>
          <span class="n">in_body</span> <span class="o">=</span> <span class="nb">true</span> <span class="n">unless</span> <span class="n">in_argument_list</span>
        <span class="n">when</span> <span class="p">.</span><span class="n">space</span><span class="o">?</span>
          <span class="cp"># ignore
</span>        <span class="k">else</span>
          <span class="k">return</span> <span class="k">if</span> <span class="n">in_body</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">def_redundant_end_loc</span><span class="p">(</span><span class="n">lexer</span><span class="p">)</span>
      <span class="n">end_loc</span> <span class="o">=</span> <span class="n">def_end_loc</span> <span class="o">=</span> <span class="n">nil</span>

      <span class="n">Tokenizer</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">lexer</span><span class="p">).</span><span class="n">run</span> <span class="k">do</span> <span class="o">|</span><span class="n">token</span><span class="o">|</span>
        <span class="n">next</span> <span class="n">unless</span> <span class="n">token</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Keyword</span><span class="o">::</span><span class="n">END</span>

        <span class="n">end_loc</span><span class="p">,</span> <span class="n">def_end_loc</span> <span class="o">=</span> <span class="n">def_end_loc</span><span class="p">,</span> <span class="n">token</span><span class="p">.</span><span class="n">location</span>
      <span class="n">end</span>

      <span class="n">end_loc</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that disallows redundant next expressions. A `next` keyword allows
</span>  <span class="cp"># a block to skip to the next iteration early, however, it is considered
</span>  <span class="cp"># redundant in cases where it is the last expression in a block or combines
</span>  <span class="cp"># into the node which is the last in a block.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># block do |v|
</span>  <span class="cp">#   next v + 1
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># block do |v|
</span>  <span class="cp">#   case v
</span>  <span class="cp">#   when .nil?
</span>  <span class="cp">#     next "nil"
</span>  <span class="cp">#   when .blank?
</span>  <span class="cp">#     next "blank"
</span>  <span class="cp">#   else
</span>  <span class="cp">#     next "empty"
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And has to be written as the following:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># block do |v|
</span>  <span class="cp">#   v + 1
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># block do |v|
</span>  <span class="cp">#   case arg
</span>  <span class="cp">#   when .nil?
</span>  <span class="cp">#     "nil"
</span>  <span class="cp">#   when .blank?
</span>  <span class="cp">#     "blank"
</span>  <span class="cp">#   else
</span>  <span class="cp">#     "empty"
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># ### Configuration params
</span>  <span class="cp">#
</span>  <span class="cp"># 1. *allow_multi_next*, default: true
</span>  <span class="cp">#
</span>  <span class="cp"># Allows end-user to configure whether to report or not the next statements
</span>  <span class="cp"># which yield tuple literals i.e.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># block do
</span>  <span class="cp">#   next a, b
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># If this param equals to `false`, the block above will be forced to be written as:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># block do
</span>  <span class="cp">#   {a, b}
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># 2. *allow_empty_next*, default: true
</span>  <span class="cp">#
</span>  <span class="cp"># Allows end-user to configure whether to report or not the next statements
</span>  <span class="cp"># without arguments. Sometimes such statements are used to yild the `nil` value explicitly.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># block do
</span>  <span class="cp">#   @foo = :empty
</span>  <span class="cp">#   next
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># If this param equals to `false`, the block above will be forced to be written as:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># block do
</span>  <span class="cp">#   @foo = :empty
</span>  <span class="cp">#   nil
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># ### YAML config example
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/RedundantNext:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp">#   AllowMultiNext: true
</span>  <span class="cp">#   AllowEmptyNext: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">RedundantNext</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Reports redundant next expressions"</span>

      <span class="n">allow_multi_next</span> <span class="nb">true</span>
      <span class="n">allow_empty_next</span> <span class="nb">true</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Redundant `next` detected"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="p">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Block</span><span class="p">)</span>
      <span class="n">AST</span><span class="o">::</span><span class="n">RedundantControlExpressionVisitor</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Next</span><span class="p">,</span> <span class="n">visitor</span> <span class="o">:</span> <span class="n">AST</span><span class="o">::</span><span class="n">RedundantControlExpressionVisitor</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">allow_multi_next</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">exp</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">TupleLiteral</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">allow_empty_next</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">exp</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="n">exp</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">nop</span><span class="o">?</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">exp_code</span> <span class="o">=</span> <span class="n">control_exp_code</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
          <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exp_code</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="k">else</span>
        <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that disallows redundant return expressions.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def foo
</span>  <span class="cp">#   return :bar
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def bar(arg)
</span>  <span class="cp">#   case arg
</span>  <span class="cp">#   when .nil?
</span>  <span class="cp">#     return "nil"
</span>  <span class="cp">#   when .blank?
</span>  <span class="cp">#     return "blank"
</span>  <span class="cp">#   else
</span>  <span class="cp">#     return "empty"
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And has to be written as the following:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def foo
</span>  <span class="cp">#   :bar
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def bar(arg)
</span>  <span class="cp">#   case arg
</span>  <span class="cp">#   when .nil?
</span>  <span class="cp">#     "nil"
</span>  <span class="cp">#   when .blank?
</span>  <span class="cp">#     "blank"
</span>  <span class="cp">#   else
</span>  <span class="cp">#     "empty"
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># ### Configuration params
</span>  <span class="cp">#
</span>  <span class="cp"># 1. *allow_multi_return*, default: true
</span>  <span class="cp">#
</span>  <span class="cp"># Allows end-user to configure whether to report or not the return statements
</span>  <span class="cp"># which return tuple literals i.e.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def method(a, b)
</span>  <span class="cp">#   return a, b
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># If this param equals to `false`, the method above has to be written as:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def method(a, b)
</span>  <span class="cp">#   {a, b}
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># 2. *allow_empty_return*, default: true
</span>  <span class="cp">#
</span>  <span class="cp"># Allows end-user to configure whether to report or not the return statements
</span>  <span class="cp"># without arguments. Sometimes such returns are used to return the `nil` value explicitly.
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def method
</span>  <span class="cp">#   @foo = :empty
</span>  <span class="cp">#   return
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># If this param equals to `false`, the method above has to be written as:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># def method
</span>  <span class="cp">#   @foo = :empty
</span>  <span class="cp">#   nil
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># ### YAML config example
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/RedundantReturn:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp">#   AllowMultiReturn: true
</span>  <span class="cp">#   AllowEmptyReturn: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">RedundantReturn</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Reports redundant return expressions"</span>

      <span class="n">allow_multi_return</span> <span class="nb">true</span>
      <span class="n">allow_empty_return</span> <span class="nb">true</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Redundant `return` detected"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Def</span><span class="p">)</span>
      <span class="n">AST</span><span class="o">::</span><span class="n">RedundantControlExpressionVisitor</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">self</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">.</span><span class="n">body</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Return</span><span class="p">,</span> <span class="n">visitor</span> <span class="o">:</span> <span class="n">AST</span><span class="o">::</span><span class="n">RedundantControlExpressionVisitor</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">allow_multi_return</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">exp</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">TupleLiteral</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">allow_empty_return</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">exp</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">node</span><span class="p">.</span><span class="n">exp</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">nop</span><span class="o">?</span><span class="p">))</span>

      <span class="k">if</span> <span class="n">exp_code</span> <span class="o">=</span> <span class="n">control_exp_code</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
        <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
          <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">exp_code</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="k">else</span>
        <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that enforces type names in camelcase manner.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, these are considered valid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># class ParseError &lt; Exception
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># module HTTP
</span>  <span class="cp">#   class RequestHandler
</span>  <span class="cp">#   end
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># alias NumericValue = Float32 | Float64 | Int32 | Int64
</span>  <span class="cp">#
</span>  <span class="cp"># lib LibYAML
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># struct TagDirective
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># enum Time::DayOfWeek
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And these are invalid type names
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># class My_class
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># module HTT_p
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># alias Numeric_value = Int32
</span>  <span class="cp">#
</span>  <span class="cp"># lib Lib_YAML
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># struct Tag_directive
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># enum Time_enum::Day_of_week
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/TypeNames:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">TypeNames</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Enforces type names in camelcase manner"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Type name should be camelcased: %s, but it was %s"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Alias</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ClassDef</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ModuleDef</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">LibDef</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">EnumDef</span><span class="p">)</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">to_s</span>
      <span class="n">expected</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="n">camelcase</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">expected</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="p">{</span><span class="n">expected</span><span class="p">,</span> <span class="n">name</span><span class="p">}</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that disallows the use of an `else` block with the `unless`.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, the rule considers these valid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># unless something
</span>  <span class="cp">#   :ok
</span>  <span class="cp"># end
</span>  <span class="cp">#
</span>  <span class="cp"># if something
</span>  <span class="cp">#   :one
</span>  <span class="cp"># else
</span>  <span class="cp">#   :two
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># But it considers this one invalid as it is an `unless` with an `else`:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># unless something
</span>  <span class="cp">#   :one
</span>  <span class="cp"># else
</span>  <span class="cp">#   :two
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># The solution is to swap the order of the blocks, and change the `unless` to
</span>  <span class="cp"># an `if`, so the previous invalid example would become this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># if something
</span>  <span class="cp">#   :two
</span>  <span class="cp"># else
</span>  <span class="cp">#   :one
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/UnlessElse:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">UnlessElse</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows the use of an `else` block with the `unless`"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Favour if over unless with else"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Unless</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="k">else</span><span class="p">.</span><span class="n">nop</span><span class="o">?</span>

      <span class="n">location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span>
      <span class="n">cond_end_location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">.</span><span class="n">end_location</span>
      <span class="n">else_location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">else_location</span>
      <span class="n">end_location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">end_location</span>

      <span class="n">unless</span> <span class="n">location</span> <span class="o">&amp;&amp;</span> <span class="n">cond_end_location</span> <span class="o">&amp;&amp;</span> <span class="n">else_location</span> <span class="o">&amp;&amp;</span> <span class="n">end_location</span>
        <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span>
        <span class="k">return</span>
      <span class="n">end</span>

      <span class="n">issue_for</span> <span class="n">location</span><span class="p">,</span> <span class="n">cond_end_location</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">keyword_begin_pos</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">pos</span><span class="p">(</span><span class="n">location</span><span class="p">)</span>
        <span class="n">keyword_end_pos</span> <span class="o">=</span> <span class="n">keyword_begin_pos</span> <span class="o">+</span> <span class="p">{{</span> <span class="s">"unless"</span><span class="p">.</span><span class="n">size</span> <span class="p">}}</span>
        <span class="n">keyword_range</span> <span class="o">=</span> <span class="n">keyword_begin_pos</span><span class="p">...</span><span class="n">keyword_end_pos</span>

        <span class="n">cond_end_pos</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">pos</span><span class="p">(</span><span class="n">cond_end_location</span><span class="p">,</span> <span class="n">end</span><span class="o">:</span> <span class="nb">true</span><span class="p">)</span>
        <span class="n">else_begin_pos</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">pos</span><span class="p">(</span><span class="n">else_location</span><span class="p">)</span>
        <span class="n">body_range</span> <span class="o">=</span> <span class="n">cond_end_pos</span><span class="p">...</span><span class="n">else_begin_pos</span>

        <span class="n">else_end_pos</span> <span class="o">=</span> <span class="n">else_begin_pos</span> <span class="o">+</span> <span class="p">{{</span> <span class="s">"else"</span><span class="p">.</span><span class="n">size</span> <span class="p">}}</span>
        <span class="n">end_end_pos</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">pos</span><span class="p">(</span><span class="n">end_location</span><span class="p">,</span> <span class="n">end</span><span class="o">:</span> <span class="nb">true</span><span class="p">)</span>
        <span class="n">end_begin_pos</span> <span class="o">=</span> <span class="n">end_end_pos</span> <span class="o">-</span> <span class="p">{{</span> <span class="s">"end"</span><span class="p">.</span><span class="n">size</span> <span class="p">}}</span>
        <span class="n">else_range</span> <span class="o">=</span> <span class="n">else_end_pos</span><span class="p">...</span><span class="n">end_begin_pos</span>

        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">keyword_range</span><span class="p">,</span> <span class="s">"if"</span><span class="p">)</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">body_range</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">code</span><span class="p">[</span><span class="n">else_range</span><span class="p">])</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">else_range</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">code</span><span class="p">[</span><span class="n">body_range</span><span class="p">])</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that enforces variable names to be in underscored case.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, these variable names are considered valid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># var_name = 1
</span>  <span class="cp"># name = 2
</span>  <span class="cp"># _another_good_name = 3
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And these are invalid variable names:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># myBadNamedVar = 1
</span>  <span class="cp"># wrong_Name = 2
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/VariableNames:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">VariableNames</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Enforces variable names to be in underscored case"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"Var name should be underscore-cased: %s, not %s"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">)</span>
      <span class="n">VarVisitor</span><span class="p">.</span><span class="k">new</span> <span class="n">self</span><span class="p">,</span> <span class="n">source</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">InstanceVar</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ClassVar</span><span class="p">)</span>
      <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">to_s</span>
      <span class="n">expected</span> <span class="o">=</span> <span class="n">name</span><span class="p">.</span><span class="n">underscore</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="n">expected</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="p">{</span><span class="n">expected</span><span class="p">,</span> <span class="n">name</span><span class="p">}</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="k">class</span> <span class="nc">VarVisitor</span> <span class="o">&lt;</span> <span class="n">AST</span><span class="o">::</span><span class="n">NodeVisitor</span>
      <span class="k">private</span> <span class="n">getter</span> <span class="n">var_locations</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span>
        <span class="o">!</span><span class="n">node</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">var_locations</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">super</span>
      <span class="n">end</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">InstanceVar</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ClassVar</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span>
          <span class="n">var_locations</span> <span class="o">&lt;&lt;</span> <span class="n">location</span>
        <span class="n">end</span>
        <span class="n">super</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># This rule is used to identify usage of single expression blocks with
</span>  <span class="cp"># argument as a receiver, that can be collapsed into a short form.
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># (1..3).any? { |i| i.odd? }
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And it should be written as this:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># (1..3).any?(&amp;.odd?)
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/VerboseBlock:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp">#   ExcludeMultipleLineBlocks: true
</span>  <span class="cp">#   ExcludeCallsWithBlock: true
</span>  <span class="cp">#   ExcludePrefixOperators: true
</span>  <span class="cp">#   ExcludeOperators: true
</span>  <span class="cp">#   ExcludeSetters: false
</span>  <span class="cp">#   MaxLineLength: ~
</span>  <span class="cp">#   MaxLength: 50 # use ~ to disable
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">VerboseBlock</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Identifies usage of collapsible single expression blocks"</span>

      <span class="n">exclude_multiple_line_blocks</span> <span class="nb">true</span>
      <span class="n">exclude_calls_with_block</span> <span class="nb">true</span>
      <span class="n">exclude_prefix_operators</span> <span class="nb">true</span>
      <span class="n">exclude_operators</span> <span class="nb">true</span>
      <span class="n">exclude_setters</span> <span class="nb">false</span>

      <span class="n">max_line_length</span> <span class="o">:</span> <span class="n">Int32</span><span class="o">?</span> <span class="o">=</span> <span class="n">nil</span> <span class="err">#</span> <span class="mi">100</span>
      <span class="n">max_length</span> <span class="o">:</span> <span class="n">Int32</span><span class="o">?</span> <span class="o">=</span> <span class="mi">50</span>
    <span class="n">end</span>

    <span class="n">MSG</span>          <span class="o">=</span> <span class="s">"Use short block notation instead: `%s`"</span>
    <span class="n">CALL_PATTERN</span> <span class="o">=</span> <span class="s">"%s(%s&amp;.%s)"</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">same_location_lines</span><span class="o">?</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">a_location</span> <span class="o">=</span> <span class="n">a</span><span class="p">.</span><span class="n">name_location</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">b_location</span> <span class="o">=</span> <span class="n">b</span><span class="p">.</span><span class="n">location</span>

      <span class="n">a_location</span><span class="p">.</span><span class="n">line_number</span> <span class="o">==</span> <span class="n">b_location</span><span class="p">.</span><span class="n">line_number</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">PREFIX_OPERATORS</span> <span class="o">=</span> <span class="p">{</span><span class="s">"+"</span><span class="p">,</span> <span class="s">"-"</span><span class="p">,</span> <span class="s">"~"</span><span class="p">}</span>
    <span class="k">private</span> <span class="n">OPERATOR_CHARS</span>   <span class="o">=</span>
      <span class="p">{</span><span class="sc">'['</span><span class="p">,</span> <span class="sc">']'</span><span class="p">,</span> <span class="sc">'!'</span><span class="p">,</span> <span class="sc">'='</span><span class="p">,</span> <span class="sc">'&gt;'</span><span class="p">,</span> <span class="sc">'&lt;'</span><span class="p">,</span> <span class="sc">'~'</span><span class="p">,</span> <span class="sc">'+'</span><span class="p">,</span> <span class="sc">'-'</span><span class="p">,</span> <span class="sc">'*'</span><span class="p">,</span> <span class="sc">'/'</span><span class="p">,</span> <span class="sc">'%'</span><span class="p">,</span> <span class="sc">'^'</span><span class="p">,</span> <span class="sc">'|'</span><span class="p">,</span> <span class="sc">'&amp;'</span><span class="p">}</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">prefix_operator</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">PREFIX_OPERATORS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="k">operator</span><span class="o">?</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="o">!</span><span class="n">name</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">in</span><span class="o">?</span><span class="p">(</span><span class="n">OPERATOR_CHARS</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">setter</span><span class="o">?</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="o">!</span><span class="n">name</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">letter</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">name</span><span class="p">.</span><span class="n">ends_with</span><span class="o">?</span><span class="p">(</span><span class="sc">'='</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">valid_length</span><span class="o">?</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">max_length</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">max_length</span>
        <span class="k">return</span> <span class="n">code</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">max_length</span>
      <span class="n">end</span>
      <span class="nb">true</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">valid_line_length</span><span class="o">?</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">max_line_length</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">max_line_length</span>
        <span class="k">if</span> <span class="n">location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name_location</span>
          <span class="n">final_line_length</span> <span class="o">=</span> <span class="n">location</span><span class="p">.</span><span class="n">column_number</span> <span class="o">+</span> <span class="n">code</span><span class="p">.</span><span class="n">size</span>
          <span class="k">return</span> <span class="n">final_line_length</span> <span class="o">&lt;=</span> <span class="n">max_line_length</span>
        <span class="n">end</span>
      <span class="n">end</span>
      <span class="nb">true</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">reference_count</span><span class="p">(</span><span class="n">node</span><span class="p">,</span> <span class="n">obj</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">)</span>
      <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">case</span> <span class="n">node</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="n">reference_count</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">obj</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="n">reference_count</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">block</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>

        <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg</span><span class="o">|</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">reference_count</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">end</span>
        <span class="n">node</span><span class="p">.</span><span class="n">named_args</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg</span><span class="o">|</span>
          <span class="n">i</span> <span class="o">+=</span> <span class="n">reference_count</span><span class="p">(</span><span class="n">arg</span><span class="p">.</span><span class="n">value</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Block</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="n">reference_count</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">body</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
      <span class="n">when</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span>
        <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">node</span> <span class="o">==</span> <span class="n">obj</span>
      <span class="n">end</span>
      <span class="n">i</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">args_to_s</span><span class="p">(</span><span class="n">io</span> <span class="p">:</span> <span class="n">IO</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">,</span> <span class="n">short_block</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span> <span class="n">skip_last_arg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">dup</span><span class="p">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">args</span><span class="o">|</span>
        <span class="n">args</span><span class="p">.</span><span class="n">pop</span><span class="o">?</span> <span class="k">if</span> <span class="n">skip_last_arg</span>
        <span class="n">args</span><span class="p">.</span><span class="n">join</span> <span class="n">io</span><span class="p">,</span> <span class="s">", "</span>

        <span class="n">named_args</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">named_args</span>
        <span class="k">if</span> <span class="n">named_args</span>
          <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="s">", "</span> <span class="n">unless</span> <span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">||</span> <span class="n">named_args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
          <span class="n">named_args</span><span class="p">.</span><span class="n">join</span> <span class="n">io</span><span class="p">,</span> <span class="s">", "</span> <span class="k">do</span> <span class="o">|</span><span class="n">arg</span><span class="p">,</span> <span class="n">inner_io</span><span class="o">|</span>
            <span class="n">inner_io</span> <span class="o">&lt;&lt;</span> <span class="n">arg</span><span class="p">.</span><span class="n">name</span> <span class="o">&lt;&lt;</span> <span class="s">": "</span> <span class="o">&lt;&lt;</span> <span class="n">arg</span><span class="p">.</span><span class="n">value</span>
          <span class="n">end</span>
        <span class="n">end</span>

        <span class="k">if</span> <span class="n">short_block</span>
          <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="s">", "</span> <span class="n">unless</span> <span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">named_args</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span> <span class="n">named_args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span><span class="p">)</span>
          <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="n">short_block</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">node_to_s</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="n">String</span><span class="p">.</span><span class="n">build</span> <span class="k">do</span> <span class="o">|</span><span class="n">str</span><span class="o">|</span>
        <span class="k">case</span> <span class="n">name</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">name</span>
        <span class="n">when</span> <span class="s">"[]"</span>
          <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="sc">'['</span>
          <span class="n">args_to_s</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
          <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="sc">']'</span>
        <span class="n">when</span> <span class="s">"[]?"</span>
          <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="sc">'['</span>
          <span class="n">args_to_s</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
          <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="s">"]?"</span>
        <span class="n">when</span> <span class="s">"[]="</span>
          <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="sc">'['</span>
          <span class="n">args_to_s</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">skip_last_arg</span><span class="p">:</span> <span class="nb">true</span><span class="p">)</span>
          <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="s">"]=("</span> <span class="o">&lt;&lt;</span> <span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">last</span><span class="o">?</span> <span class="o">&lt;&lt;</span> <span class="sc">')'</span>
        <span class="k">else</span>
          <span class="n">short_block</span> <span class="o">=</span> <span class="n">short_block_code</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
          <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="n">name</span>
          <span class="k">if</span> <span class="o">!</span><span class="n">node</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">||</span> <span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">named_args</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">node</span><span class="p">.</span><span class="n">named_args</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span><span class="p">))</span> <span class="o">||</span> <span class="n">short_block</span>
            <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="sc">'('</span>
            <span class="n">args_to_s</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">short_block</span><span class="p">)</span>
            <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="sc">')'</span>
          <span class="n">end</span>
          <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="s">" {...}"</span> <span class="k">if</span> <span class="n">node</span><span class="p">.</span><span class="n">block</span> <span class="o">&amp;&amp;</span> <span class="n">short_block</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">short_block_code</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">block</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">block</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">block_location</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="n">location</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">block_end_location</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">.</span><span class="n">end_location</span>

      <span class="n">block_code</span> <span class="o">=</span> <span class="n">source_between</span><span class="p">(</span><span class="n">block_location</span><span class="p">,</span> <span class="n">block_end_location</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">block_code</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">starts_with</span><span class="o">?</span><span class="p">(</span><span class="s">"&amp;."</span><span class="p">))</span>

      <span class="n">block_code</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">call_code</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
      <span class="n">args</span> <span class="o">=</span> <span class="n">String</span><span class="p">.</span><span class="n">build</span> <span class="p">{</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span> <span class="n">args_to_s</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="n">call</span><span class="p">)</span> <span class="p">}.</span><span class="n">presence</span>
      <span class="n">args</span> <span class="o">+=</span> <span class="s">", "</span> <span class="k">if</span> <span class="n">args</span>

      <span class="n">call_chain</span> <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">[].</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">arr</span><span class="o">|</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="n">obj</span>
        <span class="k">while</span> <span class="n">obj</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
          <span class="n">arr</span> <span class="o">&lt;&lt;</span> <span class="n">node_to_s</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
          <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">obj</span>
        <span class="n">end</span>
        <span class="n">arr</span><span class="p">.</span><span class="n">reverse</span><span class="o">!</span>
        <span class="n">arr</span> <span class="o">&lt;&lt;</span> <span class="n">node_to_s</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">name</span> <span class="o">=</span>
        <span class="n">call_chain</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="sc">'.'</span><span class="p">)</span>

      <span class="n">CALL_PATTERN</span> <span class="o">%</span> <span class="p">{</span><span class="n">call</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">name</span><span class="p">}</span>
    <span class="n">end</span>

    <span class="cp"># ameba:disable Metrics/CyclomaticComplexity
</span>    <span class="k">protected</span> <span class="n">def</span> <span class="n">issue_for_valid</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">call</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">,</span> <span class="n">block</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Block</span><span class="p">,</span> <span class="n">body</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">exclude_calls_with_block</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">body</span><span class="p">.</span><span class="n">block</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">exclude_multiple_line_blocks</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">same_location_lines</span><span class="o">?</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">exclude_prefix_operators</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">prefix_operator</span><span class="o">?</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">exclude_operators</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="k">operator</span><span class="o">?</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">if</span> <span class="n">exclude_setters</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">setter</span><span class="o">?</span><span class="p">(</span><span class="n">body</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>

      <span class="n">call_code</span> <span class="o">=</span>
        <span class="n">call_code</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">call</span><span class="p">,</span> <span class="n">body</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">valid_line_length</span><span class="o">?</span><span class="p">(</span><span class="n">call</span><span class="p">,</span> <span class="n">call_code</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">valid_length</span><span class="o">?</span><span class="p">(</span><span class="n">call_code</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">location</span> <span class="o">=</span> <span class="n">call</span><span class="p">.</span><span class="n">name_location</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">end_location</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="n">end_location</span>

      <span class="k">if</span> <span class="n">call_code</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="s">"{...}"</span><span class="p">)</span>
        <span class="n">issue_for</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="n">call_code</span>
      <span class="k">else</span>
        <span class="n">issue_for</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">MSG</span> <span class="o">%</span> <span class="n">call_code</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
          <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">call_code</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
      <span class="cp"># we are interested only in calls with block taking a single argument
</span>      <span class="cp">#
</span>      <span class="cp"># ```
</span>      <span class="cp"># (1..3).any? { |i| i.to_i64.odd? }
</span>      <span class="cp">#        ^---    ^  ^------------
</span>      <span class="cp">#        block  arg  body
</span>      <span class="cp"># ```
</span>      <span class="k">return</span> <span class="n">unless</span> <span class="p">(</span><span class="n">block</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">block</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">block</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">1</span>

      <span class="n">arg</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="n">args</span><span class="p">.</span><span class="n">first</span>

      <span class="cp"># we skip auto-generated blocks - `(1..3).any?(&amp;.odd?)`
</span>      <span class="k">return</span> <span class="k">if</span> <span class="n">arg</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">starts_with</span><span class="o">?</span><span class="p">(</span><span class="s">"__arg"</span><span class="p">)</span>

      <span class="cp"># we filter out the blocks that are of call type - `i.to_i64.odd?`
</span>      <span class="k">return</span> <span class="n">unless</span> <span class="p">(</span><span class="n">body</span> <span class="o">=</span> <span class="n">block</span><span class="p">.</span><span class="n">body</span><span class="p">).</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>

      <span class="cp"># we need to "unwind" the chain challs, so the final receiver object
</span>      <span class="cp"># ends up being a variable - `i`
</span>      <span class="n">obj</span> <span class="o">=</span> <span class="n">body</span><span class="p">.</span><span class="n">obj</span>
      <span class="k">while</span> <span class="n">obj</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Call</span><span class="p">)</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="p">.</span><span class="n">obj</span>
      <span class="n">end</span>

      <span class="cp"># only calls with a first argument used as a receiver are the valid game
</span>      <span class="k">return</span> <span class="n">unless</span> <span class="n">obj</span> <span class="o">==</span> <span class="n">arg</span>

      <span class="cp"># we bail out if the block node include the block argument
</span>      <span class="k">return</span> <span class="k">if</span> <span class="n">reference_count</span><span class="p">(</span><span class="n">body</span><span class="p">,</span> <span class="n">arg</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span>

      <span class="cp"># add issue if the given nodes pass all of the checks
</span>      <span class="n">issue_for_valid</span> <span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">block</span><span class="p">,</span> <span class="n">body</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Style</span>
  <span class="cp"># A rule that disallows the use of `while true` instead of using the idiomatic `loop`
</span>  <span class="cp">#
</span>  <span class="cp"># For example, this is considered invalid:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># while true
</span>  <span class="cp">#   do_something
</span>  <span class="cp">#   break if some_condition
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># And should be replaced by the following:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># loop do
</span>  <span class="cp">#   do_something
</span>  <span class="cp">#   break if some_condition
</span>  <span class="cp"># end
</span>  <span class="cp"># ```
</span>  <span class="cp">#
</span>  <span class="cp"># YAML configuration example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Style/WhileTrue:
</span>  <span class="cp">#   Enabled: true
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">WhileTrue</span> <span class="o">&lt;</span> <span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Disallows while statements with a true literal as condition"</span>
    <span class="n">end</span>

    <span class="n">MSG</span> <span class="o">=</span> <span class="s">"While statement using true literal as condition"</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">.</span><span class="n">true_literal</span><span class="o">?</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">end_location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">cond</span><span class="p">.</span><span class="n">end_location</span>

      <span class="n">issue_for</span> <span class="n">node</span><span class="p">,</span> <span class="n">MSG</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="s">"loop do"</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./ameba/formatter/*"
# require "./util"
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Formatter</span>
  <span class="n">module</span> <span class="n">Util</span>
    <span class="n">def</span> <span class="n">deansify</span><span class="p">(</span><span class="n">message</span> <span class="o">:</span> <span class="n">String</span><span class="o">?</span><span class="p">)</span> <span class="o">:</span> <span class="n">String</span><span class="o">?</span>
      <span class="n">message</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">gsub</span><span class="p">(</span><span class="o">/</span><span class="err">\</span><span class="n">x1b</span><span class="p">[</span><span class="o">^</span><span class="n">m</span><span class="p">]</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="p">,</span> <span class="s">""</span><span class="p">).</span><span class="n">presence</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">trim</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="n">max_length</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="n">ellipsis</span> <span class="o">=</span> <span class="s">" ..."</span><span class="p">)</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">str</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">ellipsis</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_length</span>
        <span class="n">str</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_length</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">str</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">ellipsis</span><span class="p">.</span><span class="n">size</span>
          <span class="n">str</span> <span class="o">=</span> <span class="n">str</span><span class="p">[</span><span class="mf">0.</span><span class="p">..</span><span class="o">-</span><span class="n">ellipsis</span><span class="p">.</span><span class="n">size</span><span class="p">]</span> <span class="o">+</span> <span class="n">ellipsis</span>
        <span class="n">end</span>
      <span class="n">end</span>
      <span class="n">str</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">context</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">context_lines</span> <span class="o">=</span> <span class="mi">3</span><span class="p">,</span> <span class="n">remove_empty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span>
      <span class="n">pre_context</span><span class="p">,</span> <span class="n">post_context</span> <span class="o">=</span> <span class="o">%</span><span class="n">w</span><span class="p">[],</span> <span class="o">%</span><span class="n">w</span><span class="p">[]</span>

      <span class="n">lines</span><span class="p">.</span><span class="n">each_with_index</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="p">,</span> <span class="n">i</span><span class="o">|</span>
        <span class="k">case</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">when</span> <span class="n">lineno</span> <span class="o">-</span> <span class="n">context_lines</span><span class="p">...</span><span class="n">lineno</span>
          <span class="n">pre_context</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
        <span class="n">when</span> <span class="n">lineno</span> <span class="o">+</span> <span class="mf">1.</span><span class="p">.</span><span class="n">lineno</span> <span class="o">+</span> <span class="n">context_lines</span>
          <span class="n">post_context</span> <span class="o">&lt;&lt;</span> <span class="n">line</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">remove_empty</span>
        <span class="cp"># remove empty lines at the beginning ...
</span>        <span class="k">while</span> <span class="n">pre_context</span><span class="p">.</span><span class="n">first</span><span class="o">?</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">blank</span><span class="o">?</span><span class="p">)</span>
          <span class="n">pre_context</span><span class="p">.</span><span class="n">shift</span>
        <span class="n">end</span>
        <span class="cp"># ... and the end
</span>        <span class="k">while</span> <span class="n">post_context</span><span class="p">.</span><span class="n">last</span><span class="o">?</span><span class="p">.</span><span class="k">try</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">blank</span><span class="o">?</span><span class="p">)</span>
          <span class="n">post_context</span><span class="p">.</span><span class="n">pop</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="err">{</span><span class="n">pre_context</span><span class="p">,</span> <span class="n">post_context</span><span class="err">}</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">affected_code</span><span class="p">(</span><span class="n">issue</span> <span class="p">:</span> <span class="n">Issue</span><span class="p">,</span> <span class="n">context_lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_length</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="n">ellipsis</span> <span class="o">=</span> <span class="s">" ..."</span><span class="p">,</span> <span class="n">prompt</span> <span class="o">=</span> <span class="s">"&gt; "</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">location</span> <span class="o">=</span> <span class="n">issue</span><span class="p">.</span><span class="n">location</span>

      <span class="n">affected_code</span><span class="p">(</span><span class="n">issue</span><span class="p">.</span><span class="n">code</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">issue</span><span class="p">.</span><span class="n">end_location</span><span class="p">,</span> <span class="n">context_lines</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">ellipsis</span><span class="p">,</span> <span class="n">prompt</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">affected_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">location</span><span class="p">,</span> <span class="n">end_location</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span> <span class="n">context_lines</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">max_length</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span> <span class="n">ellipsis</span> <span class="o">=</span> <span class="s">" ..."</span><span class="p">,</span> <span class="n">prompt</span> <span class="o">=</span> <span class="s">"&gt; "</span><span class="p">)</span>
      <span class="n">lines</span> <span class="o">=</span> <span class="n">code</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">)</span> <span class="err">#</span> <span class="n">must</span> <span class="n">preserve</span> <span class="n">trailing</span> <span class="n">newline</span>
      <span class="n">lineno</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span>
        <span class="n">location</span><span class="p">.</span><span class="n">line_number</span><span class="p">,</span> <span class="n">location</span><span class="p">.</span><span class="n">column_number</span>

      <span class="k">return</span> <span class="n">unless</span> <span class="n">affected_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">lineno</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span><span class="o">?</span><span class="p">.</span><span class="n">presence</span>

      <span class="k">if</span> <span class="n">column</span> <span class="o">&lt;</span> <span class="n">max_length</span>
        <span class="n">affected_line</span> <span class="o">=</span> <span class="n">trim</span><span class="p">(</span><span class="n">affected_line</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">ellipsis</span><span class="p">)</span>
      <span class="n">end</span>

      <span class="n">show_context</span> <span class="o">=</span> <span class="n">context_lines</span> <span class="o">&gt;</span> <span class="mi">0</span>

      <span class="k">if</span> <span class="n">show_context</span>
        <span class="n">pre_context</span><span class="p">,</span> <span class="n">post_context</span> <span class="o">=</span>
          <span class="n">context</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">lineno</span><span class="p">,</span> <span class="n">context_lines</span><span class="p">)</span>

        <span class="n">position</span> <span class="o">=</span> <span class="n">prompt</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">column</span>
        <span class="n">position</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="k">else</span>
        <span class="n">affected_line_size</span><span class="p">,</span> <span class="n">affected_line</span> <span class="o">=</span>
          <span class="n">affected_line</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">affected_line</span><span class="p">.</span><span class="n">lstrip</span>

        <span class="n">position</span> <span class="o">=</span> <span class="n">column</span> <span class="o">-</span> <span class="p">(</span><span class="n">affected_line_size</span> <span class="o">-</span> <span class="n">affected_line</span><span class="p">.</span><span class="n">size</span><span class="p">)</span> <span class="o">+</span> <span class="n">prompt</span><span class="p">.</span><span class="n">size</span>
        <span class="n">position</span> <span class="o">-=</span> <span class="mi">1</span>
      <span class="n">end</span>

      <span class="n">String</span><span class="p">.</span><span class="n">build</span> <span class="k">do</span> <span class="o">|</span><span class="n">str</span><span class="o">|</span>
        <span class="k">if</span> <span class="n">show_context</span>
          <span class="n">pre_context</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">trim</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">ellipsis</span><span class="p">)</span>
            <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="n">prompt</span>
            <span class="n">str</span><span class="p">.</span><span class="n">puts</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">dark_gray</span><span class="p">))</span>
          <span class="n">end</span>
        <span class="n">end</span>

        <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="n">prompt</span>
        <span class="n">str</span><span class="p">.</span><span class="n">puts</span><span class="p">(</span><span class="n">affected_line</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">white</span><span class="p">))</span>

        <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="s">" "</span> <span class="o">*</span> <span class="n">position</span><span class="p">)</span>
        <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="s">"^"</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">yellow</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">end_location</span>
          <span class="n">end_lineno</span> <span class="o">=</span> <span class="n">end_location</span><span class="p">.</span><span class="n">line_number</span>
          <span class="n">end_column</span> <span class="o">=</span> <span class="n">end_location</span><span class="p">.</span><span class="n">column_number</span>

          <span class="k">if</span> <span class="n">end_lineno</span> <span class="o">==</span> <span class="n">lineno</span> <span class="o">&amp;&amp;</span> <span class="n">end_column</span> <span class="o">&gt;</span> <span class="n">column</span>
            <span class="n">end_position</span> <span class="o">=</span> <span class="n">end_column</span> <span class="o">-</span> <span class="n">column</span>
            <span class="n">end_position</span> <span class="o">-=</span> <span class="mi">1</span>

            <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="s">"-"</span> <span class="o">*</span> <span class="n">end_position</span><span class="p">).</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">dark_gray</span><span class="p">)</span>
            <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="s">"^"</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">yellow</span><span class="p">)</span>
          <span class="n">end</span>
        <span class="n">end</span>

        <span class="n">str</span><span class="p">.</span><span class="n">puts</span>

        <span class="k">if</span> <span class="n">show_context</span>
          <span class="n">post_context</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">trim</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">max_length</span><span class="p">,</span> <span class="n">ellipsis</span><span class="p">)</span>
            <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="n">prompt</span>
            <span class="n">str</span><span class="p">.</span><span class="n">puts</span><span class="p">(</span><span class="n">line</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">dark_gray</span><span class="p">))</span>
          <span class="n">end</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># A module that utilizes Ameba's formatters.
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Formatter</span>
  <span class="cp"># A base formatter for all formatters. It uses `output` IO
</span>  <span class="cp"># to report results and also implements stub methods for
</span>  <span class="cp"># callbacks in `Ameba::Runner#run` method.
</span>  <span class="k">class</span> <span class="nc">BaseFormatter</span>
    <span class="cp"># TODO: allow other IOs
</span>    <span class="n">getter</span> <span class="n">output</span> <span class="o">:</span> <span class="n">IO</span><span class="o">::</span><span class="n">FileDescriptor</span> <span class="o">|</span> <span class="n">IO</span><span class="o">::</span><span class="n">Memory</span>
    <span class="n">getter</span> <span class="n">config</span> <span class="o">=</span> <span class="p">{}</span> <span class="n">of</span> <span class="n">Symbol</span> <span class="o">=&gt;</span> <span class="n">String</span> <span class="o">|</span> <span class="n">Bool</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">output</span> <span class="o">=</span> <span class="n">STDOUT</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Callback that indicates when inspecting is started.
</span>    <span class="cp"># A list of sources to inspect is passed as an argument.
</span>    <span class="n">def</span> <span class="n">started</span><span class="p">(</span><span class="n">sources</span><span class="p">);</span> <span class="n">end</span>

    <span class="cp"># Callback that indicates when source inspection is finished.
</span>    <span class="cp"># A corresponding source is passed as an argument.
</span>    <span class="n">def</span> <span class="nf">source_finished</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">);</span> <span class="n">end</span>

    <span class="cp"># Callback that indicates when source inspection is finished.
</span>    <span class="cp"># A corresponding source is passed as an argument.
</span>    <span class="n">def</span> <span class="nf">source_started</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">);</span> <span class="n">end</span>

    <span class="cp"># Callback that indicates when inspection is finished.
</span>    <span class="cp"># A list of inspected sources is passed as an argument.
</span>    <span class="n">def</span> <span class="nf">finished</span><span class="p">(</span><span class="n">sources</span><span class="p">);</span> <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Formatter</span>
  <span class="cp"># A formatter that shows all disabled lines by inline directives.
</span>  <span class="k">class</span> <span class="nc">DisabledFormatter</span> <span class="o">&lt;</span> <span class="n">BaseFormatter</span>
    <span class="n">def</span> <span class="nf">finished</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
      <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="s">"Disabled rules using inline directives:</span><span class="se">\n\n</span><span class="s">"</span>

      <span class="n">sources</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="o">|</span>
        <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">select</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">disabled</span><span class="o">?</span><span class="p">).</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">issue</span><span class="o">|</span>
          <span class="n">next</span> <span class="n">unless</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">issue</span><span class="p">.</span><span class="n">location</span>

          <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="s">"#{source.path}:#{loc.line_number}"</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">cyan</span><span class="p">)</span>
          <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="s">" #{issue.rule.name}</span><span class="se">\n</span><span class="s">"</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./util"
</span>
<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Formatter</span>
  <span class="cp"># A formatter that shows a progress of inspection in a terminal using dots.
</span>  <span class="cp"># It is similar to Crystal's dot formatter for specs.
</span>  <span class="k">class</span> <span class="nc">DotFormatter</span> <span class="o">&lt;</span> <span class="n">BaseFormatter</span>
    <span class="n">include</span> <span class="n">Util</span>

    <span class="err">@</span><span class="n">started_at</span> <span class="o">:</span> <span class="n">Time</span><span class="o">::</span><span class="n">Span</span><span class="o">?</span>
    <span class="err">@</span><span class="n">mutex</span> <span class="o">=</span> <span class="n">Thread</span><span class="o">::</span><span class="n">Mutex</span><span class="p">.</span><span class="k">new</span>

    <span class="cp"># Reports a message when inspection is started.
</span>    <span class="n">def</span> <span class="n">started</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
      <span class="err">@</span><span class="n">started_at</span> <span class="o">=</span> <span class="n">Time</span><span class="p">.</span><span class="n">monotonic</span>

      <span class="n">output</span><span class="p">.</span><span class="n">puts</span> <span class="n">started_message</span><span class="p">(</span><span class="n">sources</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
      <span class="n">output</span><span class="p">.</span><span class="n">puts</span>
    <span class="n">end</span>

    <span class="cp"># Reports a result of the inspection of a corresponding source.
</span>    <span class="n">def</span> <span class="n">source_finished</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">)</span>
      <span class="n">sym</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">valid</span><span class="o">?</span> <span class="o">?</span> <span class="s">"."</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">green</span><span class="p">)</span> <span class="o">:</span> <span class="s">"F"</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">red</span><span class="p">)</span>
      <span class="err">@</span><span class="n">mutex</span><span class="p">.</span><span class="n">synchronize</span> <span class="p">{</span> <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="n">sym</span> <span class="p">}</span>
    <span class="n">end</span>

    <span class="cp"># Reports a message when inspection is finished.
</span>    <span class="n">def</span> <span class="n">finished</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
      <span class="n">output</span><span class="p">.</span><span class="n">flush</span>
      <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">"</span>

      <span class="n">show_affected_code</span> <span class="o">=</span> <span class="o">!</span><span class="n">config</span><span class="p">[</span><span class="o">:</span><span class="n">without_affected_code</span><span class="p">]</span><span class="o">?</span>
      <span class="n">failed_sources</span> <span class="o">=</span> <span class="n">sources</span><span class="p">.</span><span class="n">reject</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">valid</span><span class="o">?</span>

      <span class="n">failed_sources</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">source</span><span class="o">|</span>
        <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">issue</span><span class="o">|</span>
          <span class="n">next</span> <span class="k">if</span> <span class="n">issue</span><span class="p">.</span><span class="n">disabled</span><span class="o">?</span>
          <span class="n">next</span> <span class="k">if</span> <span class="p">(</span><span class="n">location</span> <span class="o">=</span> <span class="n">issue</span><span class="p">.</span><span class="n">location</span><span class="p">).</span><span class="n">nil</span><span class="o">?</span>

          <span class="n">output</span><span class="p">.</span><span class="n">print</span> <span class="n">location</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">cyan</span><span class="p">)</span>
          <span class="k">if</span> <span class="n">issue</span><span class="p">.</span><span class="n">correctable</span><span class="o">?</span>
            <span class="k">if</span> <span class="n">config</span><span class="p">[</span><span class="o">:</span><span class="n">autocorrect</span><span class="p">]</span><span class="o">?</span>
              <span class="n">output</span><span class="p">.</span><span class="n">print</span> <span class="s">" [Corrected]"</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">green</span><span class="p">)</span>
            <span class="k">else</span>
              <span class="n">output</span><span class="p">.</span><span class="n">print</span> <span class="s">" [Correctable]"</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">yellow</span><span class="p">)</span>
            <span class="n">end</span>
          <span class="n">end</span>
          <span class="n">output</span><span class="p">.</span><span class="n">puts</span>
          <span class="n">output</span><span class="p">.</span><span class="n">puts</span> <span class="p">(</span><span class="s">"[%s] %s: %s"</span> <span class="o">%</span> <span class="p">{</span>
            <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">severity</span><span class="p">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
            <span class="n">issue</span><span class="p">.</span><span class="n">message</span><span class="p">,</span>
          <span class="p">}).</span><span class="n">colorize</span><span class="p">(</span><span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">severity</span><span class="p">.</span><span class="n">color</span><span class="p">)</span>

          <span class="k">if</span> <span class="n">show_affected_code</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">code</span> <span class="o">=</span> <span class="n">affected_code</span><span class="p">(</span><span class="n">issue</span><span class="p">))</span>
            <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="n">code</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="k">default</span><span class="p">)</span>
          <span class="n">end</span>

          <span class="n">output</span><span class="p">.</span><span class="n">puts</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="n">output</span><span class="p">.</span><span class="n">puts</span> <span class="n">finished_in_message</span><span class="p">(</span><span class="err">@</span><span class="n">started_at</span><span class="p">,</span> <span class="n">Time</span><span class="p">.</span><span class="n">monotonic</span><span class="p">)</span>
      <span class="n">output</span><span class="p">.</span><span class="n">puts</span> <span class="n">final_message</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">failed_sources</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">started_message</span><span class="p">(</span><span class="n">size</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">size</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="s">"Inspecting 1 file"</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="k">default</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="s">"Inspecting #{size} files"</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="k">default</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">finished_in_message</span><span class="p">(</span><span class="n">started</span><span class="p">,</span> <span class="n">finished</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">started</span> <span class="o">&amp;&amp;</span> <span class="n">finished</span>

      <span class="s">"Finished in #{to_human(finished - started)}"</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="k">default</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">to_human</span><span class="p">(</span><span class="n">span</span> <span class="o">:</span> <span class="n">Time</span><span class="o">::</span><span class="n">Span</span><span class="p">)</span>
      <span class="n">total_milliseconds</span> <span class="o">=</span> <span class="n">span</span><span class="p">.</span><span class="n">total_milliseconds</span>
      <span class="k">if</span> <span class="n">total_milliseconds</span> <span class="o">&lt;</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="s">"#{(span.total_milliseconds * 1_000).round.to_i} microseconds"</span>
      <span class="n">end</span>

      <span class="n">total_seconds</span> <span class="o">=</span> <span class="n">span</span><span class="p">.</span><span class="n">total_seconds</span>
      <span class="k">if</span> <span class="n">total_seconds</span> <span class="o">&lt;</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="s">"#{span.total_milliseconds.round(2)} milliseconds"</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">total_seconds</span> <span class="o">&lt;</span> <span class="mi">60</span>
        <span class="k">return</span> <span class="s">"#{total_seconds.round(2)} seconds"</span>
      <span class="n">end</span>

      <span class="n">minutes</span> <span class="o">=</span> <span class="n">span</span><span class="p">.</span><span class="n">minutes</span>
      <span class="n">seconds</span> <span class="o">=</span> <span class="n">span</span><span class="p">.</span><span class="n">seconds</span>

      <span class="s">"#{minutes}:#{seconds &lt; 10 ? "</span><span class="mi">0</span><span class="s">" : ""}#{seconds} minutes"</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">final_message</span><span class="p">(</span><span class="n">sources</span><span class="p">,</span> <span class="n">failed_sources</span><span class="p">)</span>
      <span class="n">total</span> <span class="o">=</span> <span class="n">sources</span><span class="p">.</span><span class="n">size</span>
      <span class="n">failures</span> <span class="o">=</span> <span class="n">failed_sources</span><span class="p">.</span><span class="n">sum</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
      <span class="n">color</span> <span class="o">=</span> <span class="n">failures</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="o">:</span><span class="n">green</span> <span class="o">:</span> <span class="o">:</span><span class="n">red</span>
      <span class="n">s</span> <span class="o">=</span> <span class="n">failures</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">?</span> <span class="s">"s"</span> <span class="o">:</span> <span class="s">""</span>

      <span class="s">"#{total} inspected, #{failures} failure#{s}"</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">color</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./util"
</span>
<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Formatter</span>
  <span class="cp"># A formatter that shows the detailed explanation of the issue at
</span>  <span class="cp"># a specific location.
</span>  <span class="k">class</span> <span class="nc">ExplainFormatter</span>
    <span class="n">HEADING_MARKER</span> <span class="o">=</span> <span class="s">"## "</span>

    <span class="n">include</span> <span class="n">Util</span>

    <span class="n">getter</span> <span class="n">output</span> <span class="o">:</span> <span class="n">IO</span><span class="o">::</span><span class="n">FileDescriptor</span> <span class="o">|</span> <span class="n">IO</span><span class="o">::</span><span class="n">Memory</span>
    <span class="n">getter</span> <span class="n">location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span>

    <span class="cp"># Creates a new instance of `ExplainFormatter`.
</span>    <span class="cp">#
</span>    <span class="cp"># Accepts *output* which indicates the io where the explanation will be written to.
</span>    <span class="cp"># Second argument is *location* which indicates the location to explain.
</span>    <span class="cp">#
</span>    <span class="cp"># ```
</span>    <span class="cp"># ExplainFormatter.new output, {
</span>    <span class="cp">#   file:   path,
</span>    <span class="cp">#   line:   line_number,
</span>    <span class="cp">#   column: column_number,
</span>    <span class="cp"># }
</span>    <span class="cp"># ```
</span>    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">output</span><span class="p">,</span> <span class="n">location</span><span class="p">)</span>
      <span class="err">@</span><span class="n">location</span> <span class="o">=</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="p">.</span><span class="k">new</span><span class="p">(</span>
        <span class="n">location</span><span class="p">[</span><span class="o">:</span><span class="n">file</span><span class="p">],</span>
        <span class="n">location</span><span class="p">[</span><span class="o">:</span><span class="n">line</span><span class="p">],</span>
        <span class="n">location</span><span class="p">[</span><span class="o">:</span><span class="n">column</span><span class="p">]</span>
      <span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Reports the explanations at the *@location*.
</span>    <span class="n">def</span> <span class="n">finished</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">sources</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">path</span><span class="p">.</span><span class="o">==</span><span class="p">(</span><span class="err">@</span><span class="n">location</span><span class="p">.</span><span class="n">filename</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">source</span>

      <span class="n">issue</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="o">==</span><span class="p">(</span><span class="err">@</span><span class="n">location</span><span class="p">))</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">issue</span>

      <span class="n">explain</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">issue</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">explain</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">issue</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">location</span> <span class="o">=</span> <span class="n">issue</span><span class="p">.</span><span class="n">location</span>

      <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span>
      <span class="n">output_title</span> <span class="s">"Issue info"</span>
      <span class="n">output_paragraph</span> <span class="p">[</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">red</span><span class="p">),</span>
        <span class="n">location</span><span class="p">.</span><span class="n">to_s</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">cyan</span><span class="p">),</span>
      <span class="p">]</span>

      <span class="k">if</span> <span class="n">affected_code</span> <span class="o">=</span> <span class="n">affected_code</span><span class="p">(</span><span class="n">issue</span><span class="p">,</span> <span class="n">context_lines</span><span class="o">:</span> <span class="mi">3</span><span class="p">)</span>
        <span class="n">output_title</span> <span class="s">"Affected code"</span>
        <span class="n">output_paragraph</span> <span class="n">affected_code</span>
      <span class="n">end</span>

      <span class="n">rule</span> <span class="o">=</span> <span class="n">issue</span><span class="p">.</span><span class="n">rule</span>

      <span class="n">output_title</span> <span class="s">"Rule info"</span>
      <span class="n">output_paragraph</span> <span class="s">"%s of a %s severity"</span> <span class="o">%</span> <span class="p">{</span>
        <span class="n">rule</span><span class="p">.</span><span class="n">name</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">magenta</span><span class="p">),</span>
        <span class="n">rule</span><span class="p">.</span><span class="n">severity</span><span class="p">.</span><span class="n">to_s</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="n">severity</span><span class="p">.</span><span class="n">color</span><span class="p">),</span>
      <span class="p">}</span>

      <span class="k">if</span> <span class="n">rule</span><span class="p">.</span><span class="n">responds_to</span><span class="o">?</span><span class="p">(</span><span class="o">:</span><span class="n">description</span><span class="p">)</span>
        <span class="n">output_paragraph</span> <span class="n">rule</span><span class="p">.</span><span class="n">description</span>
      <span class="n">end</span>

      <span class="n">rule_doc</span> <span class="o">=</span> <span class="n">colorize_code_fences</span><span class="p">(</span><span class="n">rule</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="n">parsed_doc</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">rule_doc</span>

      <span class="n">output_title</span> <span class="s">"Detailed description"</span>
      <span class="n">output_paragraph</span> <span class="n">rule_doc</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">colorize_code_fences</span><span class="p">(</span><span class="n">string</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">string</span>
      <span class="n">string</span>
        <span class="p">.</span><span class="n">gsub</span><span class="p">(</span><span class="o">/</span><span class="err">```</span><span class="p">(.</span><span class="o">+?</span><span class="p">)</span><span class="err">```</span><span class="o">/</span><span class="n">m</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">dark_gray</span><span class="p">))</span>
        <span class="p">.</span><span class="n">gsub</span><span class="p">(</span><span class="o">/</span><span class="err">`</span><span class="p">(</span><span class="o">?!</span><span class="err">`</span><span class="p">)(.</span><span class="o">+?</span><span class="p">)</span><span class="err">`</span><span class="o">/</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">dark_gray</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">output_title</span><span class="p">(</span><span class="n">title</span><span class="p">)</span>
      <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="n">HEADING_MARKER</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">yellow</span><span class="p">)</span>
      <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="n">title</span><span class="p">.</span><span class="n">upcase</span><span class="p">.</span><span class="n">colorize</span><span class="p">(</span><span class="o">:</span><span class="n">yellow</span><span class="p">)</span>
      <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n\n</span><span class="s">"</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">output_paragraph</span><span class="p">(</span><span class="n">paragraph</span> <span class="o">:</span> <span class="n">String</span><span class="p">)</span>
      <span class="n">output_paragraph</span><span class="p">(</span><span class="n">paragraph</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">output_paragraph</span><span class="p">(</span><span class="n">paragraph</span> <span class="o">:</span> <span class="n">Array</span><span class="p">)</span>
      <span class="n">paragraph</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
        <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="sc">' '</span> <span class="o">&lt;&lt;</span> <span class="n">line</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span>
      <span class="n">end</span>
      <span class="n">output</span> <span class="o">&lt;&lt;</span> <span class="sc">'\n'</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Formatter</span>
  <span class="k">class</span> <span class="nc">FlycheckFormatter</span> <span class="o">&lt;</span> <span class="n">BaseFormatter</span>
    <span class="err">@</span><span class="n">mutex</span> <span class="o">=</span> <span class="n">Mutex</span><span class="p">.</span><span class="k">new</span>

    <span class="n">def</span> <span class="n">source_finished</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">)</span>
      <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">issue</span><span class="o">|</span>
        <span class="n">next</span> <span class="k">if</span> <span class="n">issue</span><span class="p">.</span><span class="n">disabled</span><span class="o">?</span>
        <span class="n">next</span> <span class="k">if</span> <span class="n">issue</span><span class="p">.</span><span class="n">correctable</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">config</span><span class="p">[</span><span class="o">:</span><span class="n">autocorrect</span><span class="p">]</span><span class="o">?</span>

        <span class="n">next</span> <span class="n">unless</span> <span class="n">loc</span> <span class="o">=</span> <span class="n">issue</span><span class="p">.</span><span class="n">location</span>

        <span class="err">@</span><span class="n">mutex</span><span class="p">.</span><span class="n">synchronize</span> <span class="k">do</span>
          <span class="n">output</span><span class="p">.</span><span class="n">printf</span> <span class="s">"%s:%d:%d: %s: [%s] %s</span><span class="se">\n</span><span class="s">"</span><span class="p">,</span>
            <span class="n">source</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">loc</span><span class="p">.</span><span class="n">line_number</span><span class="p">,</span> <span class="n">loc</span><span class="p">.</span><span class="n">column_number</span><span class="p">,</span> <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">severity</span><span class="p">.</span><span class="n">symbol</span><span class="p">,</span>
            <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">issue</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">gsub</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">,</span> <span class="s">" "</span><span class="p">)</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">require</span> <span class="s">"json"</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Formatter</span>
  <span class="cp"># A formatter that produces the result in a json format.
</span>  <span class="cp">#
</span>  <span class="cp"># Example:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># {
</span>  <span class="cp">#   "metadata": {
</span>  <span class="cp">#     "ameba_version":   "x.x.x",
</span>  <span class="cp">#     "crystal_version": "x.x.x",
</span>  <span class="cp">#   },
</span>  <span class="cp">#   "sources": [
</span>  <span class="cp">#     {
</span>  <span class="cp">#       "issues": [
</span>  <span class="cp">#         {
</span>  <span class="cp">#           "location": {
</span>  <span class="cp">#             "column": 7,
</span>  <span class="cp">#             "line":   17,
</span>  <span class="cp">#           },
</span>  <span class="cp">#           "end_location": {
</span>  <span class="cp">#             "column": 20,
</span>  <span class="cp">#             "line":   17,
</span>  <span class="cp">#           },
</span>  <span class="cp">#           "message":   "Useless assignment to variable `a`",
</span>  <span class="cp">#           "rule_name": "UselessAssign",
</span>  <span class="cp">#           "severity":  "Convention",
</span>  <span class="cp">#         },
</span>  <span class="cp">#         {
</span>  <span class="cp">#           "location": {
</span>  <span class="cp">#             "column": 7,
</span>  <span class="cp">#             "line":   18,
</span>  <span class="cp">#           },
</span>  <span class="cp">#           "end_location": {
</span>  <span class="cp">#             "column": 8,
</span>  <span class="cp">#             "line":   18,
</span>  <span class="cp">#           },
</span>  <span class="cp">#           "message":   "Useless assignment to variable `a`",
</span>  <span class="cp">#           "rule_name": "UselessAssign",
</span>  <span class="cp">#         },
</span>  <span class="cp">#         {
</span>  <span class="cp">#           "location": {
</span>  <span class="cp">#             "column": 7,
</span>  <span class="cp">#             "line":   19,
</span>  <span class="cp">#           },
</span>  <span class="cp">#           "end_location": {
</span>  <span class="cp">#             "column": 9,
</span>  <span class="cp">#             "line":   19,
</span>  <span class="cp">#           },
</span>  <span class="cp">#           "message":   "Useless assignment to variable `a`",
</span>  <span class="cp">#           "rule_name": "UselessAssign",
</span>  <span class="cp">#           "severity":  "Convention",
</span>  <span class="cp">#         },
</span>  <span class="cp">#       ],
</span>  <span class="cp">#       "path": "src/ameba/formatter/json_formatter.cr",
</span>  <span class="cp">#     },
</span>  <span class="cp">#   ],
</span>  <span class="cp">#   "summary": {
</span>  <span class="cp">#     "issues_count":         3,
</span>  <span class="cp">#     "target_sources_count": 1,
</span>  <span class="cp">#   },
</span>  <span class="cp"># }
</span>  <span class="cp"># ```
</span>  <span class="k">class</span> <span class="nc">JSONFormatter</span> <span class="o">&lt;</span> <span class="n">BaseFormatter</span>
    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">output</span> <span class="o">=</span> <span class="n">STDOUT</span><span class="p">)</span>
      <span class="err">@</span><span class="n">result</span> <span class="o">=</span> <span class="n">AsJSON</span><span class="o">::</span><span class="n">Result</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">started</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
      <span class="err">@</span><span class="n">result</span><span class="p">.</span><span class="n">summary</span><span class="p">.</span><span class="n">target_sources_count</span> <span class="o">=</span> <span class="n">sources</span><span class="p">.</span><span class="n">size</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">source_finished</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">)</span>
      <span class="n">json_source</span> <span class="o">=</span> <span class="n">AsJSON</span><span class="o">::</span><span class="n">Source</span><span class="p">.</span><span class="k">new</span> <span class="n">source</span><span class="p">.</span><span class="n">path</span>

      <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">issue</span><span class="o">|</span>
        <span class="n">next</span> <span class="k">if</span> <span class="n">issue</span><span class="p">.</span><span class="n">disabled</span><span class="o">?</span>
        <span class="n">next</span> <span class="k">if</span> <span class="n">issue</span><span class="p">.</span><span class="n">correctable</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">config</span><span class="p">[</span><span class="o">:</span><span class="n">autocorrect</span><span class="p">]</span><span class="o">?</span>

        <span class="n">json_source</span><span class="p">.</span><span class="n">issues</span> <span class="o">&lt;&lt;</span> <span class="n">AsJSON</span><span class="o">::</span><span class="n">Issue</span><span class="p">.</span><span class="k">new</span><span class="p">(</span>
          <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">name</span><span class="p">,</span>
          <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">severity</span><span class="p">.</span><span class="n">to_s</span><span class="p">,</span>
          <span class="n">issue</span><span class="p">.</span><span class="n">location</span><span class="p">,</span>
          <span class="n">issue</span><span class="p">.</span><span class="n">end_location</span><span class="p">,</span>
          <span class="n">issue</span><span class="p">.</span><span class="n">message</span>
        <span class="p">)</span>
        <span class="err">@</span><span class="n">result</span><span class="p">.</span><span class="n">summary</span><span class="p">.</span><span class="n">issues_count</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">end</span>

      <span class="err">@</span><span class="n">result</span><span class="p">.</span><span class="n">sources</span> <span class="o">&lt;&lt;</span> <span class="n">json_source</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">finished</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
      <span class="err">@</span><span class="n">result</span><span class="p">.</span><span class="n">to_json</span> <span class="err">@</span><span class="n">output</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">module</span> <span class="n">AsJSON</span>
    <span class="n">record</span> <span class="n">Result</span><span class="p">,</span>
      <span class="n">sources</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Source</span><span class="p">,</span>
      <span class="n">metadata</span> <span class="o">=</span> <span class="n">Metadata</span><span class="p">.</span><span class="k">new</span><span class="p">,</span>
      <span class="n">summary</span> <span class="o">=</span> <span class="n">Summary</span><span class="p">.</span><span class="k">new</span> <span class="k">do</span>
      <span class="n">def</span> <span class="n">to_json</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nl">sources:</span>  <span class="n">sources</span><span class="p">,</span>
          <span class="nl">metadata:</span> <span class="n">metadata</span><span class="p">,</span>
          <span class="nl">summary:</span>  <span class="n">summary</span><span class="p">,</span>
        <span class="p">}.</span><span class="n">to_json</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">record</span> <span class="n">Source</span><span class="p">,</span>
      <span class="n">path</span> <span class="o">:</span> <span class="n">String</span><span class="p">,</span>
      <span class="n">issues</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Issue</span> <span class="k">do</span>
      <span class="n">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nl">path:</span>   <span class="n">path</span><span class="p">,</span>
          <span class="nl">issues:</span> <span class="n">issues</span><span class="p">,</span>
        <span class="p">}.</span><span class="n">to_json</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">record</span> <span class="n">Issue</span><span class="p">,</span>
      <span class="n">rule_name</span> <span class="o">:</span> <span class="n">String</span><span class="p">,</span>
      <span class="n">severity</span> <span class="o">:</span> <span class="n">String</span><span class="p">,</span>
      <span class="n">location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="o">?</span><span class="p">,</span>
      <span class="n">end_location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="o">?</span><span class="p">,</span>
      <span class="n">message</span> <span class="o">:</span> <span class="n">String</span> <span class="k">do</span>
      <span class="n">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nl">rule_name:</span> <span class="n">rule_name</span><span class="p">,</span>
          <span class="nl">severity:</span>  <span class="n">severity</span><span class="p">,</span>
          <span class="nl">message:</span>   <span class="n">message</span><span class="p">,</span>
          <span class="nl">location:</span>  <span class="p">{</span>
            <span class="nl">line:</span>   <span class="n">location</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">line_number</span><span class="p">,</span>
            <span class="nl">column:</span> <span class="n">location</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">column_number</span><span class="p">,</span>
          <span class="p">},</span>
          <span class="nl">end_location:</span> <span class="p">{</span>
            <span class="nl">line:</span>   <span class="n">end_location</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">line_number</span><span class="p">,</span>
            <span class="nl">column:</span> <span class="n">end_location</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">column_number</span><span class="p">,</span>
          <span class="p">},</span>
        <span class="p">}.</span><span class="n">to_json</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">record</span> <span class="n">Metadata</span><span class="p">,</span>
      <span class="n">ameba_version</span> <span class="o">:</span> <span class="n">String</span> <span class="o">=</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">VERSION</span><span class="p">,</span>
      <span class="n">crystal_version</span> <span class="o">:</span> <span class="n">String</span> <span class="o">=</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">VERSION</span> <span class="k">do</span>
      <span class="n">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nl">ameba_version:</span>   <span class="n">ameba_version</span><span class="p">,</span>
          <span class="nl">crystal_version:</span> <span class="n">crystal_version</span><span class="p">,</span>
        <span class="p">}.</span><span class="n">to_json</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">class</span> <span class="nc">Summary</span>
      <span class="n">property</span> <span class="n">target_sources_count</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="n">property</span> <span class="n">issues_count</span> <span class="o">=</span> <span class="mi">0</span>

      <span class="n">def</span> <span class="nf">to_json</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
        <span class="p">{</span>
          <span class="nl">target_sources_count:</span> <span class="n">target_sources_count</span><span class="p">,</span>
          <span class="nl">issues_count:</span>         <span class="n">issues_count</span><span class="p">,</span>
        <span class="p">}.</span><span class="n">to_json</span><span class="p">(</span><span class="n">json</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Formatter</span>
  <span class="cp"># A formatter that creates a todo config.
</span>  <span class="cp"># Basically, it takes all issues reported and disables corresponding rules
</span>  <span class="cp"># or excludes failed sources from these rules.
</span>  <span class="k">class</span> <span class="nc">TODOFormatter</span> <span class="o">&lt;</span> <span class="n">DotFormatter</span>
    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">output</span> <span class="o">=</span> <span class="n">STDOUT</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">finished</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
      <span class="n">super</span>

      <span class="n">issues</span> <span class="o">=</span> <span class="n">sources</span><span class="p">.</span><span class="n">flat_map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">issues</span><span class="p">)</span>
      <span class="n">unless</span> <span class="n">issues</span><span class="p">.</span><span class="n">any</span><span class="o">?</span> <span class="p">{</span> <span class="o">|</span><span class="n">issue</span><span class="o">|</span> <span class="o">!</span><span class="n">issue</span><span class="p">.</span><span class="n">disabled</span><span class="o">?</span> <span class="p">}</span>
        <span class="err">@</span><span class="n">output</span><span class="p">.</span><span class="n">puts</span> <span class="s">"No issues found. File is not generated."</span>
        <span class="k">return</span>
      <span class="n">end</span>

      <span class="k">if</span> <span class="n">issues</span><span class="p">.</span><span class="n">any</span><span class="o">?</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">syntax</span><span class="o">?</span><span class="p">)</span>
        <span class="err">@</span><span class="n">output</span><span class="p">.</span><span class="n">puts</span> <span class="s">"Unable to generate TODO file. Please fix syntax issues."</span>
        <span class="k">return</span>
      <span class="n">end</span>

      <span class="n">generate_todo_config</span><span class="p">(</span><span class="n">issues</span><span class="p">).</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">file</span><span class="o">|</span>
        <span class="err">@</span><span class="n">output</span><span class="p">.</span><span class="n">puts</span> <span class="s">"Created #{file.path}"</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">generate_todo_config</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span>
      <span class="n">file</span> <span class="o">=</span> <span class="n">File</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">Config</span><span class="o">::</span><span class="n">PATH</span><span class="p">,</span> <span class="n">mode</span><span class="o">:</span> <span class="s">"w"</span><span class="p">)</span>
      <span class="n">file</span> <span class="o">&lt;&lt;</span> <span class="n">header</span>
      <span class="n">rule_issues_map</span><span class="p">(</span><span class="n">issues</span><span class="p">).</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">rule</span><span class="p">,</span> <span class="n">rule_issues</span><span class="o">|</span>
        <span class="n">file</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s"># Problems found: #{rule_issues.size}"</span>
        <span class="n">file</span> <span class="o">&lt;&lt;</span> <span class="s">"</span><span class="se">\n</span><span class="s"># Run `ameba --only #{rule.name}` for details"</span>
        <span class="n">file</span> <span class="o">&lt;&lt;</span> <span class="n">rule_todo</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">rule_issues</span><span class="p">).</span><span class="n">gsub</span><span class="p">(</span><span class="s">"---"</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
      <span class="n">end</span>
      <span class="n">file</span>
    <span class="n">ensure</span>
      <span class="n">file</span><span class="p">.</span><span class="n">close</span> <span class="k">if</span> <span class="n">file</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">rule_issues_map</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span>
      <span class="n">Hash</span><span class="p">(</span><span class="n">Rule</span><span class="o">::</span><span class="n">Base</span><span class="p">,</span> <span class="n">Array</span><span class="p">(</span><span class="n">Issue</span><span class="p">)).</span><span class="k">new</span><span class="p">.</span><span class="n">tap</span> <span class="k">do</span> <span class="o">|</span><span class="n">h</span><span class="o">|</span>
        <span class="n">issues</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">issue</span><span class="o">|</span>
          <span class="n">next</span> <span class="k">if</span> <span class="n">issue</span><span class="p">.</span><span class="n">disabled</span><span class="o">?</span> <span class="o">||</span> <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Rule</span><span class="o">::</span><span class="n">Lint</span><span class="o">::</span><span class="n">Syntax</span><span class="p">)</span>
          <span class="n">next</span> <span class="k">if</span> <span class="n">issue</span><span class="p">.</span><span class="n">correctable</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">config</span><span class="p">[</span><span class="o">:</span><span class="n">autocorrect</span><span class="p">]</span><span class="o">?</span>

          <span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">]</span> <span class="o">||=</span> <span class="n">Array</span><span class="p">(</span><span class="n">Issue</span><span class="p">).</span><span class="k">new</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">issue</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">header</span>
      <span class="o">&lt;&lt;-</span><span class="n">HEADER</span>
        <span class="cp"># This configuration file was generated by `ameba --gen-config`
</span>        <span class="cp"># on #{Time.utc} using Ameba version #{VERSION}.
</span>        <span class="cp"># The point is for the user to remove these configuration records
</span>        <span class="cp"># one by one as the reported problems are removed from the code base.
</span>
        <span class="n">HEADER</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">rule_todo</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">issues</span><span class="p">)</span>
      <span class="n">rule</span><span class="p">.</span><span class="n">excluded</span> <span class="o">=</span> <span class="n">issues</span>
        <span class="p">.</span><span class="n">compact_map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">filename</span><span class="p">.</span><span class="k">try</span> <span class="o">&amp;</span><span class="p">.</span><span class="n">to_s</span><span class="p">)</span>
        <span class="p">.</span><span class="n">uniq</span><span class="o">!</span>

      <span class="p">{</span><span class="n">rule</span><span class="p">.</span><span class="n">name</span> <span class="o">=&gt;</span> <span class="n">rule</span><span class="p">}.</span><span class="n">to_yaml</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./ameba/source/**"
# require "./rewriter"
</span><span class="k">class</span> <span class="nc">Ameba</span><span class="o">::</span><span class="n">Source</span>
  <span class="cp"># This class performs the heavy lifting in the source rewriting process.
</span>  <span class="cp"># It schedules code updates to be performed in the correct order.
</span>  <span class="cp">#
</span>  <span class="cp"># For simple cases, the resulting source will be obvious.
</span>  <span class="cp">#
</span>  <span class="cp"># Examples for more complex cases follow. Assume these examples are acting on
</span>  <span class="cp"># the source `puts(:hello, :world)`. The methods `#wrap`, `#remove`, etc.
</span>  <span class="cp"># receive a range as the first two arguments; for clarity, examples below use
</span>  <span class="cp"># English sentences and a string of raw code instead.
</span>  <span class="cp">#
</span>  <span class="cp"># ## Overlapping deletions:
</span>  <span class="cp">#
</span>  <span class="cp"># * remove `:hello, `
</span>  <span class="cp"># * remove `, :world`
</span>  <span class="cp">#
</span>  <span class="cp"># The overlapping ranges are merged and `:hello, :world` will be removed.
</span>  <span class="cp">#
</span>  <span class="cp"># ## Multiple actions at the same end points:
</span>  <span class="cp">#
</span>  <span class="cp"># Results will always be independent of the order they were given.
</span>  <span class="cp"># Exception: rewriting actions done on exactly the same range (covered next).
</span>  <span class="cp">#
</span>  <span class="cp"># Example:
</span>  <span class="cp">#
</span>  <span class="cp"># * replace `, ` by ` =&gt; `
</span>  <span class="cp"># * wrap `:hello, :world` with `{` and `}`
</span>  <span class="cp"># * replace `:world` with `:everybody`
</span>  <span class="cp"># * wrap `:world` with `[`, `]`
</span>  <span class="cp">#
</span>  <span class="cp"># The resulting string will be `puts({:hello =&gt; [:everybody]})`
</span>  <span class="cp"># and this result is independent of the order the instructions were given in.
</span>  <span class="cp">#
</span>  <span class="cp"># ## Multiple wraps on same range:
</span>  <span class="cp">#
</span>  <span class="cp"># * wrap `:hello` with `(` and `)`
</span>  <span class="cp"># * wrap `:hello` with `[` and `]`
</span>  <span class="cp">#
</span>  <span class="cp"># The wraps are combined in order given and results would be `puts([(:hello)], :world)`.
</span>  <span class="cp">#
</span>  <span class="cp"># ## Multiple replacements on same range:
</span>  <span class="cp">#
</span>  <span class="cp"># * replace `:hello` by `:hi`, then
</span>  <span class="cp"># * replace `:hello` by `:hey`
</span>  <span class="cp">#
</span>  <span class="cp"># The replacements are made in the order given, so the latter replacement
</span>  <span class="cp"># supersedes the former and `:hello` will be replaced by `:hey`.
</span>  <span class="cp">#
</span>  <span class="cp"># ## Swallowed insertions:
</span>  <span class="cp">#
</span>  <span class="cp"># * wrap `world` by `__`, `__`
</span>  <span class="cp"># * replace `:hello, :world` with `:hi`
</span>  <span class="cp">#
</span>  <span class="cp"># A containing replacement will swallow the contained rewriting actions
</span>  <span class="cp"># and `:hello, :world` will be replaced by `:hi`.
</span>  <span class="cp">#
</span>  <span class="cp"># ## Implementation
</span>  <span class="cp">#
</span>  <span class="cp"># The updates are organized in a tree, according to the ranges they act on
</span>  <span class="cp"># (where children are strictly contained by their parent).
</span>  <span class="k">class</span> <span class="nc">Rewriter</span>
    <span class="n">getter</span> <span class="n">code</span> <span class="o">:</span> <span class="n">String</span>

    <span class="n">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">code</span><span class="p">)</span>
      <span class="err">@</span><span class="n">action_root</span> <span class="o">=</span> <span class="n">Rewriter</span><span class="o">::</span><span class="n">Action</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">code</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Returns `true` if no (non trivial) update has been recorded
</span>    <span class="n">def</span> <span class="n">empty</span><span class="o">?</span>
      <span class="err">@</span><span class="n">action_root</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="cp"># Replaces the code of the given range with *content*.
</span>    <span class="n">def</span> <span class="n">replace</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">combine</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">replacement</span><span class="o">:</span> <span class="n">content</span><span class="p">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Inserts the given strings before and after the given range.
</span>    <span class="n">def</span> <span class="n">wrap</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">insert_before</span><span class="p">,</span> <span class="n">insert_after</span><span class="p">)</span>
      <span class="n">combine</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">insert_before</span><span class="o">:</span> <span class="n">insert_before</span><span class="p">.</span><span class="n">to_s</span><span class="p">,</span> <span class="n">insert_after</span><span class="o">:</span> <span class="n">insert_after</span><span class="p">.</span><span class="n">to_s</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `replace(begin_pos, end_pos, "")`
</span>    <span class="n">def</span> <span class="n">remove</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
      <span class="n">replace</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="s">""</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `wrap(begin_pos, end_pos, content, nil)`
</span>    <span class="n">def</span> <span class="n">insert_before</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">wrap</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">content</span><span class="p">,</span> <span class="n">nil</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `wrap(begin_pos, end_pos, nil, content)`
</span>    <span class="n">def</span> <span class="n">insert_after</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">wrap</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">nil</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `insert_before(pos, pos, content)`
</span>    <span class="n">def</span> <span class="n">insert_before</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">insert_before</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `insert_after(pos, pos, content)`
</span>    <span class="n">def</span> <span class="n">insert_after</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">insert_after</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Applies all scheduled changes and returns modified source as a new string.
</span>    <span class="n">def</span> <span class="n">process</span>
      <span class="n">String</span><span class="p">.</span><span class="n">build</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
        <span class="n">last_end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="err">@</span><span class="n">action_root</span><span class="p">.</span><span class="n">ordered_replacements</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">replacement</span><span class="o">|</span>
          <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="n">code</span><span class="p">[</span><span class="n">last_end</span><span class="p">...</span><span class="n">begin_pos</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="n">replacement</span>
          <span class="n">last_end</span> <span class="o">=</span> <span class="n">end_pos</span>
        <span class="n">end</span>
        <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="n">code</span><span class="p">[</span><span class="n">last_end</span><span class="p">...</span><span class="n">code</span><span class="p">.</span><span class="n">size</span><span class="p">]</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">combine</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">)</span>
      <span class="n">check_range_validity</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
      <span class="n">action</span> <span class="o">=</span> <span class="n">Rewriter</span><span class="o">::</span><span class="n">Action</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="o">**</span><span class="n">attributes</span><span class="p">)</span>
      <span class="err">@</span><span class="n">action_root</span> <span class="o">=</span> <span class="err">@</span><span class="n">action_root</span><span class="p">.</span><span class="n">combine</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">check_range_validity</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">begin_pos</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">end_pos</span> <span class="o">&gt;</span> <span class="n">code</span><span class="p">.</span><span class="n">size</span>
      <span class="n">raise</span> <span class="n">IndexError</span><span class="p">.</span><span class="k">new</span><span class="p">(</span>
        <span class="s">"The range #{begin_pos}...#{end_pos} is outside the bounds of the source"</span>
      <span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="k">class</span> <span class="nc">Ameba</span><span class="o">::</span><span class="n">Source</span>
  <span class="cp"># This class takes source code and rewrites it based
</span>  <span class="cp"># on the different correction actions supplied.
</span>  <span class="k">class</span> <span class="nc">Corrector</span>
    <span class="err">@</span><span class="n">line_sizes</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Int32</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">code</span> <span class="o">:</span> <span class="n">String</span><span class="p">)</span>
      <span class="n">code</span><span class="p">.</span><span class="n">each_line</span><span class="p">(</span><span class="n">chomp</span><span class="o">:</span> <span class="nb">false</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
        <span class="err">@</span><span class="n">line_sizes</span> <span class="o">&lt;&lt;</span> <span class="n">line</span><span class="p">.</span><span class="n">size</span>
      <span class="n">end</span>
      <span class="err">@</span><span class="n">rewriter</span> <span class="o">=</span> <span class="n">Rewriter</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Replaces the code of the given range with *content*.
</span>    <span class="n">def</span> <span class="n">replace</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">),</span> <span class="n">loc_to_pos</span><span class="p">(</span><span class="n">end_location</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">replace</span><span class="p">(</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">),</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span>
      <span class="n">end_pos</span> <span class="o">-=</span> <span class="mi">1</span> <span class="n">unless</span> <span class="n">range</span><span class="p">.</span><span class="n">excludes_end</span><span class="o">?</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Inserts the given strings before and after the given range.
</span>    <span class="n">def</span> <span class="n">wrap</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">insert_before</span><span class="p">,</span> <span class="n">insert_after</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">),</span> <span class="n">loc_to_pos</span><span class="p">(</span><span class="n">end_location</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">insert_before</span><span class="p">,</span> <span class="n">insert_after</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">wrap</span><span class="p">(</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">),</span> <span class="n">insert_before</span><span class="p">,</span> <span class="n">insert_after</span><span class="p">)</span>
      <span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span>
      <span class="n">end_pos</span> <span class="o">-=</span> <span class="mi">1</span> <span class="n">unless</span> <span class="n">range</span><span class="p">.</span><span class="n">excludes_end</span><span class="o">?</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">wrap</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">insert_before</span><span class="p">,</span> <span class="n">insert_after</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `replace(location, end_location, "")`
</span>    <span class="n">def</span> <span class="n">remove</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">),</span> <span class="n">loc_to_pos</span><span class="p">(</span><span class="n">end_location</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `replace(range, "")`
</span>    <span class="n">def</span> <span class="n">remove</span><span class="p">(</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">))</span>
      <span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span>
      <span class="n">end_pos</span> <span class="o">-=</span> <span class="mi">1</span> <span class="n">unless</span> <span class="n">range</span><span class="p">.</span><span class="n">excludes_end</span><span class="o">?</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `wrap(location, end_location, content, nil)`
</span>    <span class="n">def</span> <span class="n">insert_before</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">insert_before</span><span class="p">(</span><span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">),</span> <span class="n">loc_to_pos</span><span class="p">(</span><span class="n">end_location</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `wrap(range, content, nil)`
</span>    <span class="n">def</span> <span class="n">insert_before</span><span class="p">(</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">),</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span>
      <span class="n">end_pos</span> <span class="o">-=</span> <span class="mi">1</span> <span class="n">unless</span> <span class="n">range</span><span class="p">.</span><span class="n">excludes_end</span><span class="o">?</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">insert_before</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `wrap(location, end_location, nil, content)`
</span>    <span class="n">def</span> <span class="n">insert_after</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">),</span> <span class="n">loc_to_pos</span><span class="p">(</span><span class="n">end_location</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `wrap(range, nil, content)`
</span>    <span class="n">def</span> <span class="n">insert_after</span><span class="p">(</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">),</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span><span class="p">,</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span>
      <span class="n">end_pos</span> <span class="o">-=</span> <span class="mi">1</span> <span class="n">unless</span> <span class="n">range</span><span class="p">.</span><span class="n">excludes_end</span><span class="o">?</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `insert_before(location, location, content)`
</span>    <span class="n">def</span> <span class="n">insert_before</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">insert_before</span><span class="p">(</span><span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">),</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `insert_before(pos.., content)`
</span>    <span class="n">def</span> <span class="n">insert_before</span><span class="p">(</span><span class="n">pos</span> <span class="o">:</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">insert_before</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `insert_after(location, location, content)`
</span>    <span class="n">def</span> <span class="n">insert_after</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `insert_after(...pos, content)`
</span>    <span class="n">def</span> <span class="n">insert_after</span><span class="p">(</span><span class="n">pos</span> <span class="o">:</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">insert_after</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Removes *size* characters prior to the source range.
</span>    <span class="n">def</span> <span class="n">remove_preceding</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span> <span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">remove_preceding</span><span class="p">(</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
      <span class="n">begin_pos</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">begin_pos</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span> <span class="n">begin_pos</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Removes *size* characters from the beginning of the given range.
</span>    <span class="cp"># If *size* is greater than the size of the range, the removed region can
</span>    <span class="cp"># overrun the end of the range.
</span>    <span class="n">def</span> <span class="n">remove_leading</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">),</span> <span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span><span class="p">)</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">remove_leading</span><span class="p">(</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
      <span class="n">begin_pos</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">begin</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">begin_pos</span> <span class="o">+</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Removes *size* characters from the end of the given range.
</span>    <span class="cp"># If *size* is greater than the size of the range, the removed region can
</span>    <span class="cp"># overrun the beginning of the range.
</span>    <span class="n">def</span> <span class="n">remove_trailing</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">loc_to_pos</span><span class="p">(</span><span class="n">end_location</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span> <span class="n">loc_to_pos</span><span class="p">(</span><span class="n">end_location</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># :ditto:
</span>    <span class="n">def</span> <span class="n">remove_trailing</span><span class="p">(</span><span class="n">range</span> <span class="o">:</span> <span class="n">Range</span><span class="p">(</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
      <span class="n">end_pos</span> <span class="o">=</span> <span class="n">range</span><span class="p">.</span><span class="n">end</span>
      <span class="n">end_pos</span> <span class="o">-=</span> <span class="mi">1</span> <span class="n">unless</span> <span class="n">range</span><span class="p">.</span><span class="n">excludes_end</span><span class="o">?</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">remove</span><span class="p">(</span><span class="n">end_pos</span> <span class="o">-</span> <span class="n">size</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">loc_to_pos</span><span class="p">(</span><span class="n">location</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span> <span class="o">|</span> <span class="p">{</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">})</span>
      <span class="k">if</span> <span class="n">location</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Crystal</span><span class="o">::</span><span class="n">Location</span><span class="p">)</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="n">location</span><span class="p">.</span><span class="n">line_number</span><span class="p">,</span> <span class="n">location</span><span class="p">.</span><span class="n">column_number</span>
      <span class="k">else</span>
        <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="n">location</span>
      <span class="n">end</span>
      <span class="err">@</span><span class="n">line_sizes</span><span class="p">[</span><span class="mf">0.</span><span class="p">..</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">sum</span> <span class="o">+</span> <span class="p">(</span><span class="n">column</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Replaces the code of the given node with *content*.
</span>    <span class="n">def</span> <span class="n">replace</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">replace</span><span class="p">(</span><span class="n">location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end_location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Inserts the given strings before and after the given node.
</span>    <span class="n">def</span> <span class="n">wrap</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">insert_before</span><span class="p">,</span> <span class="n">insert_after</span><span class="p">)</span>
      <span class="n">wrap</span><span class="p">(</span><span class="n">location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end_location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">insert_before</span><span class="p">,</span> <span class="n">insert_after</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `replace(node, "")`
</span>    <span class="n">def</span> <span class="n">remove</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="n">remove</span><span class="p">(</span><span class="n">location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end_location</span><span class="p">(</span><span class="n">node</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `wrap(node, content, nil)`
</span>    <span class="n">def</span> <span class="n">insert_before</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">insert_before</span><span class="p">(</span><span class="n">location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Shortcut for `wrap(node, nil, content)`
</span>    <span class="n">def</span> <span class="n">insert_after</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
      <span class="n">insert_after</span><span class="p">(</span><span class="n">end_location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">content</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Removes *size* characters prior to the given node.
</span>    <span class="n">def</span> <span class="n">remove_preceding</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
      <span class="n">remove_preceding</span><span class="p">(</span><span class="n">location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end_location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Removes *size* characters from the beginning of the given node.
</span>    <span class="cp"># If *size* is greater than the size of the node, the removed region can
</span>    <span class="cp"># overrun the end of the node.
</span>    <span class="n">def</span> <span class="n">remove_leading</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
      <span class="n">remove_leading</span><span class="p">(</span><span class="n">location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end_location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Removes *size* characters from the end of the given node.
</span>    <span class="cp"># If *size* is greater than the size of the node, the removed region can
</span>    <span class="cp"># overrun the beginning of the node.
</span>    <span class="n">def</span> <span class="n">remove_trailing</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span>
      <span class="n">remove_trailing</span><span class="p">(</span><span class="n">location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">end_location</span><span class="p">(</span><span class="n">node</span><span class="p">),</span> <span class="n">size</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">location</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">location</span> <span class="o">||</span> <span class="n">raise</span> <span class="s">"Missing location"</span>
    <span class="n">end</span>

    <span class="k">private</span> <span class="n">def</span> <span class="n">end_location</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">end_location</span> <span class="o">||</span> <span class="n">raise</span> <span class="s">"Missing end location"</span>
    <span class="n">end</span>

    <span class="cp"># Applies all scheduled changes and returns modified source as a new string.
</span>    <span class="n">def</span> <span class="n">process</span>
      <span class="err">@</span><span class="n">rewriter</span><span class="p">.</span><span class="n">process</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="k">class</span> <span class="nc">Ameba</span><span class="o">::</span><span class="n">Source</span><span class="o">::</span><span class="n">Rewriter</span>
  <span class="cp"># :nodoc:
</span>  <span class="cp"># Actions are arranged in a tree and get combined so that:
</span>  <span class="cp"># - children are strictly contained by their parent
</span>  <span class="cp"># - siblings all disjoint from one another and ordered
</span>  <span class="cp"># - only actions with `replacement == nil` may have children
</span>  <span class="k">class</span> <span class="nc">Action</span>
    <span class="n">getter</span> <span class="n">begin_pos</span> <span class="o">:</span> <span class="n">Int32</span>
    <span class="n">getter</span> <span class="n">end_pos</span> <span class="o">:</span> <span class="n">Int32</span>
    <span class="n">getter</span> <span class="n">replacement</span> <span class="o">:</span> <span class="n">String</span><span class="o">?</span>
    <span class="n">getter</span> <span class="n">insert_before</span> <span class="o">:</span> <span class="n">String</span>
    <span class="n">getter</span> <span class="n">insert_after</span> <span class="o">:</span> <span class="n">String</span>
    <span class="k">protected</span> <span class="n">getter</span> <span class="n">children</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Action</span><span class="p">)</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">begin_pos</span><span class="p">,</span>
                   <span class="err">@</span><span class="n">end_pos</span><span class="p">,</span>
                   <span class="err">@</span><span class="n">insert_before</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span>
                   <span class="err">@</span><span class="n">replacement</span> <span class="o">=</span> <span class="n">nil</span><span class="p">,</span>
                   <span class="err">@</span><span class="n">insert_after</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span>
                   <span class="err">@</span><span class="n">children</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Action</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">combine</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">self</span> <span class="k">if</span> <span class="n">action</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="err">#</span> <span class="n">Ignore</span> <span class="n">empty</span> <span class="n">action</span>

      <span class="k">if</span> <span class="n">action</span><span class="p">.</span><span class="n">begin_pos</span> <span class="o">==</span> <span class="err">@</span><span class="n">begin_pos</span> <span class="o">&amp;&amp;</span> <span class="n">action</span><span class="p">.</span><span class="n">end_pos</span> <span class="o">==</span> <span class="err">@</span><span class="n">end_pos</span>
        <span class="n">merge</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">place_in_hierarchy</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">empty</span><span class="o">?</span>
      <span class="n">replacement</span> <span class="o">=</span> <span class="err">@</span><span class="n">replacement</span>

      <span class="err">@</span><span class="n">insert_before</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">&amp;&amp;</span>
        <span class="err">@</span><span class="n">insert_after</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">&amp;&amp;</span>
        <span class="err">@</span><span class="n">children</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">&amp;&amp;</span>
        <span class="p">(</span><span class="n">replacement</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span> <span class="o">||</span>
          <span class="p">(</span><span class="n">replacement</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="err">@</span><span class="n">begin_pos</span> <span class="o">==</span> <span class="err">@</span><span class="n">end_pos</span><span class="p">))</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">ordered_replacements</span>
      <span class="n">replacement</span> <span class="o">=</span> <span class="err">@</span><span class="n">replacement</span>
      <span class="n">reps</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="p">{</span><span class="n">Int32</span><span class="p">,</span> <span class="n">Int32</span><span class="p">,</span> <span class="n">String</span><span class="p">}</span>
      <span class="n">reps</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="err">@</span><span class="n">begin_pos</span><span class="p">,</span> <span class="err">@</span><span class="n">begin_pos</span><span class="p">,</span> <span class="err">@</span><span class="n">insert_before</span><span class="p">}</span> <span class="n">unless</span> <span class="err">@</span><span class="n">insert_before</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
      <span class="n">reps</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="err">@</span><span class="n">begin_pos</span><span class="p">,</span> <span class="err">@</span><span class="n">end_pos</span><span class="p">,</span> <span class="n">replacement</span><span class="p">}</span> <span class="k">if</span> <span class="n">replacement</span>
      <span class="n">reps</span><span class="p">.</span><span class="n">concat</span><span class="p">(</span><span class="err">@</span><span class="n">children</span><span class="p">.</span><span class="n">flat_map</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">ordered_replacements</span><span class="p">))</span>
      <span class="n">reps</span> <span class="o">&lt;&lt;</span> <span class="p">{</span><span class="err">@</span><span class="n">end_pos</span><span class="p">,</span> <span class="err">@</span><span class="n">end_pos</span><span class="p">,</span> <span class="err">@</span><span class="n">insert_after</span><span class="p">}</span> <span class="n">unless</span> <span class="err">@</span><span class="n">insert_after</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
      <span class="n">reps</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">insertion</span><span class="o">?</span>
      <span class="n">replacement</span> <span class="o">=</span> <span class="err">@</span><span class="n">replacement</span>

      <span class="o">!</span><span class="err">@</span><span class="n">insert_before</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">||</span>
        <span class="o">!</span><span class="err">@</span><span class="n">insert_after</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">||</span>
        <span class="p">(</span><span class="n">replacement</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">replacement</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">with</span><span class="p">(</span><span class="o">*</span><span class="p">,</span>
                       <span class="n">begin_pos</span> <span class="o">=</span> <span class="err">@</span><span class="n">begin_pos</span><span class="p">,</span>
                       <span class="n">end_pos</span> <span class="o">=</span> <span class="err">@</span><span class="n">end_pos</span><span class="p">,</span>
                       <span class="n">insert_before</span> <span class="o">=</span> <span class="err">@</span><span class="n">insert_before</span><span class="p">,</span>
                       <span class="n">replacement</span> <span class="o">=</span> <span class="err">@</span><span class="n">replacement</span><span class="p">,</span>
                       <span class="n">insert_after</span> <span class="o">=</span> <span class="err">@</span><span class="n">insert_after</span><span class="p">,</span>
                       <span class="n">children</span> <span class="o">=</span> <span class="err">@</span><span class="n">children</span><span class="p">)</span>
      <span class="n">children</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Action</span> <span class="k">if</span> <span class="n">replacement</span>
      <span class="n">self</span><span class="p">.</span><span class="k">class</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="p">,</span> <span class="n">insert_before</span><span class="p">,</span> <span class="n">replacement</span><span class="p">,</span> <span class="n">insert_after</span><span class="p">,</span> <span class="n">children</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">place_in_hierarchy</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
      <span class="n">family</span> <span class="o">=</span> <span class="n">analyze_hierarchy</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
      <span class="n">sibling_left</span><span class="p">,</span> <span class="n">sibling_right</span> <span class="o">=</span> <span class="n">family</span><span class="p">[</span><span class="o">:</span><span class="n">sibling_left</span><span class="p">],</span> <span class="n">family</span><span class="p">[</span><span class="o">:</span><span class="n">sibling_right</span><span class="p">]</span>

      <span class="k">if</span> <span class="n">fusible</span> <span class="o">=</span> <span class="n">family</span><span class="p">[</span><span class="o">:</span><span class="n">fusible</span><span class="p">]</span>
        <span class="n">child</span> <span class="o">=</span> <span class="n">family</span><span class="p">[</span><span class="o">:</span><span class="n">child</span><span class="p">]</span>
        <span class="n">child</span> <span class="o">||=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Action</span>
        <span class="n">fuse_deletions</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">fusible</span><span class="p">,</span> <span class="n">sibling_left</span> <span class="o">+</span> <span class="n">child</span> <span class="o">+</span> <span class="n">sibling_right</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="n">extra_sibling</span> <span class="o">=</span>
          <span class="k">case</span>
          <span class="n">when</span> <span class="n">parent</span> <span class="o">=</span> <span class="n">family</span><span class="p">[:</span><span class="n">parent</span><span class="p">]</span>
            <span class="cp"># action should be a descendant of one of the children
</span>            <span class="n">parent</span><span class="p">.</span><span class="n">combine</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
          <span class="n">when</span> <span class="n">child</span> <span class="o">=</span> <span class="n">family</span><span class="p">[</span><span class="o">:</span><span class="n">child</span><span class="p">]</span>
            <span class="cp"># or it should become the parent of some of the children,
</span>            <span class="n">action</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="n">children</span><span class="o">:</span> <span class="n">child</span><span class="p">).</span><span class="n">combine_children</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">children</span><span class="p">)</span>
          <span class="k">else</span>
            <span class="cp"># or else it should become an additional child
</span>            <span class="n">action</span>
          <span class="n">end</span>
        <span class="n">self</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="n">children</span><span class="o">:</span> <span class="n">sibling_left</span> <span class="o">+</span> <span class="p">[</span><span class="n">extra_sibling</span><span class="p">]</span> <span class="o">+</span> <span class="n">sibling_right</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="cp"># Assumes *more_children* all contained within `@begin_pos...@end_pos`
</span>    <span class="k">protected</span> <span class="n">def</span> <span class="n">combine_children</span><span class="p">(</span><span class="n">more_children</span><span class="p">)</span>
      <span class="n">more_children</span><span class="p">.</span><span class="n">reduce</span><span class="p">(</span><span class="n">self</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">parent</span><span class="p">,</span> <span class="n">new_child</span><span class="o">|</span>
        <span class="n">parent</span><span class="p">.</span><span class="n">place_in_hierarchy</span><span class="p">(</span><span class="n">new_child</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="k">protected</span> <span class="n">def</span> <span class="n">fuse_deletions</span><span class="p">(</span><span class="n">action</span><span class="p">,</span> <span class="n">fusible</span><span class="p">,</span> <span class="n">other_siblings</span><span class="p">)</span>
      <span class="n">without_fusible</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="n">children</span><span class="o">:</span> <span class="n">other_siblings</span><span class="p">)</span>
      <span class="n">fusible</span> <span class="o">=</span> <span class="p">[</span><span class="n">action</span><span class="p">]</span> <span class="o">+</span> <span class="n">fusible</span>
      <span class="n">fused_begin_pos</span> <span class="o">=</span> <span class="n">fusible</span><span class="p">.</span><span class="n">min_of</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">begin_pos</span><span class="p">)</span>
      <span class="n">fused_end_pos</span> <span class="o">=</span> <span class="n">fusible</span><span class="p">.</span><span class="n">max_of</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">end_pos</span><span class="p">)</span>
      <span class="n">fused_deletion</span> <span class="o">=</span> <span class="n">action</span><span class="p">.</span><span class="n">with</span><span class="p">(</span><span class="n">begin_pos</span><span class="o">:</span> <span class="n">fused_begin_pos</span><span class="p">,</span> <span class="n">end_pos</span><span class="o">:</span> <span class="n">fused_end_pos</span><span class="p">)</span>
      <span class="n">without_fusible</span><span class="p">.</span><span class="n">combine</span><span class="p">(</span><span class="n">fused_deletion</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="cp"># Similar to `@children.bsearch_index || size` except allows for a starting point
</span>    <span class="k">protected</span> <span class="n">def</span> <span class="n">bsearch_child_index</span><span class="p">(</span><span class="n">from</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">)</span>
      <span class="n">size</span> <span class="o">=</span> <span class="err">@</span><span class="n">children</span><span class="p">.</span><span class="n">size</span>
      <span class="p">(</span><span class="n">from</span><span class="p">...</span><span class="n">size</span><span class="p">).</span><span class="n">bsearch</span> <span class="p">{</span> <span class="o">|</span><span class="n">i</span><span class="o">|</span> <span class="n">yield</span> <span class="err">@</span><span class="n">children</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="p">}</span> <span class="o">||</span> <span class="n">size</span>
    <span class="n">end</span>

    <span class="cp"># Returns the children in a hierarchy with respect to *action*:
</span>    <span class="cp">#
</span>    <span class="cp"># - `:sibling_left`, `:sibling_right` (for those that are disjoint from *action*)
</span>    <span class="cp"># - `:parent` (in case one of our children contains *action*)
</span>    <span class="cp"># - `:child` (in case *action* strictly contains some of our children)
</span>    <span class="cp"># - `:fusible` (in case *action* overlaps some children but they can be fused in one deletion)
</span>    <span class="cp">#
</span>    <span class="cp"># In case a child has equal range to *action*, it is returned as `:parent`
</span>    <span class="cp">#
</span>    <span class="cp"># Reminder: an empty range 1...1 is considered disjoint from 1...10
</span>    <span class="k">protected</span> <span class="n">def</span> <span class="n">analyze_hierarchy</span><span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="err">#</span> <span class="n">ameba</span><span class="o">:</span><span class="n">disable</span> <span class="n">Metrics</span><span class="o">/</span><span class="n">CyclomaticComplexity</span>
      <span class="cp"># left_index is the index of the first child that isn't completely to the left of action
</span>      <span class="n">left_index</span> <span class="o">=</span> <span class="n">bsearch_child_index</span> <span class="p">{</span> <span class="o">|</span><span class="n">child</span><span class="o">|</span> <span class="n">child</span><span class="p">.</span><span class="n">end_pos</span> <span class="o">&gt;</span> <span class="n">action</span><span class="p">.</span><span class="n">begin_pos</span> <span class="p">}</span>
      <span class="cp"># right_index is the index of the first child that is completely on the right of action
</span>      <span class="n">start</span> <span class="o">=</span> <span class="n">left_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">left_index</span> <span class="o">-</span> <span class="mi">1</span> <span class="err">#</span> <span class="n">See</span> <span class="s">"corner case"</span> <span class="n">below</span> <span class="k">for</span> <span class="n">reason</span> <span class="n">of</span> <span class="o">-</span><span class="mi">1</span>
      <span class="n">right_index</span> <span class="o">=</span> <span class="n">bsearch_child_index</span><span class="p">(</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">child</span><span class="o">|</span> <span class="n">child</span><span class="p">.</span><span class="n">begin_pos</span> <span class="o">&gt;=</span> <span class="n">action</span><span class="p">.</span><span class="n">end_pos</span> <span class="p">}</span>
      <span class="n">center</span> <span class="o">=</span> <span class="n">right_index</span> <span class="o">-</span> <span class="n">left_index</span>
      <span class="k">case</span> <span class="n">center</span>
      <span class="n">when</span> <span class="mi">0</span>
        <span class="cp"># All children are disjoint from action, nothing else to do
</span>      <span class="n">when</span> <span class="o">-</span><span class="mi">1</span>
        <span class="cp"># Corner case: if a child has empty range == action's range
</span>        <span class="cp"># then it will appear to be both disjoint and to the left of action,
</span>        <span class="cp"># as well as disjoint and to the right of action.
</span>        <span class="cp"># Since ranges are equal, we return it as parent
</span>        <span class="n">left_index</span> <span class="o">-=</span> <span class="mi">1</span>  <span class="err">#</span> <span class="n">Fix</span> <span class="n">indices</span><span class="p">,</span> <span class="n">as</span> <span class="n">otherwise</span> <span class="k">this</span> <span class="n">child</span> <span class="n">would</span> <span class="n">be</span>
        <span class="n">right_index</span> <span class="o">+=</span> <span class="mi">1</span> <span class="err">#</span> <span class="n">considered</span> <span class="n">as</span> <span class="n">a</span> <span class="n">sibling</span> <span class="p">(</span><span class="n">both</span> <span class="n">left</span> <span class="n">and</span> <span class="n">right</span><span class="o">!</span><span class="p">)</span>
        <span class="n">parent</span> <span class="o">=</span> <span class="err">@</span><span class="n">children</span><span class="p">[</span><span class="n">left_index</span><span class="p">]</span>
      <span class="k">else</span>
        <span class="n">overlap_left</span> <span class="o">=</span> <span class="err">@</span><span class="n">children</span><span class="p">[</span><span class="n">left_index</span><span class="p">].</span><span class="n">begin_pos</span> <span class="o">&lt;=&gt;</span> <span class="n">action</span><span class="p">.</span><span class="n">begin_pos</span>
        <span class="n">overlap_right</span> <span class="o">=</span> <span class="err">@</span><span class="n">children</span><span class="p">[</span><span class="n">right_index</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">end_pos</span> <span class="o">&lt;=&gt;</span> <span class="n">action</span><span class="p">.</span><span class="n">end_pos</span>

        <span class="n">raise</span> <span class="s">"Unable to compare begin pos"</span> <span class="k">if</span> <span class="n">overlap_left</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>
        <span class="n">raise</span> <span class="s">"Unable to compare end pos"</span> <span class="k">if</span> <span class="n">overlap_right</span><span class="p">.</span><span class="n">nil</span><span class="o">?</span>

        <span class="cp"># For one child to be the parent of action, we must have:
</span>        <span class="k">if</span> <span class="n">center</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">overlap_left</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">overlap_right</span> <span class="o">&gt;=</span> <span class="mi">0</span>
          <span class="n">parent</span> <span class="o">=</span> <span class="err">@</span><span class="n">children</span><span class="p">[</span><span class="n">left_index</span><span class="p">]</span>
        <span class="k">else</span>
          <span class="cp"># Otherwise consider all non disjoint elements (center) to be contained...
</span>          <span class="n">contained</span> <span class="o">=</span> <span class="err">@</span><span class="n">children</span><span class="p">[</span><span class="n">left_index</span><span class="p">...</span><span class="n">right_index</span><span class="p">]</span>
          <span class="n">fusible</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Action</span>
          <span class="n">fusible</span> <span class="o">&lt;&lt;</span> <span class="n">contained</span><span class="p">.</span><span class="n">shift</span> <span class="k">if</span> <span class="n">overlap_left</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="err">#</span> <span class="p">...</span> <span class="n">but</span> <span class="n">check</span> <span class="n">first</span> <span class="n">and</span> <span class="n">last</span> <span class="n">one</span>
          <span class="n">fusible</span> <span class="o">&lt;&lt;</span> <span class="n">contained</span><span class="p">.</span><span class="n">pop</span> <span class="k">if</span> <span class="n">overlap_right</span> <span class="o">&gt;</span> <span class="mi">0</span>  <span class="err">#</span> <span class="p">...</span> <span class="k">for</span> <span class="n">overlaps</span>
          <span class="n">fusible</span> <span class="o">=</span> <span class="n">nil</span> <span class="k">if</span> <span class="n">fusible</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
        <span class="n">end</span>
      <span class="n">end</span>

      <span class="err">{</span>
        <span class="nl">parent:</span>        <span class="n">parent</span><span class="p">,</span>
        <span class="nl">sibling_left:</span>  <span class="err">@</span><span class="n">children</span><span class="p">[</span><span class="mf">0.</span><span class="p">..</span><span class="n">left_index</span><span class="p">],</span>
        <span class="nl">sibling_right:</span> <span class="err">@</span><span class="n">children</span><span class="p">[</span><span class="n">right_index</span><span class="p">...</span><span class="err">@</span><span class="n">children</span><span class="p">.</span><span class="n">size</span><span class="p">],</span>
        <span class="nl">fusible:</span>       <span class="n">fusible</span><span class="p">,</span>
        <span class="nl">child:</span>         <span class="n">contained</span><span class="p">,</span>
      <span class="err">}</span>
    <span class="n">end</span>

    <span class="cp"># Assumes *action* has the exact same range and has no children
</span>    <span class="k">protected</span> <span class="n">def</span> <span class="n">merge</span><span class="p">(</span><span class="n">action</span><span class="p">)</span>
      <span class="n">self</span><span class="p">.</span><span class="n">with</span><span class="p">(</span>
        <span class="nl">insert_before:</span> <span class="s">"#{action.insert_before}#{insert_before}"</span><span class="p">,</span>
        <span class="nl">replacement:</span> <span class="n">action</span><span class="p">.</span><span class="n">replacement</span> <span class="o">||</span> <span class="err">@</span><span class="n">replacement</span><span class="p">,</span>
        <span class="nl">insert_after:</span> <span class="s">"#{insert_after}#{action.insert_after}"</span><span class="p">,</span>
      <span class="p">).</span><span class="n">combine_children</span><span class="p">(</span><span class="n">action</span><span class="p">.</span><span class="n">children</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># Ameba's entry module.
#
# To run the linter with default parameters:
#
# ```
# Ameba.run
# ```
#
# To configure and run it:
#
# ```
# config = Ameba::Config.load
# config.formatter = formatter
# config.files = file_paths
#
# Ameba.run config
# ```
</span><span class="n">module</span> <span class="n">Ameba</span>
  <span class="n">extend</span> <span class="n">self</span>

  <span class="n">VERSION</span> <span class="o">=</span> <span class="err">{{</span> <span class="err">`</span><span class="n">shards</span> <span class="n">version</span> <span class="s">"#{__DIR__}"</span><span class="err">`</span><span class="p">.</span><span class="n">chomp</span><span class="p">.</span><span class="n">stringify</span> <span class="err">}}</span>

  <span class="cp"># Initializes `Ameba::Runner` and runs it.
</span>  <span class="cp"># Can be configured via `config` parameter.
</span>  <span class="cp">#
</span>  <span class="cp"># Examples:
</span>  <span class="cp">#
</span>  <span class="cp"># ```
</span>  <span class="cp"># Ameba.run
</span>  <span class="cp"># Ameba.run config
</span>  <span class="cp"># ```
</span>  <span class="n">def</span> <span class="n">run</span><span class="p">(</span><span class="n">config</span> <span class="o">=</span> <span class="n">Config</span><span class="p">.</span><span class="n">load</span><span class="p">)</span>
    <span class="n">Runner</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="n">run</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "../src/ameba/spec/support"
# Require this file to load code that supports testing Ameba rules.
</span>
<span class="cp"># require "./be_valid"
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Spec</span>
  <span class="n">module</span> <span class="n">BeValid</span>
    <span class="n">def</span> <span class="n">be_valid</span>
      <span class="n">BeValidExpectation</span><span class="p">.</span><span class="k">new</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">struct</span> <span class="nc">BeValidExpectation</span>
    <span class="n">def</span> <span class="n">match</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">source</span><span class="p">.</span><span class="n">valid</span><span class="o">?</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">failure_message</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">String</span><span class="p">.</span><span class="n">build</span> <span class="k">do</span> <span class="o">|</span><span class="n">str</span><span class="o">|</span>
        <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="s">"Source expected to be valid, but there are issues: </span><span class="se">\n\n</span><span class="s">"</span>
        <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">reject</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="n">disabled</span><span class="o">?</span><span class="p">).</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">issue</span><span class="o">|</span>
          <span class="n">str</span> <span class="o">&lt;&lt;</span> <span class="s">"  * #{issue.rule.name}: #{issue.message}</span><span class="se">\n</span><span class="s">"</span>
        <span class="n">end</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">negative_failure_message</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="s">"Source expected to be invalid, but it is valid."</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./expect_issue"
# require "./annotated_source"
# Parsed representation of code annotated with the `# ^^^ error: Message` style
</span><span class="k">class</span> <span class="nc">Ameba</span><span class="o">::</span><span class="n">Spec</span><span class="o">::</span><span class="n">AnnotatedSource</span>
  <span class="n">ANNOTATION_PATTERN_1</span> <span class="o">=</span> <span class="o">/</span><span class="err">\</span><span class="n">A</span><span class="err">\</span><span class="n">s</span><span class="o">*</span><span class="p">(</span><span class="err">#</span> <span class="p">)</span><span class="o">?</span><span class="p">(</span><span class="err">\</span><span class="o">^+|</span><span class="err">\</span><span class="o">^</span><span class="err">{}</span><span class="p">)(</span> <span class="n">error</span><span class="p">:)</span><span class="o">?</span> <span class="o">/</span>
  <span class="n">ANNOTATION_PATTERN_2</span> <span class="o">=</span> <span class="s">" # error: "</span>

  <span class="n">ABBREV</span> <span class="o">=</span> <span class="s">"[...]"</span>

  <span class="n">getter</span> <span class="n">lines</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>

  <span class="cp"># Each entry is the line number, annotation prefix, and message.
</span>  <span class="cp"># The prefix is empty if the annotation is at the end of a code line.
</span>  <span class="n">getter</span> <span class="n">annotations</span> <span class="o">:</span> <span class="n">Array</span><span class="p">({</span><span class="n">Int32</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="p">})</span>

  <span class="cp"># Separates annotation lines from code lines. Tracks the real
</span>  <span class="cp"># code line number that each annotation corresponds to.
</span>  <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">annotated_code</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">String</span>
    <span class="n">annotations</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="p">{</span><span class="n">Int32</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="p">}</span>

    <span class="n">code_lines</span> <span class="o">=</span> <span class="n">annotated_code</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">)</span> <span class="err">#</span> <span class="n">must</span> <span class="n">preserve</span> <span class="n">trailing</span> <span class="n">newline</span>
    <span class="n">code_lines</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">code_line</span><span class="o">|</span>
      <span class="k">case</span>
      <span class="n">when</span> <span class="n">annotation_match</span> <span class="o">=</span> <span class="n">ANNOTATION_PATTERN_1</span><span class="p">.</span><span class="n">match</span><span class="p">(</span><span class="n">code_line</span><span class="p">)</span>
        <span class="n">message_index</span> <span class="o">=</span> <span class="n">annotation_match</span><span class="p">.</span><span class="n">end</span>
        <span class="n">prefix</span> <span class="o">=</span> <span class="n">code_line</span><span class="p">[</span><span class="mf">0.</span><span class="p">..</span><span class="n">message_index</span><span class="p">]</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">code_line</span><span class="p">[</span><span class="n">message_index</span><span class="p">...]</span>
        <span class="n">annotations</span> <span class="o">&lt;&lt;</span> <span class="err">{</span><span class="n">lines</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">message</span><span class="err">}</span>
      <span class="n">when</span> <span class="n">annotation_index</span> <span class="o">=</span> <span class="n">code_line</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">ANNOTATION_PATTERN_2</span><span class="p">)</span>
        <span class="n">lines</span> <span class="o">&lt;&lt;</span> <span class="n">code_line</span><span class="p">[...</span><span class="n">annotation_index</span><span class="p">]</span>
        <span class="n">message_index</span> <span class="o">=</span> <span class="n">annotation_index</span> <span class="o">+</span> <span class="n">ANNOTATION_PATTERN_2</span><span class="p">.</span><span class="n">size</span>
        <span class="n">message</span> <span class="o">=</span> <span class="n">code_line</span><span class="p">[</span><span class="n">message_index</span><span class="p">...]</span>
        <span class="n">annotations</span> <span class="o">&lt;&lt;</span> <span class="err">{</span><span class="n">lines</span><span class="p">.</span><span class="n">size</span><span class="p">,</span> <span class="s">""</span><span class="p">,</span> <span class="n">message</span><span class="err">}</span>
      <span class="k">else</span>
        <span class="n">lines</span> <span class="o">&lt;&lt;</span> <span class="n">code_line</span>
      <span class="n">end</span>
    <span class="n">end</span>
    <span class="n">annotations</span><span class="p">.</span><span class="n">map</span><span class="o">!</span> <span class="err">{</span> <span class="o">|</span><span class="n">_</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span> <span class="err">{</span><span class="mi">1</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">message</span><span class="err">}</span> <span class="err">}</span> <span class="k">if</span> <span class="n">lines</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
    <span class="k">new</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">annotations</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="cp"># NOTE: Annotations are sorted so that reconstructing the annotation
</span>  <span class="cp">#       text via `#to_s` is deterministic.
</span>  <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">lines</span><span class="p">,</span> <span class="n">annotations</span> <span class="p">:</span> <span class="n">Enumerable</span><span class="p">({</span><span class="n">Int32</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">String</span><span class="p">}))</span>
    <span class="err">@</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">annotations</span><span class="p">.</span><span class="n">to_a</span><span class="p">.</span><span class="n">sort_by</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span>
      <span class="p">{</span><span class="n">line</span><span class="p">,</span> <span class="n">message</span><span class="p">}</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># Annotates the source code with the Ameba issues provided.
</span>  <span class="cp">#
</span>  <span class="cp"># NOTE: Annotations are sorted so that reconstructing the annotation
</span>  <span class="cp">#       text via `#to_s` is deterministic.
</span>  <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="err">@</span><span class="n">lines</span><span class="p">,</span> <span class="n">issues</span> <span class="o">:</span> <span class="n">Enumerable</span><span class="p">(</span><span class="n">Issue</span><span class="p">))</span>
    <span class="err">@</span><span class="n">annotations</span> <span class="o">=</span> <span class="n">issues_to_annotations</span><span class="p">(</span><span class="n">issues</span><span class="p">).</span><span class="n">sort_by</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span>
      <span class="p">{</span><span class="n">line</span><span class="p">,</span> <span class="n">message</span><span class="p">}</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="n">def</span> <span class="o">==</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="n">other</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">AnnotatedSource</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">other</span><span class="p">.</span><span class="n">lines</span> <span class="o">==</span> <span class="n">lines</span> <span class="o">&amp;&amp;</span> <span class="n">match_annotations</span><span class="o">?</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">def</span> <span class="n">match_annotations</span><span class="o">?</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="n">annotations</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="n">other</span><span class="p">.</span><span class="n">annotations</span><span class="p">.</span><span class="n">size</span>

    <span class="n">annotations</span><span class="p">.</span><span class="n">zip</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">annotations</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="p">(</span><span class="n">actual_line</span><span class="p">,</span> <span class="n">actual_prefix</span><span class="p">,</span> <span class="n">actual_message</span><span class="p">),</span> <span class="p">(</span><span class="n">expected_line</span><span class="p">,</span> <span class="n">expected_prefix</span><span class="p">,</span> <span class="n">expected_message</span><span class="p">)</span><span class="o">|</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="n">actual_line</span> <span class="o">==</span> <span class="n">expected_line</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="n">expected_prefix</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span> <span class="o">||</span> <span class="n">actual_prefix</span> <span class="o">==</span> <span class="n">expected_prefix</span>
      <span class="n">next</span> <span class="k">if</span> <span class="n">actual_message</span> <span class="o">==</span> <span class="n">expected_message</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="n">expected_message</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="n">ABBREV</span><span class="p">)</span>

      <span class="n">regex</span> <span class="o">=</span> <span class="o">/</span><span class="err">\</span><span class="n">A</span><span class="err">#</span><span class="p">{</span><span class="n">message_to_regex</span><span class="p">(</span><span class="n">expected_message</span><span class="p">)}</span><span class="err">\</span><span class="n">Z</span><span class="o">/</span>
      <span class="k">return</span> <span class="nb">false</span> <span class="n">unless</span> <span class="n">actual_message</span><span class="p">.</span><span class="n">matches</span><span class="o">?</span><span class="p">(</span><span class="n">regex</span><span class="p">)</span>
    <span class="n">end</span>

    <span class="nb">true</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">def</span> <span class="n">message_to_regex</span><span class="p">(</span><span class="n">expected_annotation</span><span class="p">)</span>
    <span class="n">String</span><span class="p">.</span><span class="n">build</span> <span class="k">do</span> <span class="o">|</span><span class="n">io</span><span class="o">|</span>
      <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span>
      <span class="k">while</span> <span class="n">index</span> <span class="o">=</span> <span class="n">expected_annotation</span><span class="p">.</span><span class="n">index</span><span class="p">(</span><span class="n">ABBREV</span><span class="p">,</span> <span class="n">offset</span><span class="p">)</span>
        <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="n">Regex</span><span class="p">.</span><span class="n">escape</span><span class="p">(</span><span class="n">expected_annotation</span><span class="p">[</span><span class="n">offset</span><span class="p">...</span><span class="n">index</span><span class="p">])</span>
        <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="s">".*?"</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">index</span> <span class="o">+</span> <span class="n">ABBREV</span><span class="p">.</span><span class="n">size</span>
      <span class="n">end</span>
      <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="n">Regex</span><span class="p">.</span><span class="n">escape</span><span class="p">(</span><span class="n">expected_annotation</span><span class="p">[</span><span class="n">offset</span><span class="p">..])</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># Constructs an annotated source string (like what we parse).
</span>  <span class="cp">#
</span>  <span class="cp"># Reconstructs a deterministic annotated source string. This is
</span>  <span class="cp"># useful for eliminating semantically irrelevant annotation
</span>  <span class="cp"># ordering differences.
</span>  <span class="cp">#
</span>  <span class="cp">#     source1 = AnnotatedSource.parse(&lt;&lt;-CRYSTAL)
</span>  <span class="cp">#     line1
</span>  <span class="cp">#     ^ Annotation 1
</span>  <span class="cp">#      ^^ Annotation 2
</span>  <span class="cp">#     CRYSTAL
</span>  <span class="cp">#
</span>  <span class="cp">#     source2 = AnnotatedSource.parse(&lt;&lt;-CRYSTAL)
</span>  <span class="cp">#     line1
</span>  <span class="cp">#      ^^ Annotation 2
</span>  <span class="cp">#     ^ Annotation 1
</span>  <span class="cp">#     CRYSTAL
</span>  <span class="cp">#
</span>  <span class="cp">#     source1.to_s == source2.to_s # =&gt; true
</span>  <span class="n">def</span> <span class="n">to_s</span><span class="p">(</span><span class="n">io</span><span class="p">)</span>
    <span class="n">reconstructed</span> <span class="o">=</span> <span class="n">lines</span><span class="p">.</span><span class="n">dup</span>
    <span class="n">annotations</span><span class="p">.</span><span class="n">reverse_each</span> <span class="k">do</span> <span class="o">|</span><span class="n">line_number</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">message</span><span class="o">|</span>
      <span class="k">if</span> <span class="n">prefix</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
        <span class="n">reconstructed</span><span class="p">[</span><span class="n">line_number</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="s">"#{ANNOTATION_PATTERN_2}#{message}"</span>
      <span class="k">else</span>
        <span class="n">line_number</span> <span class="o">=</span> <span class="mi">0</span> <span class="k">if</span> <span class="n">lines</span><span class="p">.</span><span class="n">empty</span><span class="o">?</span>
        <span class="n">reconstructed</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">line_number</span><span class="p">,</span> <span class="s">"#{prefix}#{message}"</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
    <span class="n">io</span> <span class="o">&lt;&lt;</span> <span class="n">reconstructed</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">)</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">def</span> <span class="n">issues_to_annotations</span><span class="p">(</span><span class="n">issues</span><span class="p">)</span>
    <span class="n">issues</span><span class="p">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">issue</span><span class="o">|</span>
      <span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">end_line</span><span class="p">,</span> <span class="n">end_column</span> <span class="o">=</span> <span class="n">validate_location</span><span class="p">(</span><span class="n">issue</span><span class="p">)</span>
      <span class="n">indent_count</span> <span class="o">=</span> <span class="n">column</span> <span class="o">-</span> <span class="mi">3</span>
      <span class="n">indent</span> <span class="o">=</span> <span class="k">if</span> <span class="n">indent_count</span> <span class="o">&lt;</span> <span class="mi">0</span>
                 <span class="s">""</span>
               <span class="k">else</span>
                 <span class="s">" "</span> <span class="o">*</span> <span class="n">indent_count</span>
               <span class="n">end</span>
      <span class="n">caret_count</span> <span class="o">=</span> <span class="n">column_length</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">end_line</span><span class="p">,</span> <span class="n">end_column</span><span class="p">)</span>
      <span class="n">caret_count</span> <span class="o">+=</span> <span class="n">indent_count</span> <span class="k">if</span> <span class="n">indent_count</span> <span class="o">&lt;</span> <span class="mi">0</span>
      <span class="n">carets</span> <span class="o">=</span> <span class="k">if</span> <span class="n">caret_count</span> <span class="o">&lt;=</span> <span class="mi">0</span>
                 <span class="s">"^{}"</span>
               <span class="k">else</span>
                 <span class="s">"^"</span> <span class="o">*</span> <span class="n">caret_count</span>
               <span class="n">end</span>
      <span class="p">{</span><span class="n">line</span><span class="p">,</span> <span class="s">"#{indent}# #{carets} error: "</span><span class="p">,</span> <span class="n">issue</span><span class="p">.</span><span class="n">message</span><span class="p">}</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">def</span> <span class="n">validate_location</span><span class="p">(</span><span class="n">issue</span><span class="p">)</span>
    <span class="n">loc</span><span class="p">,</span> <span class="n">end_loc</span> <span class="o">=</span> <span class="n">issue</span><span class="p">.</span><span class="n">location</span><span class="p">,</span> <span class="n">issue</span><span class="p">.</span><span class="n">end_location</span>
    <span class="n">raise</span> <span class="s">"Missing location for issue '#{issue.message}'"</span> <span class="n">unless</span> <span class="n">loc</span>

    <span class="n">line</span><span class="p">,</span> <span class="n">column</span> <span class="o">=</span> <span class="n">loc</span><span class="p">.</span><span class="n">line_number</span><span class="p">,</span> <span class="n">loc</span><span class="p">.</span><span class="n">column_number</span>
    <span class="k">if</span> <span class="n">line</span> <span class="o">&gt;</span> <span class="n">lines</span><span class="p">.</span><span class="n">size</span> <span class="o">||</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">column</span> <span class="o">&lt;</span> <span class="mi">1</span>
      <span class="n">raise</span> <span class="s">"Invalid issue location: #{loc}"</span>
    <span class="n">end</span>

    <span class="k">if</span> <span class="n">end_loc</span>
      <span class="k">if</span> <span class="n">end_loc</span> <span class="o">&lt;</span> <span class="n">loc</span>
        <span class="n">raise</span> <span class="o">&lt;&lt;-</span><span class="n">MSG</span>
          <span class="n">Invalid</span> <span class="n">issue</span> <span class="n">location</span>
            <span class="n">start</span><span class="o">:</span> <span class="err">#</span><span class="p">{</span><span class="n">loc</span><span class="p">}</span>
            <span class="n">end</span><span class="o">:</span>   <span class="err">#</span><span class="p">{</span><span class="n">end_loc</span><span class="p">}</span>
          <span class="n">MSG</span>
      <span class="n">end</span>

      <span class="n">end_line</span><span class="p">,</span> <span class="n">end_column</span> <span class="o">=</span> <span class="n">end_loc</span><span class="p">.</span><span class="n">line_number</span><span class="p">,</span> <span class="n">end_loc</span><span class="p">.</span><span class="n">column_number</span>

      <span class="k">if</span> <span class="n">end_line</span> <span class="o">&gt;</span> <span class="n">lines</span><span class="p">.</span><span class="n">size</span> <span class="o">||</span> <span class="n">end_line</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">end_column</span> <span class="o">&lt;</span> <span class="mi">1</span>
        <span class="n">raise</span> <span class="s">"Invalid issue end location: #{end_loc}"</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="p">{</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">end_line</span><span class="p">,</span> <span class="n">end_column</span><span class="p">}</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">def</span> <span class="n">column_length</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">end_line</span><span class="p">,</span> <span class="n">end_column</span><span class="p">)</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="n">unless</span> <span class="n">end_line</span> <span class="o">&amp;&amp;</span> <span class="n">end_column</span>

    <span class="k">if</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">end_line</span>
      <span class="n">code_line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">line</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
      <span class="n">end_column</span> <span class="o">=</span> <span class="n">code_line</span><span class="p">.</span><span class="n">size</span>
    <span class="n">end</span>

    <span class="n">end_column</span> <span class="o">-</span> <span class="n">column</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./util"
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Spec</span><span class="o">::</span><span class="n">Util</span>
  <span class="n">def</span> <span class="n">normalize_code</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">separator</span> <span class="o">=</span> <span class="sc">'\n'</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">code</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span>

    <span class="cp"># remove unneeded first blank lines if any
</span>    <span class="n">lines</span><span class="p">.</span><span class="n">shift</span> <span class="k">if</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">blank</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">lines</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">1</span>

    <span class="cp"># find the minimum indentation
</span>    <span class="n">min_indent</span> <span class="o">=</span> <span class="n">lines</span><span class="p">.</span><span class="n">min_of</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
      <span class="n">line</span><span class="p">.</span><span class="n">blank</span><span class="o">?</span> <span class="o">?</span> <span class="n">code</span><span class="p">.</span><span class="n">size</span> <span class="o">:</span> <span class="n">line</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">line</span><span class="p">.</span><span class="n">lstrip</span><span class="p">.</span><span class="n">size</span>
    <span class="n">end</span>

    <span class="cp"># remove the width of minimum indentation in each line
</span>    <span class="n">lines</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="n">separator</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">line</span><span class="o">|</span>
      <span class="n">line</span><span class="p">.</span><span class="n">blank</span><span class="o">?</span> <span class="o">?</span> <span class="n">line</span> <span class="o">:</span> <span class="n">line</span><span class="p">[</span><span class="n">min_indent</span><span class="p">..]</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># Mixin for `expect_issue` and `expect_no_issues`
#
# This mixin makes it easier to specify strict issue expectations
# in a declarative and visual fashion. Just type out the code that
# should generate an issue, annotate code by writing '^'s
# underneath each character that should be highlighted, and follow
# the carets with a string (separated by a space) that is the
# message of the issue. You can include multiple issues in
# one code snippet.
#
# Usage:
#
#     expect_issue subject, &lt;&lt;-CRYSTAL
#       a do
#         b
#       end.c
#       # ^^^ error: Avoid chaining a method call on a do...end block.
#       CRYSTAL
#
# Equivalent assertion without `expect_issue`:
#
#     source = Source.new &lt;&lt;-CRYSTAL, "source.cr"
#       a do
#         b
#       end.c
#       CRYSTAL
#     subject.catch(source).should_not be_valid
#     source.issues.size.should be(1)
#
#     issue = source.issues.first
#     issue.location.to_s.should eq "source.cr:3:1"
#     issue.end_location.to_s.should eq "source.cr:3:5"
#     issue.message.should eq(
#       "Avoid chaining a method call on a do...end block."
#     )
#
# Autocorrection can be tested using `expect_correction` after
# `expect_issue`.
#
#     source = expect_issue subject, &lt;&lt;-CRYSTAL
#       x % 2 == 0
#       # ^^^^^^^^ error: Replace with `Int#even?`.
#       CRYSTAL
#
#     expect_correction source, &lt;&lt;-CRYSTAL
#       x.even?
#       CRYSTAL
#
# If you do not want to specify an issue then use the
# companion method `expect_no_issues`. This method is a much
# simpler assertion since it just inspects the code and checks
# that there were no issues. The `expect_issue` method has
# to do more work by parsing out lines that contain carets.
#
# If the code produces an issue that could not be auto-corrected, you can
# use `expect_no_corrections` after `expect_issue`.
#
#     source = expect_issue subject, &lt;&lt;-CRYSTAL
#       a do
#         b
#       end.c
#       # ^^^ error: Avoid chaining a method call on a do...end block.
#       CRYSTAL
#
#     expect_no_corrections source
#
# If your code has variables of different lengths, you can use `%{foo}`,
# `^{foo}`, and `_{foo}` to format your template; you can also abbreviate
# issue messages with `[...]`:
#
#     %w[raise fail].each do |keyword|
#       expect_issue subject, &lt;&lt;-CRYSTAL, keyword: keyword
#         %{keyword} Exception.new(msg)
#         # ^{keyword}^^^^^^^^^^^^^^^^^ error: Redundant `Exception.new` [...]
#         CRYSTAL
#
#     %w[has_one has_many].each do |type|
#       expect_issue subject, &lt;&lt;-CRYSTAL, type: type
#         class Book
#           %{type} :chapter, foreign_key: "book_id"
#           _{type}         # ^^^^^^^^^^^^^^^^^^^^^^ error: Specifying the default [...]
#         end
#         CRYSTAL
#     end
#
# If you need to specify an issue on a blank line, use the empty `^{}` marker:
#
#     expect_issue subject, &lt;&lt;-CRYSTAL
#
#       # ^{} error: Missing frozen string literal comment.
#       puts 1
#       CRYSTAL
</span><span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Spec</span><span class="o">::</span><span class="n">ExpectIssue</span>
  <span class="n">include</span> <span class="n">Spec</span><span class="o">::</span><span class="n">Util</span>

  <span class="n">def</span> <span class="nf">expect_issue</span><span class="p">(</span><span class="n">rules</span> <span class="o">:</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span> <span class="o">|</span> <span class="n">Enumerable</span><span class="p">(</span><span class="n">Rule</span><span class="o">::</span><span class="n">Base</span><span class="p">),</span>
                   <span class="n">annotated_code</span> <span class="o">:</span> <span class="n">String</span><span class="p">,</span>
                   <span class="n">path</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span>
                   <span class="o">*</span><span class="p">,</span>
                   <span class="n">file</span> <span class="o">=</span> <span class="n">__FILE__</span><span class="p">,</span>
                   <span class="n">line</span> <span class="o">=</span> <span class="n">__LINE__</span><span class="p">,</span>
                   <span class="o">**</span><span class="n">replacements</span><span class="p">)</span>
    <span class="n">annotated_code</span> <span class="o">=</span> <span class="n">format_issue</span><span class="p">(</span><span class="n">annotated_code</span><span class="p">,</span> <span class="o">**</span><span class="n">replacements</span><span class="p">)</span>
    <span class="n">expected_annotations</span> <span class="o">=</span> <span class="n">AnnotatedSource</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">annotated_code</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">expected_annotations</span><span class="p">.</span><span class="n">lines</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">lines</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="n">annotated_code</span>
      <span class="n">raise</span> <span class="s">"Use `report_no_issues` to assert that no issues are found"</span>
    <span class="n">end</span>

    <span class="n">source</span><span class="p">,</span> <span class="n">actual_annotations</span> <span class="o">=</span> <span class="n">actual_annotations</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
    <span class="n">unless</span> <span class="n">actual_annotations</span> <span class="o">==</span> <span class="n">expected_annotations</span>
      <span class="n">fail</span> <span class="o">&lt;&lt;-</span><span class="n">MSG</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">line</span>
        <span class="n">Expected</span><span class="o">:</span>

        <span class="cp">#{expected_annotations}
</span>
        <span class="n">Got</span><span class="o">:</span>

        <span class="cp">#{actual_annotations}
</span>        <span class="n">MSG</span>
    <span class="n">end</span>

    <span class="n">source</span>
  <span class="n">end</span>

  <span class="n">def</span> <span class="n">expect_correction</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">correction</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">__LINE__</span><span class="p">)</span>
    <span class="n">raise</span> <span class="s">"Use `expect_no_corrections` if the code will not change"</span> <span class="n">unless</span> <span class="n">source</span><span class="p">.</span><span class="n">correct</span><span class="o">?</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">correction</span> <span class="o">==</span> <span class="n">source</span><span class="p">.</span><span class="n">code</span>

    <span class="n">fail</span> <span class="o">&lt;&lt;-</span><span class="n">MSG</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">line</span>
      <span class="n">Expected</span> <span class="n">correction</span><span class="o">:</span>

      <span class="cp">#{correction}
</span>
      <span class="n">Got</span><span class="o">:</span>

      <span class="cp">#{source.code}
</span>      <span class="n">MSG</span>
  <span class="n">end</span>

  <span class="n">def</span> <span class="n">expect_no_corrections</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">file</span> <span class="o">=</span> <span class="n">__FILE__</span><span class="p">,</span> <span class="n">line</span> <span class="o">=</span> <span class="n">__LINE__</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">unless</span> <span class="n">source</span><span class="p">.</span><span class="n">correct</span><span class="o">?</span>

    <span class="n">fail</span> <span class="o">&lt;&lt;-</span><span class="n">MSG</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">line</span>
      <span class="n">Expected</span> <span class="n">no</span> <span class="n">corrections</span><span class="p">,</span> <span class="n">but</span> <span class="n">got</span><span class="o">:</span>

      <span class="cp">#{source.code}
</span>      <span class="n">MSG</span>
  <span class="n">end</span>

  <span class="n">def</span> <span class="n">expect_no_issues</span><span class="p">(</span><span class="n">rules</span> <span class="o">:</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span> <span class="o">|</span> <span class="n">Enumerable</span><span class="p">(</span><span class="n">Rule</span><span class="o">::</span><span class="n">Base</span><span class="p">),</span>
                       <span class="n">code</span> <span class="o">:</span> <span class="n">String</span><span class="p">,</span>
                       <span class="n">path</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span>
                       <span class="o">*</span><span class="p">,</span>
                       <span class="n">file</span> <span class="o">=</span> <span class="n">__FILE__</span><span class="p">,</span>
                       <span class="n">line</span> <span class="o">=</span> <span class="n">__LINE__</span><span class="p">)</span>
    <span class="n">lines</span> <span class="o">=</span> <span class="n">code</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="sc">'\n'</span><span class="p">)</span> <span class="err">#</span> <span class="n">must</span> <span class="n">preserve</span> <span class="n">trailing</span> <span class="n">newline</span>

    <span class="n">_</span><span class="p">,</span> <span class="n">actual_annotations</span> <span class="o">=</span> <span class="n">actual_annotations</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
    <span class="k">return</span> <span class="k">if</span> <span class="n">actual_annotations</span><span class="p">.</span><span class="n">to_s</span> <span class="o">==</span> <span class="n">code</span>

    <span class="n">fail</span> <span class="o">&lt;&lt;-</span><span class="n">MSG</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">line</span>
      <span class="n">Expected</span> <span class="n">no</span> <span class="n">issues</span><span class="p">,</span> <span class="n">but</span> <span class="n">got</span><span class="o">:</span>

      <span class="cp">#{actual_annotations}
</span>      <span class="n">MSG</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">def</span> <span class="n">actual_annotations</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">lines</span><span class="p">)</span>
    <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">normalize</span><span class="o">:</span> <span class="nb">false</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rules</span><span class="p">.</span><span class="n">is_a</span><span class="o">?</span><span class="p">(</span><span class="n">Enumerable</span><span class="p">)</span>
      <span class="n">rules</span><span class="p">.</span><span class="n">each</span><span class="p">(</span><span class="o">&amp;</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="n">source</span><span class="p">))</span>
    <span class="k">else</span>
      <span class="n">rules</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">end</span>
    <span class="p">{</span><span class="n">source</span><span class="p">,</span> <span class="n">AnnotatedSource</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">)}</span>
  <span class="n">end</span>

  <span class="k">private</span> <span class="n">def</span> <span class="n">format_issue</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="o">**</span><span class="n">replacements</span><span class="p">)</span>
    <span class="n">replacements</span><span class="p">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">keyword</span><span class="p">,</span> <span class="n">value</span><span class="o">|</span>
      <span class="n">value</span> <span class="o">=</span> <span class="n">value</span><span class="p">.</span><span class="n">to_s</span>
      <span class="n">code</span> <span class="o">=</span> <span class="n">code</span>
        <span class="p">.</span><span class="n">gsub</span><span class="p">(</span><span class="s">"%{#{keyword}}"</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
        <span class="p">.</span><span class="n">gsub</span><span class="p">(</span><span class="s">"^{#{keyword}}"</span><span class="p">,</span> <span class="s">"^"</span> <span class="o">*</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
        <span class="p">.</span><span class="n">gsub</span><span class="p">(</span><span class="s">"_{#{keyword}}"</span><span class="p">,</span> <span class="s">" "</span> <span class="o">*</span> <span class="n">value</span><span class="p">.</span><span class="n">size</span><span class="p">)</span>
    <span class="n">end</span>
    <span class="n">code</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="cp"># require "./util"
</span>
<span class="n">module</span> <span class="n">Ameba</span>
  <span class="k">class</span> <span class="nc">Source</span>
    <span class="n">include</span> <span class="n">Spec</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">code</span> <span class="o">:</span> <span class="n">String</span><span class="p">,</span> <span class="err">@</span><span class="n">path</span> <span class="o">=</span> <span class="s">""</span><span class="p">,</span> <span class="n">normalize</span> <span class="o">=</span> <span class="nb">true</span><span class="p">)</span>
      <span class="err">@</span><span class="n">code</span> <span class="o">=</span> <span class="n">normalize</span> <span class="o">?</span> <span class="n">normalize_code</span><span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="o">:</span> <span class="n">code</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">include</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Spec</span><span class="o">::</span><span class="n">BeValid</span>
<span class="n">include</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Spec</span><span class="o">::</span><span class="n">ExpectIssue</span>

<span class="n">module</span> <span class="n">Ameba</span>
  <span class="cp"># Dummy Rule which does nothing.
</span>  <span class="k">class</span> <span class="nc">DummyRule</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="o">:</span> <span class="n">String</span> <span class="o">=</span> <span class="s">"Dummy rule that does nothing."</span>
      <span class="n">dummy</span> <span class="nb">true</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">NamedRule</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"A rule with a custom name."</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">self</span><span class="p">.</span><span class="n">name</span>
      <span class="s">"BreakingRule"</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># Rule extended description
</span>  <span class="k">class</span> <span class="nc">ErrorRule</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Always adds an error at 1:1"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">issue_for</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="s">"This rule always adds an error"</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">ScopeRule</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="err">@</span><span class="p">[</span><span class="n">YAML</span><span class="o">::</span><span class="n">Field</span><span class="p">(</span><span class="n">ignore</span><span class="o">:</span> <span class="nb">true</span><span class="p">)]</span>
    <span class="n">getter</span> <span class="n">scopes</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">AST</span><span class="o">::</span><span class="n">Scope</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Internal rule to test scopes"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">,</span> <span class="n">scope</span> <span class="o">:</span> <span class="n">AST</span><span class="o">::</span><span class="n">Scope</span><span class="p">)</span>
      <span class="err">@</span><span class="n">scopes</span> <span class="o">&lt;&lt;</span> <span class="n">scope</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">FlowExpressionRule</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="err">@</span><span class="p">[</span><span class="n">YAML</span><span class="o">::</span><span class="n">Field</span><span class="p">(</span><span class="n">ignore</span><span class="o">:</span> <span class="nb">true</span><span class="p">)]</span>
    <span class="n">getter</span> <span class="n">expressions</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">AST</span><span class="o">::</span><span class="n">FlowExpression</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Internal rule to test flow expressions"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">flow_expression</span> <span class="o">:</span> <span class="n">AST</span><span class="o">::</span><span class="n">FlowExpression</span><span class="p">)</span>
      <span class="err">@</span><span class="n">expressions</span> <span class="o">&lt;&lt;</span> <span class="n">flow_expression</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">RedundantControlExpressionRule</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="err">@</span><span class="p">[</span><span class="n">YAML</span><span class="o">::</span><span class="n">Field</span><span class="p">(</span><span class="n">ignore</span><span class="o">:</span> <span class="nb">true</span><span class="p">)]</span>
    <span class="n">getter</span> <span class="n">nodes</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Internal rule to test redundant control expressions"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span><span class="p">,</span> <span class="n">visitor</span> <span class="o">:</span> <span class="n">AST</span><span class="o">::</span><span class="n">RedundantControlExpressionVisitor</span><span class="p">)</span>
      <span class="n">nodes</span> <span class="o">&lt;&lt;</span> <span class="n">node</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="cp"># A rule that always raises an error
</span>  <span class="k">class</span> <span class="nc">RaiseRule</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">property</span><span class="o">?</span> <span class="n">should_raise</span> <span class="o">=</span> <span class="nb">false</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"Internal rule that always raises"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">should_raise</span><span class="o">?</span> <span class="o">&amp;&amp;</span> <span class="n">raise</span> <span class="s">"something went wrong"</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">PerfRule</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Performance</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="o">:</span> <span class="n">String</span> <span class="o">=</span> <span class="s">"Sample performance rule"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
      <span class="n">issue_for</span><span class="p">({</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">},</span> <span class="s">"Poor performance"</span><span class="p">)</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">AtoAA</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"This rule is only used to test infinite loop detection"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ClassDef</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ModuleDef</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span> <span class="o">=</span> <span class="n">node_source</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="s">"A"</span><span class="p">)</span>

      <span class="n">issue_for</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="o">:</span> <span class="s">"A to AA"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="n">sub</span><span class="p">(</span><span class="s">"A"</span><span class="p">,</span> <span class="s">"AA"</span><span class="p">))</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">AtoB</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"This rule is only used to test infinite loop detection"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ClassDef</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ModuleDef</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span> <span class="o">=</span> <span class="n">node_source</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="s">"A"</span><span class="p">)</span>

      <span class="n">issue_for</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="o">:</span> <span class="s">"A to B"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="n">tr</span><span class="p">(</span><span class="s">"A"</span><span class="p">,</span> <span class="s">"B"</span><span class="p">))</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">BtoA</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"This rule is only used to test infinite loop detection"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ClassDef</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ModuleDef</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span> <span class="o">=</span> <span class="n">node_source</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="s">"B"</span><span class="p">)</span>

      <span class="n">issue_for</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="o">:</span> <span class="s">"B to A"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="n">tr</span><span class="p">(</span><span class="s">"B"</span><span class="p">,</span> <span class="s">"A"</span><span class="p">))</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">BtoC</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"This rule is only used to test infinite loop detection"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ClassDef</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ModuleDef</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span> <span class="o">=</span> <span class="n">node_source</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="s">"B"</span><span class="p">)</span>

      <span class="n">issue_for</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="o">:</span> <span class="s">"B to C"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="n">tr</span><span class="p">(</span><span class="s">"B"</span><span class="p">,</span> <span class="s">"C"</span><span class="p">))</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">CtoA</span> <span class="o">&lt;</span> <span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">include</span> <span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"This rule is only used to test infinite loop detection"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ClassDef</span> <span class="o">|</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ModuleDef</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span> <span class="o">=</span> <span class="n">node_source</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">source</span><span class="p">.</span><span class="n">lines</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">name</span><span class="p">.</span><span class="n">includes</span><span class="o">?</span><span class="p">(</span><span class="s">"C"</span><span class="p">)</span>

      <span class="n">issue_for</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">message</span><span class="o">:</span> <span class="s">"C to A"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">node</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">.</span><span class="n">tr</span><span class="p">(</span><span class="s">"C"</span><span class="p">,</span> <span class="s">"A"</span><span class="p">))</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">ClassToModule</span> <span class="o">&lt;</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">include</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"This rule is only used to test infinite loop detection"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ClassDef</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span>

      <span class="n">end_location</span> <span class="o">=</span> <span class="n">location</span><span class="p">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">column_number</span><span class="o">:</span> <span class="p">{{</span> <span class="s">"class"</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">}})</span>

      <span class="n">issue_for</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">message</span><span class="o">:</span> <span class="s">"class to module"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="s">"module"</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">ModuleToClass</span> <span class="o">&lt;</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Base</span>
    <span class="n">include</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">AST</span><span class="o">::</span><span class="n">Util</span>

    <span class="n">properties</span> <span class="k">do</span>
      <span class="n">description</span> <span class="s">"This rule is only used to test infinite loop detection"</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">test</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ModuleDef</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">unless</span> <span class="n">location</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">location</span>

      <span class="n">end_location</span> <span class="o">=</span> <span class="n">location</span><span class="p">.</span><span class="n">adjust</span><span class="p">(</span><span class="n">column_number</span><span class="o">:</span> <span class="p">{{</span> <span class="s">"module"</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">}})</span>

      <span class="n">issue_for</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="n">message</span><span class="o">:</span> <span class="s">"module to class"</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">corrector</span><span class="o">|</span>
        <span class="n">corrector</span><span class="p">.</span><span class="n">replace</span><span class="p">(</span><span class="n">location</span><span class="p">,</span> <span class="n">end_location</span><span class="p">,</span> <span class="s">"class"</span><span class="p">)</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">DummyFormatter</span> <span class="o">&lt;</span> <span class="n">Formatter</span><span class="o">::</span><span class="n">BaseFormatter</span>
    <span class="n">property</span> <span class="n">started_sources</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Source</span><span class="p">)</span><span class="o">?</span>
    <span class="n">property</span> <span class="n">finished_sources</span> <span class="o">:</span> <span class="n">Array</span><span class="p">(</span><span class="n">Source</span><span class="p">)</span><span class="o">?</span>
    <span class="n">property</span> <span class="n">started_source</span> <span class="o">:</span> <span class="n">Source</span><span class="o">?</span>
    <span class="n">property</span> <span class="n">finished_source</span> <span class="o">:</span> <span class="n">Source</span><span class="o">?</span>

    <span class="n">def</span> <span class="n">started</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
      <span class="err">@</span><span class="n">started_sources</span> <span class="o">=</span> <span class="n">sources</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">source_finished</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">)</span>
      <span class="err">@</span><span class="n">started_source</span> <span class="o">=</span> <span class="n">source</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">source_started</span><span class="p">(</span><span class="n">source</span> <span class="o">:</span> <span class="n">Source</span><span class="p">)</span>
      <span class="err">@</span><span class="n">finished_source</span> <span class="o">=</span> <span class="n">source</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">finished</span><span class="p">(</span><span class="n">sources</span><span class="p">)</span>
      <span class="err">@</span><span class="n">finished_sources</span> <span class="o">=</span> <span class="n">sources</span>
    <span class="n">end</span>
  <span class="n">end</span>

  <span class="k">class</span> <span class="nc">TestNodeVisitor</span> <span class="o">&lt;</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">Visitor</span>
    <span class="n">NODES</span> <span class="o">=</span> <span class="p">{</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">NilLiteral</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">Var</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">Assign</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">OpAssign</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">MultiAssign</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">Block</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">Macro</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">Def</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">If</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">While</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">MacroLiteral</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">Expressions</span><span class="p">,</span>
      <span class="n">Crystal</span><span class="o">::</span><span class="n">ControlExpression</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">def</span> <span class="n">initialize</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
      <span class="n">node</span><span class="p">.</span><span class="n">accept</span> <span class="n">self</span>
    <span class="n">end</span>

    <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="n">Crystal</span><span class="o">::</span><span class="n">ASTNode</span><span class="p">)</span>
      <span class="nb">true</span>
    <span class="n">end</span>

    <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">node</span> <span class="n">in</span> <span class="n">NODES</span> <span class="o">%</span><span class="p">}</span>
      <span class="p">{{</span> <span class="n">getter_name</span> <span class="o">=</span> <span class="n">node</span><span class="p">.</span><span class="n">stringify</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"::"</span><span class="p">).</span><span class="n">last</span><span class="p">.</span><span class="n">underscore</span> <span class="o">+</span> <span class="s">"_nodes"</span> <span class="p">}}</span>

      <span class="n">getter</span> <span class="p">{{</span> <span class="n">getter_name</span><span class="p">.</span><span class="n">id</span> <span class="p">}}</span> <span class="o">=</span> <span class="p">[]</span> <span class="n">of</span> <span class="p">{{</span> <span class="n">node</span> <span class="p">}}</span>

      <span class="n">def</span> <span class="n">visit</span><span class="p">(</span><span class="n">node</span> <span class="o">:</span> <span class="p">{{</span> <span class="n">node</span> <span class="p">}})</span>
        <span class="p">{{</span> <span class="n">getter_name</span><span class="p">.</span><span class="n">id</span> <span class="p">}}</span> <span class="o">&lt;&lt;</span> <span class="n">node</span>
        <span class="nb">true</span>
      <span class="n">end</span>
    <span class="p">{</span><span class="o">%</span> <span class="n">end</span> <span class="o">%</span><span class="p">}</span>
  <span class="n">end</span>
<span class="n">end</span>

<span class="n">def</span> <span class="n">as_node</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
  <span class="n">Crystal</span><span class="o">::</span><span class="n">Parser</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">source</span><span class="p">).</span><span class="n">parse</span>
<span class="n">end</span>

<span class="n">def</span> <span class="n">as_nodes</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
  <span class="n">Ameba</span><span class="o">::</span><span class="n">TestNodeVisitor</span><span class="p">.</span><span class="k">new</span><span class="p">(</span><span class="n">as_node</span> <span class="n">source</span><span class="p">)</span>
<span class="n">end</span>

<span class="n">def</span> <span class="n">trailing_whitespace</span>
  <span class="sc">' '</span>
<span class="n">end</span>

<span class="n">module</span> <span class="n">Ameba</span><span class="o">::</span><span class="n">Rule</span><span class="o">::</span><span class="n">Layout</span>
  <span class="n">subject</span> <span class="o">=</span> <span class="n">TrailingBlankLines</span><span class="p">.</span><span class="k">new</span>

  <span class="n">describe</span> <span class="n">TrailingBlankLines</span> <span class="k">do</span>
    <span class="n">it</span> <span class="s">"passes if there is a blank line at the end of a source"</span> <span class="k">do</span>
      <span class="n">expect_no_issues</span> <span class="n">subject</span><span class="p">,</span> <span class="s">"a = 1</span><span class="se">\n</span><span class="s">"</span>
    <span class="n">end</span>

    <span class="n">it</span> <span class="s">"passes if source is empty"</span> <span class="k">do</span>
      <span class="n">expect_no_issues</span> <span class="n">subject</span><span class="p">,</span> <span class="s">""</span>
    <span class="n">end</span>

    <span class="n">it</span> <span class="s">"fails if there is no blank lines at the end"</span> <span class="k">do</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">expect_issue</span> <span class="n">subject</span><span class="p">,</span> <span class="s">"no-blankline # error: Trailing newline missing"</span>
      <span class="n">expect_correction</span> <span class="n">source</span><span class="p">,</span> <span class="s">"no-blankline</span><span class="se">\n</span><span class="s">"</span>
    <span class="n">end</span>

    <span class="n">it</span> <span class="s">"fails if there more then one blank line at the end of a source"</span> <span class="k">do</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">expect_issue</span> <span class="n">subject</span><span class="p">,</span> <span class="s">"a = 1</span><span class="se">\n</span><span class="s"> </span><span class="se">\n</span><span class="s"> # error: Excessive trailing newline detected"</span>
      <span class="n">expect_no_corrections</span> <span class="n">source</span>
    <span class="n">end</span>

    <span class="n">it</span> <span class="s">"fails if last line is not blank"</span> <span class="k">do</span>
      <span class="n">source</span> <span class="o">=</span> <span class="n">expect_issue</span> <span class="n">subject</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n\n</span><span class="s"> puts 22 # error: Trailing newline missing"</span>
      <span class="n">expect_correction</span> <span class="n">source</span><span class="p">,</span> <span class="s">"</span><span class="se">\n\n\n</span><span class="s"> puts 22</span><span class="se">\n</span><span class="s">"</span>
    <span class="n">end</span>

    <span class="n">context</span> <span class="s">"when unnecessary blank line has been detected"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s">"reports rule, pos and message"</span> <span class="k">do</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">.</span><span class="k">new</span> <span class="s">"a = 1</span><span class="se">\n\n</span><span class="s">"</span><span class="p">,</span> <span class="s">"source.cr"</span><span class="p">,</span> <span class="n">normalize</span><span class="o">:</span> <span class="nb">false</span>
        <span class="n">subject</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="n">source</span><span class="p">).</span><span class="n">should_not</span> <span class="n">be_valid</span>

        <span class="n">issue</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">first</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">to_s</span><span class="p">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s">"source.cr:3:1"</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">end_location</span><span class="p">.</span><span class="n">should</span> <span class="n">be_nil</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s">"Excessive trailing newline detected"</span>
      <span class="n">end</span>
    <span class="n">end</span>

    <span class="n">context</span> <span class="s">"when final line has been missed"</span> <span class="k">do</span>
      <span class="n">it</span> <span class="s">"reports rule, pos and message"</span> <span class="k">do</span>
        <span class="n">source</span> <span class="o">=</span> <span class="n">Source</span><span class="p">.</span><span class="k">new</span> <span class="s">"a = 1"</span><span class="p">,</span> <span class="s">"source.cr"</span><span class="p">,</span> <span class="n">normalize</span><span class="o">:</span> <span class="nb">false</span>
        <span class="n">subject</span><span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="n">source</span><span class="p">).</span><span class="n">should_not</span> <span class="n">be_valid</span>

        <span class="n">issue</span> <span class="o">=</span> <span class="n">source</span><span class="p">.</span><span class="n">issues</span><span class="p">.</span><span class="n">first</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">rule</span><span class="p">.</span><span class="n">should_not</span> <span class="n">be_nil</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">location</span><span class="p">.</span><span class="n">to_s</span><span class="p">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s">"source.cr:1:1"</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">end_location</span><span class="p">.</span><span class="n">should</span> <span class="n">be_nil</span>
        <span class="n">issue</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">should</span> <span class="n">eq</span> <span class="s">"Trailing newline missing"</span>
      <span class="n">end</span>
    <span class="n">end</span>
  <span class="n">end</span>
<span class="n">end</span></code></pre></figure>






<a href="/ac-library.cr/docs/">Back to top page</a>




      </section>
      <footer>
        
        <p><small>Hosted on GitHub Pages  Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="/ac-library.cr/docs/assets/js/scale.fix.js"></script>
  </body>
</html>
